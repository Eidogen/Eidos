<div alignter">
# <img src="docs/Eidos.jpeg" alt="Eidos Logo" width="50">Eidos 交易系统

> 一个基于**链下撮合 + 链上结算**架构的去中心化交易系统

---

## 📖 项目简介

Eidos 是一个高性能的去中心化交易系统，采用**链下撮合 + 链上结算**的混合架构，在保证资金安全的前提下，实现中心化交易所级别的交易性能。

### 核心特点

- 🔐 **资金安全**: 用户资金始终托管在链上智能合约，系统无法挪用
- ⚡ **高性能**: 链下撮合引擎，支持毫秒级订单处理
- 💰 **低成本**: 仅最终结算上链，大幅降低 Gas 费用
- 🔍 **可验证**: 所有交易结果在链上可查，完全透明
- 🚀 **无需注册**: 钱包签名即认证，即连即用

### 架构优势

相比传统方案，Eidos 在安全性和性能之间取得了最佳平衡：

| 特性 | 传统 CEX | Eidos | 完全 DEX |
|------|---------|-------|---------|
| 资金安全 | ❌ 托管在交易所 | ✅ 链上合约托管 | ✅ 链上 |
| 交易速度 | ✅ 快 | ✅ 快 | ❌ 慢 |
| Gas 费用 | ✅ 无 | ✅ 低（仅结算） | ❌ 高 |
| 用户体验 | ✅ 简单 | ✅ 简单 | ❌ 复杂 |

---

## 🏗️ 系统架构

Eidos 采用微服务架构，包含 8 个核心服务，通过 Kafka 事件驱动实现解耦：

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户层                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Web App   │  │  Mobile App │  │  API Client │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     API 服务层 (直接对外)                         │
│  ┌────────────────────────┐                                      │
│  │      eidos-api         │                                      │
│  │   REST + WebSocket     │                                      │
│  │  - EIP-712 签名验证    │                                      │
│  │  - 限流 / 熔断         │                                      │
│  │  - 行情推送            │                                      │
│  └────────────┬───────────┘                                      │
└───────────────┼──────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     核心服务层 (gRPC 通信)                        │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ eidos-trading   │──>│ eidos-matching  │──>│  eidos-risk    │  │
│  │  (订单+清算+账户)│  │   (撮合引擎)    │  │   (风控服务)    │  │
│  └────────┬────────┘  └────────┬────────┘  └─────────────────┘  │
│           │                    │                                 │
│  ┌────────▼────────┐  ┌────────▼────────┐  ┌─────────────────┐  │
│  │  eidos-chain    │  │  eidos-market   │  │   eidos-jobs    │  │
│  │  (结算+索引)    │  │   (行情服务)    │  │   (定时任务)    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                  │
│  ┌─────────────────┐                                            │
│  │  eidos-admin   │                                            │
│  │   (管理后台)   │                                            │
│  └─────────────────┘                                            │
└─────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     消息队列 (Kafka)                             │
│  ┌─────────┐  ┌─────────┐  ┌───────────┐  ┌───────────┐        │
│  │ orders  │  │ trades  │  │ orderbook │  │settlements│        │
│  └─────────┘  └─────────┘  └───────────┘  └───────────┘        │
└─────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     基础设施层                                   │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐                 │
│  │ PostgreSQL │  │   Redis    │  │   Kafka    │                 │
│  │ + Timescale│  │  Cluster   │  │  Cluster   │                 │
│  └────────────┘  └────────────┘  └────────────┘                 │
└─────────────────────────────────────────────────────────────────┘
```

### 核心服务

| 服务名 | 端口 | 职责 |
|--------|------|------|
| **eidos-api** | 8080 | REST + WebSocket API，EIP-712 签名验证，限流熔断 |
| **eidos-trading** | 50051 | 订单管理、清算、账户余额 |
| **eidos-matching** | 50052 | 内存订单簿、订单撮合引擎 |
| **eidos-market** | 50053 | K线数据、深度行情、Ticker |
| **eidos-chain** | 50054 | 链上结算、事件索引 |
| **eidos-risk** | 50055 | 交易前/后风控检查 |
| **eidos-jobs** | 50056 | 定时对账、数据归档、统计汇总 |
| **eidos-admin** | 8088 | 运营管理后台 |

---

## 🔄 核心流程

### 下单流程

```
用户钱包签名 → eidos-api → eidos-trading → [验证+冻结+风控] → Kafka → eidos-matching
                                    ↓
                              eidos-risk (同步风控检查)
```

### 成交流程

```
eidos-matching → Kafka(trades) → eidos-trading → [解冻+扣款+加款+写流水]
                              ↓                        ↓
                        eidos-market (更新K线)    eidos-risk (异步监控)
                              ↓
                        eidos-api (WebSocket 推送公共行情)
```

### 结算流程

```
eidos-trading → Kafka(settlements) → eidos-chain → [链上结算] → 智能合约
```

---

## 🛠️ 技术栈

| 层级 | 技术选型 |
|------|---------|
| **后端服务** | Go 1.22+, gRPC, Gin |
| **消息队列** | Kafka (事件驱动架构) |
| **缓存** | Redis Cluster |
| **数据库** | PostgreSQL + TimescaleDB (时序数据) |
| **前端** | React, TailwindCSS, TanStack Query |
| **智能合约** | Solidity (部署在 Arbitrum) |
| **部署** | Docker Compose → Kubernetes |

---

## 📚 文档结构

```
docs/
├── 1-产品需求/              # 产品需求与版本规划
│   ├── 01-功能需求.md       # 功能需求说明
│   └── 02-版本规划.md       # 版本规划
│
├── 2-系统架构/              # 系统技术架构
│   └── 01-技术架构.md       # 整体技术架构设计
│
├── 3-开发规范/              # 开发规范与标准
│   ├── 00-协议总表.md       # ⭐ 配置唯一真源 (必读)
│   ├── 01-设计规范.md       # 服务设计规范
│   ├── 02-API接口规范.md    # REST/WebSocket API 规范
│   ├── 03-幂等性规范.md     # 幂等性设计规范
│   └── 04-状态机规范.md     # ⭐ 订单/成交/结算状态机 (必读)
│
├── 4-服务设计/              # 后端服务详细设计 (8个服务)
│   ├── 00-设计补充-一致性与可靠性.md  # ⭐ 分布式一致性补充设计 (必读)
│   ├── 01-交易服务.md       # eidos-trading (订单+清算+账户)
│   ├── 02-撮合引擎.md       # eidos-matching (内存订单簿+撮合)
│   ├── 03-行情服务.md       # eidos-market (K线/深度/Ticker)
│   ├── 04-链上服务.md       # eidos-chain (结算+索引)
│   ├── 05-API服务.md        # eidos-api (REST + WebSocket)
│   ├── 06-管理后台.md       # eidos-admin
│   ├── 07-定时任务.md       # eidos-jobs (对账/归档/统计)
│   └── 08-风控服务.md       # eidos-risk (风控监控)
│
├── 5-前端设计/              # 前端设计
│   └── 01-前端设计.md       # Web 前端技术方案
│
├── 6-智能合约/              # 智能合约设计
│   └── 01-合约规划.md       # 合约开发规划
│
└── 7-运维部署/              # 运维与部署
    └── 01-运维部署.md       # 部署、安全、高可用、压测一体化文档
```

---

## 🚀 快速开始

### 新成员入门

建议按以下顺序阅读文档：

1. **[功能需求](docs/1-产品需求/01-功能需求.md)** - 了解产品功能和核心概念
2. **[技术架构](docs/2-系统架构/01-技术架构.md)** - 理解整体架构设计
3. **[协议总表](docs/3-开发规范/00-协议总表.md)** ⭐ - **必读**: 所有配置的唯一真源
4. **[状态机规范](docs/3-开发规范/04-状态机规范.md)** ⭐ - **必读**: 订单/成交/结算状态流转
5. **[一致性与可靠性](docs/4-服务设计/00-设计补充-一致性与可靠性.md)** ⭐ - **必读**: 分布式一致性保障
6. 按需阅读 `4-服务设计/` 下的 8 个服务文档

### 开发规范 (必读)

- **[协议总表](docs/3-开发规范/00-协议总表.md)** - API/WebSocket/EIP-712/Kafka 配置真源
- **[状态机规范](docs/3-开发规范/04-状态机规范.md)** - 订单/成交/结算/提现状态机
- **[幂等性规范](docs/3-开发规范/03-幂等性规范.md)** - 幂等性设计原则

### 部署运维

- **[运维部署指南](docs/7-运维部署/01-运维部署.md)** - Docker 部署、安全模型、高可用、压力测试

---

## 🎯 版本规划

| 版本 | 范围 | 核心功能 |
|------|------|---------|
| **v1.0** | 现货交易 | EIP-712 签名下单、限价/市价单、撮合引擎、链上结算 |
| **v2.0** | 永续合约 | 杠杆交易、资金费率、强制清算、保证金管理 |
| **v3.0** | 预测市场 | 预测市场创建、事件结算、流动性池 |

详细规划见 [版本规划文档](docs/1-产品需求/02-版本规划.md)

---

## ⚠️ 技术风险与解决方案

| 风险 | 解决方案 | 文档位置 |
|------|----------|----------|
| **撮合引擎单点故障** | 热备切换 + Kafka 重放重建订单簿 | [运维部署](docs/7-运维部署/01-运维部署.md) |
| **链下/链上数据不一致** | 定时对账 + 冲突解决策略 | [链上服务](docs/4-服务设计/04-链上服务.md) |
| **签名验证 CPU 瓶颈** | 批量验证 + 结果缓存 | [交易服务](docs/4-服务设计/01-交易服务.md) |
| **Redis 订单簿宕机** | AOF 持久化 + Kafka 重建 | [撮合引擎](docs/4-服务设计/02-撮合引擎.md) |
| **热钱包私钥安全** | AWS KMS / HashiCorp Vault | [运维部署](docs/7-运维部署/01-运维部署.md) |
| **跨服务事务一致性** | Outbox Pattern + 幂等处理 | [一致性与可靠性](docs/4-服务设计/00-设计补充-一致性与可靠性.md) |
| **交易风控** | 交易前同步检查 + 成交后异步监控 | [风控服务](docs/4-服务设计/08-风控服务.md) |
| **快照与消息一致性** | 两阶段快照 + 消息去重 | [一致性与可靠性](docs/4-服务设计/00-设计补充-一致性与可靠性.md) |
| **分布式时间戳** | Snowflake ID 生成器 | [一致性与可靠性](docs/4-服务设计/00-设计补充-一致性与可靠性.md) |

---

## 📝 设计原则

- **资金安全第一**: 用户资金始终在链上，系统无法挪用
- **高性能**: 链下撮合实现毫秒级响应
- **高可用**: 关键服务支持热备切换，故障自动恢复
- **可观测**: 完善的监控、日志、追踪体系
- **可扩展**: 微服务架构，支持水平扩展
- **一致性**: 通过 Outbox Pattern、幂等性设计保证数据一致性

---

## 🔗 相关链接

- [功能需求文档](docs/1-产品需求/01-功能需求.md)
- [技术架构文档](docs/2-系统架构/01-技术架构.md)
- [开发规范文档](docs/3-开发规范/)
- [服务设计文档](docs/4-服务设计/)
