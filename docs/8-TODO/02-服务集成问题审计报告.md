# Eidos 服务集成问题审计报告

> **文档目的**: 记录服务间集成的所有已发现问题、缺失项和修复建议
> **审计日期**: 2025-01-18
> **审计范围**: 全部 8 个核心服务 + eidos-common 公共库
> **整体实现度**: 65-70%

---

## 一、执行摘要

### 1.1 审计结论

Eidos 系统当前处于**"链下撮合孤岛"**状态：
- ✅ 可以完成链下撮合和清算
- ❌ 无法完成链上结算（资金永远锁在链下）
- ❌ 无法实时推送订单/余额变更给用户
- ❌ 风控检查形同虚设

### 1.2 关键数据

| 指标 | 数值 |
|------|------|
| 发现问题总数 | 18 项 |
| P0 阻塞上线问题 | 7 项 |
| P1 上线前必须完成 | 6 项 |
| P2 优化项 | 5 项 |
| 预计修复总工时 | 25-35 小时 |

---

## 二、服务间通信全景图

```
                                    ┌─────────────────────────────────────────┐
                                    │           eidos-api (Gateway)           │
                                    │            HTTP: 8080                   │
                                    └─────────────┬───────────────────────────┘
                                                  │
                    ┌─────────────────────────────┼─────────────────────────────┐
                    │                             │                             │
                    ▼                             ▼                             ▼
        ┌───────────────────┐         ┌───────────────────┐         ┌───────────────────┐
        │   eidos-trading   │         │   eidos-market    │         │    eidos-risk     │
        │    gRPC: 50051    │         │    gRPC: 50053    │         │    gRPC: 50055    │
        │   ❌ 未注册服务    │         │   ❌ 未注册服务    │         │   ✅ 已注册服务    │
        └─────────┬─────────┘         └─────────┬─────────┘         └───────────────────┘
                  │                             │
                  ▼                             │
        ┌───────────────────┐                   │
        │  eidos-matching   │◄──────────────────┘
        │    gRPC: 50052    │
        │   ❌ 未注册服务    │
        └─────────┬─────────┘
                  │
    ──────────────┼────────────── Kafka ──────────────────────────────────────
                  │
                  ▼
        ┌───────────────────┐         ┌───────────────────┐
        │   eidos-chain     │         │    eidos-jobs     │
        │    gRPC: 50054    │         │    gRPC: 50056    │
        │   ❌ 未注册服务    │         │   ❌ 无客户端      │
        └───────────────────┘         └───────────────────┘

图例:
  ─────► gRPC 调用 (实线=已实现, 虚线=缺失)
  ═════► Kafka 消息流
  ❌ 问题点
  ✅ 正常
```

---

## 三、P0 问题 - 阻塞上线

### 3.1 Trading → Chain 结算链路断层

**问题 ID**: P0-001
**严重级别**: 🔴 Critical
**影响范围**: 成交后无法链上结算，资金永远锁在链下

#### 问题描述

eidos-chain 已准备好消费 `settlements` 和 `withdrawals` 话题，但 eidos-trading 尚未实现生产逻辑。

#### 当前流程（断裂）

```
matching → trade-results topic
               ↓
ClearingService.ProcessTradeResult()
    ├─ ✅ Redis Lua 原子清算
    ├─ ✅ DB 持久化成交记录
    ├─ ✅ 发布 order-updates / balance-updates
    └─ ❌ 【断点】无 settlements 消息发送
               ↓
        eidos-chain 永远收不到消息
               ↓
        成交状态永远停留在 MATCHED_OFFCHAIN
```

#### 代码证据

| 文件 | 行号 | 问题 |
|------|------|------|
| `eidos-trading/internal/service/clearing_service.go` | 70-165 | `ProcessTradeResult()` 无 Kafka 发送逻辑 |
| `eidos-trading/internal/service/withdrawal_service.go` | 225 | TODO 注释: `// 9. TODO: 发送提现请求到风控服务` |

#### 修复方案

```go
// eidos-trading/internal/service/clearing_service.go
// 在 ProcessTradeResult() 末尾添加：

func (s *ClearingService) ProcessTradeResult(ctx context.Context, result *model.TradeResult) error {
    // ... 现有逻辑 ...

    // 新增：发送结算消息到 chain 服务
    settlementMsg := &chainpb.SettlementRequest{
        TradeId:     result.TradeID,
        MakerWallet: result.MakerWallet,
        TakerWallet: result.TakerWallet,
        // ... 其他字段
    }
    if err := s.kafkaProducer.SendSettlement(ctx, settlementMsg); err != nil {
        s.logger.Error("failed to send settlement", zap.Error(err))
        // 考虑是否需要回滚
    }

    return nil
}
```

#### 工作量估算

| 任务 | 工时 |
|------|------|
| 实现 settlements 消息发送 | 2h |
| 实现 withdrawals 消息发送 | 1h |
| 单元测试 | 1h |
| 集成测试 | 1h |
| **合计** | **5h** |

---

### 3.2 Trading → Risk 同步风控断层

**问题 ID**: P0-002
**严重级别**: 🔴 Critical
**影响范围**: 全局风控规则（黑名单、异常频率）无法生效

#### 问题描述

eidos-risk 暴露了 `CheckOrder` 和 `CheckWithdraw` 接口，但 eidos-trading 未实现调用。

#### 当前下单流程

```
CreateOrder() 流程：
1. ✅ 参数校验
2. ✅ 市场校验
3. ✅ 余额校验
4. ❌ 【缺失】gRPC 调用 eidos-risk.CheckOrder()
5. ✅ 本地 RiskConfigProvider 限额检查（仅静态配置）
6. ✅ 发送到撮合引擎
```

#### 代码证据

| 文件 | 问题 |
|------|------|
| `eidos-trading/internal/client/` | 目录中不存在 `risk_client.go` |
| `eidos-trading/internal/service/order_service.go` | 无 `CheckOrder` 调用 |
| `eidos-trading/internal/service/withdrawal_service.go:225` | TODO 注释但未实现 |

#### 修复方案

**步骤 1**: 创建 risk_client.go

```go
// eidos-trading/internal/client/risk_client.go
package client

import (
    "context"
    riskpb "eidos/proto/risk/v1"
    "google.golang.org/grpc"
)

type RiskClient struct {
    client riskpb.RiskServiceClient
}

func NewRiskClient(conn *grpc.ClientConn) *RiskClient {
    return &RiskClient{
        client: riskpb.NewRiskServiceClient(conn),
    }
}

func (c *RiskClient) CheckOrder(ctx context.Context, req *riskpb.CheckOrderRequest) (*riskpb.CheckOrderResponse, error) {
    return c.client.CheckOrder(ctx, req)
}

func (c *RiskClient) CheckWithdraw(ctx context.Context, req *riskpb.CheckWithdrawRequest) (*riskpb.CheckWithdrawResponse, error) {
    return c.client.CheckWithdraw(ctx, req)
}
```

**步骤 2**: 在 OrderService 中注入调用

```go
// eidos-trading/internal/service/order_service.go
// 在 CreateOrder() 中添加风控检查

func (s *OrderService) CreateOrder(ctx context.Context, req *CreateOrderRequest) (*Order, error) {
    // ... 参数校验 ...

    // 新增：调用风控服务
    riskResp, err := s.riskClient.CheckOrder(ctx, &riskpb.CheckOrderRequest{
        Wallet:   req.Wallet,
        Market:   req.Market,
        Side:     req.Side,
        Price:    req.Price,
        Quantity: req.Quantity,
    })
    if err != nil {
        return nil, fmt.Errorf("risk check failed: %w", err)
    }
    if !riskResp.Allowed {
        return nil, errors.New(riskResp.Reason)
    }

    // ... 继续现有逻辑 ...
}
```

#### 工作量估算

| 任务 | 工时 |
|------|------|
| 创建 risk_client.go | 1h |
| 修改 OrderService | 1h |
| 修改 WithdrawalService | 0.5h |
| 修改 app.go 初始化 | 0.5h |
| 单元测试 | 1h |
| **合计** | **4h** |

---

### 3.3 gRPC 服务注册缺失

**问题 ID**: P0-003
**严重级别**: 🔴 Critical
**影响范围**: 服务间 gRPC 调用完全失败

#### 问题描述

多个服务的 gRPC Handler 已实现，但未在 gRPC Server 中注册。

#### 问题清单

| 服务 | 端口 | Handler 文件 | 注册状态 | 影响 |
|------|------|-------------|---------|------|
| eidos-trading | 50051 | `internal/handler/trading_handler.go` | ❌ 未注册 | eidos-api 无法调用 |
| eidos-matching | 50052 | `internal/handler/grpc_handler.go` | ❌ 未注册 | 无法查询订单簿 |
| eidos-market | 50053 | - | ❌ 无 gRPC 服务端 | 行情查询依赖 HTTP |
| eidos-chain | 50054 | `internal/handler/chain_handler.go` | ❌ 未注册 | eidos-jobs 无法查询 |
| eidos-risk | 50055 | `internal/handler/risk_handler.go` | ✅ 已注册 | 正常 |
| eidos-jobs | 50056 | - | ❌ 无 gRPC 服务端 | - |

#### 代码证据

```go
// eidos-chain/internal/app/app.go:345
// TODO: 注册 gRPC 服务
```

```go
// eidos-matching/cmd/main.go:117
// healthServer.SetServingStatus 是 TODO
```

#### 修复方案

以 eidos-trading 为例：

```go
// eidos-trading/internal/app/app.go

func (a *App) Run() error {
    // ... 现有初始化 ...

    // 新增：启动 gRPC 服务器
    grpcServer := grpc.NewServer(
        grpc.UnaryInterceptor(middleware.UnaryServerInterceptor()),
    )

    // 注册服务
    tradingpb.RegisterTradingServiceServer(grpcServer, a.tradingHandler)

    // 注册健康检查
    healthServer := health.NewServer()
    grpc_health_v1.RegisterHealthServer(grpcServer, healthServer)
    healthServer.SetServingStatus("eidos.trading.v1.TradingService", grpc_health_v1.HealthCheckResponse_SERVING)

    // 启动监听
    lis, err := net.Listen("tcp", ":50051")
    if err != nil {
        return err
    }

    go grpcServer.Serve(lis)

    // ... 继续现有逻辑 ...
}
```

#### 工作量估算

| 任务 | 工时 |
|------|------|
| eidos-trading gRPC 注册 | 0.5h |
| eidos-matching gRPC 注册 | 0.5h |
| eidos-chain gRPC 注册 | 0.5h |
| 测试验证 | 0.5h |
| **合计** | **2h** |

---

### 3.4 eidos-trading Kafka 消费缺失

**问题 ID**: P0-004
**严重级别**: 🔴 Critical
**影响范围**: 成交结果、结算确认、提现确认无法处理

#### 问题描述

eidos-trading 只生产 Kafka 消息，不消费任何消息。

#### 缺失的消费者

| Topic | 来源 | 用途 | 状态 |
|-------|------|------|------|
| `trade-results` | eidos-matching | 处理撮合成交结果 | ❌ 未消费 |
| `order-cancelled` | eidos-matching | 确认订单取消 | ❌ 未消费 |
| `settlement-confirmed` | eidos-chain | 更新结算状态 | ❌ 未消费 |
| `withdrawal-confirmed` | eidos-chain | 更新提现状态 | ❌ 未消费 |
| `deposits` | eidos-chain | 处理充值到账 | ❌ 未消费 |

#### 修复方案

```go
// eidos-trading/internal/kafka/consumer.go

type Consumer struct {
    reader           *kafka.Reader
    clearingService  *service.ClearingService
    withdrawalService *service.WithdrawalService
    depositService   *service.DepositService
}

func (c *Consumer) Start(ctx context.Context) error {
    for {
        msg, err := c.reader.ReadMessage(ctx)
        if err != nil {
            return err
        }

        switch msg.Topic {
        case TopicTradeResults:
            c.handleTradeResult(ctx, msg)
        case TopicOrderCancelled:
            c.handleOrderCancelled(ctx, msg)
        case TopicSettlementConfirmed:
            c.handleSettlementConfirmed(ctx, msg)
        case TopicWithdrawalConfirmed:
            c.handleWithdrawalConfirmed(ctx, msg)
        case TopicDeposits:
            c.handleDeposit(ctx, msg)
        }
    }
}
```

#### 工作量估算

| 任务 | 工时 |
|------|------|
| 实现 Consumer 框架 | 1h |
| 实现各 handler | 3h |
| 单元测试 | 1h |
| 集成测试 | 1h |
| **合计** | **6h** |

---

### 3.5 eidos-trading Kafka 生产缺失

**问题 ID**: P0-005
**严重级别**: 🔴 Critical
**影响范围**: WebSocket 推送、风控监控无法工作

#### 问题描述

eidos-trading 缺少关键事件的 Kafka 生产。

#### 缺失的生产者

| Topic | 消费者 | 用途 | 状态 |
|-------|--------|------|------|
| `order-updates` | eidos-api, eidos-risk | 订单状态变更 | ❌ 未生产 |
| `balance-updates` | eidos-api, eidos-risk | 余额变更 | ❌ 未生产 |
| `withdrawals` | eidos-chain, eidos-risk | 提现请求 | ❌ 未生产 |

#### 修复方案

在相关 Service 中添加 Kafka 发送逻辑：

```go
// eidos-trading/internal/service/order_service.go

func (s *OrderService) UpdateOrderStatus(ctx context.Context, orderID string, status int) error {
    // ... 更新数据库 ...

    // 新增：发送订单更新消息
    s.kafkaProducer.SendOrderUpdate(ctx, &OrderUpdateMsg{
        OrderID:   orderID,
        Status:    status,
        UpdatedAt: time.Now().UnixMilli(),
    })

    return nil
}
```

#### 工作量估算

| 任务 | 工时 |
|------|------|
| 实现 order-updates 生产 | 1h |
| 实现 balance-updates 生产 | 1h |
| 实现 withdrawals 生产 | 0.5h |
| 测试验证 | 0.5h |
| **合计** | **3h** |

---

### 3.6 eidos-api Risk 客户端缺失

**问题 ID**: P0-006
**严重级别**: 🟠 High
**影响范围**: API 网关无法进行风控前置检查

#### 问题描述

eidos-api 配置文件中有 risk 服务地址，但未实现客户端。

#### 代码证据

```yaml
# eidos-api/config/config.yaml
grpc_clients:
  trading: localhost:50051
  market: localhost:50053
  risk: localhost:50055  # 配置存在
```

```
eidos-api/internal/client/
├── trading_client.go  ✅
├── market_client.go   ✅
└── risk_client.go     ❌ 不存在
```

#### 修复方案

参考 trading_client.go 实现 risk_client.go。

#### 工作量估算

| 任务 | 工时 |
|------|------|
| 创建 risk_client.go | 1h |
| 修改 handler 调用 | 1h |
| 测试验证 | 0.5h |
| **合计** | **2.5h** |

---

### 3.7 eidos-jobs gRPC 客户端缺失

**问题 ID**: P0-007
**严重级别**: 🟠 High
**影响范围**: 对账、统计等定时任务无法执行

#### 问题描述

eidos-jobs 的 `client/` 目录为空，无法调用其他服务。

#### 代码证据

```go
// eidos-jobs/internal/jobs/reconciliation.go:281-307

func (p *MockReconciliationDataProvider) GetOffchainBalances(...) (..., error) {
    // TODO: 实际实现通过 gRPC 调用 trading 服务
    return make(map[string]map[string]decimal.Decimal), nil  // 返回空！
}

func (p *MockReconciliationDataProvider) GetOnchainBalances(...) (..., error) {
    // TODO: 实际实现通过 gRPC 调用 chain 服务
    return make(map[string]map[string]decimal.Decimal), nil  // 返回空！
}
```

#### 修复方案

```go
// eidos-jobs/internal/client/trading_client.go
// eidos-jobs/internal/client/chain_client.go
// eidos-jobs/internal/client/market_client.go

// 然后替换 MockReconciliationDataProvider 为真实实现
type GRPCReconciliationDataProvider struct {
    tradingClient *TradingClient
    chainClient   *ChainClient
}

func (p *GRPCReconciliationDataProvider) GetOffchainBalances(ctx context.Context, wallets []string) (map[string]map[string]decimal.Decimal, error) {
    return p.tradingClient.GetBalances(ctx, wallets)
}

func (p *GRPCReconciliationDataProvider) GetOnchainBalances(ctx context.Context, wallets []string) (map[string]map[string]decimal.Decimal, error) {
    return p.chainClient.GetOnchainBalances(ctx, wallets)
}
```

#### 工作量估算

| 任务 | 工时 |
|------|------|
| 创建 trading_client.go | 1h |
| 创建 chain_client.go | 1h |
| 创建 market_client.go | 0.5h |
| 替换 Mock 实现 | 1h |
| 测试验证 | 0.5h |
| **合计** | **4h** |

---

## 四、P1 问题 - 上线前必须完成

### 4.1 eidos-api WebSocket 推送缺失

**问题 ID**: P1-001
**严重级别**: 🟡 Medium
**影响范围**: 用户无法实时收到订单/余额更新

#### 问题描述

eidos-api 不消费 Kafka 消息，无法将更新推送到 WebSocket。

#### 缺失链路

```
eidos-trading → order-updates topic → ❌ eidos-api 不消费 → ❌ WebSocket 不推送
eidos-trading → balance-updates topic → ❌ eidos-api 不消费 → ❌ WebSocket 不推送
```

#### 修复方案

1. 在 eidos-api 中添加 Kafka Consumer
2. 实现 Kafka → WebSocket Hub 桥接
3. 实现私有频道身份验证

#### 工作量估算: 4h

---

### 4.2 eidos-chain Indexer 未实现

**问题 ID**: P1-002
**严重级别**: 🟡 Medium
**影响范围**: 无法监听链上充值事件

#### 问题描述

`eidos-chain/internal/indexer/` 目录存在但内容为空或仅有结构。

#### 修复方案

实现 EVM 事件监听器，监听 Deposit 事件并发送到 Kafka。

#### 工作量估算: 3h

---

### 4.3 私有频道身份验证缺失

**问题 ID**: P1-003
**严重级别**: 🟡 Medium
**影响范围**: 任何人可订阅他人的订单/余额更新

#### 当前状态

```
# 任何人都可以订阅
ws.subscribe("orders.0x1234...")  // 无身份验证
```

#### 修复方案

添加 EIP-712 签名验证后才能订阅私有频道。

#### 工作量估算: 2h

---

### 4.4 配置统一中心缺失

**问题 ID**: P1-004
**严重级别**: 🟡 Medium
**影响范围**: 配置不一致可能导致业务错误

#### 问题描述

各服务独立读取代币和市场配置，无统一下发机制。

#### 当前状态

```
eidos-trading: config/config.yaml → MarketConfig
eidos-market:  config/config.yaml → MarketConfig  // 可能不一致
eidos-chain:   config/config.yaml → TokenConfig   // 可能不一致
```

#### 修复方案

1. 使用 Nacos 作为配置中心
2. 所有服务从 Nacos 读取统一配置
3. 支持配置热更新

#### 工作量估算: 4h

---

### 4.5 清算与成交逻辑重叠

**问题 ID**: P1-005
**严重级别**: 🟡 Medium
**影响范围**: 代码维护困难，潜在 bug 风险

#### 问题描述

| 服务 | 方法 | 状态 |
|------|------|------|
| ClearingService | ProcessTradeResult() | ✅ 被调用 |
| TradeService | CreateSettlementBatch() | ❌ 从未被调用 |

#### 修复方案

1. 明确职责边界
2. 删除死代码或整合逻辑

#### 工作量估算: 2h

---

### 4.6 eidos-risk 消费依赖缺失

**问题 ID**: P1-006
**严重级别**: 🟡 Medium
**影响范围**: 风控监控无法实时生效

#### 问题描述

eidos-risk 需要消费 `order-updates`, `balance-updates`, `withdrawals`，但 eidos-trading 未生产这些消息。

#### 依赖关系

```
eidos-risk 消费:
  - order-updates    ← 依赖 eidos-trading 发送 (P0-005)
  - balance-updates  ← 依赖 eidos-trading 发送 (P0-005)
  - withdrawals      ← 依赖 eidos-trading 发送 (P0-005)
```

**解决**: 修复 P0-005 后自动解决。

---

## 五、P2 问题 - 优化项

### 5.1 Proto 版本不统一

**问题 ID**: P2-001
**影响**: 可能存在字段不一致

#### 修复建议

统一 proto 版本，使用 buf 管理。

---

### 5.2 缺少集成测试

**问题 ID**: P2-002
**影响**: 无法验证端到端流程

#### 修复建议

编写核心流程的集成测试用例。

---

### 5.3 监控指标不完整

**问题 ID**: P2-003
**影响**: 无法及时发现系统问题

#### 修复建议

补充 Prometheus 指标和 Grafana 仪表盘。

---

### 5.4 错误处理不统一

**问题 ID**: P2-004
**影响**: 调试困难

#### 修复建议

使用 eidos-common/pkg/errors 统一错误定义。

---

### 5.5 日志格式不统一

**问题 ID**: P2-005
**影响**: 日志分析困难

#### 修复建议

统一使用结构化日志格式。

---

## 六、修复优先级和排期建议

### 6.1 第一阶段：打通核心链路（Day 1-2）

| 任务 | 问题 ID | 工时 | 负责人 |
|------|---------|------|--------|
| gRPC 服务注册 | P0-003 | 2h | |
| trading Kafka 生产 | P0-005 | 3h | |
| trading Kafka 消费 | P0-004 | 6h | |
| **小计** | | **11h** | |

### 6.2 第二阶段：完善风控链路（Day 2-3）

| 任务 | 问题 ID | 工时 | 负责人 |
|------|---------|------|--------|
| trading risk_client | P0-002 | 4h | |
| api risk_client | P0-006 | 2.5h | |
| **小计** | | **6.5h** | |

### 6.3 第三阶段：打通结算链路（Day 3-4）

| 任务 | 问题 ID | 工时 | 负责人 |
|------|---------|------|--------|
| settlements 消息发送 | P0-001 | 5h | |
| chain indexer | P1-002 | 3h | |
| **小计** | | **8h** | |

### 6.4 第四阶段：完善推送和对账（Day 4-5）

| 任务 | 问题 ID | 工时 | 负责人 |
|------|---------|------|--------|
| jobs gRPC 客户端 | P0-007 | 4h | |
| api WebSocket 推送 | P1-001 | 4h | |
| **小计** | | **8h** | |

### 6.5 总计

| 阶段 | 工时 |
|------|------|
| 第一阶段 | 11h |
| 第二阶段 | 6.5h |
| 第三阶段 | 8h |
| 第四阶段 | 8h |
| **总计** | **33.5h** |

---

## 七、Kafka Topic 对接状态矩阵

| Topic | 生产者 | 消费者 | 生产状态 | 消费状态 | 备注 |
|-------|--------|--------|---------|---------|------|
| `orders` | trading | matching | ✅ | ✅ | 正常 |
| `cancel-requests` | trading | matching | ✅ | ✅ | 正常 |
| `trade-results` | matching | trading, market, risk | ✅ | ⚠️ | trading 未消费 |
| `order-cancelled` | matching | trading | ✅ | ❌ | trading 未消费 |
| `orderbook-updates` | matching | market | ✅ | ✅ | 正常 |
| `order-updates` | trading | api, risk | ❌ | - | trading 未生产 |
| `balance-updates` | trading | api, risk | ❌ | - | trading 未生产 |
| `deposits` | chain | trading | ✅ | ❌ | trading 未消费 |
| `withdrawals` | trading | chain, risk | ❌ | ✅ | trading 未生产 |
| `settlements` | trading | chain | ❌ | ✅ | trading 未生产 |
| `settlement-confirmed` | chain | trading | ✅ | ❌ | trading 未消费 |
| `withdrawal-confirmed` | chain | trading | ✅ | ❌ | trading 未消费 |
| `kline-1m` | market | - | ✅ | - | 正常 |
| `risk-alerts` | risk | - | ✅ | - | 正常 |

---

## 八、gRPC 服务对接状态矩阵

| 调用方 | 被调用方 | 端口 | 客户端状态 | 服务端状态 |
|--------|---------|------|-----------|-----------|
| api | trading | 50051 | ✅ 完整 | ❌ 未注册 |
| api | market | 50053 | ✅ 完整 | ❌ 无 gRPC |
| api | risk | 50055 | ❌ 缺失 | ✅ 已注册 |
| trading | matching | 50052 | ✅ 完整 | ❌ 未注册 |
| trading | risk | 50055 | ❌ 缺失 | ✅ 已注册 |
| market | matching | 50052 | ✅ 完整 | ❌ 未注册 |
| jobs | trading | 50051 | ❌ 缺失 | ❌ 未注册 |
| jobs | chain | 50054 | ❌ 缺失 | ❌ 未注册 |
| jobs | market | 50053 | ❌ 缺失 | ❌ 无 gRPC |

---

## 九、验收检查清单

### 9.1 P0 修复验收

- [ ] eidos-trading gRPC 服务可被 eidos-api 调用
- [ ] eidos-matching gRPC 服务可被 eidos-trading 调用
- [ ] eidos-chain gRPC 服务可被 eidos-jobs 调用
- [ ] eidos-trading 能消费 trade-results 并更新订单状态
- [ ] eidos-trading 能消费 settlement-confirmed 并更新结算状态
- [ ] eidos-trading 能生产 order-updates 消息
- [ ] eidos-trading 能生产 balance-updates 消息
- [ ] eidos-trading 能生产 settlements 消息
- [ ] eidos-trading 能调用 eidos-risk.CheckOrder()
- [ ] eidos-api 能调用 eidos-risk.CheckOrder()
- [ ] eidos-jobs 对账任务能获取真实数据

### 9.2 P1 修复验收

- [ ] eidos-api WebSocket 能推送 order-updates
- [ ] eidos-api WebSocket 能推送 balance-updates
- [ ] eidos-chain indexer 能监听充值事件
- [ ] WebSocket 私有频道需要身份验证

### 9.3 端到端流程验收

- [ ] 下单 → 撮合 → 成交 → 结算 → 链上确认 全流程
- [ ] 充值 → 余额更新 → WebSocket 推送 全流程
- [ ] 提现 → 风控检查 → 链上执行 → 确认 全流程
- [ ] 对账任务能检测链上链下差异

---

## 附录 A：问题索引

| 问题 ID | 标题 | 优先级 | 工时 |
|---------|------|--------|------|
| P0-001 | Trading → Chain 结算链路断层 | 🔴 | 5h |
| P0-002 | Trading → Risk 同步风控断层 | 🔴 | 4h |
| P0-003 | gRPC 服务注册缺失 | 🔴 | 2h |
| P0-004 | eidos-trading Kafka 消费缺失 | 🔴 | 6h |
| P0-005 | eidos-trading Kafka 生产缺失 | 🔴 | 3h |
| P0-006 | eidos-api Risk 客户端缺失 | 🟠 | 2.5h |
| P0-007 | eidos-jobs gRPC 客户端缺失 | 🟠 | 4h |
| P1-001 | eidos-api WebSocket 推送缺失 | 🟡 | 4h |
| P1-002 | eidos-chain Indexer 未实现 | 🟡 | 3h |
| P1-003 | 私有频道身份验证缺失 | 🟡 | 2h |
| P1-004 | 配置统一中心缺失 | 🟡 | 4h |
| P1-005 | 清算与成交逻辑重叠 | 🟡 | 2h |
| P1-006 | eidos-risk 消费依赖缺失 | 🟡 | - |
| P2-001 | Proto 版本不统一 | ⚪ | 2h |
| P2-002 | 缺少集成测试 | ⚪ | 8h |
| P2-003 | 监控指标不完整 | ⚪ | 4h |
| P2-004 | 错误处理不统一 | ⚪ | 3h |
| P2-005 | 日志格式不统一 | ⚪ | 2h |

---

> **维护说明**: 本文档应随修复进度持续更新，每完成一项修复后及时标记状态。
> **更新记录**:
> - 2025-01-18: 初始版本，完成全面审计
