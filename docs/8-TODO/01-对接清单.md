# Eidos 对接清单 (TODO)

> **文档目的**: 记录各服务之间的对接任务、集成测试项和上线前检查项
> **更新时间**: 2025-01-17

---

## 一、服务实现状态

| 服务 | 状态 | 说明 |
|------|------|------|
| eidos-common | ✅ 完成 | 公共库（nacos, grpc, kafka, redis, postgres, crypto, logger 等） |
| eidos-trading | ✅ 完成 | 交易服务（订单、清算、账户、余额管理） |
| eidos-matching | ✅ 完成 | 撮合引擎（内存订单簿、价格时间优先匹配） |
| eidos-market | ✅ 完成 | 行情服务（K线、深度、Ticker、成交数据） |
| eidos-chain | ✅ 完成 | 链上服务（结算、索引、充提处理） |
| eidos-risk | ✅ 完成 | 风控服务（前置检查、后置监控、规则引擎） |
| eidos-jobs | ✅ 完成 | 定时任务（对账、归档、统计、健康检查） |
| eidos-admin | ✅ 完成 | 管理后台（交易对配置、系统配置、审计日志） |
| eidos-api | ⚠️ 基础完成 | REST + WebSocket 网关（需完善 WebSocket 推送） |

---

## 二、Kafka 消息对接

### 2.1 生产者-消费者关系

| Topic | 生产者 | 消费者 | 状态 | 备注 |
|-------|--------|--------|------|------|
| `orders` | eidos-trading | eidos-matching | ⏳ 待测试 | 订单提交到撮合 |
| `cancel-requests` | eidos-trading | eidos-matching | ⏳ 待测试 | 取消请求 |
| `trade-results` | eidos-matching | eidos-trading, eidos-market, eidos-risk | ⏳ 待测试 | 撮合结果广播 |
| `order-updates` | eidos-trading | eidos-api | ⏳ 待测试 | 订单状态变更推送 |
| `order-cancelled` | eidos-matching | eidos-trading | ⏳ 待测试 | 撮合确认取消 |
| `orderbook-updates` | eidos-matching | eidos-market | ⏳ 待测试 | 订单簿增量更新 |
| `balance-updates` | eidos-trading | eidos-api | ⏳ 待测试 | 余额变更推送 |
| `deposits` | eidos-chain | eidos-trading | ⏳ 待测试 | 充值确认 |
| `withdrawals` | eidos-trading | eidos-chain | ⏳ 待测试 | 提现请求 |
| `settlements` | eidos-chain | - | ⏳ 待测试 | 结算批次 |
| `settlement-confirmed` | eidos-chain | eidos-trading | ⏳ 待测试 | 结算确认 |
| `kline-1m` | eidos-market | - | ⏳ 待测试 | K线数据 |
| `risk-alerts` | eidos-risk | - | ⏳ 待测试 | 风控告警 |

### 2.2 消息格式验证

- [ ] 验证所有 Protobuf 消息定义一致性
- [ ] 验证 Partition Key 正确使用
- [ ] 验证幂等键设计

---

## 三、gRPC 服务对接

### 3.1 服务调用关系

```
eidos-api (HTTP Gateway)
    ├── eidos-trading:50051  (订单/余额/账户)
    ├── eidos-market:50053   (行情数据)
    └── eidos-risk:50055     (风控查询)

eidos-trading
    ├── eidos-risk:50055     (前置风控检查)
    └── eidos-matching:50052 (撮合状态查询)

eidos-jobs
    ├── eidos-trading:50051  (对账任务)
    ├── eidos-chain:50054    (结算状态)
    └── eidos-market:50053   (统计任务)
```

### 3.2 Proto 文件对接清单

| Proto | 状态 | 位置 |
|-------|------|------|
| trading.proto | ⏳ 待验证 | proto/trading/v1/ |
| matching.proto | ⏳ 待验证 | proto/matching/v1/ |
| market.proto | ⏳ 待验证 | proto/market/v1/ |
| chain.proto | ⏳ 待验证 | proto/chain/v1/ |
| risk.proto | ⏳ 待验证 | proto/risk/v1/ |

### 3.3 gRPC 对接任务

- [ ] 统一 proto 版本和代码生成
- [ ] 验证服务发现（Nacos）注册正确
- [ ] 测试 gRPC 健康检查
- [ ] 测试 gRPC 超时和重试策略

---

## 四、数据库对接

### 4.1 数据库清单

| 数据库 | 服务 | 状态 | 主要表 |
|--------|------|------|--------|
| eidos_trading | eidos-trading | ✅ 迁移完成 | orders, trades, balances, nonces, deposits, withdrawals |
| eidos_market | eidos-market | ✅ 迁移完成 | klines, tickers (TimescaleDB) |
| eidos_chain | eidos-chain | ✅ 迁移完成 | settlement_batches, chain_events, reconciliation_records |
| eidos_risk | eidos-risk | ✅ 迁移完成 | risk_rules, risk_events, blacklist |
| eidos_admin | eidos-admin | ✅ 迁移完成 | admins, market_configs, system_configs, audit_logs |

### 4.2 数据库对接任务

- [ ] 验证所有外键约束
- [ ] 验证索引设计
- [ ] 测试数据库连接池配置
- [ ] 测试读写分离（如适用）

---

## 五、Redis 对接

### 5.1 缓存 Key 设计

| Key Pattern | 服务 | 用途 |
|-------------|------|------|
| `eidos:order:{order_id}` | eidos-trading | 订单缓存 |
| `eidos:balance:{wallet}:{token}` | eidos-trading | 余额缓存 |
| `eidos:nonce:{wallet}` | eidos-trading | Nonce 计数器 |
| `eidos:ticker:{market}` | eidos-market | Ticker 缓存 |
| `eidos:depth:{market}` | eidos-market | 深度快照 |
| `eidos:kline:{market}:{interval}` | eidos-market | K线缓存 |
| `eidos:risk:blacklist` | eidos-risk | 黑名单 |
| `eidos:risk:limit:{wallet}` | eidos-risk | 限额状态 |
| `eidos:admin:session:{token}` | eidos-admin | 会话缓存 |

### 5.2 Pub/Sub 频道

| 频道 | 发布者 | 订阅者 | 用途 |
|------|--------|--------|------|
| `eidos:ticker:{market}` | eidos-market | eidos-api | Ticker 推送 |
| `eidos:depth:{market}` | eidos-market | eidos-api | 深度推送 |
| `eidos:trades:{market}` | eidos-market | eidos-api | 成交推送 |
| `eidos:order:{wallet}` | eidos-trading | eidos-api | 订单状态推送 |
| `eidos:balance:{wallet}` | eidos-trading | eidos-api | 余额变更推送 |

### 5.3 Redis 对接任务

- [ ] 验证 Redis Cluster 配置
- [ ] 测试 Pub/Sub 消息传递
- [ ] 验证缓存过期策略
- [ ] 测试 Redis 连接断开重连

---

## 六、WebSocket 对接

### 6.1 公共频道

| 频道 | 数据源 | 状态 |
|------|--------|------|
| `ticker.{market}` | eidos-market | ⏳ 待测试 |
| `depth.{market}.{level}` | eidos-market | ⏳ 待测试 |
| `kline.{market}.{interval}` | eidos-market | ⏳ 待测试 |
| `trades.{market}` | eidos-market | ⏳ 待测试 |

### 6.2 私有频道

| 频道 | 数据源 | 状态 |
|------|--------|------|
| `orders.{wallet}` | eidos-trading | ⏳ 待实现 |
| `balances.{wallet}` | eidos-trading | ⏳ 待实现 |

### 6.3 WebSocket 对接任务

- [ ] 实现 eidos-api WebSocket Hub
- [ ] 实现 Redis Pub/Sub 到 WebSocket 桥接
- [ ] 实现私有频道鉴权
- [ ] 测试 WebSocket 心跳机制
- [ ] 测试 WebSocket 断线重连

---

## 七、EIP-712 签名对接

### 7.1 签名验证流程

```
前端 (MetaMask/WalletConnect)
    │
    ▼ EIP-712 签名
后端 (eidos-api)
    │
    ▼ ecrecover 验签
eidos-trading
    │
    ▼ Nonce 检查 + 业务处理
```

### 7.2 签名类型

| 操作 | TypeHash | 服务 | 状态 |
|------|----------|------|------|
| 创建订单 | `Order(...)` | eidos-trading | ⏳ 待测试 |
| 取消订单 | `Cancel(...)` | eidos-trading | ⏳ 待测试 |
| 提现 | `Withdraw(...)` | eidos-trading | ⏳ 待测试 |

### 7.3 EIP-712 对接任务

- [ ] 验证 Domain 配置一致性
- [ ] 测试各种签名类型验证
- [ ] 测试 Nonce 防重放机制
- [ ] 测试签名过期检查

---

## 八、集成测试清单

### 8.1 核心流程测试

| 测试场景 | 涉及服务 | 状态 |
|----------|----------|------|
| 下单 → 撮合 → 成交 | api → trading → matching → trading → api | ⏳ 待测试 |
| 取消订单 | api → trading → matching → trading | ⏳ 待测试 |
| 充值确认 | chain → trading | ⏳ 待测试 |
| 提现流程 | api → trading → chain | ⏳ 待测试 |
| 结算流程 | trading → chain → trading | ⏳ 待测试 |
| 风控拦截 | api → trading → risk (拦截) | ⏳ 待测试 |

### 8.2 边界条件测试

- [ ] 订单金额边界值
- [ ] 余额不足场景
- [ ] 并发下单场景
- [ ] 撮合引擎重启恢复
- [ ] 网络分区场景
- [ ] 数据库主从切换

### 8.3 性能测试

- [ ] 单市场 TPS 测试
- [ ] 多市场并发测试
- [ ] WebSocket 连接数压测
- [ ] 数据库连接池压测

---

## 九、上线前检查清单

### 9.1 配置检查

- [ ] 所有服务 chainId 配置一致
- [ ] EIP-712 Domain 配置正确
- [ ] Kafka Topic 已创建
- [ ] 数据库迁移已执行
- [ ] Redis 连接配置正确
- [ ] Nacos 服务注册正确

### 9.2 安全检查

- [ ] JWT 密钥已更新
- [ ] 管理后台默认密码已修改
- [ ] 数据库密码强度检查
- [ ] API 限流配置
- [ ] CORS 配置正确

### 9.3 监控检查

- [ ] Prometheus 指标暴露
- [ ] Grafana 仪表盘配置
- [ ] 日志收集配置
- [ ] 告警规则配置

### 9.4 灾备检查

- [ ] 数据库备份策略
- [ ] Redis 持久化配置
- [ ] 服务健康检查配置
- [ ] 自动扩缩容策略

---

## 十、优先级排序

### P0 - 核心流程 (阻塞上线)

1. Kafka 消息生产/消费测试
2. gRPC 服务间调用测试
3. 下单-撮合-成交 全流程测试
4. EIP-712 签名验证测试

### P1 - 重要功能 (需上线前完成)

1. WebSocket 推送实现
2. 充提流程测试
3. 风控拦截测试
4. 管理后台功能验收

### P2 - 优化项 (可上线后完善)

1. 性能优化
2. 监控完善
3. 文档补充
4. 自动化测试覆盖

---

## 附录：联调步骤

### A. 本地开发环境启动顺序

```bash
# 1. 基础设施
docker-compose up -d postgres redis kafka nacos

# 2. 执行数据库迁移
for svc in trading market chain risk admin; do
    cd eidos-$svc && make migrate-up && cd ..
done

# 3. 启动核心服务
make -C eidos-trading run &
make -C eidos-matching run &
make -C eidos-market run &

# 4. 启动支撑服务
make -C eidos-chain run &
make -C eidos-risk run &
make -C eidos-jobs run &
make -C eidos-admin run &

# 5. 启动网关
make -C eidos-api run &
```

### B. 服务健康检查

```bash
# 检查所有服务健康状态
curl http://localhost:8080/health/ready  # eidos-api
curl http://localhost:8088/health/ready  # eidos-admin

# 检查 gRPC 服务
grpcurl -plaintext localhost:50051 grpc.health.v1.Health/Check
grpcurl -plaintext localhost:50052 grpc.health.v1.Health/Check
grpcurl -plaintext localhost:50053 grpc.health.v1.Health/Check
```

### C. 日志查看

```bash
# 查看服务日志
tail -f logs/eidos-trading.log
tail -f logs/eidos-matching.log
tail -f logs/eidos-api.log
```

---

> **维护说明**: 本文档应随开发进度持续更新，每完成一项对接任务后及时标记状态。
