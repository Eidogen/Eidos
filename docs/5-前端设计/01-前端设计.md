# Eidos 前端设计

> 设计原则: 前端轻量化，业务逻辑后置

---

## 一、设计原则

### 1.1 核心理念

**"薄前端，厚后端"** - 前端只负责展示和交互，所有业务逻辑、数据处理、校验都在后端完成。

```
┌─────────────────────────────────────────────────────────────────────┐
│                         前端职责边界                                  │
├─────────────────────────────────────────────────────────────────────┤
│  ✅ 前端负责:                    │  ❌ 前端不负责:                    │
│  - UI 渲染和交互                 │  - 业务逻辑计算                    │
│  - 用户输入收集                  │  - 数据校验 (后端二次校验)         │
│  - 钱包连接/签名                 │  - 价格计算/手续费计算             │
│  - 数据展示和格式化              │  - 订单状态判断                    │
│  - WebSocket 消息订阅            │  - K线聚合/指标计算                │
│  - 本地状态管理 (UI状态)         │  - 持仓盈亏计算                    │
│  - 路由和页面切换                │  - 风控规则判断                    │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

| 项目 | 技术栈 | 说明 |
|------|--------|------|
| **交易前端** | React + TypeScript | 主流选择，生态完善 |
| **运营后台** | React + Ant Design Pro | 快速开发，组件丰富 |
| **客户端状态** | Zustand | 轻量级，管理 UI 状态 (主题/侧边栏/表单) |
| **服务端状态** | React Query | 管理 API 数据 (订单/余额/行情缓存) |
| **WebSocket** | 原生封装 | 自动重连、心跳检测 |
| **图表** | TradingView | 专业K线图表 |
| **钱包连接** | wagmi + viem | EVM 钱包标准方案 |
| **构建工具** | Vite | 快速构建 |

---

## 二、交易前端 (Trading Web)

### 2.1 页面结构

```
eidos-web/
├── src/
│   ├── pages/
│   │   ├── Trade/              # 交易页面 (核心)
│   │   ├── Markets/            # 市场列表
│   │   ├── Portfolio/          # 资产/持仓
│   │   └── History/            # 历史记录
│   ├── components/
│   │   ├── Chart/              # TradingView 图表
│   │   ├── OrderBook/          # 订单簿
│   │   ├── TradeForm/          # 下单表单
│   │   ├── Positions/          # 持仓列表
│   │   ├── Orders/             # 订单列表
│   │   └── Wallet/             # 钱包组件
│   ├── hooks/
│   │   ├── useWebSocket.ts     # WebSocket 连接
│   │   ├── useWallet.ts        # 钱包操作
│   │   └── useMarket.ts        # 市场数据
│   ├── services/
│   │   └── api.ts              # REST API 封装
│   ├── stores/
│   │   ├── marketStore.ts      # 行情状态
│   │   └── userStore.ts        # 用户状态
│   └── utils/
│       ├── format.ts           # 格式化工具
│       └── signature.ts        # EIP-712 签名
```

### 2.2 核心页面设计

#### 2.2.1 交易页面布局

```
┌──────────────────────────────────────────────────────────────────────────┐
│  Header: Logo | Markets Dropdown | Wallet Connect                        │
├────────────────────────┬─────────────────────┬───────────────────────────┤
│                        │                     │                           │
│                        │     Order Book      │      Trade Form           │
│     TradingView        │     (买卖盘)         │      (下单区)              │
│     Chart              │                     │                           │
│     (K线图)            │─────────────────────│  [买入] [卖出]             │
│                        │                     │  价格: ______             │
│                        │   Recent Trades     │  数量: ______             │
│                        │   (最新成交)         │  [确认下单]               │
├────────────────────────┴─────────────────────┴───────────────────────────┤
│  Tabs: [当前订单] [持仓] [历史订单] [成交记录]                              │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │  订单/持仓列表                                                       │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 数据流转

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           交易页面数据流                                      │
│                                                                              │
│  ┌──────────────┐      REST API        ┌──────────────┐                     │
│  │   页面加载    │ ─────────────────────▶│   后端API    │                     │
│  └──────────────┘   GET /markets/:id    └──────────────┘                     │
│         │                                      │                             │
│         │  初始数据: ticker, orderbook         │                             │
│         ◀──────────────────────────────────────┘                             │
│         │                                                                    │
│         ▼                                                                    │
│  ┌──────────────┐      WebSocket        ┌──────────────┐                     │
│  │   建立连接    │ ─────────────────────▶│   WS Server  │                     │
│  └──────────────┘   subscribe channels  └──────────────┘                     │
│         │                                      │                             │
│         │  实时推送: ticker, depth, trades     │                             │
│         ◀──────────────────────────────────────┘                             │
│         │                                                                    │
│         ▼                                                                    │
│  ┌──────────────┐                                                            │
│  │   状态更新    │ ──▶ Zustand Store ──▶ UI 组件重渲染                        │
│  └──────────────┘                                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 WebSocket 订阅

#### 2.3.1 频道设计

| 频道 | 格式 | 说明 |
|------|------|------|
| ticker | `ticker.{market}` | 实时行情 |
| depth | `depth.{market}.{level}` | 订单簿深度 |
| trades | `trades.{market}` | 最新成交 |

#### 2.3.2 消息处理流程

```
WebSocket 消息 ──▶ 消息解析 ──▶ 按类型分发 ──▶ 更新 Store ──▶ UI 响应
                      │
                      ├── ticker ──▶ marketStore.updateTicker()
                      ├── depth ──▶ marketStore.updateOrderBook()
                      ├── trades ──▶ marketStore.addTrade()
                      └── kline  ──▶ marketStore.updateKline()
```

### 2.4 钱包集成

#### 2.4.1 支持的钱包

- MetaMask
- WalletConnect
- Coinbase Wallet
- OKX Wallet

#### 2.4.2 签名流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           下单签名流程                                        │
│                                                                              │
│  1. 用户填写订单  ──▶  2. 构造订单数据  ──▶  3. 请求后端预处理                  │
│                                                    │                         │
│                                                    ▼                         │
│                              ┌─────────────────────────────────────┐         │
│                              │  POST /orders/prepare               │         │
│                              │  Request: {market, side, type,      │         │
│                              │           price, quantity}          │         │
│                              │  Response: {nonce, deadline,        │         │
│                              │            eip712_data}             │         │
│                              └─────────────────────────────────────┘         │
│                                                    │                         │
│                                                    ▼                         │
│  4. 弹出钱包签名  ◀──  EIP-712 TypedData  ◀──  组装签名数据                   │
│         │                                                                    │
│         ▼                                                                    │
│  5. 用户确认签名  ──▶  6. 提交订单到后端  ──▶  7. 显示结果                     │
│                              │                                               │
│                              ▼                                               │
│                       POST /orders                                           │
│                       {order_data, signature}                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.5 TradingView 集成

#### 2.5.1 数据源接口

前端需实现 TradingView Datafeed 接口，对接后端 API：

| 接口 | 对应后端 API | 说明 |
|------|-------------|------|
| `resolveSymbol` | GET /markets/:id | 获取交易对信息 |
| `getBars` | GET /klines | 获取K线数据 |
| `subscribeBars` | WebSocket kline channel | 实时K线订阅 |
| `unsubscribeBars` | WebSocket unsubscribe | 取消订阅 |

#### 2.5.2 配置要点

```typescript
// TradingView 配置
const config = {
  supported_resolutions: ['1', '5', '15', '30', '60', '240', '1D', '1W'],
  exchanges: [{ value: 'Eidos', name: 'Eidos Exchange' }],
  symbols_types: [{ name: 'Spot', value: 'spot' }],
};
```

### 2.6 状态管理

#### 2.6.1 Store 划分

```typescript
// marketStore - 行情数据 (公共)
interface MarketStore {
  currentMarket: string;
  ticker: Record<string, Ticker>;
  orderBook: OrderBook;
  recentTrades: Trade[];
}

// userStore - 用户数据 (私有)
interface UserStore {
  wallet: string | null;
  balances: Record<string, Balance>;
  orders: Order[];
  positions: Position[];
}
```

#### 2.6.2 数据更新策略

| 数据类型 | 初始加载 | 更新方式 |
|---------|---------|---------|
| 市场列表 | REST API | 低频轮询 (5min) |
| Ticker | REST API | WebSocket 推送 |
| OrderBook | REST API | WebSocket 增量更新 |
| 用户余额 | REST API (连接钱包后) | 下单/撤单/充提后刷新 + 低频轮询 |
| 用户订单 | REST API | 下单/撤单后刷新 + 低频轮询 |

---

## 三、运营后台 (Admin Panel)

### 3.1 页面结构

```
eidos-admin-web/
├── src/
│   ├── pages/
│   │   ├── Dashboard/          # 数据看板
│   │   ├── Markets/            # 交易对管理
│   │   ├── Users/              # 用户管理
│   │   ├── Orders/             # 订单查询
│   │   ├── Finance/            # 财务管理
│   │   ├── System/             # 系统配置
│   │   └── Logs/               # 操作日志
│   ├── components/
│   │   └── ...                 # Ant Design Pro 组件
│   ├── services/
│   │   └── adminApi.ts         # 后台 API
│   └── access.ts               # 权限配置
```

### 3.2 功能模块

#### 3.2.1 数据看板

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Dashboard                                       │
├─────────────┬─────────────┬─────────────┬─────────────────────────────────── │
│  24h 交易量  │  24h 交易额  │  活跃用户    │  待处理提现                        │
│  125,432    │  $2.5M      │  3,421      │  23                               │
├─────────────┴─────────────┴─────────────┴───────────────────────────────────┤
│                                                                              │
│  [交易量趋势图 - 7天]                    [交易对排行]                          │
│                                                                              │
│  [充提统计]                              [最新订单]                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 核心功能列表

| 模块 | 功能 | 说明 |
|------|------|------|
| **交易对管理** | 列表/添加/编辑/上下架 | 管理交易市场 |
| **用户管理** | 查询/详情/操作记录 | 按钱包地址查询 |
| **订单查询** | 列表/详情/筛选 | 全量订单查询 |
| **财务管理** | 充提记录/手动处理 | 充值提现审核 |
| **系统配置** | 参数配置/开关控制 | 运营参数管理 |
| **操作日志** | 审计日志查询 | 后台操作记录 |

### 3.3 权限设计

#### 3.3.1 角色定义

| 角色 | 权限范围 |
|------|---------|
| **super_admin** | 全部权限 |
| **admin** | 除系统配置外的所有功能 |
| **operator** | 查询 + 基础操作 |
| **viewer** | 仅查询权限 |

#### 3.3.2 权限控制流程

```
页面加载 ──▶ 获取用户角色 ──▶ 匹配权限配置 ──▶ 渲染可见菜单/按钮
                │
                ▼
         后端 JWT 解析 ──▶ 返回 role + permissions
```

### 3.4 与后端 API 对接

运营后台所有功能都通过 eidos-admin 服务 API 实现：

| 前端功能 | 后端 API | 方法 |
|---------|---------|------|
| 登录 | /admin/login | POST |
| 获取用户信息 | /admin/profile | GET |
| 市场列表 | /admin/markets | GET |
| 创建市场 | /admin/markets | POST |
| 更新市场 | /admin/markets/:id | PUT |
| 订单列表 | /admin/orders | GET |
| 用户查询 | /admin/users | GET |
| 充值记录 | /admin/deposits | GET |
| 提现记录 | /admin/withdrawals | GET |
| 审核提现 | /admin/withdrawals/:id/approve | POST |
| 系统配置 | /admin/configs | GET/PUT |
| 操作日志 | /admin/audit-logs | GET |

---

## 四、公共组件

### 4.1 WebSocket 客户端

```typescript
// 核心功能
class WebSocketClient {
  // 自动重连 (指数退避)
  // 心跳检测 (30s)
  // 消息队列 (断线缓存)
  // 订阅管理
}

// 使用方式
const ws = useWebSocket();
ws.subscribe('ticker.BTC-USDC');
ws.on('ticker', (data) => updateTicker(data));
```

### 4.2 钱包连接

```typescript
// 核心功能
const useWallet = () => {
  // 连接钱包
  // 断开连接
  // 签名消息 (EIP-712)
  // 监听账户变化
  // 监听链变化
};
```

### 4.3 格式化工具

```typescript
// 数值格式化
formatPrice(price: string, decimals: number): string
formatQuantity(qty: string, decimals: number): string
formatPercent(value: number): string

// 时间格式化
formatTime(timestamp: number): string
formatDate(timestamp: number): string
```

---

## 五、与后端服务对接

### 5.1 API 调用关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                              前端应用                                        │
│                                                                              │
│     ┌─────────────────┐              ┌─────────────────┐                    │
│     │   交易前端       │              │   运营后台       │                    │
│     └────────┬────────┘              └────────┬────────┘                    │
│              │                                │                              │
└──────────────┼────────────────────────────────┼──────────────────────────────┘
               │                                │
               ▼                                ▼
        ┌──────────────┐                 ┌──────────────┐
        │ eidos-api    │                 │ eidos-admin  │
        │ (REST + WS)  │                 │ (REST)       │
        └──────────────┘                 └──────────────┘
```

### 5.2 错误处理

后端返回统一错误格式，前端统一处理：

```typescript
// 后端错误响应
interface ErrorResponse {
  code: string;        // 错误码
  message: string;     // 错误信息
}

// 前端处理
const errorHandler = (error: ErrorResponse) => {
  switch (error.code) {
    case 'INVALID_SIGNATURE':
      toast.error('签名无效，请重新签名');
      break;
    case 'INSUFFICIENT_BALANCE':
      toast.error('余额不足');
      break;
    default:
      toast.error(error.message);
  }
};
```

### 5.3 请求认证

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              认证方式                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  交易前端 (参考: 3-开发规范/00-协议总表.md):                                 │
│  ┌──────────────────────────────────────────────────────────────┐           │
│  │  公开接口: 无需认证 (行情、市场信息)                            │           │
│  │  私有接口: 钱包签名认证                                        │           │
│  │            Header: Authorization: EIP712 {wallet}:{ts}:{sig}   │           │
│  └──────────────────────────────────────────────────────────────┘           │
│                                                                              │
│  运营后台:                                                                   │
│  ┌──────────────────────────────────────────────────────────────┐           │
│  │  所有接口: JWT 认证                                            │           │
│  │            Header: Authorization: Bearer {token}              │           │
│  └──────────────────────────────────────────────────────────────┘           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、部署架构

### 6.1 构建产物

```
交易前端:
  - 静态文件 (HTML/JS/CSS)
  - 部署到 CDN / Nginx

运营后台:
  - 静态文件 (HTML/JS/CSS)
  - 部署到内网 Nginx (IP 白名单)
```

### 6.2 环境配置

```typescript
// 环境变量 (详见 3-开发规范/00-协议总表.md)
VITE_API_URL=https://api.eidos.exchange      // REST API
VITE_WS_URL=wss://api.eidos.exchange/ws      // WebSocket (同域名)
VITE_CHAIN_ID=42161                           // 链 ID (Arbitrum One)
```

---

## 七、开发规范

### 7.1 代码规范

- TypeScript 严格模式
- ESLint + Prettier
- 组件使用函数式 + Hooks
- 禁止 any 类型

### 7.2 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 组件 | PascalCase | `OrderBook.tsx` |
| Hook | camelCase + use | `useWebSocket.ts` |
| 工具函数 | camelCase | `formatPrice.ts` |
| 常量 | UPPER_SNAKE | `MAX_RETRY_COUNT` |
| Store | camelCase + Store | `marketStore.ts` |

### 7.3 Git 分支

```
main          # 生产环境
├── develop   # 开发环境
├── feature/* # 功能分支
└── hotfix/*  # 紧急修复
```

### 7.4 国际化 (i18n)

#### 技术方案

使用 **react-i18next** + **namespaces** 按模块拆分语言包：

```typescript
// i18n/config.ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

i18n.use(initReactI18next).init({
  fallbackLng: 'en',
  supportedLngs: ['en', 'zh-CN', 'zh-TW', 'ja', 'ko'],
  ns: ['common', 'trade', 'portfolio', 'errors'],
  defaultNS: 'common',
  interpolation: { escapeValue: false },
  backend: {
    loadPath: '/locales/{{lng}}/{{ns}}.json',
  },
});
```

#### 语言包结构

```
public/locales/
├── en/
│   ├── common.json      # 通用文案 (导航、按钮)
│   ├── trade.json       # 交易相关
│   ├── portfolio.json   # 资产/持仓
│   └── errors.json      # 错误消息
├── zh-CN/
│   ├── common.json
│   ├── trade.json
│   └── ...
└── zh-TW/
    └── ...
```

#### 使用示例

```tsx
// 组件中使用
import { useTranslation } from 'react-i18next';

function TradeForm() {
  const { t } = useTranslation('trade');

  return (
    <button>{t('order.submit')}</button>  // "Place Order" / "下单"
  );
}
```

#### 数字/日期本地化

```typescript
// utils/format.ts
import { format } from 'date-fns';
import { enUS, zhCN, zhTW, ja, ko } from 'date-fns/locale';

const localeMap = { 'en': enUS, 'zh-CN': zhCN, 'zh-TW': zhTW, 'ja': ja, 'ko': ko };

export function formatDate(date: Date, pattern: string, lng: string) {
  return format(date, pattern, { locale: localeMap[lng] || enUS });
}

// 价格格式化 (后端返回 string，前端仅做展示格式化)
export function formatPrice(price: string, precision: number = 2, lng: string) {
  const num = parseFloat(price);
  return new Intl.NumberFormat(lng, {
    minimumFractionDigits: precision,
    maximumFractionDigits: precision,
  }).format(num);
}
```

### 7.5 Mock 数据规范 (前后端联调)

#### 原则

1. **后端先行**: 后端优先提供 API，前端按接口文档开发
2. **契约优先**: 使用 OpenAPI 定义接口，生成 Mock 数据
3. **最小 Mock**: 仅在后端未就绪时使用 Mock，后端就绪立即切换

#### Mock 工具

| 阶段 | 工具 | 说明 |
|------|------|------|
| 接口设计 | Swagger/OpenAPI | 后端生成接口文档 |
| 前端开发 | MSW (Mock Service Worker) | 拦截网络请求，本地 Mock |
| 集成测试 | 后端 Mock Server | 后端提供测试环境 |

#### MSW 配置示例

```typescript
// mocks/handlers.ts
import { http, HttpResponse } from 'msw';

export const handlers = [
  // 订单列表 Mock
  http.get('/api/v1/orders', () => {
    return HttpResponse.json({
      success: true,
      data: {
        items: [
          { order_id: 'mock-001', side: 'buy', price: '100.50', quantity: '10', status: 'new' },
          { order_id: 'mock-002', side: 'sell', price: '101.00', quantity: '5', status: 'filled' },
        ],
        total: 2,
        page: 1,
        page_size: 20,
      },
    });
  }),

  // 下单 Mock
  http.post('/api/v1/orders', async ({ request }) => {
    const body = await request.json();
    return HttpResponse.json({
      success: true,
      data: { order_id: `mock-${Date.now()}`, ...body, status: 'new' },
    });
  }),
];

// mocks/browser.ts
import { setupWorker } from 'msw/browser';
import { handlers } from './handlers';

export const worker = setupWorker(...handlers);
```

#### Mock 数据规范

| 字段类型 | Mock 规则 | 示例 |
|----------|----------|------|
| 价格/数量 | 字符串，保留精度 | `"100.50"`, `"0.001"` |
| 时间戳 | 毫秒级 number | `1704067200000` |
| 地址 | 有效 EVM 地址 | `"0x742d35Cc..."` |
| ID | 带 `mock-` 前缀 | `"mock-order-001"` |
| 枚举值 | 与后端一致 | `"buy"`, `"sell"` |

#### 环境切换

```typescript
// main.tsx
async function enableMocking() {
  if (import.meta.env.DEV && import.meta.env.VITE_USE_MOCK === 'true') {
    const { worker } = await import('./mocks/browser');
    return worker.start({ onUnhandledRequest: 'bypass' });
  }
}

enableMocking().then(() => {
  ReactDOM.createRoot(document.getElementById('root')!).render(<App />);
});
```

```bash
# .env.development
VITE_USE_MOCK=true    # 开启 Mock
VITE_API_URL=https://api.eidos.exchange

# .env.production
VITE_USE_MOCK=false   # 关闭 Mock
```
