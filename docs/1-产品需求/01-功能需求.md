# Eidos 功能需求

> 系统类型: 链下撮合 + 链上结算 (类 Polymarket/dYdX)

---

## 一、系统概述

### 1.1 什么是"链下撮合 + 链上结算"?

传统中心化交易所 (CEX) 的问题是资金完全托管在交易所，用户需要信任交易所不会跑路。而完全去中心化交易所 (DEX) 的问题是每笔交易都要上链，速度慢、费用高。

**我们的方案是两者的结合**：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│   传统 CEX                    我们的方案                   完全 DEX          │
│                                                                              │
│   资金在交易所    ───────>    资金在链上合约    <───────   资金在链上        │
│   撮合在服务器    ───────>    撮合在服务器      <───────   撮合在链上        │
│   结算在数据库    ───────>    结算在链上        <───────   结算在链上        │
│                                                                              │
│   速度: 快                    速度: 快                     速度: 慢          │
│   安全: 低                    安全: 高                     安全: 高          │
│   费用: 低                    费用: 低                     费用: 高          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**核心优势**：
- **资金安全**: 用户资金始终在链上智能合约中，系统无法挪用
- **高性能**: 链下撮合可以实现毫秒级响应
- **低成本**: 只有最终结算需要上链，Gas 费用低
- **可验证**: 所有交易结果在链上可查

### 1.2 用户如何使用?

```
传统交易所:                         我们的系统:
1. 注册账号 (邮箱/手机)              1. 无需注册
2. KYC 身份验证                      2. 无需 KYC
3. 充值到交易所地址                  3. 连接钱包，直接充值到合约
4. 用密码登录                        4. 无需登录，钱包签名即认证
5. 下单 (API Key)                    5. 下单 (钱包签名)
6. 提现 (需审核)                     6. 提现 (签名即执行，无需审核)
```

### 1.3 核心概念解释

| 概念 | 解释 |
|------|------|
| **EIP-712 签名** | 以太坊的一种签名标准，用户在钱包中签名一个结构化的数据（比如订单），系统可以验证这个签名确实是该钱包地址的持有者签的 |
| **Maker/Taker** | Maker 是挂单等待成交的人（提供流动性），Taker 是主动吃单的人（消耗流动性）。通常 Maker 费率更低 |
| **Nonce** | 一个递增的数字，用来防止同一个签名被重复使用（重放攻击）。每次签名都要用新的 nonce |
| **Gas** | 在区块链上执行交易需要支付的费用。链下操作不需要 Gas |

### 1.4 实现阶段

| 阶段 | 内容 | 说明 |
|------|------|------|
| **Phase 1** | 现货交易 | 基础现货交易功能，核心架构搭建 |
| **Phase 2** | 永续合约 | 在现货基础上扩展杠杆交易、做空等功能 |

---

## 二、Phase 1: 现货交易需求

### 2.1 资金系统

#### 2.1.1 支持的代币

| 代币 | 用途 | 说明 |
|------|------|------|
| **USDC** | 计价币 | 稳定币，用于定价和结算 |
| **USDT** | 计价币 | 稳定币，用于定价和结算 |
| **其他代币** | 交易币 | 后续可扩展，如 BTC、ETH 等 |

> 系统设计上支持多代币扩展，新增代币只需配置，无需改代码。

#### 2.1.2 需求列表

| 需求ID | 需求名称 | 优先级 | 说明 |
|--------|---------|--------|------|
| F-001 | 充值 | P0 | 用户将代币从钱包转入交易合约 |
| F-002 | 提现 | P0 | 用户签名提现请求，将资金从合约转回钱包 |
| F-003 | 余额查询 | P0 | 查询可用余额、冻结余额（挂单占用）、总余额 |
| F-004 | 资金流水 | P1 | 所有资金变动的历史记录 |
| F-005 | 子账户 | P2 | 一个钱包下可创建多个独立的交易账户 |

#### 2.1.3 充值/提现配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| **充值确认数** | 0 | 区块确认数量，可配置。0 表示不等待确认（测试环境用） |
| **最小充值金额** | 10 USDC/USDT | 低于此金额的充值不处理，可配置 |
| **提现限额** | 无限制 | 单笔/单日无限额限制 |
| **提现手续费** | 0 | 暂不收取，后续可配置 |

#### 2.1.4 余额类型说明

```
总余额 = 可用余额 + 冻结余额

示例:
┌─────────────────────────────────────────────────────────────┐
│  用户充值了 10000 USDC                                       │
│                                                              │
│  总余额:     10000 USDC                                      │
│  可用余额:    7000 USDC  ← 可以用来下新订单或提现            │
│  冻结余额:    3000 USDC  ← 已挂单占用，取消后会解冻          │
└─────────────────────────────────────────────────────────────┘

注意: 下单时会先冻结相应金额，因此不可能出现余额不足成交的情况
```

#### 2.1.5 充值/提现流程

**充值**: 链上操作，用户主动调用合约
```
1. 用户在钱包中授权 (approve) 合约使用代币
2. 用户调用合约的 deposit() 函数
3. 合约将代币从用户钱包转入合约
4. 系统监听链上事件，等待确认数（可配置，默认0）
5. 确认后更新用户余额
```

**提现**: 需要用户签名
```
1. 用户在前端构造提现请求 (代币、金额、nonce、过期时间)
2. 用户用钱包签名这个请求
3. 系统验证签名有效性
4. 系统调用合约执行提现
5. 合约将代币转回用户钱包
```

### 2.2 现货订单类型

#### 2.2.1 基础订单 (P0 必须实现)

| 需求ID | 订单类型 | 说明 | 使用场景 |
|--------|---------|------|---------|
| S-001 | **限价单 (Limit)** | 指定价格挂单，等待被吃 | 想以更好价格成交，不急 |
| S-002 | **市价单 (Market)** | 按当前最优价格立即成交 | 想立即成交，不在乎价格 |

**限价单示例**:
```
当前 BTC 价格: 50000 USDC

用户挂一个限价买单: 价格 49000, 数量 0.1 BTC
→ 这个订单会挂在订单簿上等待
→ 当有人愿意以 49000 或更低价格卖出时，订单成交
→ 用户作为 Maker，享受更低手续费
```

**市价单示例**:
```
当前 BTC 价格: 50000 USDC
订单簿最优卖价: 50010 USDC

用户下一个市价买单: 数量 0.1 BTC
→ 立即以 50010 的价格成交
→ 用户作为 Taker，支付更高手续费
```

#### 2.2.2 订单有效期类型

| 类型 | 全称 | 说明 | 使用场景 |
|------|------|------|---------|
| **GTC** | Good-Till-Cancelled | 一直有效直到成交或取消 | 默认类型，想挂单等待 |
| **IOC** | Immediate-Or-Cancel | 立即成交，未成交部分自动取消 | 想尽量成交，不想挂单 |
| **FOK** | Fill-Or-Kill | 要么全部成交，要么全部取消 | 大单必须全部成交 |

**示例对比**:
```
用户下一个买单: 数量 1 BTC
当前卖一盘口只有 0.3 BTC

GTC: 成交 0.3 BTC，剩余 0.7 BTC 挂单等待
IOC: 成交 0.3 BTC，剩余 0.7 BTC 取消
FOK: 无法全部成交，整个订单取消，不成交任何部分
```

#### 2.2.3 滑点保护 (市价单)

市价单需要用户设置滑点容忍度，防止价格剧烈波动时成交价格偏离过大。

| 参数 | 说明 |
|------|------|
| **滑点比例** | 用户设置，如 0.5%、1%、2% |
| **保护价格** | 最新价 × (1 ± 滑点比例) |

```
用户设置滑点 1%，当前 BTC 价格 50000

市价买单保护:
→ 最高可接受价格 = 50000 × 1.01 = 50500
→ 如果成交均价超过 50500，订单失败

市价卖单保护:
→ 最低可接受价格 = 50000 × 0.99 = 49500
→ 如果成交均价低于 49500，订单失败
```

#### 2.2.4 条件订单 (P1 第二优先级)

| 需求ID | 订单类型 | 说明 | 使用场景 |
|--------|---------|------|---------|
| S-003 | **止损单 (Stop-Loss)** | 价格跌破某值时，自动市价卖出 | 防止亏损扩大 |
| S-004 | **止盈单 (Take-Profit)** | 价格涨到某值时，自动卖出 | 锁定利润 |
| S-005 | **止损限价单** | 价格触发后，以指定限价下单 | 更精确的止损 |

**止损单示例**:
```
用户持有 1 BTC，买入价 50000 USDC
设置止损单: 触发价 48000

当 BTC 跌到 48000 时:
→ 系统自动下一个市价卖单
→ 立即卖出，避免更大亏损
```

#### 2.2.5 高级订单 (P2 可选)

| 需求ID | 订单类型 | 说明 |
|--------|---------|------|
| S-006 | **OCO 订单** | One-Cancels-Other，两个订单只能成交一个 |
| S-007 | **追踪止损** | 止损价随市价上涨而上涨，锁定利润 |

**OCO 订单示例**:
```
用户持有 1 BTC，买入价 50000

同时设置:
- 止盈单: 55000 卖出 (赚 5000)
- 止损单: 48000 卖出 (亏 2000)

任一订单成交后，另一个自动取消
```

### 2.3 订单管理

#### 2.3.1 功能列表

| 需求ID | 功能 | 优先级 | 说明 |
|--------|------|--------|------|
| S-010 | 取消订单 | P0 | 取消未成交的挂单，需要钱包签名 |
| S-011 | 批量取消 | P1 | 一键取消某交易对或全部挂单 |
| S-012 | 修改订单 | P1 | 修改未成交订单的价格或数量 |
| S-013 | 订单历史 | P0 | 查询历史订单，支持按状态/时间筛选 |
| S-014 | 成交记录 | P0 | 查询成交明细 |
| S-015 | 当前挂单 | P0 | 查询所有未成交的订单 |

#### 2.3.2 自成交规则

**规则**: 禁止自成交 (与传统交易所一致)

当用户的买单和卖单可能匹配时:
```
用户 A 有一个卖单: 50000 USDC
用户 A 又下一个买单: 50000 USDC

系统行为: 拒绝新订单，返回错误 "SELF_TRADE_NOT_ALLOWED"
```

#### 2.3.3 订单限制 (可配置)

| 限制项 | 默认值 | 说明 |
|--------|--------|------|
| **单用户单交易对最大挂单数** | 200 | 超出后无法下新单 |
| **单交易对最大挂单总数** | 100,000 | 全市场订单簿深度限制 |
| **单笔最大订单金额** | 1,000,000 USDC | 风控限制 |
| **单笔最小订单金额** | 10 USDC | 防止小额刷单 |

> 所有限制项均可通过配置文件调整，无需改代码。

#### 2.3.4 订单状态流转

```
                    ┌──────────────┐
                    │   已取消     │
                    │ (Cancelled)  │
                    └──────────────┘
                          ↑
                          │ 用户取消
                          │
┌──────────┐      ┌──────────────┐      ┌──────────────┐
│  待处理   │ ───> │   挂单中     │ ───> │   已成交     │
│ (Pending) │      │   (Open)     │      │  (Filled)    │
└──────────┘      └──────────────┘      └──────────────┘
                          │
                          │ 部分成交
                          ↓
                  ┌──────────────┐
                  │  部分成交    │
                  │  (Partial)   │
                  └──────────────┘
                          │
                          │ 过期
                          ↓
                  ┌──────────────┐
                  │   已过期     │
                  │  (Expired)   │
                  └──────────────┘
```

### 2.4 交易对管理

| 需求ID | 功能 | 优先级 | 说明 |
|--------|------|--------|------|
| S-020 | 交易对列表 | P0 | 获取所有支持的交易对 |
| S-021 | 交易对配置 | P0 | 每个交易对的精度和限制 |
| S-022 | 交易对状态 | P1 | 启用/暂停/下线 |

**交易对配置示例**:
```json
{
  "symbol": "BTC-USDC",
  "baseToken": "BTC",
  "quoteToken": "USDC",
  "priceDecimals": 2,
  "sizeDecimals": 6,
  "minSize": "0.0001",
  "maxSize": "100",
  "minNotional": "10",
  "makerFee": "0.001",
  "takerFee": "0.001",
  "status": "active"
}
```

### 2.5 行情数据

| 需求ID | 功能 | 优先级 | 说明 |
|--------|------|--------|------|
| M-001 | 实时行情 | P0 | 最新价、24h涨跌幅、24h成交量 |
| M-002 | 订单簿 (Order Book) | P0 | 实时买卖盘口深度 |
| M-003 | 深度聚合 | P1 | 按价格精度聚合 |
| M-004 | K线数据 | P0 | 1m, 5m, 15m, 1h, 4h, 1d, 1w |
| M-005 | 成交流 | P0 | 实时成交记录 |
| M-006 | Ticker | P0 | 24小时统计 |

**订单簿示例**:
```
卖单 (Asks) - 价格从低到高
┌─────────────────────────────┐
│  价格      │  数量   │ 总计  │
├─────────────────────────────┤
│  50030     │  0.5    │  0.5  │  ← 最优卖价 (卖一)
│  50050     │  1.2    │  1.7  │
│  50100     │  2.0    │  3.7  │
└─────────────────────────────┘

当前价格: 50000

买单 (Bids) - 价格从高到低
┌─────────────────────────────┐
│  价格      │  数量   │ 总计  │
├─────────────────────────────┤
│  49980     │  0.8    │  0.8  │  ← 最优买价 (买一)
│  49950     │  1.5    │  2.3  │
│  49900     │  3.0    │  5.3  │
└─────────────────────────────┘
```

**K线数据字段**:
```json
{
  "openTime": 1704067200000,
  "open": "50000.00",
  "high": "50500.00",
  "low": "49800.00",
  "close": "50200.00",
  "volume": "123.456",
  "quoteVolume": "6172800.00",
  "trades": 1234
}
```

### 2.6 手续费系统

#### 2.6.1 费用结构

| 需求ID | 功能 | 优先级 | 说明 |
|--------|------|--------|------|
| FE-001 | Maker/Taker 费率 | P0 | 基础费率设置 |
| FE-002 | VIP 等级 | P2 | 按交易量享受折扣 |
| FE-003 | 手续费账单 | P1 | 手续费明细查询 |

#### 2.6.2 手续费计算与扣除

**扣除时机**: 撮合成功后立即扣除（与传统交易所一致）

**计算方式**:
```
成交金额 = 价格 × 数量 = 50000 × 0.1 = 5000 USDC
手续费 = 成交金额 × 费率 = 5000 × 0.1% = 5 USDC

Maker (挂单方): 费率通常较低，如 0.05%
Taker (吃单方): 费率通常较高，如 0.1%
```

**手续费归属**: 平台收入，记入平台账户进行财务核算

#### 2.6.3 VIP 等级体系 (P2)

| 等级 | 30日交易量 | Maker 费率 | Taker 费率 |
|------|-----------|-----------|-----------|
| VIP 0 | < $100K | 0.10% | 0.10% |
| VIP 1 | ≥ $100K | 0.08% | 0.10% |
| VIP 2 | ≥ $500K | 0.06% | 0.08% |
| VIP 3 | ≥ $1M | 0.04% | 0.06% |
| VIP 4 | ≥ $5M | 0.02% | 0.04% |

### 2.7 前端系统

#### 2.7.1 交易前端 (Web)

| 需求ID | 功能模块 | 优先级 | 说明 |
|--------|---------|--------|------|
| FE-001 | **钱包连接** | P0 | MetaMask/WalletConnect 连接、账户切换、网络检测 |
| FE-002 | **交易面板** | P0 | 限价单/市价单下单、滑点设置、订单有效期选择 |
| FE-003 | **订单簿** | P0 | 实时深度展示、价格点击下单、深度聚合切换 |
| FE-004 | **K线图表** | P0 | 多周期切换(1m/5m/15m/1h/4h/1d)、技术指标 |
| FE-005 | **资产管理** | P0 | 充值、提现、余额展示、资金流水 |
| FE-006 | **订单管理** | P0 | 当前委托、历史订单、成交记录、批量取消 |
| FE-007 | **行情列表** | P1 | 交易对列表、涨跌排序、收藏、搜索 |
| FE-008 | **成交记录** | P0 | 实时成交流展示 |
| FE-009 | **通知中心** | P1 | 订单成交通知、系统公告 |

**交易页面布局**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Logo    [交易对选择 ▼]    [行情]  [交易]  [资产]           [连接钱包]      │
├─────────────────────────────────────────────────────────────────────────────┤
│                              │                    │                          │
│       K线图表区              │      订单簿        │       下单面板           │
│                              │                    │                          │
│   - 周期切换                 │   卖单 (红)        │   [限价] [市价]          │
│   - 技术指标                 │   ────────        │                          │
│   - 画线工具                 │   50100 | 0.5     │   价格: [______]         │
│                              │   50050 | 1.2     │   数量: [______]         │
│                              │   ────────        │   可用: 10,000 USDC      │
│                              │   买单 (绿)        │                          │
│                              │   49980 | 0.8     │   [买入 BTC]             │
│                              │   49950 | 1.5     │   [卖出 BTC]             │
│                              │                    │                          │
├──────────────────────────────┴────────────────────┴──────────────────────────┤
│  [当前委托]  [历史订单]  [成交记录]                                          │
│  ──────────────────────────────────────────────────────────────────────────  │
│  订单ID  |  交易对  |  方向  |  价格  |  数量  |  已成交  |  状态  | 操作   │
│  xxxxx   | BTC-USDC |  买入  | 49000  |  0.1   |   0     |  挂单中 | [取消] │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.7.2 运营后台 (Admin)

| 需求ID | 功能模块 | 优先级 | 说明 |
|--------|---------|--------|------|
| AD-001 | **交易对管理** | P0 | 新增/编辑/上下线交易对、费率设置 |
| AD-002 | **代币管理** | P1 | 添加新支持的代币、配置合约地址 |
| AD-003 | **用户查询** | P0 | 按钱包地址查询余额、订单、成交 |
| AD-004 | **订单管理** | P0 | 查询全部订单、异常订单处理 |
| AD-005 | **成交查询** | P0 | 成交记录查询、导出 |
| AD-006 | **系统配置** | P1 | 限流、限额等参数在线配置 |
| AD-007 | **数据统计** | P1 | 交易量、手续费收入、用户增长报表 |
| AD-008 | **监控告警** | P1 | 服务状态、告警规则、告警历史 |
| AD-009 | **操作日志** | P0 | 管理员操作审计日志 |
| AD-010 | **权限管理** | P0 | 角色管理、账号管理 |

### 2.8 API 接口

#### 2.8.1 接口类型

| 需求ID | 功能 | 优先级 | 说明 |
|--------|------|--------|------|
| API-001 | REST API | P0 | HTTP 接口，用于下单、查询 |
| API-002 | WebSocket | P0 | 实时推送行情、订单状态 |
| API-003 | 签名认证 | P0 | 通过 EIP-712 签名验证身份 |
| API-004 | 限流控制 | P0 | 防止 API 滥用 |
| API-005 | API 文档 | P1 | OpenAPI 格式文档 |
| API-006 | 错误码规范 | P1 | 统一的错误码 |

**REST vs WebSocket**:
```
REST API (请求-响应模式):
- 下单、取消、查询余额、查询订单历史
- 适合: 需要精确响应的操作

WebSocket (实时推送模式):
- 行情更新、订单簿变化、订单状态变化
- 适合: 需要实时更新的数据
```

#### 2.8.2 API 限流配置 (可配置)

| 限制类型 | 默认值 | 说明 |
|---------|--------|------|
| **REST 下单** | 10 次/秒/用户 | 防止刷单 |
| **REST 查询** | 100 次/秒/用户 | 读操作限制 |
| **WebSocket 消息** | 20 条/秒/连接 | 订阅限制 |
| **IP 总请求** | 1000 次/分钟/IP | 全局限制 |

> 所有限流参数均可配置，按用户钱包地址或 IP 维度进行限制。

### 2.9 异常处理

与传统交易所保持一致的异常处理策略:

| 异常类型 | 处理方式 | 用户提示 |
|---------|---------|---------|
| **余额不足** | 拒绝订单 | INSUFFICIENT_BALANCE |
| **价格超限** | 拒绝订单 | PRICE_OUT_OF_RANGE |
| **数量超限** | 拒绝订单 | SIZE_OUT_OF_RANGE |
| **签名无效** | 拒绝请求 | INVALID_SIGNATURE |
| **Nonce 已用** | 拒绝请求 | NONCE_ALREADY_USED |
| **订单已过期** | 拒绝订单 | ORDER_EXPIRED |
| **交易对暂停** | 拒绝订单 | MARKET_SUSPENDED |
| **系统维护** | 暂停服务 | SYSTEM_MAINTENANCE |
| **撮合引擎异常** | 自动恢复/切换 | SERVICE_UNAVAILABLE |

---

## 三、运营管理系统

### 3.1 系统概述

需要一个独立的后台管理系统，供运营人员使用。

### 3.2 功能模块

| 模块 | 功能 | 优先级 |
|------|------|--------|
| **交易对管理** | 新增/编辑/上下线交易对 | P0 |
| **费率管理** | 设置 Maker/Taker 费率 | P0 |
| **代币管理** | 添加新支持的代币 | P1 |
| **用户查询** | 按钱包地址查询用户信息、余额、订单 | P0 |
| **订单管理** | 查询所有订单、异常订单处理 | P0 |
| **成交查询** | 成交记录查询、统计 | P0 |
| **系统配置** | 限流、限额等参数配置 | P1 |
| **数据统计** | 交易量、手续费收入等报表 | P1 |
| **告警管理** | 告警规则配置、告警历史 | P1 |
| **操作日志** | 管理员操作审计 | P0 |

### 3.3 权限设计

| 角色 | 权限 |
|------|------|
| **超级管理员** | 全部权限 |
| **运营** | 查询、费率配置、交易对管理 |
| **客服** | 只读查询 |
| **财务** | 手续费报表、资金流水 |

---

## 四、Phase 2: 永续合约需求 (后续迭代)

> 永续合约是一种没有到期日的衍生品，可以做多或做空，支持杠杆交易。

### 4.1 核心概念

| 概念 | 解释 |
|------|------|
| **做多 (Long)** | 预期价格上涨，先买后卖赚差价 |
| **做空 (Short)** | 预期价格下跌，先卖后买赚差价 |
| **杠杆** | 用小资金控制大仓位，如 10x 杠杆用 1000 USDC 可开 10000 USDC 的仓位 |
| **保证金** | 开仓时锁定的资金，用于覆盖可能的亏损 |
| **强制平仓** | 亏损过大时，系统强制平掉仓位防止穿仓 |
| **资金费率** | 多空双方定期支付的费用，用于让合约价格贴近现货价格 |

### 4.2 资金系统扩展

| 需求ID | 功能 | 说明 |
|--------|------|------|
| F-010 | 账户划转 | 现货账户 ↔ 合约账户资金划转 |
| F-011 | 合约账户余额 | 独立管理合约账户的保证金 |

### 4.3 开平仓

| 需求ID | 功能 | 说明 |
|--------|------|------|
| P-001 | 开多 | 预期上涨，买入做多 |
| P-002 | 开空 | 预期下跌，卖出做空 |
| P-003 | 平仓 | 关闭已有仓位 |
| P-004 | 市价全平 | 一键平掉所有仓位 |

### 4.4 保证金模式

| 需求ID | 功能 | 说明 |
|--------|------|------|
| P-021 | 全仓 (Cross) | 所有仓位共享保证金，爆仓会影响全部资金 |
| P-022 | 逐仓 (Isolated) | 每个仓位独立保证金，爆仓只损失该仓位保证金 |

**模式对比**:
```
全仓模式:
- 账户余额: 10000 USDC (共享)
- BTC 仓位: 使用 3000 USDC 保证金
- ETH 仓位: 使用 2000 USDC 保证金
- 如果 BTC 爆仓，可能亏掉全部 10000 USDC

逐仓模式:
- BTC 仓位: 独立 3000 USDC 保证金
- ETH 仓位: 独立 2000 USDC 保证金
- 如果 BTC 爆仓，最多亏 3000 USDC，ETH 仓位不受影响
```

### 4.5 风控系统

| 需求ID | 功能 | 说明 |
|--------|------|------|
| R-010 | 强平预警 | 保证金率低于 300% 时告警 |
| R-011 | 强制平仓 | 保证金率低于 100% 时系统强平 |
| R-020 | 保险基金 | 覆盖穿仓损失 |
| R-021 | ADL 自动减仓 | 保险基金不足时，减仓盈利方 |

**保证金率计算**:
```
保证金率 = 净值 / 维持保证金 × 100%

净值 = 账户余额 + 未实现盈亏
维持保证金 = 仓位价值 × 维持保证金率 (通常 0.5%-1%)

保证金率 < 100% → 触发强平
```

### 4.6 资金费率

| 需求ID | 功能 | 说明 |
|--------|------|------|
| FR-001 | 费率计算 | 基于合约价格与现货价格的偏离程度 |
| FR-002 | 定时结算 | 每 8 小时结算一次 |

**资金费率机制**:
```
合约价格 > 现货价格 (溢价):
→ 多头付费给空头
→ 激励做空，压低合约价格

合约价格 < 现货价格 (折价):
→ 空头付费给多头
→ 激励做多，拉高合约价格
```

---

## 五、非功能性需求

### 5.1 性能要求 (参考主流交易所)

| 指标 | Phase 1 目标 | Phase 2 目标 | 主流交易所参考 |
|------|-------------|-------------|---------------|
| **单引擎 TPS** | 100,000+ | 500,000+ | OKX/火币 10万+，Binance 100万+ |
| **撮合延迟 P50** | < 0.5ms | < 0.1ms | 毫秒级 |
| **撮合延迟 P99** | < 2ms | < 1ms | < 5ms |
| **订单簿深度** | 100万订单 | 500万订单 | 百万级 |
| **API 响应 P99** | < 20ms | < 10ms | < 20ms |
| **WebSocket 延迟** | < 50ms | < 20ms | < 50ms |
| **故障恢复时间** | < 1s | < 0.5s | 秒级 |

> 撮合引擎是核心中的核心，性能和可用性是第一优先级。采用传统交易所方案：红黑树+双向链表数据结构、对象池复用、单线程per交易对、批量处理等成熟技术。

### 5.2 安全要求

| 要求 | 说明 |
|------|------|
| 签名验证 | 所有写操作必须验证 EIP-712 签名 |
| Nonce 检查 | 每个签名只能使用一次，防止重放攻击 |
| 过期时间 | 签名必须带有效期，过期失效 |
| 合约审计 | 智能合约需要第三方安全审计 |

### 5.3 可用性要求

| 要求 | 目标 |
|------|------|
| 系统可用性 | 99.9% |
| 撮合引擎可用性 | 99.99% |
| 数据一致性 | 强一致 |
| 故障恢复时间 | < 5 分钟 |

---

## 六、术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 挂单方 | Maker | 提供流动性，订单挂在订单簿上等待成交 |
| 吃单方 | Taker | 消耗流动性，主动与订单簿上的订单成交 |
| 订单簿 | Order Book | 所有挂单的集合，按价格排序 |
| 深度 | Depth | 订单簿中各价格的订单数量 |
| K线 | Candlestick | 显示一段时间内价格变化的图表 |
| 滑点 | Slippage | 实际成交价格与预期价格的偏差 |
| 标记价格 | Mark Price | 公允价格，用于计算盈亏和强平 (Phase 2) |
| 指数价格 | Index Price | 多交易所价格的加权平均 (Phase 2) |
| 资金费率 | Funding Rate | 多空双方定期支付的费用 (Phase 2) |
| 强制平仓 | Liquidation | 保证金不足时系统强制平仓 (Phase 2) |
| 自动减仓 | ADL | 保险基金不足时减仓盈利方 (Phase 2) |

---
