# Eidos 协议总表

> **权威性**: 本文档为所有配置的**唯一真源**，其他文档如有冲突以本文档为准

---

## 一、API 端点配置

### 1.1 域名规划

| 环境 | REST API | WebSocket | 管理后台 |
|------|----------|-----------|----------|
| **开发** | `http://localhost:8080` | `ws://localhost:8080/ws` | `http://localhost:8088` |
| **测试** | `https://api-test.eidos.exchange` | `wss://api-test.eidos.exchange/ws` | `https://admin-test.eidos.exchange` |
| **生产** | `https://api.eidos.exchange` | `wss://api.eidos.exchange/ws` | `https://admin.eidos.exchange` |

> **注意**: WebSocket 与 REST API 使用同一域名，通过 `/ws` 路径区分

### 1.2 REST API 路径

| 模块 | 路径 | 方法 | 说明 |
|------|------|------|------|
| **订单** | `/api/v1/orders` | POST | 创建订单 |
| | `/api/v1/orders/prepare` | POST | 准备订单 (获取签名数据) |
| | `/api/v1/orders/{order_id}` | GET | 查询订单 |
| | `/api/v1/orders/{order_id}` | DELETE | 取消订单 |
| | `/api/v1/orders` | GET | 订单列表 |
| **余额** | `/api/v1/balances` | GET | 查询余额 |
| | `/api/v1/balances/withdraw` | POST | 发起提现 |
| | `/api/v1/balances/history` | GET | 资金流水 |
| **行情** | `/api/v1/markets` | GET | 市场列表 |
| | `/api/v1/markets/{market}/ticker` | GET | 24h Ticker |
| | `/api/v1/markets/{market}/depth` | GET | 订单簿深度 |
| | `/api/v1/markets/{market}/trades` | GET | 最新成交 |
| | `/api/v1/markets/{market}/klines` | GET | K 线数据 |
| **健康** | `/health/live` | GET | 存活探针 |
| | `/health/ready` | GET | 就绪探针 |
| **文档** | `/swagger/*` | GET | Swagger UI |

---

## 二、鉴权规范

### 2.1 HTTP Header (统一标准)

```http
Authorization: EIP712 {wallet}:{timestamp}:{signature}
Content-Type: application/json
```

| Header | 格式 | 示例 |
|--------|------|------|
| `Authorization` | `EIP712 {wallet}:{timestamp}:{signature}` | `EIP712 0x1234...abcd:1704067200000:0xabc...def` |

> **重要**: 不再使用 `X-Wallet-Address`, `X-Signature`, `X-Timestamp` 分离头，统一使用 `Authorization` 头

### 2.2 签名时间戳

- 格式: 毫秒级 Unix 时间戳
- 有效期: ±5 分钟 (300000ms)
- 时区: UTC

---

## 三、EIP-712 签名规范

### 3.1 Domain (唯一标准)

```json
{
  "name": "EidosExchange",
  "version": "1",
  "chainId": 31337,
  "verifyingContract": "0x0000000000000000000000000000000000000000"
}
```

| 字段 | 开发环境 | 测试环境 | 生产环境 |
|------|----------|----------|----------|
| `name` | `EidosExchange` | `EidosExchange` | `EidosExchange` |
| `version` | `1` | `1` | `1` |
| `chainId` | `31337` | `421614` | `42161` |
| `verifyingContract` | `0x0000...0000` | 测试合约地址 | 生产合约地址 |

> **重要**: Domain name 必须是 `EidosExchange` (无空格)，不是 `Eidos Exchange`

### 3.2 TypeHash 定义

```go
// Order TypeHash
OrderTypeHash = keccak256(
    "Order(address wallet,string market,uint8 side,uint8 orderType,uint256 price,uint256 amount,uint256 nonce,uint256 expiry)"
)

// Cancel TypeHash
CancelTypeHash = keccak256(
    "Cancel(address wallet,string orderId,uint256 nonce)"
)

// Withdraw TypeHash
WithdrawTypeHash = keccak256(
    "Withdraw(address wallet,string token,uint256 amount,string toAddress,uint256 nonce)"
)
```

### 3.3 Mock 模式

在合约未部署阶段，后端采用 **Mock 签名验证**模式：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Mock 签名验证模式说明                                     │
│                                                                              │
│  ⭐ 重要: Mock 模式下，签名验证仅在后端执行                                 │
│                                                                              │
│  Mock 模式特点:                                                              │
│  ═══════════════                                                             │
│  1. verifyingContract = 0x0000000000000000000000000000000000000000           │
│     (零地址表示 Mock 模式，无实际链上合约)                                   │
│                                                                              │
│  2. 签名验证流程:                                                            │
│     用户钱包签名 (EIP-712) → 后端 ecrecover 恢复地址 → 比对钱包地址          │
│                                                                              │
│  3. 链上结算暂不执行:                                                        │
│     成交记录仅在链下数据库中标记为 SETTLED_ONCHAIN                           │
│     (模拟链上结算成功)                                                       │
│                                                                              │
│  4. 充提流程:                                                                │
│     - 充值: 通过运营后台手动入账 (模拟充值)                                  │
│     - 提现: 通过运营后台手动审核+出账 (模拟提现)                             │
│                                                                              │
│  何时切换到正式模式:                                                         │
│  ═══════════════════                                                         │
│  - 智能合约部署完成后                                                       │
│  - verifyingContract 替换为实际合约地址                                      │
│  - 签名验证 + 链上结算同时执行                                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**后端验证逻辑 (Mock 模式)**:

```go
// Mock 签名验证 - 仅验证签名者地址，不与链上合约交互
func VerifySignature(wallet, message, signature string) bool {
    // 1. 使用 EIP-712 规范哈希消息
    messageHash := hashTypedDataV4(message)

    // 2. 从签名恢复地址
    recoveredAddress := ecrecover(messageHash, signature)

    // 3. 比对地址 (不区分大小写)
    return strings.EqualFold(recoveredAddress, wallet)
}

// 判断是否为 Mock 模式
func IsMockMode() bool {
    return config.VerifyingContract == "0x0000000000000000000000000000000000000000"
}
```

**前端适配**:

前端仍使用标准 EIP-712 签名流程，无需针对 Mock 模式做特殊处理:

```typescript
// 前端签名 (Mock 模式与正式模式代码相同)
const domain = {
  name: 'EidosExchange',
  version: '1',
  chainId: 31337,  // 开发环境
  verifyingContract: '0x0000000000000000000000000000000000000000'  // Mock 模式
};

const signature = await signer.signTypedData(domain, types, message);
```

> **注意**: Mock 模式仅用于开发测试阶段，生产环境必须使用正式合约模式。

---

## 四、Kafka Topic 规范

### 4.1 命名规则

- **不使用前缀**: Topic 名称不加 `eidos-` 前缀
- **使用短横线**: 单词间用 `-` 分隔
- **小写字母**: 全部使用小写

### 4.2 Topic 清单

| Topic | Partition Key | 生产者 | 消费者 | 保留时间 |
|-------|---------------|--------|--------|----------|
| `orders` | `market` | eidos-trading | eidos-matching | 7 天 |
| `cancel-requests` | `market` | eidos-trading | eidos-matching | 3 天 |
| `trade-results` | `market` | eidos-matching | eidos-trading, eidos-market, eidos-risk | 30 天 |
| `order-updates` | `order_id` | eidos-trading | eidos-api | 3 天 |
| `order-cancelled` | `order_id` | eidos-matching | eidos-trading | 3 天 |
| `orderbook-updates` | `market` | eidos-matching | eidos-market | 1 天 |
| `balance-updates` | `wallet` | eidos-trading | eidos-api | 3 天 |
| `deposits` | `tx_hash` | eidos-chain | eidos-trading | 30 天 |
| `withdrawals` | `wallet` | eidos-trading | eidos-chain | 30 天 |
| `settlements` | `batch_id` | eidos-chain | - | 30 天 |
| `settlement-confirmed` | `batch_id` | eidos-chain | eidos-trading | 30 天 |
| `kline-1m` | `market` | eidos-market | - | 1 天 |
| `risk-alerts` | `wallet` | eidos-risk | - | 30 天 |

> **Partition Key 设计原则**:
> - `market`: 同市场订单/撮合需要顺序处理 (撮合引擎单线程)
> - `wallet`: 同用户提现/余额变动需要顺序处理 (防止竞态)
> - `tx_hash`: 按链上交易去重 (幂等性)
> - `batch_id`: 同批次结算顺序处理

### 4.3 幂等键规范

| Topic | 幂等键 | 说明 |
|-------|--------|------|
| `orders` | `order_id` | 订单 ID 全局唯一 |
| `trade-results` | `trade_id` | 成交 ID 全局唯一 |
| `deposits` | `tx_hash:log_index` | 链上交易哈希 + 日志索引 |
| `withdrawals` | `withdraw_id` | 提现 ID |
| `settlements` | `batch_id` | 结算批次 ID |

---

## 五、服务端口规范

### 5.1 端口分配表

| 服务 | gRPC 端口 | HTTP 端口 | 容器内部 | 宿主机映射 | 说明 |
|------|-----------|-----------|----------|------------|------|
| eidos-api | - | 8080 | 8080 | 8080 | REST API 聚合层 (直接对外) |
| eidos-trading | 50051 | 8080 | 8080 | - | 交易服务 (订单+清算+账户) |
| eidos-matching | 50052 | 8080 | 8080 | - | 撮合引擎 |
| eidos-market | 50053 | 8080 | 8080 | - | 行情服务 |
| eidos-chain | 50054 | 8080 | 8080 | - | 链上服务 (结算+索引) |
| eidos-risk | 50055 | 8080 | 8080 | - | 风控服务 |
| eidos-jobs | 50056 | 8080 | 8080 | - | 定时任务 |
| eidos-admin | - | 8088 | 8088 | 8088 | 运营后台 |

> **说明**:
> - 只有 eidos-api、eidos-admin 对外暴露 HTTP 端口
> - 内部服务通过 gRPC 通信，不对外暴露
> - eidos-trading 整合了原 eidos-trade、eidos-clearing、eidos-account
> - eidos-chain 整合了原 eidos-settlement、eidos-indexer

### 5.2 服务发现配置

```yaml
# 所有服务使用 gRPC 端口进行服务间通信 (通过 Nacos 注册发现)
services:
  eidos-trading:
    address: "eidos-trading:50051"
  eidos-matching:
    address: "eidos-matching:50052"
  eidos-market:
    address: "eidos-market:50053"
  eidos-chain:
    address: "eidos-chain:50054"
  eidos-risk:
    address: "eidos-risk:50055"
  eidos-jobs:
    address: "eidos-jobs:50056"
```

---

## 六、WebSocket 频道规范

### 6.1 公共频道 (无需认证)

| 频道 | 格式 | 示例 |
|------|------|------|
| Ticker | `ticker.{market}` | `ticker.BTC-USDC` |
| 深度 | `depth.{market}.{level}` | `depth.BTC-USDC.20` |
| K线 | `kline.{market}.{interval}` | `kline.BTC-USDC.1m` |
| 成交 | `trades.{market}` | `trades.BTC-USDC` |

### 6.2 Redis 内部频道

| 用途 | 格式 | 示例 |
|------|------|------|
| Ticker | `eidos:ticker:{market}` | `eidos:ticker:BTC-USDC` |
| 深度 | `eidos:depth:{market}` | `eidos:depth:BTC-USDC` |
| K线 | `eidos:kline:{market}:{interval}` | `eidos:kline:BTC-USDC:1m` |
| 成交 | `eidos:trades:{market}` | `eidos:trades:BTC-USDC` |

> **规则**: 外部 WebSocket 用点号 `.`，内部 Redis 用冒号 `:` 并加 `eidos:` 前缀

---

## 七、数据库规范

### 7.1 数据库分配

| 服务 | 数据库名 | 主要表 |
|------|----------|--------|
| eidos-trading | eidos_trading | orders, nonces, trades, transactions, balances, deposits, withdrawals |
| eidos-matching | - | 纯内存服务，无持久化数据库 |
| eidos-market | eidos_market | klines, tickers (TimescaleDB) |
| eidos-chain | eidos_chain | settlement_batches, withdrawal_txs, deposit_records, chain_events, reconciliation_records |
| eidos-risk | eidos_risk | risk_rules, risk_events, blacklist, risk_audit_logs |
| eidos-admin | eidos_admin | markets, tokens, admins, configs |
| eidos-jobs | - | 使用其他服务数据库 (只读/调度) |

> **说明**:
> - eidos-trading 共享数据库，整合订单、清算、账户数据
> - eidos-chain 共享数据库，整合结算和索引数据

### 7.3 配置版本号（强制）

为避免多服务配置版本分叉（撮合/行情/交易/风控加载到不同版本），配置变更必须有**单调递增版本号**。

```sql
-- 推荐：全局配置版本表（按 scope 维度）
CREATE TABLE config_versions (
    scope        VARCHAR(50) PRIMARY KEY,   -- market_configs / system_configs / risk_rules ...
    version      BIGINT NOT NULL DEFAULT 0,
    updated_by   VARCHAR(42),
    updated_at   BIGINT NOT NULL
);
```

> 发布流程与验收方式见：[4-服务设计/06-管理后台.md](../4-服务设计/06-管理后台.md) 的“4.1 交易对配置管理”章节。

### 7.2 通用审计字段

```sql
-- 每个表必须包含
created_by      VARCHAR(42),
created_at      BIGINT NOT NULL,
updated_by      VARCHAR(42),
updated_at      BIGINT NOT NULL
```

---

## 八、链配置

### 8.1 ChainId

| 环境 | ChainId | 网络 |
|------|---------|------|
| 开发 | `31337` | Hardhat/Anvil |
| 测试 | `421614` | Arbitrum Sepolia |
| 生产 | `42161` | Arbitrum One |

### 8.2 合约地址 (Mock 模式)

```yaml
# Mock 模式: 使用零地址，表示 Mock 模式
verifying_contract: "0x0000000000000000000000000000000000000000"

# 正式模式: 使用实际合约地址
# verifying_contract: "0x..." (待部署)
```

### 8.3 区块确认数

| 环境 | 充值确认数 | 结算确认数 | 说明 |
|------|-----------|-----------|------|
| 开发 | `0` | `0` | 即时确认 |
| 测试 | `0` | `0` | 即时确认 |
| 生产 | `0` | `0` | 即时确认 (Arbitrum L2 finality 足够快) |

> **说明**: Arbitrum L2 的 finality 机制保证交易快速确认，无需额外等待区块确认数。

```yaml
# 配置示例
blockchain:
  confirmations:
    deposit: ${DEPOSIT_CONFIRMATIONS:-0}    # 充值确认数
    settlement: ${SETTLEMENT_CONFIRMATIONS:-0}  # 结算确认数
```

---

## 九、配置优先级

当配置存在冲突时，按以下优先级确定最终值：

1. **本协议总表** (最高优先级)
2. 各服务设计文档
3. Docker 部署配置

---

---

## 附录：快速参考

### A. 前端集成清单

```typescript
// 环境配置
const config = {
  apiUrl: 'https://api.eidos.exchange',
  wsUrl: 'wss://api.eidos.exchange/ws',
  chainId: 42161,
  domain: {
    name: 'EidosExchange',
    version: '1',
    chainId: 42161,
    verifyingContract: '0x...'
  }
};

// 鉴权 Header
const headers = {
  'Authorization': `EIP712 ${wallet}:${timestamp}:${signature}`,
  'Content-Type': 'application/json'
};
```

### B. 后端服务配置模板

```yaml
# config.yaml
service:
  name: eidos-xxx
  grpc_port: 50051
  http_port: 8080

eip712:
  domain:
    name: "EidosExchange"
    version: "1"
    chain_id: ${CHAIN_ID:31337}
    verifying_contract: ${CONTRACT_ADDRESS:0x0000000000000000000000000000000000000000}

kafka:
  brokers:
    - kafka:9092
  topics:
    orders: orders
    trade_results: trade-results
    balance_updates: balance-updates
    risk_alerts: risk-alerts

grpc:
  clients:
    trading: "eidos-trading:50051"
    matching: "eidos-matching:50052"
    market: "eidos-market:50053"
    chain: "eidos-chain:50054"
    risk: "eidos-risk:50055"
```
