# Eidos 统一设计规范

> 适用范围: 所有后端服务

---

## 一、服务命名规范

### 1.1 服务名称

所有服务必须以 `eidos-` 为前缀:

| 服务名 | 说明 |
|--------|------|
| eidos-api | REST + WebSocket 网关 |
| eidos-trading | 交易服务 (订单+清算+账户) |
| eidos-matching | 撮合引擎 |
| eidos-market | 行情服务 |
| eidos-chain | 链上服务 (结算+索引) |
| eidos-risk | 风控服务 |
| eidos-admin | 管理后台 |
| eidos-jobs | 定时任务 |

### 1.2 Nacos 注册配置

```yaml
nacos:
  server_addr: "nacos:8848"
  namespace: "eidos-prod"           # 环境隔离: eidos-dev, eidos-test, eidos-prod
  group: "EIDOS_GROUP"
  service_name: "eidos-xxx"         # 与服务名一致
  metadata:
    version: "1.0.0"
    grpc_port: "50051"
```

---

## 二、数据库设计规范

### 2.1 通用字段要求

**每个表必须包含以下四个审计字段:**

```sql
-- 审计字段 (必须)
created_by      VARCHAR(42),              -- 创建者 (钱包地址或系统标识)
created_at      BIGINT NOT NULL,          -- 创建时间 (毫秒级时间戳)
updated_by      VARCHAR(42),              -- 更新者
updated_at      BIGINT NOT NULL,          -- 更新时间 (毫秒级时间戳)
```

### 2.2 表结构模板

```sql
CREATE TABLE table_name (
    -- 主键
    id              BIGSERIAL PRIMARY KEY,

    -- 业务字段
    -- ...

    -- 审计字段 (必须)
    created_by      VARCHAR(42),
    created_at      BIGINT NOT NULL,
    updated_by      VARCHAR(42),
    updated_at      BIGINT NOT NULL
);

-- 创建时间索引 (用于查询和清理)
CREATE INDEX idx_{table}_created_at ON table_name (created_at);
CREATE INDEX idx_{table}_updated_at ON table_name (updated_at);
```

### 2.3 字段类型规范

| 类型 | 使用场景 | 示例 |
|------|---------|------|
| **BIGSERIAL** | 自增主键 | id |
| **VARCHAR(42)** | 钱包地址 | wallet_address |
| **VARCHAR(64)** | UUID/业务ID | order_id, trade_id |
| **VARCHAR(66)** | 交易哈希 | tx_hash |
| **VARCHAR(20)** | 短标识 | token, market |
| **DECIMAL(36,18)** | 金额/数量 | amount, price |
| **BIGINT** | 时间戳 (毫秒) | created_at |
| **SMALLINT** | 枚举/状态 | status, side |
| **BOOLEAN** | 布尔 | is_active |
| **BYTEA** | 二进制 | signature |

### 2.4 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 表名 | 小写+下划线，复数 | orders, balances, trades |
| 字段名 | 小写+下划线 | wallet_address, order_id |
| 主键 | id | id |
| 外键 | {表名}_id | order_id, user_id |
| 索引 | idx_{表名}_{字段} | idx_orders_wallet |
| 唯一索引 | uk_{表名}_{字段} | uk_orders_order_id |

### 2.5 状态枚举规范

```sql
-- 订单状态
-- 0: PENDING    - 待处理
-- 1: OPEN       - 挂单中
-- 2: PARTIAL    - 部分成交
-- 3: FILLED     - 完全成交
-- 4: CANCELLED  - 已取消
-- 5: EXPIRED    - 已过期
-- 6: REJECTED   - 被拒绝

-- 充值状态
-- 0: PENDING    - 待确认
-- 1: CONFIRMED  - 已确认
-- 2: CREDITED   - 已入账

-- 提现状态
-- 0: PENDING    - 待处理
-- 1: PROCESSING - 处理中
-- 2: SUBMITTED  - 已提交
-- 3: CONFIRMED  - 已确认
-- 4: FAILED     - 失败
```

---

## 三、代码设计规范

### 3.1 分层架构

所有服务统一采用分层架构:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          服务分层架构                                        │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │  Handler Layer (处理层)                                             │     │
│  │  - 接收 gRPC/HTTP 请求                                              │     │
│  │  - 参数校验                                                         │     │
│  │  - 调用 Service                                                     │     │
│  │  - 错误转换                                                         │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                  │                                          │
│                                  ▼                                          │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │  Service Layer (业务层)                                             │     │
│  │  - 核心业务逻辑                                                     │     │
│  │  - 事务控制                                                         │     │
│  │  - 调用 Repository                                                  │     │
│  │  - 调用其他 Service                                                 │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                  │                                          │
│                                  ▼                                          │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │  Repository Layer (数据层)                                          │     │
│  │  - 数据库 CRUD                                                      │     │
│  │  - 缓存操作                                                         │     │
│  │  - 不包含业务逻辑                                                   │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                  │                                          │
│                                  ▼                                          │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │  Infrastructure Layer (基础设施层)                                  │     │
│  │  - 数据库连接                                                       │     │
│  │  - Redis 客户端                                                     │     │
│  │  - Kafka 客户端                                                     │     │
│  │  - gRPC 客户端                                                      │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 目录结构

```
eidos-xxx/
├── cmd/
│   └── main.go                 # 入口
├── config/
│   └── config.yaml             # 配置文件
├── internal/
│   ├── config/                 # 配置加载
│   ├── handler/                # gRPC/HTTP 处理器
│   ├── service/                # 业务逻辑
│   ├── repository/             # 数据访问
│   ├── model/                  # 数据模型
│   └── client/                 # 外部服务客户端
├── pkg/                        # 可复用包
│   ├── errors/                 # 错误定义
│   ├── utils/                  # 工具函数
│   └── middleware/             # 中间件
├── api/
│   └── proto/                  # Proto 定义
├── scripts/                    # 脚本
├── Dockerfile
├── Makefile
└── go.mod
```

### 3.3 公共抽象层

以下组件应抽象为公共包 (`eidos-common`):

```
eidos-common/
├── pkg/
│   ├── nacos/                  # Nacos 服务注册/发现
│   ├── grpc/                   # gRPC 客户端封装
│   ├── kafka/                  # Kafka 生产者/消费者
│   ├── redis/                  # Redis 客户端
│   ├── postgres/               # PostgreSQL 连接池
│   ├── crypto/                 # EIP-712 签名验证
│   ├── decimal/                # 高精度数值计算
│   ├── errors/                 # 统一错误码
│   ├── logger/                 # 统一日志
│   ├── metrics/                # Prometheus 指标
│   └── middleware/             # 通用中间件
└── proto/                      # 公共 Proto 定义
```

### 3.4 接口设计原则

```go
// 1. 使用接口定义依赖 (eidos-trading 服务内部)
type BalanceRepository interface {
    GetBalance(ctx context.Context, wallet, token string) (*Balance, error)
    FreezeBalance(ctx context.Context, req *FreezeRequest) error
}

// 2. 构造函数注入依赖
func NewTradeService(
    balanceRepo BalanceRepository,
    orderRepo OrderRepository,
    kafkaProducer KafkaProducer,
) *TradeService {
    return &TradeService{
        balanceRepo:   balanceRepo,
        orderRepo:     orderRepo,
        kafkaProducer: kafkaProducer,
    }
}

// 3. Context 传递请求上下文
func (s *TradeService) CreateOrder(ctx context.Context, req *CreateOrderRequest) (*Order, error) {
    // ctx 包含 trace_id, user_id 等
}

// 4. 统一错误处理
func (s *TradeService) CreateOrder(ctx context.Context, req *CreateOrderRequest) (*Order, error) {
    if err := s.validate(req); err != nil {
        return nil, errors.Wrap(ErrInvalidRequest, err.Error())
    }
    // ...
}
```

### 3.5 错误处理规范

```go
// 定义错误码
var (
    ErrInvalidSignature    = errors.New("INVALID_SIGNATURE", "签名无效")
    ErrInsufficientBalance = errors.New("INSUFFICIENT_BALANCE", "余额不足")
    ErrOrderNotFound       = errors.New("ORDER_NOT_FOUND", "订单不存在")
)

// 错误包装
if err := s.repo.GetOrder(orderID); err != nil {
    if errors.Is(err, sql.ErrNoRows) {
        return errors.Wrap(ErrOrderNotFound, orderID)
    }
    return errors.Wrap(ErrInternal, err.Error())
}

// gRPC 错误转换
func toGRPCError(err error) error {
    switch {
    case errors.Is(err, ErrInvalidSignature):
        return status.Error(codes.InvalidArgument, err.Error())
    case errors.Is(err, ErrOrderNotFound):
        return status.Error(codes.NotFound, err.Error())
    default:
        return status.Error(codes.Internal, err.Error())
    }
}
```

---

## 四、Proto 设计规范

### 4.1 文件组织

```
proto/
├── common/
│   ├── pagination.proto        # 分页
│   └── timestamp.proto         # 时间戳
├── order/
│   └── order_service.proto
├── balance/
│   └── balance_service.proto
└── ...
```

### 4.2 命名规范

```protobuf
// 包名: 小写
package eidos.trade.v1;

// 服务名: 大驼峰 + Service
service TradeService { }

// 方法名: 大驼峰
rpc CreateOrder(CreateOrderRequest) returns (CreateOrderResponse);

// 消息名: 大驼峰
message CreateOrderRequest { }

// 字段名: 下划线
string order_id = 1;

// 枚举名: 大驼峰，值: 全大写下划线
enum OrderStatus {
    ORDER_STATUS_UNSPECIFIED = 0;
    ORDER_STATUS_OPEN = 1;
}
```

### 4.3 通用消息

```protobuf
// 分页请求
message PaginationRequest {
    int32 page = 1;           // 页码，从 1 开始
    int32 page_size = 2;      // 每页大小，默认 20
}

// 分页响应
message PaginationResponse {
    int32 total = 1;
    int32 page = 2;
    int32 page_size = 3;
    int32 total_pages = 4;
}

// 统一响应
message Response {
    bool success = 1;
    string error_code = 2;
    string error_message = 3;
}
```

---

## 五、日志规范

### 5.1 日志级别

| 级别 | 使用场景 |
|------|---------|
| **DEBUG** | 开发调试信息 |
| **INFO** | 正常业务流程 |
| **WARN** | 异常但可恢复 |
| **ERROR** | 错误需要关注 |

### 5.2 日志格式

```json
{
    "level": "INFO",
    "time": "2025-12-01T12:00:00.000Z",
    "service": "eidos-trading",
    "trace_id": "abc123",
    "user_id": "0x...",
    "method": "CreateOrder",
    "duration_ms": 15,
    "msg": "order created",
    "order_id": "xxx"
}
```

### 5.3 必须记录的日志

- 服务启动/停止
- 请求开始/结束
- 关键业务操作
- 错误和异常
- 外部服务调用

---

## 六、监控规范

### 6.1 必须暴露的指标

```go
// 请求计数
request_total{service, method, status}

// 请求延迟
request_duration_seconds{service, method}

// 业务指标 (按服务定义)
orders_created_total{market, side}
trades_volume_total{market}
balance_operations_total{operation, token}
```

### 6.2 健康检查

每个服务必须实现:

```go
// gRPC 健康检查
service Health {
    rpc Check(HealthCheckRequest) returns (HealthCheckResponse);
}

// HTTP 健康检查 (用于 K8s)
GET /health/live    // 存活探针
GET /health/ready   // 就绪探针
```

---

## 七、配置规范

### 7.1 配置文件结构

```yaml
# config.yaml
service:
  name: eidos-xxx
  port: 50051
  env: prod                     # dev, test, prod

nacos:
  server_addr: "nacos:8848"
  namespace: "eidos-prod"
  group: "EIDOS_GROUP"

postgres:
  host: postgres
  port: 5432
  database: eidos_xxx
  max_connections: 100

redis:
  cluster:
    nodes:
      - redis-1:6379
      - redis-2:6379
      - redis-3:6379

kafka:
  brokers:
    - kafka-1:9092
    - kafka-2:9092
    - kafka-3:9092

log:
  level: info
  format: json
```

### 7.2 环境变量覆盖

```bash
# 环境变量优先级高于配置文件
EIDOS_SERVICE_PORT=50051
EIDOS_POSTGRES_HOST=localhost
EIDOS_NACOS_SERVER_ADDR=localhost:8848
```

---

## 八、版本控制

### 8.1 API 版本

- Proto 包名包含版本: `eidos.order.v1`
- 重大变更时升级版本: `v1` → `v2`
- 保持向后兼容至少 2 个版本

### 8.2 数据库迁移

- 使用迁移工具 (golang-migrate)
- 每次变更一个迁移文件
- 迁移文件命名: `{timestamp}_{description}.{up|down}.sql`

```
migrations/
├── 20241201120000_create_orders_table.up.sql
├── 20241201120000_create_orders_table.down.sql
├── 20241202150000_add_order_status_index.up.sql
└── 20241202150000_add_order_status_index.down.sql
```
