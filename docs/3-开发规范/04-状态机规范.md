# Eidos 状态机规范

> **目的**: 明确订单、成交、结算、提现的状态流转与一致性保障

---

## 一、一致性模型说明

### 1.1 架构特点

Eidos 采用**链下撮合 + 链上结算**的混合架构，这意味着：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           一致性模型                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  链下部分 (最终一致性)                链上部分 (强一致性)                      │
│  ├── 订单撮合                         ├── 资金结算                           │
│  ├── 余额冻结/划转                    ├── 充值确认                           │
│  ├── 订单状态更新                     └── 提现执行                           │
│  └── 行情数据聚合                                                            │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  关键原则:                                                           │    │
│  │  1. 链下余额 = 链上余额的"乐观视图"                                   │    │
│  │  2. 链上结算是最终权威                                                │    │
│  │  3. 用户可用余额 = 已结算部分 + 未结算但已成交部分 (有限额控制)        │    │
│  │  4. 提现只允许提取已结算部分                                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 术语定义

| 术语 | 定义 |
|------|------|
| **链下余额** | 交易系统维护的余额，包含已结算和待结算部分 |
| **链上余额** | 智能合约中的实际余额 |
| **已结算余额** | 已通过链上结算确认的余额 |
| **待结算余额** | 成交后尚未结算上链的余额增量 |
| **可提现余额** | 只包含已结算部分，不包含待结算部分 |

---

## 二、订单状态机

### 2.1 状态定义

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           订单状态枚举                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  状态值  │  状态名      │  说明                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│    0     │  PENDING     │  待处理 (刚创建，尚未发送到撮合引擎)                 │
│    1     │  OPEN        │  挂单中 (已进入订单簿，等待成交)                     │
│    2     │  PARTIAL     │  部分成交 (已有部分成交，剩余挂单中)                 │
│    3     │  FILLED      │  完全成交 (全部成交，订单结束)                       │
│    4     │  CANCELLED   │  已取消 (用户取消或系统取消)                         │
│    5     │  EXPIRED     │  已过期 (超过有效期自动取消)                         │
│    6     │  REJECTED    │  被拒绝 (余额不足/风控拦截等)                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 状态流转图

```
                                    ┌──────────────┐
                                    │   REJECTED   │
                                    │     (6)      │
                                    └──────────────┘
                                           ▲
                                           │ 余额不足/风控拦截
                                           │
┌──────────────┐     入库成功     ┌──────────────┐     进入订单簿     ┌──────────────┐
│   (创建)     │ ───────────────> │   PENDING    │ ─────────────────> │    OPEN      │
│              │                  │     (0)      │                    │     (1)      │
└──────────────┘                  └──────────────┘                    └──────┬───────┘
                                                                             │
                        ┌────────────────────────────────────────────────────┼────────────────────┐
                        │                                                    │                    │
                        ▼                                                    ▼                    ▼
               ┌──────────────┐                                     ┌──────────────┐    ┌──────────────┐
               │   EXPIRED    │                                     │   PARTIAL    │    │  CANCELLED   │
               │     (5)      │                                     │     (2)      │    │     (4)      │
               └──────────────┘                                     └──────┬───────┘    └──────────────┘
                                                                           │
                                                                           │ 继续成交
                                                                           ▼
                                                                    ┌──────────────┐
                                                                    │   FILLED     │
                                                                    │     (3)      │
                                                                    └──────────────┘
```

### 2.3 状态转换规则

| 当前状态 | 目标状态 | 触发条件 | 触发者 |
|----------|----------|----------|--------|
| - | PENDING | 订单创建成功，冻结成功 | eidos-trading |
| PENDING | OPEN | 订单进入订单簿 | eidos-matching |
| PENDING | REJECTED | 余额不足/风控拦截 | eidos-trading |
| OPEN | PARTIAL | 发生部分成交 | eidos-matching |
| OPEN | FILLED | 发生完全成交 | eidos-matching |
| OPEN | CANCELLED | 用户取消/系统取消 | eidos-matching |
| OPEN | EXPIRED | 订单过期 | eidos-matching |
| PARTIAL | FILLED | 剩余部分完全成交 | eidos-matching |
| PARTIAL | CANCELLED | 用户取消剩余部分 | eidos-matching |

### 2.4 幂等处理

```go
// 订单状态更新必须幂等
func (s *TradeService) UpdateOrderStatus(ctx context.Context, orderId string, newStatus OrderStatus) error {
    return s.db.Transaction(func(tx *gorm.DB) error {
        var order Order
        if err := tx.Clauses(clause.Locking{Strength: "UPDATE"}).
            Where("order_id = ?", orderId).First(&order).Error; err != nil {
            return err
        }

        // 幂等检查：如果已经是目标状态，直接返回成功
        if order.Status == newStatus {
            return nil
        }

        // 状态流转校验
        if !isValidTransition(order.Status, newStatus) {
            return ErrInvalidStateTransition
        }

        return tx.Model(&order).Update("status", newStatus).Error
    })
}
```

---

## 三、成交结算状态机

### 3.1 状态定义

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         成交结算状态枚举                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  状态值  │  状态名              │  说明                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│    0     │  MATCHED_OFFCHAIN    │  链下成交 (撮合完成，链下余额已划转)         │
│    1     │  SETTLEMENT_PENDING  │  结算待处理 (已加入结算批次，等待上链)       │
│    2     │  SETTLEMENT_SUBMITTED│  结算已提交 (交易已提交到链上，等待确认)     │
│    3     │  SETTLED_ONCHAIN     │  链上已结算 (交易确认，结算完成)             │
│    4     │  SETTLEMENT_FAILED   │  结算失败 (链上交易失败，需要重试/回滚)      │
│    5     │  ROLLED_BACK         │  已回滚 (人工确认无法恢复，余额已逆向操作)   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 状态流转图

```
┌──────────────────┐
│  MATCHED_OFFCHAIN│  ◄─── 撮合引擎产生成交
│       (0)        │
└────────┬─────────┘
         │
         │ 加入结算批次
         ▼
┌──────────────────┐
│SETTLEMENT_PENDING│  ◄─── 等待批量结算
│       (1)        │
└────────┬─────────┘
         │
         │ 提交链上交易
         ▼
┌──────────────────┐
│SETTLEMENT_SUBMITTED│ ◄─── 交易已广播
│       (2)        │
└────────┬─────────┘
         │
         ├─────────────────────────────┐
         │ 交易确认                     │ 交易失败/回滚
         ▼                             ▼
┌──────────────────┐          ┌──────────────────┐
│  SETTLED_ONCHAIN │          │ SETTLEMENT_FAILED│
│       (3)        │          │       (4)        │
└──────────────────┘          └────────┬─────────┘
                                       │
                        ┌──────────────┴──────────────┐
                        │ 重试 (最多 3 次)             │ 人工确认无法恢复
                        ▼                             ▼
               ┌──────────────────┐          ┌──────────────────┐
               │SETTLEMENT_PENDING│          │   ROLLED_BACK    │
               │       (1)        │          │       (5)        │
               └──────────────────┘          └──────────────────┘
```

### 3.3 结算批次策略

```go
// 结算批次配置
type SettlementConfig struct {
    BatchSize        int           // 每批最大成交数: 100
    BatchInterval    time.Duration // 批次间隔: 10s
    MaxRetries       int           // 最大重试次数: 3
    RetryBackoff     time.Duration // 重试退避: 30s
    ConfirmBlocks    int           // 确认区块数: 0 (Arbitrum L2)
}

// 结算批次
type SettlementBatch struct {
    BatchID     string
    Trades      []Trade
    Status      SettlementStatus
    TxHash      string
    SubmittedAt time.Time
    ConfirmedAt time.Time
    RetryCount  int
}
```

### 3.4 失败处理与回滚

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         结算失败处理流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. 检测失败类型:                                                            │
│     ├── Gas 不足 → 增加 Gas 重试                                             │
│     ├── Nonce 冲突 → 重新获取 Nonce 重试                                     │
│     ├── 合约回滚 → 分析原因，可能需要拆分批次                                 │
│     └── 网络超时 → 检查交易状态，避免重复提交                                 │
│                                                                              │
│  2. 重试策略:                                                                │
│     ├── 重试次数 < 3 → 指数退避重试 (30s, 60s, 120s)                         │
│     └── 重试次数 >= 3 → 标记为 FAILED，触发人工介入告警                       │
│                                                                              │
│  3. 人工介入:                                                                │
│     ├── 管理后台查看失败批次                                                 │
│     ├── 分析链上交易失败原因                                                 │
│     ├── 手动重试或拆分批次                                                   │
│     └── 极端情况: 回滚链下余额变动                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 重试逻辑代码实现

```go
// 结算重试配置
const (
    MaxRetryAttempts = 3
    BaseRetryDelay   = 30 * time.Second
)

// 结算失败重试处理
func (s *SettlementService) handleFailedBatch(ctx context.Context, batch *SettlementBatch) error {
    // 1. 分析失败原因
    failureType := s.analyzeFailure(batch.LastError)

    // 2. 根据失败类型决定策略
    switch failureType {
    case FailureTypeGasInsufficient:
        batch.GasPrice = batch.GasPrice * 120 / 100 // 增加 20% Gas
        return s.retryWithBackoff(ctx, batch)

    case FailureTypeNonceConflict:
        batch.Nonce = s.fetchLatestNonce(ctx, batch.FromAddress)
        return s.retryWithBackoff(ctx, batch)

    case FailureTypeContractRevert:
        // 合约回滚，尝试拆分批次
        if len(batch.Trades) > 1 {
            return s.splitAndRetry(ctx, batch)
        }
        return s.markAsFailed(ctx, batch) // 单笔仍失败，标记失败

    case FailureTypeNetworkTimeout:
        // 先检查链上状态，避免重复提交
        if confirmed, err := s.checkOnchainStatus(ctx, batch.TxHash); err == nil && confirmed {
            return s.markAsSettled(ctx, batch)
        }
        return s.retryWithBackoff(ctx, batch)
    }
    return nil
}

// 指数退避重试
func (s *SettlementService) retryWithBackoff(ctx context.Context, batch *SettlementBatch) error {
    batch.RetryCount++

    if batch.RetryCount > MaxRetryAttempts {
        // 超过最大重试次数，标记失败并告警
        s.alertService.Send(AlertCritical, "Settlement batch exceeded max retries", batch.BatchID)
        return s.markAsFailed(ctx, batch)
    }

    // 计算退避时间: 30s, 60s, 120s
    delay := BaseRetryDelay * time.Duration(1<<(batch.RetryCount-1))
    batch.NextRetryAt = time.Now().Add(delay)
    batch.Status = SettlementStatusPending

    return s.repo.UpdateBatch(ctx, batch)
}

// 回滚处理 (需人工审批)
func (s *SettlementService) rollbackBatch(ctx context.Context, batch *SettlementBatch, approverID string) error {
    // 1. 验证审批权限
    if !s.hasRollbackPermission(ctx, approverID) {
        return ErrUnauthorized
    }

    // 2. 逆向操作每笔成交的余额变动
    for _, trade := range batch.Trades {
        if err := s.accountService.ReverseTradeBalance(ctx, trade); err != nil {
            return fmt.Errorf("rollback trade %s failed: %w", trade.TradeID, err)
        }
    }

    // 3. 更新状态
    batch.Status = SettlementStatusRolledBack
    batch.RolledBackAt = time.Now()
    batch.RolledBackBy = approverID

    // 4. 记录审计日志
    s.auditLog.Record(ctx, "settlement_rollback", batch.BatchID, approverID)

    return s.repo.UpdateBatch(ctx, batch)
}
```

---

## 四、提现状态机

### 4.1 状态定义

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           提现状态枚举                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  状态值  │  状态名       │  说明                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│    0     │  PENDING      │  待处理 (用户发起，签名验证通过)                   │
│    1     │  PROCESSING   │  处理中 (风控通过，准备提交链上)                   │
│    2     │  SUBMITTED    │  已提交 (链上交易已广播)                          │
│    3     │  CONFIRMED    │  已确认 (链上交易确认，提现完成)                   │
│    4     │  FAILED       │  失败 (链上交易失败)                               │
│    5     │  CANCELLED    │  已取消 (用户取消或系统取消)                       │
│    6     │  REJECTED     │  被拒绝 (风控拦截)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 状态流转图

```
┌──────────────┐     签名验证通过     ┌──────────────┐     风控通过      ┌──────────────┐
│   (创建)     │ ──────────────────> │   PENDING    │ ────────────────> │  PROCESSING  │
│              │                      │     (0)      │                   │     (1)      │
└──────────────┘                      └──────┬───────┘                   └──────┬───────┘
                                             │                                  │
                         用户取消/超时        │                                  │ 提交链上
                                             ▼                                  ▼
                                      ┌──────────────┐                   ┌──────────────┐
                                      │  CANCELLED   │                   │  SUBMITTED   │
                                      │     (5)      │                   │     (2)      │
                                      └──────────────┘                   └──────┬───────┘
                                                                                │
                                             ┌──────────────────────────────────┼──────────────┐
                                             │                                  │              │
                                             │ 风控拦截                         │ 确认         │ 失败
                                             ▼                                  ▼              ▼
                                      ┌──────────────┐                   ┌──────────────┐ ┌──────────────┐
                                      │   REJECTED   │                   │  CONFIRMED   │ │   FAILED     │
                                      │     (6)      │                   │     (3)      │ │     (4)      │
                                      └──────────────┘                   └──────────────┘ └──────┬───────┘
                                                                                                 │
                                                                                                 │ 重试
                                                                                                 ▼
                                                                                          ┌──────────────┐
                                                                                          │  PROCESSING  │
                                                                                          │     (1)      │
                                                                                          └──────────────┘
```

### 4.3 提现幂等键

```go
// 提现幂等键: wallet + nonce
type WithdrawIdempotencyKey struct {
    Wallet string
    Nonce  uint64
}

func (k WithdrawIdempotencyKey) String() string {
    return fmt.Sprintf("%s:%d", k.Wallet, k.Nonce)
}

// 创建提现时检查幂等 (eidos-trading 服务)
func (s *AccountService) CreateWithdraw(ctx context.Context, req *WithdrawRequest) (*Withdraw, error) {
    key := WithdrawIdempotencyKey{Wallet: req.Wallet, Nonce: req.Nonce}

    // 检查是否已存在
    existing, err := s.repo.GetWithdrawByIdempotencyKey(ctx, key.String())
    if err == nil && existing != nil {
        return existing, nil // 幂等返回
    }

    // 创建新提现...
}
```

### 4.4 失败回补机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         提现失败回补流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  触发条件: 提现状态变为 FAILED                                               │
│                                                                              │
│  处理步骤:                                                                   │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │  1. 解冻提现金额                                                    │     │
│  │     UPDATE balances SET frozen = frozen - amount,                  │     │
│  │                         available = available + amount             │     │
│  │     WHERE wallet = ? AND token = ?                                 │     │
│  │                                                                    │     │
│  │  2. 记录回补流水                                                    │     │
│  │     INSERT INTO balance_logs (type='WITHDRAW_REFUND', ...)        │     │
│  │                                                                    │     │
│  │  3. 更新提现记录                                                    │     │
│  │     UPDATE withdrawals SET status='FAILED',                       │     │
│  │                           refunded_at=NOW()                       │     │
│  │     WHERE withdraw_id = ?                                         │     │
│  │                                                                    │     │
│  │  4. 发送通知                                                        │     │
│  │     Kafka: balance-updates                                        │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│  事务保证: 上述步骤在同一个数据库事务中执行                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、充值状态机

### 5.1 状态定义

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           充值状态枚举                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  状态值  │  状态名       │  说明                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│    0     │  PENDING      │  待确认 (检测到链上转账事件)                       │
│    1     │  CONFIRMED    │  已确认 (达到确认区块数)                           │
│    2     │  CREDITED     │  已入账 (链下余额已增加)                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 状态流转

```
┌──────────────┐     检测到事件     ┌──────────────┐     达到确认数     ┌──────────────┐
│  (链上事件)   │ ────────────────> │   PENDING    │ ─────────────────> │  CONFIRMED   │
│              │                    │     (0)      │                    │     (1)      │
└──────────────┘                    └──────────────┘                    └──────┬───────┘
                                                                               │
                                                                               │ 入账成功
                                                                               ▼
                                                                        ┌──────────────┐
                                                                        │   CREDITED   │
                                                                        │     (2)      │
                                                                        └──────────────┘
```

### 5.3 充值幂等键

```go
// 充值幂等键: tx_hash + log_index
type DepositIdempotencyKey struct {
    TxHash   string
    LogIndex uint
}

func (k DepositIdempotencyKey) String() string {
    return fmt.Sprintf("%s:%d", k.TxHash, k.LogIndex)
}
```

---

## 六、余额可用性语义

### 6.1 余额分类

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           余额可用性定义                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  总余额 = 可用余额 + 冻结余额                                                 │
│                                                                              │
│  可用余额 = 已结算可用 + 待结算可用                                           │
│  ├── 已结算可用: 链上已确认的余额                                            │
│  └── 待结算可用: 链下成交增加但尚未结算的余额                                 │
│                                                                              │
│  可提现余额 = 已结算可用 (只有链上确认的才能提现)                              │
│                                                                              │
│  冻结余额 = 订单冻结 + 提现冻结                                               │
│  ├── 订单冻结: 挂单占用的资金                                                │
│  └── 提现冻结: 提现处理中占用的资金                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 提现限额控制

```go
// 计算可提现余额 (eidos-trading 服务)
func (s *AccountService) GetWithdrawableBalance(ctx context.Context, wallet, token string) (*big.Int, error) {
    balance, err := s.repo.GetBalance(ctx, wallet, token)
    if err != nil {
        return nil, err
    }

    // 可提现 = 已结算可用余额
    // 不包含待结算部分，确保链上有足够资金
    return balance.SettledAvailable, nil
}

// 余额结构
type Balance struct {
    Wallet           string
    Token            string
    Available        *big.Int // 总可用 (交易可用)
    Frozen           *big.Int // 冻结
    SettledAvailable *big.Int // 已结算可用 (可提现)
    PendingSettle    *big.Int // 待结算增量
}
```

### 6.3 风险控制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           待结算余额风控                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  问题: 如果用户用待结算余额下单，而结算失败，会造成超额交易                    │
│                                                                              │
│  解决方案:                                                                   │
│                                                                              │
│  1. 待结算余额使用限额                                                       │
│     - 单用户待结算余额上限: 10,000 USDC                                      │
│     - 全系统待结算余额上限: 1,000,000 USDC                                   │
│                                                                              │
│  2. 结算频率保障                                                             │
│     - 正常: 每 10 秒结算一批                                                 │
│     - 待结算池接近阈值: 立即触发结算                                         │
│                                                                              │
│  3. 结算失败熔断                                                             │
│     - 连续 3 次结算失败: 暂停新订单，只允许取消                               │
│     - 人工介入后恢复                                                         │
│                                                                              │
│  4. 保险金兜底                                                               │
│     - 系统保险金账户: 覆盖潜在结算失败损失                                   │
│     - 定期从手续费收入补充                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、事件契约

### 7.1 Kafka 消息 Schema

```protobuf
// 成交结果事件
message TradeResultEvent {
    string trade_id = 1;
    string order_id = 2;
    string market = 3;
    string maker_wallet = 4;
    string taker_wallet = 5;
    string price = 6;
    string amount = 7;
    string quote_amount = 8;
    int64 matched_at = 9;
    SettlementStatus settlement_status = 10;
}

enum SettlementStatus {
    MATCHED_OFFCHAIN = 0;
    SETTLEMENT_PENDING = 1;
    SETTLEMENT_SUBMITTED = 2;
    SETTLED_ONCHAIN = 3;
    SETTLEMENT_FAILED = 4;
}

// 结算确认事件
message SettlementConfirmedEvent {
    string batch_id = 1;
    string tx_hash = 2;
    int64 block_number = 3;
    repeated string trade_ids = 4;
    int64 confirmed_at = 5;
}
```

### 7.2 消息顺序保证

| Topic | Partition Key | 顺序保证 |
|-------|---------------|----------|
| `orders` | `market` | 同一交易对的订单顺序 |
| `trade-results` | `market` | 同一交易对的成交顺序 |
| `balance-updates` | `wallet` | 同一用户的余额变动顺序 |
| `settlements` | `batch_id` | 同一批次的结算顺序 |
| `withdrawals` | `wallet` | 同一用户的提现顺序 |

---

## 八、监控与告警

### 8.1 关键指标

| 指标 | 阈值 | 告警级别 |
|------|------|----------|
| 待结算成交数 | > 1000 | Warning |
| 待结算成交金额 | > 500,000 USDC | Warning |
| 结算失败率 | > 1% | Critical |
| 待处理提现数 | > 100 | Warning |
| 提现处理延迟 | > 10 分钟 | Warning |
| 连续结算失败次数 | >= 3 | Critical (熔断) |

### 8.2 告警处理

```yaml
alerts:
  - name: settlement_backlog_high
    condition: pending_settlements > 1000
    action:
      - notify: slack, pagerduty
      - auto_scale: settlement workers

  - name: settlement_failure_critical
    condition: consecutive_failures >= 3
    action:
      - notify: slack, pagerduty, sms
      - circuit_break: pause_new_orders
      - require: manual_intervention
```

---

## 附录：状态转换矩阵

### A. 订单状态转换矩阵

| 当前\目标 | PENDING | OPEN | PARTIAL | FILLED | CANCELLED | EXPIRED | REJECTED |
|-----------|---------|------|---------|--------|-----------|---------|----------|
| (新建) | ✓ | - | - | - | - | - | - |
| PENDING | - | ✓ | - | - | - | - | ✓ |
| OPEN | - | - | ✓ | ✓ | ✓ | ✓ | - |
| PARTIAL | - | - | - | ✓ | ✓ | - | - |
| FILLED | - | - | - | - | - | - | - |
| CANCELLED | - | - | - | - | - | - | - |
| EXPIRED | - | - | - | - | - | - | - |
| REJECTED | - | - | - | - | - | - | - |

### B. 成交结算状态转换矩阵

| 当前\目标 | MATCHED | PENDING | SUBMITTED | SETTLED | FAILED | ROLLED_BACK |
|-----------|---------|---------|-----------|---------|--------|-------------|
| (新建) | ✓ | - | - | - | - | - |
| MATCHED | - | ✓ | - | - | - | - |
| PENDING | - | - | ✓ | - | - | - |
| SUBMITTED | - | - | - | ✓ | ✓ | - |
| SETTLED | - | - | - | - | - | - |
| FAILED | - | ✓ | - | - | - | ✓ |
| ROLLED_BACK | - | - | - | - | - | - |

> **注**: FAILED → ROLLED_BACK 转换需要人工审批，详见 [04-链上服务.md](../4-服务设计/04-链上服务.md)
