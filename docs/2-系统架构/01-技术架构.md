# Eidos 技术架构

---

## 一、架构概述

### 1.1 为什么选择混合架构?

我们采用 **链下撮合 + 链上结算** 的混合架构，这是目前最优的平衡方案:

| 架构类型 | 资金安全 | 交易速度 | Gas 成本 | 代表项目 |
|---------|---------|---------|---------|---------|
| 纯中心化 (CEX) | 低 (信任交易所) | 极快 | 无 | Binance, OKX |
| 纯链上 (DEX) | 高 | 慢 (受限于区块时间) | 高 | Uniswap |
| **混合架构** | **高** | **快** | **低** | Polymarket, dYdX |

### 1.2 核心设计理念

```
用户视角:
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│   1. 连接钱包 (MetaMask)                                                     │
│      └── 无需注册、无需 KYC                                                  │
│                                                                              │
│   2. 充值到合约                                                              │
│      └── USDC/USDT 从钱包转到链上合约，用户仍是资金的"主人"                  │
│                                                                              │
│   3. 签名下单                                                                │
│      └── 钱包弹窗，用户签名订单数据                                          │
│      └── 签名不上链，所以不花 Gas                                            │
│                                                                              │
│   4. 系统撮合                                                                │
│      └── 后端服务器快速撮合，毫秒级完成                                       │
│                                                                              │
│   5. 批量结算                                                                │
│      └── 系统定期将成交结果批量提交到链上                                    │
│      └── 用户不需要操作，系统承担 Gas                                        │
│                                                                              │
│   6. 提现                                                                    │
│      └── 用户签名提现请求，资金直接回到钱包                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 关键技术点解释

#### EIP-712 签名是什么?

EIP-712 是以太坊的一种签名标准。用户在钱包里签名时，会看到一个结构化的数据（不是乱码），知道自己在签什么:

```
┌─────────────────────────────────────────┐
│  MetaMask 签名请求                       │
├─────────────────────────────────────────┤
│                                          │
│  Eidos 请求签名:                         │
│                                          │
│  类型: 限价买单                          │
│  交易对: BTC-USDC                        │
│  价格: 50000.00                          │
│  数量: 0.1                               │
│  Nonce: 42                               │
│  过期: 2025-12-31 23:59:59               │
│                                          │
│  [拒绝]              [签名]              │
│                                          │
└─────────────────────────────────────────┘
```

签名后，后端可以通过密码学验证:
- 这个签名确实是该钱包地址的持有者签的
- 签名内容没有被篡改

#### 为什么要用 Nonce?

Nonce 是一个递增的数字，防止签名被重复使用:

```
没有 Nonce 的情况:
1. 用户签名了一个买单
2. 订单成交
3. 攻击者截获这个签名
4. 攻击者重放这个签名，再次下单
5. 用户被重复扣款!

有 Nonce 的情况:
1. 用户签名买单，Nonce = 42
2. 订单成交，系统记录 Nonce 42 已使用
3. 攻击者重放签名
4. 系统检查: Nonce 42 已使用，拒绝!
5. 用户安全
```

---

## 二、系统架构图

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层                                          │
│                                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                          │
│  │   Web 前端   │  │   交易机器人 │  │   SDK      │                          │
│  │             │  │  (用户自建)  │  │ (JS/Python) │                          │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                          │
│         │                │                │                                  │
│         │    ┌───────────┴───────────┐    │                                  │
│         │    │   钱包签名 (EIP-712)   │    │                                  │
│         │    │   MetaMask / WalletConnect                                    │
│         │    └───────────┬───────────┘    │                                  │
│         │                │                │                                  │
└─────────┴────────────────┴────────────────┴──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          网关层                                              │
│                                                                              │
│                    ┌──────────────────────┐                                  │
│                    │     API Gateway      │                                  │
│                    │                      │                                  │
│                    │  功能:               │                                  │
│                    │  - 请求路由          │                                  │
│                    │  - 限流 (防止滥用)   │                                  │
│                    │  - 负载均衡          │                                  │
│                    │  - SSL 终止          │                                  │
│                    └──────────┬───────────┘                                  │
│                               │                                              │
│              ┌────────────────┼────────────────┐                             │
│              │                │                │                             │
│              ▼                ▼                ▼                             │
│     ┌──────────────────────┐                      ┌────────────┐            │
│     │       eidos-api       │                      │  管理后台  │            │
│     │ (REST + WebSocket)    │                      │   API      │            │
│     │                      │                      │            │            │
│     │ 处理:                 │                      │ 运营功能:  │            │
│     │ - 下单/取消/查询       │                      │ - 交易对   │            │
│     │ - 行情查询/推送         │                      │ - 费率     │            │
│     │ - 限流/认证/路由         │                      │ - 监控     │            │
│     └──────────────────────┘                      └────────────┘            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        消息队列 (Kafka)                                      │
│                                                                              │
│   为什么用 Kafka?                                                            │
│   - 解耦: 服务之间不直接调用，通过消息通信                                   │
│   - 异步: 下单后不用等结算完成才返回                                         │
│   - 可靠: 消息持久化，服务重启不丢数据                                       │
│   - 回放: 可以重放消息恢复状态                                               │
│                                                                              │
│  ┌─────────┐  ┌─────────┐  ┌───────────┐  ┌─────────┐  ┌───────────┐       │
│  │ orders  │  │ trades  │  │ orderbook │  │ balance │  │settlements│       │
│  │         │  │         │  │ -updates  │  │ -updates│  │           │       │
│  │ 新订单  │  │ 成交    │  │ 深度变化  │  │ 余额变化│  │ 结算记录  │       │
│  └─────────┘  └─────────┘  └───────────┘  └─────────┘  └───────────┘       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                           │
         ┌─────────────────┼─────────────────┬─────────────────┐
         │                 │                 │                 │
         ▼                 ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          核心服务层                                          │
│                                                                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐           │
│  │  Order Service   │  │ Matching Engine  │  │ Balance Service  │           │
│  │    订单服务      │  │    撮合引擎      │  │    余额服务      │           │
│  │                  │  │   (按交易对分离)  │  │                  │           │
│  │  - 签名验证      │  │  - 内存订单簿    │  │  - 余额查询      │           │
│  │  - Nonce 检查    │  │  - 撮合算法      │  │  - 冻结/解冻     │           │
│  │  - 余额预检      │  │  - 价格优先      │  │  - 扣款/加款     │           │
│  │  - 订单入库      │  │  - 时间优先      │  │  - 流水记录      │           │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘           │
│                                                                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐           │
│  │  Market Data     │  │  Settlement      │  │  Indexer         │           │
│  │   行情服务       │  │   结算服务       │  │   索引服务       │           │
│  │                  │  │                  │  │                  │           │
│  │  - K线聚合       │  │  - 批量收集成交  │  │  - 监听链上事件  │           │
│  │  - Ticker 计算   │  │  - 构造链上交易  │  │  - 检测充值      │           │
│  │  - 深度快照      │  │  - 提交到区块链  │  │  - 同步状态      │           │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          区块链层                                            │
│                                                                              │
│  ┌────────────────────────┐  ┌────────────────────────┐                     │
│  │     Vault 合约         │  │   Exchange 合约        │                     │
│  │    (资金托管)          │  │    (交易结算)          │                     │
│  │                        │  │                        │                     │
│  │  deposit()   充值      │  │  settle()   批量结算   │                     │
│  │  withdraw()  提现      │  │                        │                     │
│  │  balanceOf() 查余额    │  │  验证签名 + 执行交易   │                     │
│  └────────────────────────┘  └────────────────────────┘                     │
│                                                                              │
│  ┌────────────────────────┐                                                  │
│  │   USDC / USDT Token    │  ← 用户的资金                                    │
│  │       (ERC-20)         │                                                  │
│  └────────────────────────┘                                                  │
│                                                                              │
│  推荐链: Arbitrum / Base / Polygon (L2，Gas 低，速度快)                      │
│                                                                              │
│  注: Phase 1 合约采用简化设计，满足测试需求即可                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据存储层                                          │
│                                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                   │
│  │  PostgreSQL  │    │ Redis Cluster│    │ TimescaleDB  │                   │
│  │              │    │   (分片集群)  │    │              │                   │
│  │  存储:       │    │              │    │  存储:       │                   │
│  │  - 订单      │    │  缓存:       │    │  - K线数据   │                   │
│  │  - 成交      │    │  - 订单簿    │    │  - 历史数据  │                   │
│  │  - 余额      │    │  - 实时行情  │    │  - 统计信息  │                   │
│  │  - 用户配置  │    │  - 限流计数  │    │              │                   │
│  └──────────────┘    │  - 会话缓存  │    └──────────────┘                   │
│                      └──────────────┘                                        │
│                                                                              │
│  Redis Cluster 架构:                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  分片策略: 16384 槽位，按 CRC16(key) % 16384 分片                   │    │
│  │                                                                      │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐         │    │
│  │  │ Shard 1   │  │ Shard 2   │  │ Shard 3   │  │ Shard N   │  ...    │    │
│  │  │ Master    │  │ Master    │  │ Master    │  │ Master    │         │    │
│  │  │ 0-5460    │  │ 5461-10922│  │10923-16383│  │           │         │    │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘         │    │
│  │        │              │              │              │                │    │
│  │  ┌─────▼─────┐  ┌─────▼─────┐  ┌─────▼─────┐  ┌─────▼─────┐         │    │
│  │  │ Replica 1 │  │ Replica 2 │  │ Replica 3 │  │ Replica N │         │    │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘         │    │
│  │                                                                      │    │
│  │  Key 设计 (确保同交易对数据在同一分片):                              │    │
│  │  - 订单簿: {BTC-USDC}:orderbook:bids                                │    │
│  │  - 行情:   {BTC-USDC}:ticker                                        │    │
│  │  - 深度:   {BTC-USDC}:depth:100                                     │    │
│  │  - 成交:   {BTC-USDC}:trades                                        │    │
│  │  → 使用 {} 包裹的部分作为 Hash Tag，确保同交易对数据落在同一节点    │    │
│  │                                                                      │    │
│  │  部署建议:                                                           │    │
│  │  - 最少 6 节点 (3 Master + 3 Replica)                               │    │
│  │  - 生产环境: 12+ 节点 (6 Master + 6 Replica)                        │    │
│  │  - 每个 Master 分配 50GB+ 内存                                      │    │
│  │  - 开启 AOF 持久化，每秒刷盘                                        │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  数据库设计原则:                                                             │
│  - 避免深度使用 PostgreSQL 特有功能                                          │
│  - 后续可能迁移到 TiDB 等分布式数据库                                        │
│  - 使用标准 SQL，不依赖特定数据库方言                                        │
│                                                                              │
│  时序数据库选型 (可替换):                                                    │
│  - TimescaleDB: PostgreSQL 扩展，与主库统一技术栈                            │
│  - InfluxDB: 专业时序数据库，性能更优                                        │
│  - ClickHouse: 列式存储，适合大规模分析                                      │
│  - TDengine: 国产时序数据库，性能优秀                                        │
│  → 通过抽象层封装，后续可按需切换                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    云托管基础设施说明 (Cloud Managed Infrastructure)         │
│                                                                              │
│  ⭐ 重要: 所有基础设施组件均使用云厂商托管服务                               │
│  ═══════════════════════════════════════════                                 │
│                                                                              │
│  本系统采用云托管模式部署基础设施，开发团队专注于应用层逻辑:                 │
│                                                                              │
│  ┌────────────────────┬────────────────────────────────────────────────┐    │
│  │ 组件               │ 云服务选型                                      │    │
│  ├────────────────────┼────────────────────────────────────────────────┤    │
│  │ PostgreSQL         │ AWS RDS / 阿里云 RDS / 腾讯云 TDSQL            │    │
│  │ Redis Cluster      │ AWS ElastiCache / 阿里云 Redis / 腾讯云 Redis  │    │
│  │ Kafka              │ AWS MSK / 阿里云 Kafka / Confluent Cloud       │    │
│  │ TimescaleDB        │ Timescale Cloud / 自建 (可选)                  │    │
│  └────────────────────┴────────────────────────────────────────────────┘    │
│                                                                              │
│  云托管优势:                                                                 │
│  ──────────                                                                  │
│  1. 自动高可用: 云服务自带主从复制、故障切换、数据备份                      │
│  2. 弹性扩展: 按需扩容，无需手动运维                                        │
│  3. 安全合规: 云厂商提供加密、审计、合规认证                                │
│  4. 监控告警: 云服务自带监控面板和告警能力                                  │
│  5. 降低运维成本: 无需专职 DBA/运维人员管理基础设施                         │
│                                                                              │
│  应用层关注点:                                                               │
│  ──────────────                                                              │
│  - 连接池配置: 合理配置数据库/Redis 连接池大小                              │
│  - 重试策略: 应用层处理临时故障的重试逻辑                                   │
│  - 健康检查: 服务启动时检查依赖组件可用性                                   │
│  - 优雅降级: 缓存不可用时的降级策略                                         │
│                                                                              │
│  配置示例 (环境变量):                                                        │
│  ────────────────────                                                        │
│  ```yaml                                                                     │
│  # 数据库 (云托管 RDS)                                                       │
│  DATABASE_URL: "postgres://user:pass@rds-endpoint:5432/eidos_db"            │
│  DB_MAX_CONNECTIONS: 100                                                     │
│  DB_MAX_IDLE_CONNECTIONS: 10                                                 │
│                                                                              │
│  # Redis (云托管 Redis Cluster)                                              │
│  REDIS_CLUSTER_NODES: "redis-cluster-endpoint:6379"                         │
│  REDIS_PASSWORD: "${REDIS_PASSWORD}"                                         │
│                                                                              │
│  # Kafka (云托管 MSK/Kafka)                                                  │
│  KAFKA_BROKERS: "kafka-broker1:9092,kafka-broker2:9092"                     │
│  KAFKA_SECURITY_PROTOCOL: "SASL_SSL"                                        │
│  ```                                                                         │
│                                                                              │
│  > 注: 本文档中关于 Redis Cluster 分片、PostgreSQL 复制等内容为架构说明，   │
│  > 实际部署时由云服务自动处理，应用层无需关心具体实现细节。                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          监控告警层 (Prometheus + Grafana)                   │
│                                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                   │
│  │  Prometheus  │    │   Grafana    │    │ AlertManager │                   │
│  │              │    │              │    │              │                   │
│  │  采集:       │    │  展示:       │    │  告警:       │                   │
│  │  - 服务指标  │    │  - 监控面板  │    │  - 规则配置  │                   │
│  │  - 系统指标  │    │  - 趋势图表  │    │  - 通知渠道  │                   │
│  │  - 业务指标  │    │  - 实时数据  │    │  - 告警历史  │                   │
│  └──────────────┘    └──────────────┘    └──────────────┘                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 关键流程

#### 下单流程详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           下单流程 (限价买单为例)                             │
│                                                                              │
│   用户            前端           Order Service      Matching       Balance   │
│    │               │                 │              Engine          Service  │
│    │               │                 │                │               │      │
│    │  1. 输入      │                 │                │               │      │
│    │  价格=49000   │                 │                │               │      │
│    │  数量=0.1     │                 │                │               │      │
│    │───────────────>                 │                │               │      │
│    │               │                 │                │               │      │
│    │  2. 前端构造订单数据            │                │               │      │
│    │  {                              │                │               │      │
│    │    market: "BTC-USDC",          │                │               │      │
│    │    side: "BUY",                 │                │               │      │
│    │    price: "49000",              │                │               │      │
│    │    size: "0.1",                 │                │               │      │
│    │    timeInForce: "GTC",          │                │               │      │
│    │    slippage: "0.01",            │                │               │      │
│    │    nonce: 42,                   │                │               │      │
│    │    expiration: 1735689600       │                │               │      │
│    │  }                              │                │               │      │
│    │               │                 │                │               │      │
│    │  3. 钱包弹窗  │                 │                │               │      │
│    │  请求签名     │                 │                │               │      │
│    │<──────────────│                 │                │               │      │
│    │               │                 │                │               │      │
│    │  4. 用户确认  │                 │                │               │      │
│    │  点击"签名"  │                 │                │               │      │
│    │───────────────>                 │                │               │      │
│    │               │                 │                │               │      │
│    │               │  5. POST /orders                 │               │      │
│    │               │  发送订单+签名  │                │               │      │
│    │               │────────────────>│                │               │      │
│    │               │                 │                │               │      │
│    │               │      6. 验证签名 (ecrecover)     │               │      │
│    │               │      恢复出签名者地址            │               │      │
│    │               │      确认 = 订单中的 maker       │               │      │
│    │               │                 │                │               │      │
│    │               │      7. 检查 Nonce               │               │      │
│    │               │      确认 42 未被使用            │               │      │
│    │               │                 │                │               │      │
│    │               │      8. 检查自成交               │               │      │
│    │               │      确认无冲突挂单              │               │      │
│    │               │                 │                │               │      │
│    │               │      9. 检查余额                 │               │      │
│    │               │      需要: 49000 × 0.1 = 4900    │               │      │
│    │               │      可用: 10000 ✓              │               │      │
│    │               │                 │                │               │      │
│    │               │      10. 冻结余额                │               │      │
│    │               │      可用: 10000 → 5100         │               │      │
│    │               │      冻结: 0 → 4900              │               │      │
│    │               │                 │                │               │      │
│    │               │                 │  11. Kafka     │               │      │
│    │               │                 │  发送订单     │               │      │
│    │               │                 │───────────────>│               │      │
│    │               │                 │                │               │      │
│    │               │                 │       12. 加入订单簿           │      │
│    │               │                 │       买单队列: [..., 49000]   │      │
│    │               │                 │                │               │      │
│    │               │                 │       13. 尝试撮合             │      │
│    │               │                 │       最优卖价 50000           │      │
│    │               │                 │       买价 49000 < 50000       │      │
│    │               │                 │       无法成交，继续挂单       │      │
│    │               │                 │                │               │      │
│    │               │  14. 返回订单确认                │               │      │
│    │               │<────────────────│                │               │      │
│    │               │                 │                │               │      │
│    │  15. 显示     │                 │                │               │      │
│    │  "挂单成功"   │                 │                │               │      │
│    │<──────────────│                 │                │               │      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 撮合流程详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           撮合流程 (发生成交)                                │
│                                                                              │
│   场景: 订单簿上有一个买单 (价格 50000, 数量 0.2)                            │
│         新来一个卖单 (市价, 数量 0.1)                                        │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  1. 订单簿状态 (撮合前)                                              │   │
│   │                                                                      │   │
│   │  卖单队列 (Asks):                                                    │   │
│   │  └── (空)                                                            │   │
│   │                                                                      │   │
│   │  买单队列 (Bids):                                                    │   │
│   │  └── 价格 50000, 数量 0.2 (挂单者: Alice)                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                              │
│                               ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  2. 新卖单到达                                                       │   │
│   │                                                                      │   │
│   │  类型: 市价卖单                                                      │   │
│   │  数量: 0.1 BTC                                                       │   │
│   │  下单者: Bob                                                         │   │
│   │  滑点设置: 1%                                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                              │
│                               ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  3. 撮合引擎处理                                                     │   │
│   │                                                                      │   │
│   │  市价卖单 → 与最优买单匹配                                           │   │
│   │  最优买价: 50000                                                     │   │
│   │  卖单数量: 0.1                                                       │   │
│   │  买单数量: 0.2                                                       │   │
│   │                                                                      │   │
│   │  成交数量: min(0.1, 0.2) = 0.1                                       │   │
│   │  成交价格: 50000 (按挂单价格成交)                                    │   │
│   │  成交金额: 50000 × 0.1 = 5000 USDC                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                              │
│                               ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  4. 计算并扣除手续费 (撮合成功后立即扣除)                            │   │
│   │                                                                      │   │
│   │  {                                                                   │   │
│   │    maker: "Alice",          // 挂单方                                │   │
│   │    taker: "Bob",            // 吃单方                                │   │
│   │    price: 50000,                                                     │   │
│   │    size: 0.1,                                                        │   │
│   │    makerFee: 2.5 USDC,      // 0.05% 从 Alice 扣除                  │   │
│   │    takerFee: 5 USDC         // 0.1% 从 Bob 扣除                     │   │
│   │  }                                                                   │   │
│   │                                                                      │   │
│   │  手续费记入平台账户                                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                              │
│                               ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  5. 更新余额                                                         │   │
│   │                                                                      │   │
│   │  Alice (买方):                                                       │   │
│   │    USDC: 冻结 -5000, 解冻后余额 -5000                                │   │
│   │    BTC:  +0.1                                                        │   │
│   │    手续费: -2.5 USDC (记入平台)                                      │   │
│   │                                                                      │   │
│   │  Bob (卖方):                                                         │   │
│   │    BTC:  -0.1                                                        │   │
│   │    USDC: +5000                                                       │   │
│   │    手续费: -5 USDC (记入平台)                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                              │
│                               ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  6. 订单簿状态 (撮合后)                                              │   │
│   │                                                                      │   │
│   │  买单队列 (Bids):                                                    │   │
│   │  └── 价格 50000, 数量 0.1 (Alice 的剩余挂单)                         │   │
│   │                                                                      │   │
│   │  Bob 的卖单已完全成交，不进入订单簿                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、服务详解

### 3.1 服务列表与职责

| 服务 | 语言 | 核心职责 | 为什么需要它 |
|------|------|---------|-------------|
| **eidos-api** | Go | REST + WebSocket (直接对外) | 处理用户请求，含限流/认证/实时推送 |
| **eidos-trading** | Go | 交易服务 (订单+清算+账户) | 下单验证+冻结+成交余额划转+充提流水 |
| **eidos-matching** | Go | 撮合引擎 | 核心！内存订单簿 + 撮合 |
| **eidos-market** | Go | 行情服务 | 生成 K 线、Ticker、深度 |
| **eidos-chain** | Go | 链上服务 (结算+索引) | 成交批量上链 + 监听区块链事件 |
| **eidos-risk** | Go | 风控服务 | 交易前同步检查 + 成交后异步监控 |
| **eidos-jobs** | Go | 定时任务 | 对账、清理、统计 |
| **eidos-admin** | Go | 后台管理 | 运营管理功能 |

> **服务合并说明**:
> - eidos-trading 整合了原 eidos-trade、eidos-clearing、eidos-account
> - eidos-chain 整合了原 eidos-settlement、eidos-indexer
> - eidos-risk 为新增的风控服务

### 3.2 前端与接入（精简）

本章仅保留核心约束：
- **对外入口**：统一由 `eidos-api` 提供 **REST + WebSocket**（WS 不单独拆服务）。
- **频道模型**：当前版本 **无私有频道**，仅公共行情/公共数据推送。
- **签名下单**：前端 EIP-712 签名，后端进行签名/nonce/过期时间校验并落库。

> **前端详细设计**：参见 [01-前端设计.md](../5-前端设计/01-前端设计.md)

### 3.3 服务通信方式

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        服务间如何通信?                                       │
│                                                                              │
│  核心原则: 后端微服务间统一使用 gRPC                                         │
│  ═══════════════════════════════════                                         │
│                                                                              │
│  为什么选择 gRPC?                                                            │
│  ─────────────────                                                           │
│  1. 高性能: 基于 HTTP/2，二进制协议，延迟低                                 │
│  2. 类型安全: 基于 Protobuf，编译时检查类型                                 │
│  3. 代码生成: 自动生成客户端/服务端代码                                     │
│  4. 多语言支持: Go 原生支持，生态成熟                                       │
│  5. 流式支持: 支持双向流，适合实时数据                                      │
│  6. 服务治理: 原生支持负载均衡、健康检查、重试                              │
│                                                                              │
│                                                                              │
│  方式1: 同步调用 (gRPC)                                                      │
│  ──────────────────────                                                      │
│  适用: 需要立即得到结果的操作                                                │
│                                                                              │
│  例子: 用户查询余额                                                          │
│  eidos-api ──gRPC──> eidos-trading ──返回余额──> eidos-api                  │
│                                                                              │
│  例子: 订单验证余额 (eidos-trading 内部处理)                                 │
│  eidos-trading: 下单+验证+冻结+清算 在同一服务内完成                         │
│                                                                              │
│  优点: 高性能、类型安全、易于维护                                            │
│  缺点: 调用方需要等待，服务挂了会影响调用方 (需配合熔断器)                  │
│                                                                              │
│                                                                              │
│  方式2: 异步消息 (Kafka)                                                     │
│  ────────────────────────                                                    │
│  适用: 不需要立即得到结果、需要解耦的操作                                    │
│                                                                              │
│  例子: 订单撮合                                                              │
│  eidos-trading ──发消息──> Kafka ──消费消息──> eidos-matching               │
│                                                                              │
│  优点: 解耦、异步、可靠                                                      │
│  缺点: 有延迟、需要处理消息顺序                                              │
│                                                                              │
│                                                                              │
│  我们的选择:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  后端微服务间同步调用 ──> gRPC (统一协议)                           │    │
│  │    - eidos-api ←→ eidos-trading                                     │    │
│  │    - eidos-api ←→ eidos-market                                      │    │
│  │    - eidos-trading ←→ eidos-risk (交易前风控检查)                   │    │
│  │    - eidos-chain ←→ eidos-trading (结算确认)                        │    │
│  │    - eidos-admin ←→ 各业务服务                                      │    │
│  │                                                                      │    │
│  │  事件驱动写入类 ──> 异步 Kafka                                      │    │
│  │    - 订单事件 (下单、取消)                                          │    │
│  │    - 成交事件                                                        │    │
│  │    - 结算事件                                                        │    │
│  │                                                                      │    │
│  │  实时推送 (ticker/depth/kline/trades) ──> Redis Pub/Sub + eidos-api(WebSocket) │
│  │                                                                      │    │
│  │  外部 API (前端/第三方) ──> REST + WebSocket                        │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.1 服务注册与发现 (Nacos)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Nacos 服务注册与发现                                    │
│                                                                              │
│  为什么需要服务注册与发现?                                                   │
│  ═══════════════════════════                                                 │
│  - gRPC 调用需要知道目标服务地址                                             │
│  - 微服务多实例部署，地址动态变化                                            │
│  - 需要健康检查，自动剔除故障节点                                            │
│  - 需要负载均衡，分发请求到多个实例                                          │
│                                                                              │
│  选型: Nacos                                                                 │
│  ════════════                                                                │
│  - 阿里开源，生产验证                                                        │
│  - 同时支持服务发现 + 配置中心                                               │
│  - Go SDK 完善                                                               │
│  - 支持健康检查、权重路由、元数据                                            │
│                                                                              │
│  架构:                                                                       │
│  ──────                                                                      │
│                                                                              │
│  ┌──────────────┐                    ┌──────────────┐                       │
│  │eidos-trading │ ──── 注册 ────────>│              │                       │
│  │ 实例1        │                    │              │                       │
│  └──────────────┘                    │              │                       │
│  ┌──────────────┐                    │    Nacos     │                       │
│  │eidos-trading │ ──── 注册 ────────>│    Cluster   │                       │
│  │ 实例2        │                    │              │                       │
│  └──────────────┘                    │              │                       │
│  ┌──────────────┐                    │              │                       │
│  │ eidos-risk   │ ──── 注册 ────────>│              │                       │
│  └──────────────┘                    └──────┬───────┘                       │
│                                             │                                │
│                                             │ 订阅                           │
│                                             ▼                                │
│  ┌──────────────┐                    ┌──────────────┐                       │
│  │ eidos-api    │ <── 获取实例列表 ──│   gRPC 客户端 │                       │
│  │              │                    │   负载均衡   │                       │
│  └──────────────┘                    └──────────────┘                       │
│                                                                              │
│  服务注册信息:                                                               │
│  ──────────────                                                              │
│  {                                                                           │
│    "serviceName": "eidos-trading",                                          │
│    "groupName": "EIDOS_GROUP",                                              │
│    "namespaceId": "eidos-prod",                                             │
│    "ip": "10.0.1.100",                                                      │
│    "port": 50051,                                                           │
│    "weight": 1.0,                                                           │
│    "healthy": true,                                                         │
│    "metadata": {                                                            │
│      "version": "1.0.0",                                                    │
│      "grpc-port": "50051"                                                   │
│    }                                                                        │
│  }                                                                          │
│                                                                              │
│  客户端集成:                                                                 │
│  ────────────                                                                │
│  1. 服务启动时向 Nacos 注册                                                  │
│  2. gRPC 客户端从 Nacos 获取实例列表                                        │
│  3. 客户端本地缓存实例列表，订阅变更                                        │
│  4. 使用 Round-Robin 或 Weight 负载均衡                                     │
│  5. 健康检查失败时自动剔除                                                   │
│                                                                              │
│  Nacos 部署:                                                                 │
│  ─────────────                                                               │
│  - 生产环境: 3 节点集群                                                      │
│  - 使用 MySQL 持久化                                                         │
│  - 开启鉴权                                                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.2 gRPC 服务定义示例 (Proto)

```protobuf
// balance_service.proto
syntax = "proto3";

package balance;

option go_package = "github.com/eidos-exchange/proto/account";

// 账户服务 (余额查询、充值、提现)
service AccountService {
    // 查询余额
    rpc GetBalance(GetBalanceRequest) returns (GetBalanceResponse);

    // 查询余额列表
    rpc GetBalances(GetBalancesRequest) returns (GetBalancesResponse);

    // 充值入账 (由 indexer 调用)
    rpc Credit(CreditRequest) returns (CreditResponse);

    // 提现申请
    rpc RequestWithdraw(WithdrawRequest) returns (WithdrawResponse);
}

message GetBalanceRequest {
    string wallet_address = 1;
    string token = 2;
}

message GetBalanceResponse {
    string available = 1;  // 可用余额
    string frozen = 2;     // 冻结余额
}

message FreezeBalanceRequest {
    string wallet_address = 1;
    string token = 2;
    string amount = 3;
    string order_id = 4;   // 关联订单
}

message FreezeBalanceResponse {
    bool success = 1;
    string error_message = 2;
}
```

```protobuf
// order_service.proto
syntax = "proto3";

package order;

option go_package = "github.com/eidos-exchange/proto/trade";

// 交易服务 (下单+验证+冻结一体)
service TradeService {
    // 创建订单 (包含签名验证 + 余额冻结)
    rpc CreateOrder(CreateOrderRequest) returns (CreateOrderResponse);

    // 取消订单 (包含余额解冻)
    rpc CancelOrder(CancelOrderRequest) returns (CancelOrderResponse);

    // 查询订单
    rpc GetOrder(GetOrderRequest) returns (GetOrderResponse);

    // 查询用户订单列表
    rpc ListOrders(ListOrdersRequest) returns (ListOrdersResponse);

    // 查询用户成交列表
    rpc ListUserTrades(ListUserTradesRequest) returns (ListUserTradesResponse);
}

message CreateOrderRequest {
    string maker = 1;
    string market = 2;
    string side = 3;
    string order_type = 4;
    string price = 5;
    string size = 6;
    string time_in_force = 7;
    string slippage = 8;
    uint64 nonce = 9;
    int64 expiration = 10;
    bytes signature = 11;
}

message CreateOrderResponse {
    bool success = 1;
    string order_id = 2;
    string error_message = 3;
}
```

#### 3.3.2 gRPC 服务间调用架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           gRPC 服务调用关系图                                │
│                                                                              │
│                          ┌──────────────────┐                                │
│                          │   api-gateway    │                                │
│                          │   (路由/限流)     │                                │
│                          └────────┬─────────┘                                │
│                                   │ REST/WS (外部)                           │
│                                   ▼                                          │
│                          ┌──────────────────┐                                │
│                          │   eidos-api      │                                │
│                          │ (REST + WebSocket)│                               │
│                          └────────┬─────────┘                                │
│                                   │                                          │
│                    ┌──────────────┼──────────────┐                           │
│                    │ gRPC         │ gRPC         │ gRPC                      │
│                    ▼              ▼              ▼                           │
│           ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                │
│           │eidos-trading │ │ eidos-market │ │  eidos-risk  │                │
│           │(订单+清算+账户)│ │  (行情服务)  │ │  (风控服务)  │                │
│           └──────┬───────┘ └──────────────┘ └──────────────┘                │
│                  │                                                           │
│                  │                                                           │
│                  │ Kafka                                                     │
│                  ▼                                                           │
│            ┌─────────────┐                                                   │
│            │   Kafka     │ (异步事件)                                        │
│            └─────┬───────┘                                                   │
│                  │                                                           │
│    ┌─────────────┼─────────────┬─────────────┐                              │
│    │             │             │             │                              │
│    ▼             ▼             ▼             ▼                              │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐                   │
│  │eidos-     │ │eidos-     │ │eidos-     │ │eidos-     │                   │
│  │matching   │ │trading    │ │chain      │ │jobs       │                   │
│  │(撮合引擎) │ │(成交处理) │ │(结算+索引)│ │(定时任务) │                   │
│  └───────────┘ └───────────┘ └─────┬─────┘ └───────────┘                   │
│                                    │ gRPC                                   │
│                                    ▼                                        │
│                             ┌───────────┐                                   │
│                             │eidos-     │                                   │
│                             │trading    │                                   │
│                             │(更新余额) │                                   │
│                             └───────────┘                                   │
│                                                                              │
│  ┌──────────────┐                                                            │
│  │ eidos-admin  │ ──gRPC──> eidos-trading, eidos-market, eidos-risk         │
│  │  (后台管理)   │                                                           │
│  └──────────────┘                                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.3 gRPC 配置与最佳实践

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           gRPC 最佳实践                                      │
│                                                                              │
│  1. 连接池管理                                                               │
│  ─────────────                                                               │
│  - 使用 gRPC 内置连接池                                                      │
│  - 配置最大连接数、空闲超时                                                  │
│  - 启用 keepalive 心跳检测                                                   │
│                                                                              │
│  2. 负载均衡                                                                 │
│  ───────────                                                                 │
│  - 客户端负载均衡 (round_robin)                                              │
│  - 配合服务注册发现 (Nacos)                                                  │
│  - 支持权重路由                                                              │
│                                                                              │
│  3. 熔断与重试                                                               │
│  ─────────────                                                               │
│  - 配置重试策略 (最大重试次数、退避算法)                                     │
│  - 集成熔断器 (如 hystrix-go 或 sentinel-golang)                            │
│  - 配置超时时间                                                              │
│                                                                              │
│  4. 监控与追踪                                                               │
│  ─────────────                                                               │
│  - gRPC 拦截器集成 Prometheus 指标                                           │
│  - 集成 OpenTelemetry 分布式追踪                                             │
│  - 记录请求日志                                                              │
│                                                                              │
│  5. 安全通信                                                                 │
│  ───────────                                                                 │
│  - 内网服务间使用 mTLS                                                       │
│  - 配置证书轮换                                                              │
│                                                                              │
│  示例 Go 配置 (参考: 3-开发规范/00-协议总表.md):                             │
│  ─────────────                                                               │
│  ```go                                                                       │
│  // gRPC 客户端配置                                                          │
│  conn, err := grpc.Dial(                                                     │
│      "eidos-trading:50051",  // 交易服务 gRPC 端口                           │
│      grpc.WithTransportCredentials(creds),                                   │
│      grpc.WithDefaultServiceConfig(`{                                        │
│          "loadBalancingConfig": [{"round_robin":{}}],                        │
│          "methodConfig": [{                                                  │
│              "name": [{"service": "trading.TradingService"}],                │
│              "timeout": "5s",                                                │
│              "retryPolicy": {                                                │
│                  "maxAttempts": 3,                                           │
│                  "initialBackoff": "0.1s",                                   │
│                  "maxBackoff": "1s",                                         │
│                  "backoffMultiplier": 2,                                     │
│                  "retryableStatusCodes": ["UNAVAILABLE"]                     │
│              }                                                               │
│          }]                                                                  │
│      }`),                                                                    │
│      grpc.WithUnaryInterceptor(                                              │
│          grpc_prometheus.UnaryClientInterceptor,                             │
│      ),                                                                      │
│  )                                                                           │
│  ```                                                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 撮合引擎概述

撮合引擎负责 **订单簿维护与撮合产生成交**，实现价格优先/时间优先。

> **详细设计**：参见 [02-撮合引擎.md](../4-服务设计/02-撮合引擎.md)

### 3.4 结算服务概述

结算负责将链下成交 **批量提交链上**，并将链上确认结果回写链下状态机。

> **详细设计**：参见 [04-链上服务.md](../4-服务设计/04-链上服务.md)

---

## 四、技术选型

### 4.1 为什么选这些技术?

| 技术 | 选型 | 为什么选它 |
|------|------|-----------|
| **后端语言** | Go (统一) | 高性能、编译型、天生支持并发、类型安全、部署简单 |
| **微服务通信** | gRPC + Protobuf | 高性能、类型安全、代码生成、HTTP/2 多路复用 |
| **前端框架** | React + TypeScript | 生态成熟、类型安全、组件化 |
| **数据库** | PostgreSQL → TiDB | 初期 PostgreSQL，后期可迁移 TiDB 分布式 |
| **缓存** | Redis Cluster | 分片集群、极快、支持多种数据结构、Pub/Sub、水平扩展 |
| **消息队列** | Kafka | 高吞吐、持久化、可回放、生态成熟 |
| **时序数据** | TimescaleDB (可替换) | 初期用 TimescaleDB，可替换为 InfluxDB/ClickHouse/TDengine |
| **区块链** | Arbitrum/Base | L2 低 Gas、快确认、EVM 兼容 |
| **监控** | Prometheus + Grafana | 业界标准、生态丰富、易于集成 |
| **服务注册发现** | Nacos | 服务注册/配置中心一体化，Go SDK 支持良好 |
| **链路追踪** | OpenTelemetry | 分布式追踪标准，支持 gRPC 拦截器 |

### 4.2 数据库设计原则

为保证后续可迁移到 TiDB 等分布式数据库:

1. **使用标准 SQL**: 避免 PostgreSQL 特有语法
2. **避免存储过程**: 逻辑放在应用层
3. **避免特殊类型**: 不使用 ARRAY、HSTORE 等
4. **合理设计主键**: 使用分布式友好的 ID 生成策略
5. **避免复杂事务**: 减少跨表事务，优先单表操作

### 4.3 数据库表设计（链接）

本章不展开表结构细节；请以协议与各服务设计文档为准：
- **协议总表（单一事实源）**：参见 [00-协议总表.md](../3-开发规范/00-协议总表.md)
- **交易相关表结构/字段语义**：参见 [01-交易服务.md](../4-服务设计/01-交易服务.md)

## 五、监控告警系统

### 5.1 Prometheus 监控指标

各服务需要暴露的核心指标:

| 服务 | 指标 | 类型 | 说明 |
|------|------|------|------|
| **eidos-matching** | `matching_latency_ms` | Histogram | 撮合延迟分布 |
| | `orderbook_depth` | Gauge | 订单簿深度 |
| | `trades_total` | Counter | 成交笔数 |
| | `orders_processed_total` | Counter | 处理订单数 |
| **eidos-trading** | `order_validation_latency_ms` | Histogram | 订单验证耗时 |
| | `signature_verify_errors` | Counter | 签名验证失败次数 |
| | `nonce_errors` | Counter | Nonce 错误次数 |
| | `freeze_errors` | Counter | 冻结失败次数 |
| | `clearing_operations_total` | Counter | 清算操作次数 |
| | `balance_transfer_errors` | Counter | 余额划转失败次数 |
| **eidos-api** | `request_latency_ms` | Histogram | 请求延迟 |
| | `request_total` | Counter | 请求总数 |
| | `rate_limit_rejected` | Counter | 限流拒绝数 |
| **eidos-chain** | `settlement_latency_ms` | Histogram | 结算延迟 |
| | `settlement_failures` | Counter | 结算失败次数 |
| | `pending_settlements` | Gauge | 待结算数量 |
| | `deposit_events_total` | Counter | 充值事件数 |
| **eidos-risk** | `risk_check_latency_ms` | Histogram | 风控检查耗时 |
| | `risk_rejections_total` | Counter | 风控拒绝次数 |
| | `blacklist_hits` | Counter | 黑名单命中次数 |

### 5.2 告警规则

| 规则名称 | 条件 | 级别 | 说明 |
|---------|------|------|------|
| **MatchingEngineDown** | 撮合引擎无响应 > 10s | Critical | 立即处理 |
| **HighMatchingLatency** | P99 延迟 > 50ms | Warning | 性能下降 |
| **OrderbookSyncLag** | 订单簿同步延迟 > 1s | Warning | 数据不一致风险 |
| **SettlementBacklog** | 待结算 > 1000 笔 | Warning | 结算积压 |
| **SettlementFailure** | 结算失败 > 3 次/分钟 | Critical | 链上问题 |
| **HighErrorRate** | 错误率 > 1% | Warning | 服务异常 |
| **DatabaseConnectionFull** | 连接池使用率 > 80% | Warning | 资源不足 |
| **KafkaLag** | 消费延迟 > 10000 条 | Warning | 消费积压 |

### 5.3 监控面板 (Grafana)

推荐的监控面板:

1. **Overview Dashboard**: 系统全局视图
   - 请求 QPS
   - 错误率
   - 延迟分布
   - 服务健康状态

2. **Trading Dashboard**: 交易视图
   - 交易量趋势
   - 撮合延迟
   - 订单簿深度
   - 手续费收入

3. **Infrastructure Dashboard**: 基础设施
   - CPU/内存使用率
   - 数据库连接数
   - Kafka 消费延迟
   - Redis 命中率

---

## 六、安全设计

### 6.1 API 安全

| 安全措施 | 实现方式 |
|---------|---------|
| **签名验证** | 所有写操作验证 EIP-712 签名 |
| **Nonce 机制** | 防止重放攻击 |
| **过期时间** | 签名带有效期 |
| **限流** | 按用户/IP 限制请求频率 |
| **HTTPS** | 全链路加密 |
| **CORS** | 限制跨域访问 |

### 6.2 服务安全

| 安全措施 | 实现方式 |
|---------|---------|
| **网络隔离** | 内部服务不暴露公网 |
| **认证授权** | 服务间 mTLS |
| **日志审计** | 所有操作记录日志 |
| **密钥管理** | 使用 Vault 管理敏感信息 |

### 6.3 数据安全

| 安全措施 | 实现方式 |
|---------|---------|
| **数据备份** | 定期备份，异地存储 |
| **加密存储** | 敏感数据加密 |
| **访问控制** | 最小权限原则 |

### 6.4 风控体系
风控为分层协作（入口限流 + 交易前校验 + 异步监控），规则与降级策略以专门文档为准。

> **详细设计**：参见 [08-风控服务.md](../4-服务设计/08-风控服务.md)

---

## 七、智能合约设计 (Demo)

Phase 1 采用简化设计，满足测试需求:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/utils/cryptography/ECDSA.sol";
import "@openzeppelin/contracts/utils/cryptography/EIP712.sol";

contract EidosExchange is EIP712 {
    using ECDSA for bytes32;

    // EIP-712 TypeHash 常量
    bytes32 public constant WITHDRAW_TYPEHASH = keccak256(
        "Withdraw(address user,address token,uint256 amount,uint256 nonce,uint256 expiration)"
    );

    // 支持的代币
    mapping(address => bool) public supportedTokens;

    // 用户余额: user => token => amount
    mapping(address => mapping(address => uint256)) public balances;

    // 已使用的 nonce
    mapping(address => mapping(uint256 => bool)) public usedNonces;

    // 管理员
    address public admin;

    // 事件
    event Deposit(address indexed user, address indexed token, uint256 amount);
    event Withdraw(address indexed user, address indexed token, uint256 amount);
    event Settled(bytes32 indexed tradeHash);

    constructor() EIP712("EidosExchange", "1") {
        admin = msg.sender;
    }

    // 添加支持的代币
    function addSupportedToken(address token) external {
        require(msg.sender == admin, "Only admin");
        supportedTokens[token] = true;
    }

    // 充值
    function deposit(address token, uint256 amount) external {
        require(supportedTokens[token], "Token not supported");
        require(amount > 0, "Amount must be positive");

        IERC20(token).transferFrom(msg.sender, address(this), amount);
        balances[msg.sender][token] += amount;

        emit Deposit(msg.sender, token, amount);
    }

    // 提现 (需要 EIP-712 签名)
    function withdraw(
        address token,
        uint256 amount,
        uint256 nonce,
        uint256 expiration,
        bytes calldata signature
    ) external {
        require(block.timestamp < expiration, "Signature expired");
        require(!usedNonces[msg.sender][nonce], "Nonce already used");
        require(balances[msg.sender][token] >= amount, "Insufficient balance");

        // 验证 EIP-712 TypedData 签名
        bytes32 structHash = keccak256(abi.encode(
            WITHDRAW_TYPEHASH,
            msg.sender,
            token,
            amount,
            nonce,
            expiration
        ));
        bytes32 digest = _hashTypedDataV4(structHash);
        address signer = ECDSA.recover(digest, signature);
        require(signer == msg.sender, "Invalid signature");

        usedNonces[msg.sender][nonce] = true;
        balances[msg.sender][token] -= amount;
        IERC20(token).transfer(msg.sender, amount);

        emit Withdraw(msg.sender, token, amount);
    }

    // 批量结算 (由系统调用)
    function settle(
        address[] calldata makers,
        address[] calldata takers,
        address[] calldata baseTokens,
        address[] calldata quoteTokens,
        uint256[] calldata baseAmounts,
        uint256[] calldata quoteAmounts
    ) external {
        require(msg.sender == admin, "Only admin");
        require(makers.length == takers.length, "Length mismatch");

        for (uint i = 0; i < makers.length; i++) {
            // 更新余额
            balances[makers[i]][baseTokens[i]] += baseAmounts[i];
            balances[makers[i]][quoteTokens[i]] -= quoteAmounts[i];
            balances[takers[i]][baseTokens[i]] -= baseAmounts[i];
            balances[takers[i]][quoteTokens[i]] += quoteAmounts[i];
        }
    }
}
```

> 注: 这是简化的 Demo 合约，用于测试。生产环境需要完整的安全审计。

---

## 八、Phase 2 扩展预留

Phase 1 的架构设计已经考虑了 Phase 2 的扩展:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Phase 2 扩展点                                        │
│                                                                              │
│  新增服务:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  risk-engine        风控引擎                                         │    │
│  │  └── 保证金计算、强平检测、风险监控                                  │    │
│  │                                                                      │    │
│  │  liquidation-engine 清算引擎                                         │    │
│  │  └── 执行强平、ADL、保险基金管理                                     │    │
│  │                                                                      │    │
│  │  funding-service    资金费率服务                                     │    │
│  │  └── 计算费率、定时结算                                              │    │
│  │                                                                      │    │
│  │  price-oracle       价格预言机                                       │    │
│  │  └── Mark Price、Index Price 计算                                   │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  数据库扩展:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  positions 表        持仓记录                                        │    │
│  │  funding_rates 表    资金费率历史                                    │    │
│  │  liquidations 表     强平记录                                        │    │
│  │  insurance_fund 表   保险基金记录                                    │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  现有服务改造:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  eidos-trading      支持合约订单参数 (杠杆、保证金模式、账户划转)    │    │
│  │  eidos-matching     支持合约仓位处理                                 │    │
│  │  eidos-risk         支持合约风控 (杠杆率检查、强平风控)              │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、开发规范

本章不展开规范细节；请以开发规范目录为准：
- [00-协议总表.md](../3-开发规范/00-协议总表.md)
- [01-设计规范.md](../3-开发规范/01-设计规范.md)
- [02-API接口规范.md](../3-开发规范/02-API接口规范.md)
- [03-幂等性规范.md](../3-开发规范/03-幂等性规范.md)
- [04-状态机规范.md](../3-开发规范/04-状态机规范.md)
- [00-设计补充-一致性与可靠性.md](../4-服务设计/00-设计补充-一致性与可靠性.md)

---
