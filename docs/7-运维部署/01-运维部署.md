# Eidos 运维部署指南

> 适用范围: 所有后端服务

---

## 一、部署架构

### 1.1 环境规划

| 环境 | 用途 | 部署方式 | 特点 |
|------|------|----------|------|
| **dev** | 本地开发 | Docker Compose 单机 | 热重载、日志详细 |
| **test** | 测试验证 | Docker Compose 多节点 | 模拟生产、可清理 |
| **prod** | 生产环境 | Kubernetes 集群 | 高可用、多副本 |

### 1.2 服务列表 (8 个进程)

| 服务 | 镜像名 | gRPC 端口 | HTTP 端口 | 说明 |
|------|--------|-----------|-----------|------|
| **eidos-api** | eidos-api | - | 8080 | REST + WebSocket 网关 |
| **eidos-trading** | eidos-trading | 50051 | 8080 | 交易服务 (订单+清算+账户) |
| **eidos-matching** | eidos-matching | 50052 | 8080 | 撮合引擎 |
| **eidos-market** | eidos-market | 50053 | 8080 | 行情服务 |
| **eidos-chain** | eidos-chain | 50054 | 8080 | 链上服务 (结算+索引) |
| **eidos-risk** | eidos-risk | 50055 | 8080 | 风控服务 |
| **eidos-jobs** | eidos-jobs | 50056 | 8080 | 定时任务 |
| **eidos-admin** | eidos-admin | - | 8088 | 管理后台 |


### 1.3 基础设施

| 组件 | 镜像 | 端口 | 用途 |
|------|------|------|------|
| PostgreSQL 16 | postgres:16 | 5432 | 主数据库 |
| TimescaleDB | timescale/timescaledb:latest-pg16 | 5433 | K线时序数据 |
| Redis 7 | redis:7 | 6379 | 缓存 + Pub/Sub |
| Kafka 3.x | confluentinc/cp-kafka | 9092 | 消息队列 |
| Zookeeper | confluentinc/cp-zookeeper | 2181 | Kafka 依赖 |
| Nacos 2.x | nacos/nacos-server | 8848 | 服务注册发现 |
| Prometheus | prom/prometheus | 9090 | 监控采集 |
| Grafana | grafana/grafana | 3000 | 监控面板 |

---

## 二、Docker Compose 部署

### 2.1 服务启动顺序

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          服务启动顺序                                        │
│                                                                              │
│  Layer 0 (基础设施):                                                         │
│    PostgreSQL → Redis → Kafka → Nacos                                       │
│                                                                              │
│  Layer 1 (核心服务):                                                         │
│    eidos-trading → eidos-matching → eidos-market                            │
│    eidos-chain → eidos-risk → eidos-jobs                                    │
│                                                                              │
│  Layer 2 (网关层):                                                           │
│    eidos-api → eidos-admin                                                  │
│                                                                              │
│  健康检查: 所有服务通过 /health/ready 探针确认就绪                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Dockerfile 设计

**多阶段构建模板**:

```dockerfile
# Stage 1: Builder
FROM golang:1.22-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
ARG SERVICE_NAME
ARG VERSION
RUN CGO_ENABLED=0 go build -ldflags="-s -w -X main.Version=${VERSION}" \
    -o /app/bin/${SERVICE_NAME} ./cmd/${SERVICE_NAME}

# Stage 2: Runtime
FROM alpine:3.19
RUN adduser -D -u 1000 eidos
COPY --from=builder /app/bin/${SERVICE_NAME} /usr/local/bin/
COPY --from=builder /app/config /etc/eidos/
USER eidos
EXPOSE 50051 8080
ENTRYPOINT ["/usr/local/bin/${SERVICE_NAME}"]
```

**安全要求**:
- 非 root 用户运行
- 只读文件系统 (除日志目录)
- 最终镜像 < 30MB

### 2.3 资源配置 (生产环境)

| 服务 | CPU 限制 | 内存限制 | 副本数 | 说明 |
|------|----------|----------|--------|------|
| eidos-trading | 4C | 8G | 2 | 无状态，水平扩展 |
| eidos-matching | 8C | 16G | 1 主 + 1 热备 | 有状态，主备模式 |
| eidos-market | 2C | 4G | 2 | 无状态 |
| eidos-chain | 2C | 4G | 2 | 无状态 |
| eidos-risk | 2C | 4G | 2 | 无状态 |
| eidos-api | 4C | 8G | 3 | 负载均衡 |
| PostgreSQL | 8C | 32G | 主从 | 同步复制 |
| Redis | 4C | 16G | 6 (3主3从) | Cluster 模式 |
| Kafka | 4C | 8G | 3 节点 | RF=3 |

### 2.4 网络规划

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Docker 网络                                         │
│                                                                              │
│  eidos-frontend (对外):                                                      │
│  ────────────────────                                                        │
│  - eidos-api: 8080 → 宿主机 8080                                            │
│  - eidos-admin: 8088 → 宿主机 8088                                          │
│                                                                              │
│  eidos-backend (内部):                                                       │
│  ─────────────────────                                                       │
│  - 所有 gRPC 服务通过容器名通信                                             │
│  - 不对外暴露                                                               │
│                                                                              │
│  eidos-infra (基础设施):                                                     │
│  ──────────────────────                                                      │
│  - PostgreSQL, Redis, Kafka, Nacos                                          │
│  - 仅内部访问                                                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.5 运维命令

```bash
# 启动所有服务
docker-compose -f docker-compose-{env}.yml up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f {service-name}

# 重启单个服务
docker-compose restart {service-name}

# 停止所有服务
docker-compose down

# 强制重建镜像
docker-compose up -d --build {service-name}
```

---

## 三、安全模型

### 3.1 信任层次

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           信任层次模型                                        │
│                                                                              │
│  Level 0: 用户端 (完全不信任)                                               │
│  ────────────────────────────                                               │
│  - 所有输入必须验签 (EIP-712)                                               │
│  - 所有参数必须校验                                                         │
│  - Nonce 防重放                                                             │
│                                                                              │
│  Level 1: API 网关 (条件信任)                                               │
│  ─────────────────────────────                                              │
│  - 验签后信任来源                                                           │
│  - 仍校验业务规则                                                           │
│  - 限流、防刷保护                                                           │
│                                                                              │
│  Level 2: 后端服务间 (内部信任)                                             │
│  ──────────────────────────────                                             │
│  - gRPC mTLS 双向认证                                                       │
│  - Kafka 消息签名                                                           │
│  - 服务网格隔离                                                             │
│                                                                              │
│  Level 3: 链上合约 (高信任)                                                 │
│  ───────────────────────────                                                │
│  - 最终权威                                                                 │
│  - 不可篡改                                                                 │
│  - 所有资金操作需要签名                                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 服务操作边界

| 组件 | 可做 | 不可做 |
|------|-----|-------|
| **eidos-trading** | 验证签名、订单管理、余额划转、清算 | 无签名操作资金 |
| **eidos-matching** | 撮合订单、生成成交 | 直接扣款 |
| **eidos-chain** | 链上结算、事件索引、调用合约 | 单独转移资金 |
| **eidos-risk** | 风控校验、异常检测 | 拦截已签名操作 |
| **热钱包** | 执行 settle/withdraw | 任意调用合约 |
| **管理后台** | 查询、配置、暂停 | 直接操作资金 |

### 3.3 威胁模型

| 威胁 | 风险等级 | 攻击面 | 缓解措施 |
|------|---------|--------|----------|
| **签名重放** | 高 | API | Nonce + 过期时间 + Redis 去重 |
| **热钱包私钥泄露** | 严重 | 服务器 | 限额 + 多签 + 监控 |
| **自成交操纵** | 中 | 撮合 | 自成交检测 + 拒绝 |
| **链下数据篡改** | 高 | 数据库 | 定期对账、链上权威 |
| **DDoS** | 中 | API | 限流 + WAF + CDN |
| **内部人员作恶** | 高 | 管理后台 | 审计日志 + 权限分离 |

### 3.4 密钥管理

| 密钥类型 | 存储位置 | 访问控制 | 轮换周期 |
|---------|---------|---------|---------|
| 热钱包私钥 | HSM/KMS | 仅 eidos-chain | 按需 |
| JWT 签名密钥 | 环境变量 | eidos-api | 30天 |
| 数据库密码 | Secrets | 各服务 | 90天 |
| Redis 密码 | Secrets | 各服务 | 90天 |

### 3.5 应急响应

| 级别 | 触发条件 | 响应时间 | 操作 | 决策人 |
|------|---------|---------|------|--------|
| **P0** | 资金被盗/合约漏洞 | 5min | 暂停合约、冻结热钱包 | 单人可操作 |
| **P1** | 安全漏洞发现 | 30min | 修复部署、审计日志 | 2人确认 |
| **P2** | 异常但无损失 | 2h | 调查分析 | 常规流程 |

---

## 四、高可用方案

### 4.1 撮合引擎高可用

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      撮合引擎主备架构                                        │
│                                                                              │
│  ┌─────────────────┐              ┌─────────────────┐                       │
│  │  Primary        │              │  Standby        │                       │
│  │  (活跃)         │              │  (热备)         │                       │
│  ├─────────────────┤              ├─────────────────┤                       │
│  │ 消费 Kafka 订单  │              │ 同步消费 Kafka  │                       │
│  │ 执行撮合        │              │ (不发送输出)    │                       │
│  │ 发送成交结果    │              │ 订单簿同步      │                       │
│  └────────┬────────┘              └────────┬────────┘                       │
│           │                                │                                 │
│           │       ZooKeeper               │                                 │
│           └──────────┬────────────────────┘                                 │
│                      │                                                       │
│                ┌─────┴─────┐                                                │
│                │  Leader   │                                                │
│                │  Election │                                                │
│                └───────────┘                                                │
│                                                                              │
│  故障切换:                                                                   │
│  - 心跳超时: 500ms                                                          │
│  - 切换时间: ~50ms (ZK Leader 选举)                                         │
│  - 数据丢失: 0 (Kafka 回放)                                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**订单簿恢复策略**:

| 恢复方式 | 数据来源 | 恢复时间 | 适用场景 |
|---------|---------|---------|---------|
| 热备接管 | 内存同步 | < 50ms | 主节点故障 |
| Redis 快照 | 每 30s 快照 | < 5s | 热备也挂 |
| Kafka 回放 | 历史消息 | < 30s | 全部重建 |

### 4.2 数据库高可用

**PostgreSQL 主从架构**:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      PostgreSQL 主从架构                                     │
│                                                                              │
│  ┌──────────┐   同步复制   ┌──────────┐                                     │
│  │  Master  │ ──────────> │  Slave   │                                     │
│  │  (读写)  │             │  (只读)  │                                     │
│  └────┬─────┘             └────┬─────┘                                     │
│       │                        │                                            │
│       └──────────┬─────────────┘                                           │
│                  │                                                          │
│            ┌─────┴─────┐                                                   │
│            │ PgBouncer │                                                   │
│            │  连接池   │                                                   │
│            └───────────┘                                                   │
│                                                                              │
│  故障切换:                                                                   │
│  - 检测时间: 10s (Patroni)                                                  │
│  - 切换时间: < 30s                                                          │
│  - 数据丢失: 0 (同步复制)                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Redis Cluster**:

| 配置 | 说明 |
|------|------|
| 节点数 | 6 (3主3从) |
| 分片数 | 3 (16384 slots) |
| 复制因子 | 1 (每主一从) |
| 故障检测 | cluster-node-timeout 5000ms |
| 自动切换 | cluster-replica-validity-factor 10 |

### 4.3 Kafka 高可用

| 配置项 | 值 | 说明 |
|--------|-----|------|
| Broker 数量 | 3 | 生产最少 3 节点 |
| min.insync.replicas | 2 | 写入需 2 副本确认 |
| replication.factor | 3 | 每 Topic 3 副本 |
| unclean.leader.election | false | 禁止脏选举 |
| acks | all | 生产者等待所有副本 |

### 4.4 RTO/RPO 目标

| 场景 | RTO | RPO | 说明 |
|------|-----|-----|------|
| 撮合引擎单节点故障 | < 1s | 0 | 热备接管 |
| 撮合引擎全部故障 | < 30s | 0 | Kafka 回放 |
| PostgreSQL 主库故障 | < 30s | 0 | 同步复制 |
| Redis 单节点故障 | < 10s | 0 | Cluster 自动切换 |
| Kafka 单 Broker 故障 | 0 | 0 | 多副本 |
| 单机房故障 | < 5min | < 1min | 异地容灾 (规划中) |

### 4.5 蓝绿/灰度部署

#### 4.5.1 部署策略选择

| 策略 | 适用场景 | 风险 | 回滚时间 |
|------|----------|------|----------|
| **蓝绿部署** | 全量发布、重大版本更新 | 低 | < 1min |
| **灰度发布** | 功能验证、A/B 测试 | 中 | < 1min |
| **滚动更新** | 小版本迭代 | 中 | 2-5min |

#### 4.5.2 蓝绿部署流程 (Kubernetes)

```yaml
# 蓝绿部署配置示例 (eidos-trading)
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: eidos-trading
spec:
  replicas: 3
  strategy:
    blueGreen:
      activeService: eidos-trading        # 生产流量入口
      previewService: eidos-trading-preview  # 预览环境
      autoPromotionEnabled: false         # 手动确认切换
      scaleDownDelaySeconds: 300          # 旧版本保留 5 分钟
  template:
    # ... Pod 模板
```

**切换流程**:

```
1. 部署新版本到 Preview 环境
   kubectl argo rollouts set image eidos-trading eidos-trading=eidos-trading:v1.1.0

2. 验证 Preview 环境
   curl -X POST http://eidos-trading-preview:8080/health/ready

3. 手动确认切换 (或自动分析)
   kubectl argo rollouts promote eidos-trading

4. 回滚 (如有问题)
   kubectl argo rollouts undo eidos-trading
```

#### 4.5.3 灰度发布配置 (基于权重)

```yaml
# Istio VirtualService 灰度配置
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: eidos-trading
spec:
  hosts:
    - eidos-trading
  http:
    - match:
        - headers:
            x-canary:
              exact: "true"  # 带标记的请求走新版本
      route:
        - destination:
            host: eidos-trading
            subset: canary
    - route:
        - destination:
            host: eidos-trading
            subset: stable
          weight: 90          # 90% 流量走稳定版本
        - destination:
            host: eidos-trading
            subset: canary
          weight: 10          # 10% 流量走灰度版本
```

#### 4.5.4 关键服务发布顺序

| 发布阶段 | 服务 | 策略 | 说明 |
|----------|------|------|------|
| 1 | eidos-jobs | 滚动 | 无状态，影响小 |
| 2 | eidos-admin | 蓝绿 | 管理后台，可离线验证 |
| 3 | eidos-market | 灰度 10% | 行情服务，可并行验证 |
| 4 | eidos-risk | 灰度 10% | 风控服务，需充分测试 |
| 5 | eidos-chain | 蓝绿 | 链上服务，需完整切换 |
| 6 | eidos-trading | 灰度 5% | 核心交易，谨慎灰度 |
| 7 | eidos-matching | **停机** | 撮合引擎需热备切换 |
| 8 | eidos-api/ws | 灰度 10% | 流量入口，最后切换 |

> **注意**: eidos-matching 撮合引擎不支持常规灰度，需使用热备切换方案 (见 4.1 节)。

---

## 五、压力测试

### 5.1 性能目标

| 指标 | 当前目标 | 后续目标 | 测量方式 |
|------|----------|----------|---------|
| 撮合引擎 TPS | 10,000/s | 100,000/s | 单引擎单交易对 |
| API 下单延迟 P50 | < 50ms | < 20ms | 端到端 |
| API 下单延迟 P99 | < 200ms | < 100ms | 端到端 |
| WebSocket 推送延迟 | < 100ms | < 50ms | 成交到推送 |
| 订单簿深度 | 10万订单 | 100万订单 | 单交易对 |

### 5.2 测试环境配置

| 组件 | 配置 | 数量 | 说明 |
|------|------|------|------|
| API 服务 | 4C 8G | 2 | eidos-api |
| 交易服务 | 4C 8G | 2 | eidos-trading |
| 撮合引擎 | 8C 16G | 1 | eidos-matching |
| 链上服务 | 4C 8G | 1 | eidos-chain |
| 风控服务 | 4C 8G | 1 | eidos-risk |

### 5.3 测试场景

**场景 1: 下单压测**

| 阶段 | 并发用户 | 目标 TPS | 持续时间 |
|------|---------|---------|---------|
| 预热 | 10 | 100 | 5min |
| 阶梯 1 | 50 | 500 | 10min |
| 阶梯 2 | 100 | 1,000 | 10min |
| 阶梯 3 | 200 | 2,000 | 10min |
| 峰值 | 500 | 5,000 | 5min |
| 稳定 | 200 | 2,000 | 30min |

**场景 2: 撮合压测**

| 订单类型 | 比例 | 说明 |
|---------|------|------|
| 限价单 (可成交) | 40% | 立即撮合 |
| 限价单 (挂单) | 40% | 进入订单簿 |
| 市价单 | 10% | 吃单 |
| 取消单 | 10% | 取消挂单 |

**场景 3: WebSocket 压测**

| 连接数 | 订阅频道 | 推送频率 |
|--------|---------|---------|
| 10,000 | ticker.* | 100/s |
| 5,000 | depth.*.20 | 50/s |
| 1,000 | orders.* | 按需 |

### 5.4 验收标准

- [ ] 持续 30 分钟达到目标 TPS
- [ ] 错误率 < 0.1%
- [ ] 无 OOM / 服务崩溃
- [ ] CPU < 80%, 内存 < 80%
- [ ] P99 延迟不超过目标值
- [ ] Kafka 消费无积压

### 5.5 性能优化检查点

| 组件 | 检查项 | 优化方向 |
|------|--------|----------|
| eidos-api | 连接池大小 | 调整 MaxOpenConns |
| eidos-trading | 签名验证 | 缓存 ecrecover 结果 |
| eidos-matching | 订单簿结构 | 红黑树 + 对象池 |
| PostgreSQL | 慢查询 | 添加索引、分表 |
| Redis | 热点 Key | 本地缓存、拆分 |
| Kafka | 分区数 | 增加 Partition |

---

## 六、监控告警

### 6.1 监控指标

**系统指标**:

| 指标 | 告警阈值 | 级别 |
|------|---------|------|
| CPU 使用率 | > 80% (5min) | Warning |
| 内存使用率 | > 80% | Warning |
| 磁盘使用率 | > 85% | Warning |
| 磁盘 IO 等待 | > 50ms | Warning |

**业务指标**:

| 指标 | 告警阈值 | 级别 | 说明 |
|------|---------|------|------|
| API 延迟 P99 | > 200ms | Warning | 接口慢 |
| API 错误率 | > 1% | Critical | 服务异常 |
| 撮合引擎心跳 | 丢失 | Critical | 需要切换 |
| Kafka 消费延迟 | > 10,000 | Warning | 处理积压 |
| 订单处理延迟 | > 100ms | Warning | 撮合慢 |
| 结算积压数 | > 1,000 | Warning | 链上拥堵 |

### 6.2 健康检查

| 服务类型 | 检查方式 | 端点 | 间隔 |
|---------|---------|------|------|
| HTTP 服务 | HTTP GET | /health/ready | 10s |
| gRPC 服务 | grpc.health.v1.Health | - | 10s |
| PostgreSQL | pg_isready | - | 10s |
| Redis | PING | - | 5s |
| Kafka | Broker 状态 | - | 30s |

### 6.3 日志收集

| 日志类型 | 采集方式 | 保留时间 |
|---------|---------|---------|
| 应用日志 | Filebeat → ES | 30天 |
| 访问日志 | Fluentd → S3 | 90天 |
| 审计日志 | 直写数据库 | 永久 |
| 链上事件 | 链上查询 | 永久 |

---

## 七、Kafka Topic 规划

| Topic | Partition | Replication | 保留时间 | 生产者 | 消费者 |
|-------|-----------|-------------|----------|--------|--------|
| orders | 16 | 3 | 7d | eidos-trading | eidos-matching |
| cancel-requests | 8 | 3 | 3d | eidos-trading | eidos-matching |
| trade-results | 16 | 3 | 30d | eidos-matching | eidos-trading, eidos-market, eidos-risk |
| order-updates | 8 | 3 | 3d | eidos-trading | eidos-api |
| orderbook-updates | 8 | 3 | 1d | eidos-matching | eidos-market |
| balance-updates | 8 | 3 | 7d | eidos-trading | eidos-api |
| deposits | 4 | 3 | 30d | eidos-chain | eidos-trading |
| withdrawals | 4 | 3 | 30d | eidos-trading | eidos-chain |
| settlements | 4 | 3 | 30d | eidos-chain | - |
| risk-alerts | 4 | 3 | 30d | eidos-risk | - |

---

## 八、故障演练

### 8.1 演练计划

| 演练项目 | 频率 | 方法 | 验收标准 |
|----------|------|------|---------|
| 撮合引擎切换 | 每月 | kill 主节点进程 | < 1s 恢复，无数据丢失 |
| 数据库切换 | 每季度 | 停止主库 | < 30s 恢复，无数据丢失 |
| Redis 节点故障 | 每季度 | 停止 1 个 master | 自动切换，服务不中断 |
| Kafka Broker 故障 | 每季度 | 停止 1 个 Broker | 生产消费不中断 |
| 全链路恢复 | 每年 | 全部停止，从备份恢复 | < 30min 恢复服务 |

### 8.2 回滚策略

| 变更类型 | 回滚方式 | 回滚时间 |
|---------|---------|---------|
| 服务部署 | 镜像回滚 | < 5min |
| 数据库迁移 | down migration | < 10min |
| 配置变更 | 配置回滚 | < 2min |
| 链上合约 | 无法回滚 | - |

### 8.3 配置发布 SOP（强制）

为避免 `eidos-trading / eidos-matching / eidos-market / eidos-risk / eidos-api` 加载到不同版本配置，配置变更必须遵循：
- **配置版本号（config_versions）**：每次变更 bump 版本号
- **版本验收**：所有相关服务必须可观测地上报当前版本（指标或内部接口）
- **发布流程**：区分“允许热更新”与“必须维护窗口发布（含停新单→切撮合→切行情→恢复）”

详细流程与 SQL 示例见：[4-服务设计/06-管理后台.md](../4-服务设计/06-管理后台.md) 的“4.1 交易对配置管理”章节。

---

