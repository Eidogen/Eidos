# Eidos 链上服务设计

> 服务名: eidos-chain
> 语言: Go

---

## 一、服务概述

### 1.1 核心定位

eidos-chain 是链上交互核心服务，整合了链上结算和链上索引两大功能模块。

**设计原则**:
- 将链上交互逻辑整合到同一服务，简化部署和运维
- Settlement 负责系统 → 链上的数据写入
- Indexer 负责链上 → 系统的数据同步

### 1.2 内部模块

```
eidos-chain
├── settlement/     结算模块 (原 eidos-settlement)
│   ├── 批量收集成交结果
│   ├── 构造链上交易
│   ├── 提交结算到区块链
│   └── 处理提现请求
└── indexer/        索引模块 (原 eidos-indexer)
    ├── 监听链上事件
    ├── 检测充值
    ├── 确认提现
    └── 同步链上状态
```

### 1.3 职责边界

| 职责 | 描述 | 属于本服务 |
|------|------|-----------|
| 成交收集 | 从 Kafka 收集成交结果 | ✅ settlement |
| 批量打包 | 合并多笔成交为一次交易 | ✅ settlement |
| 交易构造 | 构造链上交易数据 | ✅ settlement |
| 提交上链 | 发送交易到区块链 | ✅ settlement |
| 提现处理 | 处理用户提现请求 | ✅ settlement |
| 区块监听 | 监听新区块和事件 | ✅ indexer |
| 充值检测 | 检测 Deposit 事件 | ✅ indexer |
| 入账通知 | 通知余额服务入账 | ✅ indexer |
| 状态同步 | 同步链上合约状态 | ✅ indexer |
| 余额管理 | 用户余额增减 | ❌ (eidos-trading) |

### 1.4 对外能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      eidos-chain 对外能力                                    │
│                                                                              │
│  gRPC 接口:                                                                  │
│  ═══════════                                                                 │
│  - GetSettlement / RetrySettle    查询/重试结算                             │
│  - GetWithdrawTx                  查询提现交易                              │
│  - GetDeposit                     查询充值状态                              │
│  - GetBlockHeight                 查询区块高度                              │
│                                                                              │
│  Kafka 消费:                                                                 │
│  ───────────                                                                 │
│  - topic: settlements   (待结算成交)                                         │
│  - topic: withdrawals   (提现请求)                                           │
│                                                                              │
│  Kafka 生产:                                                                 │
│  ───────────                                                                 │
│  - topic: deposits              (充值事件，给 eidos-trading)                 │
│  - topic: settlement-confirmed  (结算确认)                                   │
│  - topic: withdrawal-confirmed  (提现确认)                                   │
│                                                                              │
│  链上交互:                                                                   │
│  ───────────                                                                 │
│  - Vault.deposit() 监听                                                      │
│  - Vault.withdraw() 执行                                                     │
│  - Exchange.batchSettle() 执行                                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、Settlement 模块

### 2.1 批量结算流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          批量结算流程                                        │
│                                                                              │
│  Kafka                eidos-chain.settlement              Blockchain        │
│    │                          │                              │              │
│    │ settlements              │                              │              │
│    │──────────────────────────>                              │              │
│    │                          │                              │              │
│    │                          │ 1. 收集成交                  │              │
│    │                          │    累积到批次                │              │
│    │                          │                              │              │
│    │                          │ 2. 触发条件:                 │              │
│    │                          │    - 成交数 >= 100           │              │
│    │                          │    - 或 时间 >= 5s           │              │
│    │                          │                              │              │
│    │                          │ 3. 构造批量结算交易          │              │
│    │                          │    Exchange.batchSettle()    │              │
│    │                          │─────────────────────────────>│              │
│    │                          │                              │              │
│    │                          │ 4. 等待确认                  │              │
│    │                          │<─────────────────────────────│              │
│    │                          │                              │              │
│    │                          │ 5. 更新结算状态              │              │
│    │                          │    Kafka: settlement-confirmed               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 提现处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          提现处理流程                                        │
│                                                                              │
│  1. 从 Kafka 消费提现请求                                                   │
│  2. 验证 EIP-712 签名                                                       │
│  3. 检查链上余额                                                            │
│  4. 构造提现交易 Vault.withdraw()                                           │
│  5. 等待链上确认                                                            │
│  6. 发送确认事件 Kafka: withdrawal-confirmed                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 结算失败处理策略

**设计原则:**
- 优先重试，不轻易回滚 (大多数失败是临时性的)
- 3 次重试 + 指数退避足以覆盖 99%+ 的临时故障
- 限额控制：单用户待结算上限 10,000 USDC，全系统 1,000,000 USDC

**失败类型与处理:**

| 失败类型 | 原因 | 处理策略 | 是否回滚 |
|----------|------|----------|----------|
| Gas 不足 | 热钱包 ETH 不足 | 充值 ETH 后自动重试 | ❌ |
| Nonce 冲突 | 并发提交导致 | 重新获取 Nonce 重试 | ❌ |
| 网络超时 | RPC 节点问题 | 切换节点重试 | ❌ |
| 合约 Revert | 余额不足/权限问题 | 人工分析，可能拆分批次 | ⚠️ 视情况 |
| 持续失败 | 合约 Bug/不可恢复错误 | 熔断 + 人工介入 | ✅ 可能 |

---

## 三、Indexer 模块

### 3.1 充值检测流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          充值检测流程                                        │
│                                                                              │
│  1. 监听新区块                                                               │
│  2. 解析 Deposit 事件 (user, token, amount)                                 │
│  3. 保存待确认记录                                                           │
│  4. 等待确认数达标 (Arbitrum: 0 确认即可)                                   │
│  5. 发送 Kafka: deposits 事件                                               │
│  6. eidos-trading 入账                                                       │
│  7. 更新记录状态 status = CREDITED                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 区块处理策略

- **确认数**: 所有环境 0 个确认 (Arbitrum L2 快速确认)
- **检查点机制**: 每 10 个区块或 30 秒保存检查点
- **存储**: Redis + PostgreSQL 双写
- **重启恢复**: 从检查点继续扫描

---

## 四、链上链下对账

### 4.1 对账类型

| 对账类型 | 频率 | 内容 | 处理方式 |
|----------|------|------|----------|
| **实时对账** | 每次结算后 | 验证结算交易成功 | 失败则重试/告警 |
| **定时对账** | 每小时 | 抽样用户余额校验 | 差异记录，人工处理 |
| **全量对账** | 每日 | 全部用户余额校验 | 生成对账报告 |
| **紧急对账** | 手动触发 | 指定用户/全量 | 人工发起 |

### 4.2 对账计算公式

```
链上余额 = 链下已结算余额

off_chain_settled = initial_deposit
                  + SUM(settled_deposits)
                  - SUM(confirmed_withdrawals)
                  + SUM(settled_trade_gains)
                  - SUM(settled_trade_losses)
                  - SUM(settled_fees)

校验: on_chain_balance = off_chain_settled
```

---

## 五、数据库设计

> 表名前缀: `eidos_chain_`

### 5.1 结算批次表

```sql
CREATE TABLE eidos_chain_settlement_batches (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    batch_id        VARCHAR(64) NOT NULL UNIQUE,      -- 批次唯一ID
    trade_count     INT NOT NULL,                     -- 批次包含的成交数量
    trade_ids       TEXT NOT NULL,                    -- 成交ID列表 (JSON数组格式)
    chain_id        INT NOT NULL,                     -- 链ID (42161=Arbitrum One)
    tx_hash         VARCHAR(66),                      -- 链上交易哈希 (0x开头，提交后填写)
    block_number    BIGINT,                           -- 交易所在区块号 (确认后填写)
    gas_used        BIGINT,                           -- 实际消耗的Gas数量
    gas_price       VARCHAR(36),                      -- Gas价格 (wei)
    status          SMALLINT NOT NULL DEFAULT 0,      -- 状态: 0=待提交, 1=已提交, 2=已确认, 3=失败
    error_message   VARCHAR(500),                     -- 失败原因 (失败时填写)
    retry_count     INT NOT NULL DEFAULT 0,           -- 重试次数
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    updated_at      BIGINT NOT NULL,                  -- 更新时间 (毫秒时间戳)

    INDEX idx_settlement_batches_status (status),     -- 按状态查询
    INDEX idx_settlement_batches_created_at (created_at)  -- 按时间查询
);
```

### 5.2 提现交易表

```sql
CREATE TABLE eidos_chain_withdrawal_txs (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    withdraw_id     VARCHAR(64) NOT NULL UNIQUE,      -- 提现唯一ID (来自trading服务)
    wallet_address  VARCHAR(42) NOT NULL,             -- 用户钱包地址 (发起方)
    to_address      VARCHAR(42) NOT NULL,             -- 目标地址 (接收方)
    token           VARCHAR(20) NOT NULL,             -- 代币符号
    token_address   VARCHAR(42) NOT NULL,             -- 代币合约地址
    amount          DECIMAL(36, 18) NOT NULL,         -- 提现金额
    chain_id        INT NOT NULL,                     -- 链ID
    tx_hash         VARCHAR(66),                      -- 链上交易哈希 (提交后填写)
    block_number    BIGINT,                           -- 交易所在区块号 (确认后填写)
    gas_used        BIGINT,                           -- 实际消耗的Gas数量
    status          SMALLINT NOT NULL DEFAULT 0,      -- 状态: 0=待提交, 1=已提交, 2=已确认, 3=失败
    error_message   VARCHAR(500),                     -- 失败原因 (失败时填写)
    retry_count     INT NOT NULL DEFAULT 0,           -- 重试次数
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    updated_at      BIGINT NOT NULL,                  -- 更新时间 (毫秒时间戳)

    INDEX idx_withdrawal_txs_wallet (wallet_address), -- 按用户查询
    INDEX idx_withdrawal_txs_status (status)          -- 按状态查询
);
```

### 5.3 充值记录表

```sql
-- 充值记录表 (按月分区)
-- 预估数据量: 每日 1万~10万 条
-- 分区策略: 按 created_at 时间范围分区，每月一个分区
CREATE TABLE eidos_chain_deposit_records (
    id              BIGSERIAL,                        -- 自增ID
    deposit_id      VARCHAR(64) NOT NULL,             -- 充值唯一ID
    wallet_address  VARCHAR(42) NOT NULL,             -- 用户钱包地址
    token           VARCHAR(20) NOT NULL,             -- 代币符号
    token_address   VARCHAR(42) NOT NULL,             -- 代币合约地址
    amount          DECIMAL(36, 18) NOT NULL,         -- 充值金额
    chain_id        INT NOT NULL,                     -- 链ID
    tx_hash         VARCHAR(66) NOT NULL,             -- 链上交易哈希 (幂等键，防重复入账)
    block_number    BIGINT NOT NULL,                  -- 交易所在区块号
    block_hash      VARCHAR(66) NOT NULL,             -- 区块哈希
    log_index       INT NOT NULL,                     -- 事件日志索引
    confirmations   INT NOT NULL DEFAULT 0,           -- 当前确认数
    required_confirmations INT NOT NULL,              -- 需要的确认数 (Arbitrum=0)
    status          SMALLINT NOT NULL DEFAULT 0,      -- 状态: 0=待确认, 1=已确认, 2=已入账
    credited_at     BIGINT,                           -- 入账时间 (已入账时填写)
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    updated_at      BIGINT NOT NULL,                  -- 更新时间 (毫秒时间戳)

    PRIMARY KEY (created_at, id),                     -- 分区键必须包含在主键中
    UNIQUE (deposit_id, created_at),                  -- 充值ID唯一 (包含分区键)
    UNIQUE (tx_hash, created_at)                      -- 交易哈希唯一 (包含分区键)
) PARTITION BY RANGE (created_at);

-- 分区索引
CREATE INDEX idx_deposit_records_wallet ON eidos_chain_deposit_records (wallet_address, created_at DESC);
CREATE INDEX idx_deposit_records_status ON eidos_chain_deposit_records (status) WHERE status < 2;  -- 部分索引，仅索引未完成
CREATE INDEX idx_deposit_records_block ON eidos_chain_deposit_records (chain_id, block_number);

-- 分区示例 (按月)
CREATE TABLE eidos_chain_deposit_records_2024_01 PARTITION OF eidos_chain_deposit_records
    FOR VALUES FROM (1704067200000) TO (1706745600000);
CREATE TABLE eidos_chain_deposit_records_2024_02 PARTITION OF eidos_chain_deposit_records
    FOR VALUES FROM (1706745600000) TO (1709251200000);
```

### 5.4 区块检查点表

```sql
CREATE TABLE eidos_chain_block_checkpoints (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    chain_id        INT NOT NULL UNIQUE,              -- 链ID (每条链一条记录)
    block_number    BIGINT NOT NULL,                  -- 最后处理的区块号
    block_hash      VARCHAR(66) NOT NULL,             -- 最后处理的区块哈希
    processed_at    BIGINT NOT NULL,                  -- 处理时间 (毫秒时间戳)
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    updated_at      BIGINT NOT NULL                   -- 更新时间 (毫秒时间戳)
);
```

### 5.5 链上事件表

```sql
-- 链上事件表 (按月分区)
-- 预估数据量: 每日 10万+ 条 (取决于链上活跃度)
-- 分区策略: 按 created_at 时间范围分区，每月一个分区
CREATE TABLE eidos_chain_events (
    id              BIGSERIAL,                        -- 自增ID
    chain_id        INT NOT NULL,                     -- 链ID
    block_number    BIGINT NOT NULL,                  -- 事件所在区块号
    tx_hash         VARCHAR(66) NOT NULL,             -- 交易哈希
    log_index       INT NOT NULL,                     -- 事件日志索引
    event_type      VARCHAR(50) NOT NULL,             -- 事件类型: Deposit/Withdraw/Settlement
    event_data      JSONB NOT NULL,                   -- 事件数据 (JSON格式)
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    updated_at      BIGINT NOT NULL,                  -- 更新时间 (毫秒时间戳)

    PRIMARY KEY (created_at, id),                     -- 分区键必须包含在主键中
    UNIQUE (chain_id, tx_hash, log_index, created_at) -- 同一事件唯一 (包含分区键)
) PARTITION BY RANGE (created_at);

-- 分区索引
CREATE INDEX idx_events_block ON eidos_chain_events (chain_id, block_number);
CREATE INDEX idx_events_type ON eidos_chain_events (event_type, created_at DESC);
CREATE INDEX idx_events_tx ON eidos_chain_events (tx_hash);

-- 分区示例 (按月)
CREATE TABLE eidos_chain_events_2024_01 PARTITION OF eidos_chain_events
    FOR VALUES FROM (1704067200000) TO (1706745600000);
CREATE TABLE eidos_chain_events_2024_02 PARTITION OF eidos_chain_events
    FOR VALUES FROM (1706745600000) TO (1709251200000);
```

### 5.6 结算回滚审计表

```sql
CREATE TABLE eidos_chain_settlement_rollback_logs (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    batch_id        VARCHAR(64) NOT NULL,             -- 回滚的批次ID
    trade_count     INT NOT NULL,                     -- 涉及的成交数量
    affected_users  INT NOT NULL,                     -- 受影响的用户数
    total_base_amount   DECIMAL(36, 18) NOT NULL,     -- 涉及的基础代币总量
    total_quote_amount  DECIMAL(36, 18) NOT NULL,     -- 涉及的计价代币总量
    failure_reason  VARCHAR(500) NOT NULL,            -- 结算失败原因
    rollback_reason VARCHAR(500) NOT NULL,            -- 回滚原因
    operator        VARCHAR(42) NOT NULL,             -- 操作人钱包地址
    approved_by     VARCHAR(42) NOT NULL,             -- 审批人钱包地址 (双人审批)
    rollback_at     BIGINT NOT NULL,                  -- 回滚执行时间
    original_tx_hash VARCHAR(66),                     -- 原结算交易哈希
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)

    INDEX idx_rollback_logs_batch (batch_id),         -- 按批次查询
    INDEX idx_rollback_logs_time (rollback_at)        -- 按时间查询
);
```

### 5.7 对账记录表

```sql
CREATE TABLE eidos_chain_reconciliation_records (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    wallet_address  VARCHAR(42) NOT NULL,             -- 用户钱包地址
    token           VARCHAR(20) NOT NULL,             -- 代币符号
    on_chain_balance    DECIMAL(36, 18) NOT NULL,     -- 链上余额 (从合约读取)
    off_chain_settled   DECIMAL(36, 18) NOT NULL,     -- 链下已结算余额
    off_chain_available DECIMAL(36, 18) NOT NULL,     -- 链下可用余额
    off_chain_frozen    DECIMAL(36, 18) NOT NULL,     -- 链下冻结余额
    pending_settle      DECIMAL(36, 18) NOT NULL,     -- 待结算金额
    difference      DECIMAL(36, 18) NOT NULL,         -- 差异金额 (链上-链下已结算)
    status          VARCHAR(20) NOT NULL,             -- 状态: OK/DISCREPANCY/RESOLVED/IGNORED
    resolution      VARCHAR(500),                     -- 解决方案描述
    resolved_by     VARCHAR(42),                      -- 解决人钱包地址
    resolved_at     BIGINT,                           -- 解决时间
    checked_at      BIGINT NOT NULL,                  -- 对账时间
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)

    INDEX idx_reconciliation_wallet (wallet_address), -- 按用户查询
    INDEX idx_reconciliation_status (status),         -- 按状态查询
    INDEX idx_reconciliation_checked (checked_at)     -- 按对账时间查询
);
```

---

## 六、Nonce 管理

### 6.1 问题

批量结算和提现同时使用热钱包，可能产生 Nonce 竞争。

### 6.2 解决方案

- 使用 Redis 分布式锁管理 Nonce
- AcquireNonce() → 获取并锁定
- ConfirmNonce() → 确认使用成功
- ReleaseNonce() → 释放未使用的 nonce
- SyncFromChain() → 从链上同步 nonce

### 6.3 异常处理

| 异常类型 | 处理 |
|----------|------|
| Nonce too low | 从链上同步 nonce，重试 |
| Nonce too high | 等待之前交易完成 |
| Replacement underpriced | 增加 gas price 替换 |
| Lock contention | 等待 + 指数退避 |

---

## 七、热钱包安全

### 7.1 安全架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  密钥管理层: AWS KMS / Vault / HSM                                          │
│       ↓                                                                      │
│  签名服务层: 密钥永不离开 KMS，仅对交易哈希签名                              │
│       ↓                                                                      │
│  风控层: 单笔限额、每日累计限额、大额多签审批                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 多签机制

- 大额提现 (> $10,000) 需要多签审批
- 使用 Gnosis Safe 合约
- 2/3 签名阈值

### 7.3 余额监控

- 每 5 分钟检查热钱包余额
- ETH 不足时告警 (用于 gas)
- 代币余额过低时告警

---

## 八、结算批次拆分

当批量结算合约 revert 时:

1. **二分拆分**: 将批次一分为二，分别提交
2. **逐条处理**: 当二分后仍失败，逐条提交
3. **快速失败检测**: 使用 eth_call 模拟，避免浪费 gas

---

## 九、RPC 故障切换

- 维护多个 RPC 端点池
- 每 30 秒健康检查
- 自动切换到延迟最低的健康节点
- 连续失败 3 次标记为不健康

---

## 十、Redis 缓存设计

### 10.1 Key 命名规范

```
格式: eidos:chain:{业务域}:{标识符}

示例:
- eidos:chain:nonce:{wallet}              热钱包当前 nonce
- eidos:chain:nonce:lock:{wallet}         nonce 分布式锁
- eidos:chain:deposit:{tx_hash}           充值幂等缓存
- eidos:chain:settlement:{batch_id}       结算状态缓存
- eidos:chain:withdrawal:{withdraw_id}    提现状态缓存
- eidos:chain:checkpoint:{chain_id}       区块检查点
- eidos:chain:rpc:health:{endpoint}       RPC 健康状态
- eidos:chain:gas:price                   Gas 价格缓存
```

### 10.2 缓存策略

| 缓存类型 | TTL | 一致性策略 | 用途 |
|----------|-----|------------|------|
| Nonce 缓存 | 永久 | 链上同步 | 热钱包 nonce 管理 |
| Nonce 锁 | 30s | 自动释放 | 防止并发竞争 |
| 充值幂等 | 7d | - | 防止重复入账 |
| 结算状态 | 1h | 写后更新 | 快速查询结算进度 |
| 提现状态 | 1h | 写后更新 | 快速查询提现进度 |
| 区块检查点 | 永久 | 定期更新 | 故障恢复 |
| RPC 健康 | 1m | 定期检测 | 故障切换 |
| Gas 价格 | 30s | 定期刷新 | 交易构造 |

### 10.3 Nonce 管理缓存

```
# Nonce 当前值 (使用 INCR 原子递增)
eidos:chain:nonce:{wallet} → current_nonce (INT)

# Nonce 分布式锁 (防止并发获取)
eidos:chain:nonce:lock:{wallet} → lock_holder (STRING, TTL=30s)

# 待确认交易队列 (用于 nonce 连续性检查)
eidos:chain:nonce:pending:{wallet} → [nonce1, nonce2, ...] (ZSET, score=timestamp)
```

---

## 十一、配置

```yaml
service:
  name: eidos-chain
  grpc_port: 50054

blockchain:
  rpc_url: "https://arb-mainnet.g.alchemy.com/v2/xxx"
  backup_rpc_urls:
    - "https://arb1.arbitrum.io/rpc"
  chain_id: 42161

settlement:
  batch_size: 100
  batch_interval: 5s
  retry_count: 3

indexer:
  confirmations: 0
  poll_interval: 1s
  checkpoint_interval: 10

# =============================================================================
# 安全传输配置 (云组件加密)
# =============================================================================
# 说明: 生产环境使用云托管组件，默认启用加密传输
#       本地开发/测试环境可关闭加密以简化配置
security:
  # 总开关: true=启用加密, false=关闭加密 (本地测试)
  tls_enabled: ${TLS_ENABLED:false}

  # gRPC TLS (服务间调用)
  grpc:
    enabled: ${GRPC_TLS_ENABLED:false}
    cert: "${GRPC_CERT_PATH}"
    key: "${GRPC_KEY_PATH}"
    ca_cert: "${GRPC_CA_CERT_PATH}"
    client_auth: false

  # PostgreSQL TLS (云 RDS)
  postgres:
    enabled: ${PG_TLS_ENABLED:false}
    sslmode: "verify-full"
    ca_cert: "${PG_CA_CERT_PATH}"

  # Kafka TLS/SASL
  kafka:
    enabled: ${KAFKA_TLS_ENABLED:false}
    protocol: "SASL_SSL"
    sasl_mechanism: "SCRAM-SHA-512"
    ca_cert: "${KAFKA_CA_CERT_PATH}"
    username: "${KAFKA_SASL_USERNAME}"
    password: "${KAFKA_SASL_PASSWORD}"

  # Redis TLS
  redis:
    enabled: ${REDIS_TLS_ENABLED:false}
    ca_cert: "${REDIS_CA_CERT_PATH}"
    skip_verify: false

  # 热钱包密钥管理 (云 KMS)
  kms:
    enabled: ${KMS_ENABLED:false}
    provider: "aws"                          # aws | gcp | aliyun | vault
    region: "${KMS_REGION}"
    key_id: "${KMS_KEY_ID}"                  # KMS 密钥 ID
    # AWS 专用配置
    aws_access_key: "${AWS_ACCESS_KEY_ID}"   # 建议使用 IAM Role
    aws_secret_key: "${AWS_SECRET_ACCESS_KEY}"
```

---

## 十一、监控指标

| 指标 | 说明 |
|------|------|
| chain_settlement_batches_total | 结算批次数 |
| chain_settlement_trades_total | 已结算成交数 |
| chain_settlement_duration_seconds | 结算耗时 |
| chain_withdrawals_total | 提现处理数 |
| chain_deposits_detected_total | 充值检测数 |
| chain_indexer_block_height | 当前索引高度 |
| chain_indexer_lag_blocks | 落后区块数 |
| chain_reconciliation_discrepancies | 对账差异数 |
| chain_rpc_latency_seconds | RPC 延迟 |
| chain_rpc_healthy | RPC 健康状态 |

---

## 十二、错误码

| 错误码 | 说明 |
|--------|------|
| CHAIN_SETTLEMENT_PENDING | 结算处理中 |
| CHAIN_SETTLEMENT_FAILED | 结算失败 |
| CHAIN_WITHDRAW_PENDING | 提现处理中 |
| CHAIN_WITHDRAW_FAILED | 提现失败 |
| CHAIN_INSUFFICIENT_BALANCE | 链上余额不足 |
| CHAIN_DEPOSIT_NOT_CONFIRMED | 充值未确认 |
| CHAIN_GAS_INSUFFICIENT | Gas 不足 |
| CHAIN_NONCE_CONFLICT | Nonce 冲突 |
| CHAIN_RPC_ERROR | RPC 错误 |
| CHAIN_CONTRACT_REVERT | 合约回滚 |

---

## 十三、Proto 定义

详见: `eidos-chain/api/proto/chain/v1/chain.proto`

核心接口:
- GetSettlementStatus / RetrySettlement
- GetDepositStatus / GetIndexerStatus
- GetWithdrawalStatus / GetPendingWithdrawals
- TriggerReconciliation / GetReconciliationStatus
- GetWalletBalance
