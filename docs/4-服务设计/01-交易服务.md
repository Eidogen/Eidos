# Eidos 交易服务设计

> 服务名: eidos-trading
> 语言: Go

> **补充设计**: 关于分布式一致性、Outbox Pattern、余额模型增强等内容，
> 请参阅 [00-设计补充-一致性与可靠性.md](./00-设计补充-一致性与可靠性.md)

---

## 一、服务概述

### 1.1 核心定位

eidos-trading 是交易核心服务，整合了订单管理、成交清算、账户余额三大功能模块。

**设计原则**:
- 参考 ViaBTC 撮合引擎设计，将强关联的交易逻辑整合到同一服务
- 减少跨服务调用，避免分布式事务复杂性
- 使用数据库事务保证原子性

### 1.2 内部模块

```
eidos-trading
├── order/          订单模块 (原 eidos-trade)
│   ├── 订单创建
│   ├── EIP-712 签名验证
│   ├── Nonce 管理
│   ├── 自成交检查
│   ├── 余额冻结
│   ├── 订单取消
│   └── 发送到撮合
├── clearing/       清算模块 (原 eidos-clearing)
│   ├── 成交处理
│   ├── 余额划转
│   ├── 手续费扣取
│   ├── 流水记录
│   └── 订单状态更新
└── account/        账户模块 (原 eidos-account)
    ├── 余额查询
    ├── 充值入账
    ├── 提现申请
    └── 流水查询
```

### 1.3 职责边界

| 职责 | 描述 | 属于本服务 |
|------|------|-----------|
| 订单创建 | 接收、验证、持久化新订单 | ✅ order |
| EIP-712 签名验证 | 验证用户签名有效性 | ✅ order |
| Nonce 管理 | 防重放攻击 | ✅ order |
| 余额冻结/解冻 | 下单冻结、取消解冻 | ✅ order |
| 订单取消 | 处理取消请求 | ✅ order |
| 发送到撮合 | 将订单发送到 Kafka | ✅ order |
| 成交清算 | 成交后资金划转 | ✅ clearing |
| 手续费扣取 | 按费率扣取手续费 | ✅ clearing |
| 流水记录 | 资金变动记录 | ✅ clearing |
| 余额查询 | 查询可用/冻结余额 | ✅ account |
| 充值入账 | 接收链上充值事件 | ✅ account |
| 提现申请 | 验证并扣减余额 | ✅ account |
| 订单撮合 | 订单匹配 | ❌ (eidos-matching) |
| 风控检查 | 交易前风控校验 | ❌ (eidos-risk) |

### 1.4 对外能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      eidos-trading 对外能力                                  │
│                                                                              │
│  gRPC 接口:                                                                  │
│  ═══════════                                                                 │
│                                                                              │
│  Order 模块:                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │  CreateOrder    │  │  CancelOrder    │  │  GetOrder       │              │
│  │  创建订单       │  │  取消订单       │  │  查询订单       │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │  ListOrders     │  │  GetOpenOrders  │  │  BatchCancel    │              │
│  │  查询订单列表   │  │  查询当前挂单   │  │  批量取消       │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                              │
│  Account 模块:                                                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │  GetBalance     │  │  GetBalances    │  │ RequestWithdraw │              │
│  │  查询单币种余额  │  │  查询全部余额   │  │  提现申请       │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │ GetTransactions │  │  GetDeposits    │  │ GetWithdrawals  │              │
│  │  查询流水       │  │  查询充值记录   │  │  查询提现记录   │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                              │
│  Kafka 消费:                                                                 │
│  ───────────                                                                 │
│  - topic: order-cancelled   (撮合引擎的取消确认)                             │
│  - topic: trade-results     (撮合引擎的成交结果)                             │
│  - topic: deposits          (indexer 推送的充值事件)                         │
│                                                                              │
│  Kafka 生产:                                                                 │
│  ───────────                                                                 │
│  - topic: orders            (发送新订单到撮合引擎)                           │
│  - topic: cancel-requests   (发送取消请求到撮合引擎)                         │
│  - topic: balance-updates   (余额变动事件，给 WS 推送)                       │
│  - topic: order-updates     (订单状态变化，给 WS 推送)                       │
│  - topic: settlements       (待结算记录，给 eidos-chain)                     │
│  - topic: withdrawals       (提现请求，给 eidos-chain)                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、Order 模块

### 2.1 创建订单流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           创建订单流程                                       │
│                                                                              │
│  eidos-api           eidos-trading                eidos-risk      Kafka     │
│      │                     │                          │             │       │
│      │  1. CreateOrder     │                          │             │       │
│      │  (gRPC)             │                          │             │       │
│      │────────────────────>│                          │             │       │
│      │                     │                          │             │       │
│      │                     │  2. 验证签名 (EIP-712)   │             │       │
│      │                     │                          │             │       │
│      │                     │  3. 检查 Nonce           │             │       │
│      │                     │                          │             │       │
│      │                     │  4. 风控检查 (同步)      │             │       │
│      │                     │─────────────────────────>│             │       │
│      │                     │<─────────────────────────│             │       │
│      │                     │                          │             │       │
│      │                     │  5. 自成交检查           │             │       │
│      │                     │                          │             │       │
│      │                     │  6. 计算冻结金额         │             │       │
│      │                     │     买单: price × size   │             │       │
│      │                     │     卖单: size           │             │       │
│      │                     │                          │             │       │
│      │                     │  7. BEGIN 事务           │             │       │
│      │                     │     - 检查 available >= X│             │       │
│      │                     │     - available -= X     │             │       │
│      │                     │     - frozen += X        │             │       │
│      │                     │     - INSERT order       │             │       │
│      │                     │     - INSERT nonce_used  │             │       │
│      │                     │     COMMIT               │             │       │
│      │                     │                          │             │       │
│      │                     │  8. 发送到撮合引擎 ─────────────────────>│       │
│      │                     │     topic: orders        │             │       │
│      │                     │                          │             │       │
│      │  9. 返回订单ID      │                          │             │       │
│      │<────────────────────│                          │             │       │
│                                                                              │
│  关键点:                                                                     │
│  - 余额冻结和订单创建在同一个数据库事务中                                    │
│  - 风控检查在事务前同步调用                                                  │
│  - Kafka 发送在事务外，失败则重试                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 取消订单流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           取消订单流程                                       │
│                                                                              │
│  eidos-api      eidos-trading       eidos-matching                          │
│      │                │                   │                                 │
│      │ 1. CancelOrder │                   │                                 │
│      │───────────────>│                   │                                 │
│      │                │                   │                                 │
│      │                │ 2. 验证签名       │                                 │
│      │                │                   │                                 │
│      │                │ 3. 更新订单状态   │                                 │
│      │                │ CANCELLING        │                                 │
│      │                │                   │                                 │
│      │                │ 4. 发送取消请求   │                                 │
│      │                │──────────────────>│                                 │
│      │                │   Kafka           │                                 │
│      │                │                   │                                 │
│      │                │                   │ 5. 从订单簿移除                 │
│      │                │                   │                                 │
│      │                │ 6. 取消确认       │                                 │
│      │                │<──────────────────│                                 │
│      │                │   remaining_size  │                                 │
│      │                │                   │                                 │
│      │                │ 7. BEGIN 事务     │                                 │
│      │                │    - frozen -= remaining                            │
│      │                │    - available += remaining                         │
│      │                │    - UPDATE order CANCELLED                         │
│      │                │    COMMIT         │                                 │
│      │                │                   │                                 │
│      │ 8. 返回成功    │                   │                                 │
│      │<───────────────│                   │                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 签名验证优化

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      签名验证优化策略                                        │
│                                                                              │
│  1. 签名缓存                                                                 │
│  ────────────                                                                │
│  Key:    sig_cache:{signature_hash}                                          │
│  Value:  {wallet: "0x...", valid: true, verified_at: timestamp}             │
│  TTL:    5 分钟                                                              │
│                                                                              │
│  验证流程:                                                                   │
│  func (s *OrderService) VerifySignature(order, sig) (bool, error) {         │
│      // 1. 查缓存                                                            │
│      cacheKey := sha256(sig)                                                 │
│      if cached := redis.Get(cacheKey); cached != nil {                      │
│          return cached.valid && cached.wallet == order.Maker, nil           │
│      }                                                                       │
│                                                                              │
│      // 2. 执行验证                                                          │
│      wallet, err := crypto.RecoverEIP712(order, sig)                        │
│      if err != nil {                                                         │
│          return false, err                                                   │
│      }                                                                       │
│                                                                              │
│      // 3. 写缓存                                                            │
│      redis.Set(cacheKey, {wallet, true}, 5*time.Minute)                     │
│                                                                              │
│      return wallet == order.Maker, nil                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、Clearing 模块

### 3.1 成交清算流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          成交清算流程                                        │
│                                                                              │
│  场景: Alice (买方) 以 50000 USDC 购买 0.1 BTC                              │
│        Bob (卖方) 卖出 0.1 BTC 获得 50000 USDC                               │
│        手续费: Alice (taker) 5 USDC, Bob (maker) 2.5 USDC                   │
│                                                                              │
│  Kafka                  eidos-trading.clearing              PostgreSQL      │
│    │                           │                                 │          │
│    │  trade-results            │                                 │          │
│    │  {                        │                                 │          │
│    │    trade_id: "xxx",       │                                 │          │
│    │    maker: Bob,            │                                 │          │
│    │    taker: Alice,          │                                 │          │
│    │    price: 50000,          │                                 │          │
│    │    size: 0.1,             │                                 │          │
│    │    maker_fee: 2.5,        │                                 │          │
│    │    taker_fee: 5           │                                 │          │
│    │  }                        │                                 │          │
│    │──────────────────────────>│                                 │          │
│    │                           │                                 │          │
│    │                           │  1. 幂等检查                    │          │
│    │                           │     trade_id 是否已处理?        │          │
│    │                           │                                 │          │
│    │                           │  2. BEGIN TRANSACTION           │          │
│    │                           │─────────────────────────────────>│          │
│    │                           │                                 │          │
│    │                           │  3. Alice (买方) 处理           │          │
│    │                           │     USDC: frozen -= 5000        │          │
│    │                           │     BTC: available += 0.1       │          │
│    │                           │                                 │          │
│    │                           │  4. Bob (卖方) 处理             │          │
│    │                           │     BTC: frozen -= 0.1          │          │
│    │                           │     USDC: available += 4997.5   │          │
│    │                           │                                 │          │
│    │                           │  5. 平台手续费                  │          │
│    │                           │     USDC: available += 7.5      │          │
│    │                           │                                 │          │
│    │                           │  6. 更新订单状态                │          │
│    │                           │  7. 写入 trades 表              │          │
│    │                           │  8. 写入 transactions 流水      │          │
│    │                           │                                 │          │
│    │                           │  9. COMMIT                      │          │
│    │                           │<─────────────────────────────────│          │
│    │                           │                                 │          │
│    │                           │  10. 发送事件                   │          │
│    │<──────────────────────────│     balance-updates             │          │
│    │                           │     order-updates               │          │
│    │                           │     settlements                 │          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 幂等性设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          幂等性设计                                          │
│                                                                              │
│  问题: Kafka 消息可能重复消费 (网络重试、consumer rebalance)                 │
│                                                                              │
│  解决方案: trade_id 作为幂等键                                               │
│  ═══════════════════════════════                                             │
│                                                                              │
│  1. 数据库唯一约束                                                           │
│  ────────────────────                                                        │
│  CREATE TABLE trades (                                                       │
│      trade_id VARCHAR(64) PRIMARY KEY,  -- 幂等键                            │
│      ...                                                                     │
│  );                                                                          │
│                                                                              │
│  2. 处理流程                                                                 │
│  ────────────                                                                │
│  a. 事务开始                                                                 │
│  b. SELECT 检查 trade_id 是否存在                                            │
│  c. 已存在: 直接返回成功 (幂等)                                              │
│  d. 不存在: 执行清算逻辑                                                     │
│  e. INSERT trade 记录                                                        │
│  f. 事务提交                                                                 │
│                                                                              │
│  3. 并发安全                                                                 │
│  ────────────                                                                │
│  INSERT INTO trades (trade_id, ...)                                          │
│  VALUES ($1, ...)                                                            │
│  ON CONFLICT (trade_id) DO NOTHING;                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、Account 模块

### 4.1 余额模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           余额模型                                           │
│                                                                              │
│  总余额 (Total) = 可用余额 (Available) + 冻结余额 (Frozen)                   │
│  ══════════════════════════════════════════════════════════                  │
│                                                                              │
│  用户余额示例:                                                               │
│  ────────────────                                                            │
│  USDC:                                                                       │
│    总余额:   10,000.00                                                       │
│    可用余额:  7,000.00  <- 可下单/可提现                                     │
│    冻结余额:  3,000.00  <- 挂单占用                                          │
│                                                                              │
│  余额变动场景:                                                               │
│  ──────────────                                                              │
│  1. 充值: available += amount                                                │
│  2. 提现: available -= amount (需 available >= amount)                       │
│  3. 下单冻结: available -= X, frozen += X (order 模块)                       │
│  4. 取消解冻: frozen -= X, available += X (order 模块)                       │
│  5. 成交: frozen -= X, 买方 available += Y (clearing 模块)                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 充值流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           充值流程                                           │
│                                                                              │
│  链上             eidos-chain.indexer        eidos-trading.account          │
│    │                    │                        │                          │
│    │  1. 用户转账       │                        │                          │
│    │  Vault.deposit()   │                        │                          │
│    │                    │                        │                          │
│    │  2. Deposit 事件   │                        │                          │
│    │───────────────────>│                        │                          │
│    │                    │                        │                          │
│    │                    │  3. Kafka: deposits    │                          │
│    │                    │───────────────────────>│                          │
│    │                    │                        │                          │
│    │                    │                        │  4. 幂等检查             │
│    │                    │                        │     tx_hash 存在?        │
│    │                    │                        │                          │
│    │                    │                        │  5. 入账                 │
│    │                    │                        │     available += amount  │
│    │                    │                        │                          │
│    │                    │                        │  6. 写入 deposits 表     │
│    │                    │                        │                          │
│    │                    │                        │  7. 发送 balance-updates │
│    │                    │                        │                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 提现流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           提现流程                                           │
│                                                                              │
│  用户         eidos-api    eidos-trading.account    eidos-chain       链上  │
│    │              │                  │                   │              │   │
│    │  1. 签名提现 │                  │                   │              │   │
│    │  (EIP-712)   │                  │                   │              │   │
│    │─────────────>│                  │                   │              │   │
│    │              │                  │                   │              │   │
│    │              │  2. RequestWithdraw                  │              │   │
│    │              │  (gRPC)          │                   │              │   │
│    │              │─────────────────>│                   │              │   │
│    │              │                  │                   │              │   │
│    │              │                  │  3. 验证签名      │              │   │
│    │              │                  │                   │              │   │
│    │              │                  │  4. 检查余额      │              │   │
│    │              │                  │  available >= X   │              │   │
│    │              │                  │                   │              │   │
│    │              │                  │  5. 扣减余额      │              │   │
│    │              │                  │  available -= X   │              │   │
│    │              │                  │                   │              │   │
│    │              │                  │  6. 写 withdrawals│              │   │
│    │              │                  │  status=PENDING   │              │   │
│    │              │                  │                   │              │   │
│    │              │                  │  7. Kafka         │              │   │
│    │              │                  │──────────────────>│              │   │
│    │              │                  │                   │              │   │
│    │              │                  │                   │  8. 批量提现 │   │
│    │              │                  │                   │─────────────>│   │
│    │              │                  │                   │              │   │
│    │              │                  │  9. 更新状态      │              │   │
│    │              │                  │<──────────────────│              │   │
│    │              │                  │  CONFIRMED        │              │   │
│    │              │                  │                   │              │   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、数据库设计

### 5.1 订单表 (orders)

```sql
CREATE TABLE orders (
    id              BIGSERIAL PRIMARY KEY,
    order_id        VARCHAR(64) NOT NULL UNIQUE,

    -- 用户信息
    maker           VARCHAR(42) NOT NULL,

    -- 订单信息
    market          VARCHAR(20) NOT NULL,
    side            SMALLINT NOT NULL,            -- 0=买, 1=卖
    order_type      SMALLINT NOT NULL,            -- 0=限价, 1=市价
    time_in_force   SMALLINT NOT NULL DEFAULT 0,  -- 0=GTC, 1=IOC, 2=FOK

    -- 价格数量
    price           DECIMAL(36, 18) NOT NULL,
    size            DECIMAL(36, 18) NOT NULL,
    filled_size     DECIMAL(36, 18) NOT NULL DEFAULT 0,
    remaining_size  DECIMAL(36, 18) NOT NULL,

    -- 冻结信息
    frozen_token    VARCHAR(20) NOT NULL,
    frozen_amount   DECIMAL(36, 18) NOT NULL,

    -- 签名相关
    nonce           BIGINT NOT NULL,
    expiration      BIGINT NOT NULL,
    signature       BYTEA NOT NULL,

    -- 状态
    status          SMALLINT NOT NULL DEFAULT 0,
    cancel_reason   VARCHAR(100),

    -- 审计字段
    created_at      BIGINT NOT NULL,
    updated_at      BIGINT NOT NULL,

    INDEX idx_orders_maker (maker),
    INDEX idx_orders_market_status (market, status),
    INDEX idx_orders_created_at (created_at)
);
```

### 5.2 成交表 (trades)

```sql
CREATE TABLE trades (
    trade_id        VARCHAR(64) PRIMARY KEY,

    -- 订单信息
    maker_order_id  VARCHAR(64) NOT NULL,
    taker_order_id  VARCHAR(64) NOT NULL,

    -- 用户信息
    maker           VARCHAR(42) NOT NULL,
    taker           VARCHAR(42) NOT NULL,

    -- 交易信息
    market          VARCHAR(20) NOT NULL,
    side            SMALLINT NOT NULL,            -- taker 方向
    price           DECIMAL(36, 18) NOT NULL,
    size            DECIMAL(36, 18) NOT NULL,
    quote_amount    DECIMAL(36, 18) NOT NULL,

    -- 手续费
    maker_fee       DECIMAL(36, 18) NOT NULL,
    taker_fee       DECIMAL(36, 18) NOT NULL,
    fee_token       VARCHAR(20) NOT NULL,

    -- 时间
    traded_at       BIGINT NOT NULL,

    -- 结算状态
    settlement_status   SMALLINT NOT NULL DEFAULT 0,
    settlement_batch_id VARCHAR(64),
    settlement_tx_hash  VARCHAR(66),

    -- 审计字段
    created_at      BIGINT NOT NULL,
    updated_at      BIGINT NOT NULL,

    INDEX idx_trades_market (market),
    INDEX idx_trades_maker (maker),
    INDEX idx_trades_taker (taker),
    INDEX idx_trades_traded_at (traded_at),
    INDEX idx_trades_settlement (settlement_status)
);
```

### 5.3 余额表 (balances)

```sql
CREATE TABLE balances (
    id              BIGSERIAL PRIMARY KEY,
    wallet_address  VARCHAR(42) NOT NULL,
    token           VARCHAR(20) NOT NULL,

    -- 余额 (DECIMAL 保证精度)
    available       DECIMAL(36, 18) NOT NULL DEFAULT 0,
    frozen          DECIMAL(36, 18) NOT NULL DEFAULT 0,

    -- 乐观锁
    version         BIGINT NOT NULL DEFAULT 0,

    created_at      BIGINT NOT NULL,
    updated_at      BIGINT NOT NULL,

    UNIQUE (wallet_address, token),
    CONSTRAINT chk_available_non_negative CHECK (available >= 0),
    CONSTRAINT chk_frozen_non_negative CHECK (frozen >= 0),

    INDEX idx_balances_wallet (wallet_address)
);
```

### 5.4 资金流水表 (transactions)

```sql
CREATE TABLE transactions (
    id              BIGSERIAL PRIMARY KEY,
    tx_id           VARCHAR(64) NOT NULL UNIQUE,

    wallet_address  VARCHAR(42) NOT NULL,
    token           VARCHAR(20) NOT NULL,

    -- 类型: TRADE_BUY, TRADE_SELL, FEE, DEPOSIT, WITHDRAW
    tx_type         SMALLINT NOT NULL,

    -- 金额 (正数增加，负数减少)
    amount          DECIMAL(36, 18) NOT NULL,
    balance_after   DECIMAL(36, 18) NOT NULL,

    -- 关联信息
    ref_type        VARCHAR(20),
    ref_id          VARCHAR(64),

    created_at      BIGINT NOT NULL,

    INDEX idx_tx_wallet (wallet_address),
    INDEX idx_tx_created (created_at)
);
```

### 5.5 充值表 (deposits)

```sql
CREATE TABLE deposits (
    id              BIGSERIAL PRIMARY KEY,
    deposit_id      VARCHAR(64) NOT NULL UNIQUE,

    wallet_address  VARCHAR(42) NOT NULL,
    token           VARCHAR(20) NOT NULL,
    amount          DECIMAL(36, 18) NOT NULL,

    -- 链上信息
    chain_id        INT NOT NULL,
    tx_hash         VARCHAR(66) NOT NULL UNIQUE,
    block_number    BIGINT NOT NULL,

    -- 状态: 0=待确认, 1=已确认, 2=已入账
    status          SMALLINT NOT NULL DEFAULT 0,

    created_at      BIGINT NOT NULL,
    updated_at      BIGINT NOT NULL,

    INDEX idx_deposits_wallet (wallet_address),
    INDEX idx_deposits_status (status)
);
```

### 5.6 提现表 (withdrawals)

```sql
CREATE TABLE withdrawals (
    id              BIGSERIAL PRIMARY KEY,
    withdraw_id     VARCHAR(64) NOT NULL UNIQUE,

    wallet_address  VARCHAR(42) NOT NULL,
    to_address      VARCHAR(42) NOT NULL,
    token           VARCHAR(20) NOT NULL,
    amount          DECIMAL(36, 18) NOT NULL,

    -- 签名
    nonce           BIGINT NOT NULL,
    signature       BYTEA NOT NULL,

    -- 链上信息
    tx_hash         VARCHAR(66),

    -- 状态: 0=PENDING, 1=PROCESSING, 2=SUBMITTED, 3=CONFIRMED, 4=FAILED
    status          SMALLINT NOT NULL DEFAULT 0,
    error_message   VARCHAR(500),

    created_at      BIGINT NOT NULL,
    updated_at      BIGINT NOT NULL,

    INDEX idx_withdrawals_wallet (wallet_address),
    INDEX idx_withdrawals_status (status)
);
```

---

## 六、错误码

```go
const (
    // 签名相关
    ErrCodeInvalidSignature    = "TRADING_INVALID_SIGNATURE"
    ErrCodeSignerMismatch      = "TRADING_SIGNER_MISMATCH"
    ErrCodeOrderExpired        = "TRADING_ORDER_EXPIRED"

    // Nonce 相关
    ErrCodeNonceAlreadyUsed    = "TRADING_NONCE_ALREADY_USED"

    // 余额相关
    ErrCodeInsufficientBalance = "TRADING_INSUFFICIENT_BALANCE"

    // 订单相关
    ErrCodeOrderNotFound       = "TRADING_ORDER_NOT_FOUND"
    ErrCodeOrderNotCancellable = "TRADING_ORDER_NOT_CANCELLABLE"
    ErrCodeSelfTradeNotAllowed = "TRADING_SELF_TRADE_NOT_ALLOWED"

    // 市场相关
    ErrCodeMarketNotFound      = "TRADING_MARKET_NOT_FOUND"
    ErrCodeMarketSuspended     = "TRADING_MARKET_SUSPENDED"

    // 风控相关
    ErrCodeRiskRejected        = "TRADING_RISK_REJECTED"

    // 提现相关
    ErrCodeWithdrawMinAmount   = "TRADING_WITHDRAW_MIN_AMOUNT"
    ErrCodeWithdrawDailyLimit  = "TRADING_WITHDRAW_DAILY_LIMIT"
)
```

---

## 七、配置

```yaml
service:
  name: eidos-trading
  grpc_port: 50051
  http_port: 8080

# 数据库 (所有模块共享)
postgres:
  host: postgres
  port: 5432
  database: eidos_trading
  max_connections: 200

# Redis
redis:
  cluster:
    nodes:
      - redis-1:6379
      - redis-2:6379
      - redis-3:6379
  nonce_ttl: 604800      # 7 天
  sig_cache_ttl: 300     # 5 分钟

# Kafka
kafka:
  brokers:
    - kafka-1:9092
    - kafka-2:9092
    - kafka-3:9092
  consumer:
    group_id: eidos-trading
    topics:
      - order-cancelled
      - trade-results
      - deposits
    batch_size: 100
  producer:
    topics:
      orders: orders
      cancel_requests: cancel-requests
      balance_updates: balance-updates
      order_updates: order-updates
      settlements: settlements
      withdrawals: withdrawals

# EIP-712
eip712:
  domain:
    name: "EidosExchange"
    version: "1"
    chain_id: 42161
    verifying_contract: "0x..."

# 风控服务
risk:
  enabled: true
  grpc_addr: "eidos-risk:50055"
  timeout: 100ms         # 风控检查超时

# 业务限制
limits:
  max_open_orders_per_user_per_market: 200
  min_order_value: "10"      # USDC
  max_order_value: "1000000" # USDC

# 手续费账户
fee_account:
  wallet: "0xFEE..."

# 支持的代币
tokens:
  - symbol: USDC
    decimals: 6
    min_deposit: "10"
    min_withdraw: "10"
  - symbol: BTC
    decimals: 8
    min_deposit: "0.0001"
    min_withdraw: "0.0001"
```

---

## 八、监控指标

```go
var (
    // Order 模块
    orderCreatedTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "trading_order_created_total",
            Help: "Total orders created",
        },
        []string{"market", "side", "order_type"},
    )

    signatureVerifyDuration = prometheus.NewHistogram(
        prometheus.HistogramOpts{
            Name:    "trading_signature_verify_seconds",
            Help:    "Signature verification duration",
            Buckets: []float64{0.001, 0.005, 0.01, 0.05, 0.1},
        },
    )

    // Clearing 模块
    tradesProcessed = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "trading_trades_processed_total",
            Help: "Total trades processed",
        },
        []string{"market"},
    )

    clearingDuration = prometheus.NewHistogram(
        prometheus.HistogramOpts{
            Name:    "trading_clearing_duration_seconds",
            Help:    "Clearing processing duration",
            Buckets: []float64{0.001, 0.005, 0.01, 0.05, 0.1},
        },
    )

    feesCollected = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "trading_fees_collected_total",
            Help: "Total fees collected",
        },
        []string{"token"},
    )

    // Account 模块
    depositTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "trading_deposit_total",
            Help: "Total deposits",
        },
        []string{"token", "status"},
    )

    withdrawTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "trading_withdraw_total",
            Help: "Total withdrawals",
        },
        []string{"token", "status"},
    )

    // Kafka 消费延迟
    kafkaLag = prometheus.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "trading_kafka_consumer_lag",
            Help: "Kafka consumer lag",
        },
        []string{"topic"},
    )
)
```

---

## 九、扩展规划 (永续合约)

> **状态**: 架构预留，后续实现

### 9.1 模块结构规划

```
eidos-trading/
├── internal/
│   ├── spot/              # 现货模块 (当前实现)
│   │   ├── order.go       # 现货订单
│   │   └── clearing.go    # 现货清算
│   │
│   ├── perpetual/         # 永续模块 (后续新增)
│   │   ├── order.go       # 永续订单
│   │   ├── position.go    # 仓位管理
│   │   ├── margin.go      # 保证金计算
│   │   └── funding.go     # 资金费率处理
│   │
│   ├── account/           # 账户模块 (共用)
│   │   └── balance.go     # 余额管理
│   │
│   └── common/            # 公共模块
│       ├── signature.go   # EIP-712 签名验证
│       ├── nonce.go       # Nonce 管理
│       └── kafka.go       # Kafka 生产/消费
```

### 9.2 永续合约新增组件

| 模块 | 文件 | 职责 |
|-----|------|------|
| `perpetual/order.go` | 永续订单 | 永续订单创建、验证、开仓/平仓判断 |
| `perpetual/position.go` | 仓位管理 | 仓位开/平、均价计算、未实现盈亏 |
| `perpetual/margin.go` | 保证金引擎 | 初始保证金、维持保证金、保证金率计算 |
| `perpetual/funding.go` | 资金费率 | 资金费率结算处理 (每 8 小时) |

### 9.3 新增数据表

```sql
-- 永续仓位表
CREATE TABLE positions (
    id              BIGSERIAL PRIMARY KEY,
    wallet_address  VARCHAR(42) NOT NULL,
    market          VARCHAR(20) NOT NULL,      -- BTC-USDC-PERP

    -- 仓位信息
    side            SMALLINT NOT NULL,          -- 0=LONG, 1=SHORT
    size            DECIMAL(36, 18) NOT NULL,   -- 仓位大小
    entry_price     DECIMAL(36, 18) NOT NULL,   -- 开仓均价
    leverage        SMALLINT NOT NULL,          -- 杠杆倍数

    -- 保证金
    margin          DECIMAL(36, 18) NOT NULL,   -- 保证金金额
    margin_token    VARCHAR(20) NOT NULL,       -- 保证金币种

    -- 计算字段 (实时更新)
    unrealized_pnl  DECIMAL(36, 18) NOT NULL DEFAULT 0,
    liquidation_price DECIMAL(36, 18),

    -- 状态
    status          SMALLINT NOT NULL DEFAULT 0, -- 0=OPEN, 1=CLOSED, 2=LIQUIDATED

    created_at      BIGINT NOT NULL,
    updated_at      BIGINT NOT NULL,

    UNIQUE (wallet_address, market),
    INDEX idx_positions_wallet (wallet_address),
    INDEX idx_positions_market (market)
);

-- 资金费率历史表
CREATE TABLE funding_rates (
    id              BIGSERIAL PRIMARY KEY,
    market          VARCHAR(20) NOT NULL,
    funding_rate    DECIMAL(18, 8) NOT NULL,    -- 资金费率 (可正可负)
    funding_time    BIGINT NOT NULL,            -- 结算时间

    UNIQUE (market, funding_time),
    INDEX idx_funding_market (market)
);

-- 资金费率结算记录
CREATE TABLE funding_settlements (
    id              BIGSERIAL PRIMARY KEY,
    wallet_address  VARCHAR(42) NOT NULL,
    market          VARCHAR(20) NOT NULL,
    position_size   DECIMAL(36, 18) NOT NULL,
    funding_rate    DECIMAL(18, 8) NOT NULL,
    payment         DECIMAL(36, 18) NOT NULL,   -- 正数=收取，负数=支付
    funding_time    BIGINT NOT NULL,

    INDEX idx_funding_settlements_wallet (wallet_address)
);
```

### 9.4 新增服务: eidos-liquidator

永续合约需要独立的清算服务，不放在 eidos-trading 内：

```
eidos-liquidator/          # 独立服务 (后续新增)
├── cmd/
│   └── main.go
├── internal/
│   ├── monitor/           # 仓位监控
│   │   ├── margin_monitor.go  # 保证金率实时监控
│   │   └── price_feed.go      # 标记价格订阅
│   ├── engine/            # 强平引擎
│   │   ├── liquidator.go      # 强平逻辑
│   │   └── adl.go             # 自动减仓 (ADL)
│   └── client/            # 外部调用
│       └── trading_client.go  # 调用 eidos-trading
```

**强平服务独立的原因**:
- 强平必须独立运行，即使 trading 服务故障
- 强平订单具有最高优先级
- 安全隔离，便于独立审计

### 9.5 架构对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    现货 vs 永续 架构对比                                      │
│                                                                              │
│  现货 (v1.0):                                                                │
│  ────────────                                                                │
│  eidos-trading                                                               │
│  ├── order/      订单管理                                                    │
│  ├── clearing/   成交清算                                                    │
│  └── account/    账户余额                                                    │
│                                                                              │
│  永续 (v2.0):                                                                │
│  ────────────                                                                │
│  eidos-trading (扩展)                                                        │
│  ├── spot/        现货模块 (原有)                                            │
│  ├── perpetual/   永续模块 (新增)                                            │
│  │   ├── 永续订单                                                            │
│  │   ├── 仓位管理                                                            │
│  │   ├── 保证金计算                                                          │
│  │   └── 资金费率                                                            │
│  └── account/     账户模块 (共用)                                            │
│                                                                              │
│  eidos-liquidator (新增独立服务)                                             │
│  └── 强平监控 + 执行                                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.6 接口扩展预留

```protobuf
// 永续订单接口 (后续实现)
service PerpetualOrderService {
    // 开仓/平仓
    rpc CreatePerpOrder(CreatePerpOrderRequest) returns (CreatePerpOrderResponse);
    // 查询仓位
    rpc GetPosition(GetPositionRequest) returns (GetPositionResponse);
    rpc ListPositions(ListPositionsRequest) returns (ListPositionsResponse);
    // 调整保证金
    rpc AdjustMargin(AdjustMarginRequest) returns (AdjustMarginResponse);
    // 设置止盈止损
    rpc SetTPSL(SetTPSLRequest) returns (SetTPSLResponse);
}

// 资金费率接口 (后续实现)
service FundingService {
    // 查询当前资金费率
    rpc GetFundingRate(GetFundingRateRequest) returns (GetFundingRateResponse);
    // 查询资金费率历史
    rpc ListFundingHistory(ListFundingHistoryRequest) returns (ListFundingHistoryResponse);
}
```

---

## 十、扩展规划 (预测市场)

> **状态**: 架构预留，后续实现
> **参考**: Polymarket

### 10.1 核心概念

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      预测市场核心机制                                         │
│                                                                              │
│  市场示例: "2024年美国大选 - 特朗普获胜?"                                    │
│                                                                              │
│  代币模型:                                                                   │
│  ──────────                                                                  │
│  抵押品 (USDC) ←→ YES 代币 + NO 代币                                        │
│                                                                              │
│  1 USDC = 1 YES + 1 NO  (拆分 Split)                                        │
│  1 YES + 1 NO = 1 USDC  (合并 Merge)                                        │
│                                                                              │
│  市场结算:                                                                   │
│  ──────────                                                                  │
│  结果 = YES: 1 YES = 1 USDC, 1 NO = 0 USDC                                  │
│  结果 = NO:  1 YES = 0 USDC, 1 NO = 1 USDC                                  │
│                                                                              │
│  价格含义:                                                                   │
│  ──────────                                                                  │
│  YES 价格 $0.65 = 市场认为 65% 概率发生                                      │
│  NO 价格 $0.35 = 市场认为 35% 概率不发生                                     │
│  YES + NO 价格 ≈ $1.00 (套利机制保证)                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.2 镜像订单机制 (Mirror Order)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      镜像订单机制                                            │
│                                                                              │
│  问题: 用户想买 YES@0.65，但 YES 订单簿没有卖单                              │
│  解决: 自动在 NO 订单簿挂一个 "我要卖 NO@0.35" 的镜像单                      │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  用户下单: 买 YES@0.65                                              │    │
│  │                                                                     │    │
│  │  系统生成:                                                          │    │
│  │  ┌─────────────────┐         ┌─────────────────┐                   │    │
│  │  │  YES 订单簿     │         │  NO 订单簿      │                   │    │
│  │  │  ─────────────  │         │  ─────────────  │                   │    │
│  │  │  买 YES@0.65    │ ◀─镜像──▶│  卖 NO@0.35    │                   │    │
│  │  │  (主订单)       │         │  (镜像订单)     │                   │    │
│  │  └─────────────────┘         └─────────────────┘                   │    │
│  │                                                                     │    │
│  │  成交场景 A: YES 订单簿有人卖 YES@0.65                              │    │
│  │  → 主订单成交，镜像订单自动取消                                     │    │
│  │                                                                     │    │
│  │  成交场景 B: NO 订单簿有人买 NO@0.35                                │    │
│  │  → 镜像订单成交，主订单自动取消                                     │    │
│  │  → 系统自动 Split: 1 USDC → 1 YES + 1 NO                           │    │
│  │  → 用户获得 YES，对手方获得 NO                                      │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  关键: 两个订单共享状态，只能成交一个，另一个自动取消                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.3 模块结构规划

```
eidos-trading/
├── internal/
│   ├── spot/              # 现货模块 (v1.0)
│   ├── perpetual/         # 永续模块 (后续新增)
│   │
│   ├── prediction/        # 预测市场模块 (后续新增)
│   │   ├── order.go       # 预测市场订单 (含镜像单逻辑)
│   │   ├── mirror.go      # 镜像订单管理
│   │   ├── token.go       # YES/NO 代币管理
│   │   ├── split.go       # 代币拆分 (USDC → YES + NO)
│   │   ├── merge.go       # 代币合并 (YES + NO → USDC)
│   │   └── settlement.go  # 市场结算 (YES=1 或 NO=1)
│   │
│   ├── account/           # 账户模块 (共用)
│   └── common/            # 公共模块
```

### 10.4 关联订单数据模型

```sql
-- 预测市场表
CREATE TABLE prediction_markets (
    id              BIGSERIAL PRIMARY KEY,
    market_id       VARCHAR(64) NOT NULL UNIQUE,

    -- 市场信息
    question        TEXT NOT NULL,              -- "2024年美国大选 - 特朗普获胜?"
    description     TEXT,
    category        VARCHAR(50),                -- politics, sports, crypto

    -- 代币
    yes_token       VARCHAR(20) NOT NULL,       -- TRUMP-YES
    no_token        VARCHAR(20) NOT NULL,       -- TRUMP-NO
    collateral      VARCHAR(20) NOT NULL,       -- USDC

    -- 时间
    end_time        BIGINT NOT NULL,            -- 投注截止时间
    resolution_time BIGINT,                     -- 结果确认时间

    -- 状态: 0=ACTIVE, 1=PAUSED, 2=RESOLVED_YES, 3=RESOLVED_NO, 4=CANCELLED
    status          SMALLINT NOT NULL DEFAULT 0,

    -- 统计
    total_volume    DECIMAL(36, 18) NOT NULL DEFAULT 0,
    open_interest   DECIMAL(36, 18) NOT NULL DEFAULT 0,

    created_at      BIGINT NOT NULL,
    updated_at      BIGINT NOT NULL
);

-- 关联订单表 (镜像订单关系)
CREATE TABLE linked_orders (
    id              BIGSERIAL PRIMARY KEY,
    link_id         VARCHAR(64) NOT NULL UNIQUE,  -- 关联组 ID

    -- 主订单
    primary_order_id    VARCHAR(64) NOT NULL,
    primary_market      VARCHAR(20) NOT NULL,     -- YES 市场
    primary_side        SMALLINT NOT NULL,        -- 买/卖

    -- 镜像订单
    mirror_order_id     VARCHAR(64) NOT NULL,
    mirror_market       VARCHAR(20) NOT NULL,     -- NO 市场
    mirror_side         SMALLINT NOT NULL,        -- 反向

    -- 状态: 0=ACTIVE, 1=PRIMARY_FILLED, 2=MIRROR_FILLED, 3=CANCELLED
    status          SMALLINT NOT NULL DEFAULT 0,

    -- 原始金额 (用于拆分)
    collateral_amount   DECIMAL(36, 18) NOT NULL,

    created_at      BIGINT NOT NULL,
    updated_at      BIGINT NOT NULL,

    INDEX idx_linked_primary (primary_order_id),
    INDEX idx_linked_mirror (mirror_order_id)
);

-- 代币拆分/合并记录
CREATE TABLE token_operations (
    id              BIGSERIAL PRIMARY KEY,
    operation_id    VARCHAR(64) NOT NULL UNIQUE,

    wallet_address  VARCHAR(42) NOT NULL,
    market_id       VARCHAR(64) NOT NULL,

    -- 操作类型: 0=SPLIT, 1=MERGE
    operation_type  SMALLINT NOT NULL,

    -- 金额
    collateral_amount   DECIMAL(36, 18) NOT NULL,  -- USDC 数量
    yes_amount          DECIMAL(36, 18) NOT NULL,  -- YES 数量
    no_amount           DECIMAL(36, 18) NOT NULL,  -- NO 数量

    created_at      BIGINT NOT NULL,

    INDEX idx_token_ops_wallet (wallet_address)
);
```

### 10.5 镜像订单处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      镜像订单处理流程                                         │
│                                                                              │
│  1. 用户下单 (买 YES@0.65)                                                   │
│  ──────────────────────────                                                  │
│  eidos-trading:                                                              │
│    a. 创建主订单 (order_id: A, market: YES, side: BUY, price: 0.65)         │
│    b. 创建镜像订单 (order_id: B, market: NO, side: SELL, price: 0.35)       │
│    c. 创建关联记录 (link_id: X, primary: A, mirror: B)                      │
│    d. 冻结用户 0.65 USDC                                                    │
│    e. 两个订单同时发送到撮合引擎                                            │
│                                                                              │
│  2. 撮合引擎处理                                                             │
│  ──────────────────                                                          │
│  eidos-matching:                                                             │
│    - YES 和 NO 是两个独立订单簿                                              │
│    - 正常撮合，成交后发送 trade-results                                      │
│                                                                              │
│  3. 成交处理 (关键!)                                                         │
│  ────────────────────                                                        │
│  eidos-trading 收到成交:                                                     │
│    a. 查询订单是否有关联 (linked_orders)                                    │
│    b. 如果有关联:                                                           │
│       - 主订单成交 → 取消镜像订单                                           │
│       - 镜像订单成交 → 取消主订单 + 执行 Split                              │
│    c. 更新关联状态                                                          │
│                                                                              │
│  4. 镜像成交的特殊处理 (Split)                                               │
│  ────────────────────────────                                                │
│  场景: 用户买 YES@0.65，镜像单 (卖 NO@0.35) 成交                            │
│                                                                              │
│  处理步骤:                                                                   │
│    a. 用户支付 0.65 USDC                                                    │
│    b. 对手方支付 0.35 USDC                                                  │
│    c. 系统执行 Split: 1.00 USDC → 1 YES + 1 NO                              │
│    d. 用户获得 1 YES                                                        │
│    e. 对手方获得 1 NO                                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.6 代币拆分与合并

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      代币拆分与合并                                          │
│                                                                              │
│  拆分 (Split):                                                               │
│  ─────────────                                                               │
│  输入: 1 USDC                                                                │
│  输出: 1 YES + 1 NO                                                          │
│                                                                              │
│  用途:                                                                       │
│  - 镜像订单成交时自动拆分                                                    │
│  - 用户手动拆分 (获取 YES/NO 代币)                                          │
│                                                                              │
│  ────────────────────────────────────────────────────────────────────────   │
│                                                                              │
│  合并 (Merge):                                                               │
│  ─────────────                                                               │
│  输入: 1 YES + 1 NO                                                          │
│  输出: 1 USDC                                                                │
│                                                                              │
│  用途:                                                                       │
│  - 套利: 如果 YES + NO < 1，买入两边然后合并获利                            │
│  - 提前退出: 不想等结果，直接合并退出                                        │
│                                                                              │
│  ────────────────────────────────────────────────────────────────────────   │
│                                                                              │
│  结算 (Redeem):                                                              │
│  ──────────────                                                              │
│  市场结束后:                                                                 │
│  - 结果 = YES: 1 YES → 1 USDC, 1 NO → 0 USDC                                │
│  - 结果 = NO:  1 YES → 0 USDC, 1 NO → 1 USDC                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.7 与永续合约的架构对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    扩展模块架构对比                                           │
│                                                                              │
│  v1.0 现货:                                                                  │
│  ────────────                                                                │
│  eidos-trading                                                               │
│  ├── spot/        现货订单                                                   │
│  └── account/     账户余额                                                   │
│                                                                              │
│  v2.0 永续合约: (新增)                                                       │
│  ──────────────────────                                                      │
│  eidos-trading                                                               │
│  ├── perpetual/   仓位/保证金/资金费率                                       │
│  └── account/     共用                                                       │
│                                                                              │
│  eidos-liquidator (新增独立服务)                                             │
│  └── 强平监控                                                                │
│                                                                              │
│  v2.0 预测市场: (新增)                                                       │
│  ──────────────────────                                                      │
│  eidos-trading                                                               │
│  ├── prediction/  镜像订单/代币拆分合并                                      │
│  └── account/     共用                                                       │
│                                                                              │
│  eidos-oracle (新增独立服务) - 可选，用于结果验证                            │
│  └── 预测市场结果源                                                          │
│                                                                              │
│  关键差异:                                                                   │
│  ──────────                                                                  │
│  │ 特性         │ 永续合约        │ 预测市场         │                      │
│  │─────────────│────────────────│─────────────────│                      │
│  │ 订单类型     │ 普通订单        │ 镜像订单 (关联)   │                      │
│  │ 清算         │ 强制平仓        │ 市场结算         │                      │
│  │ 代币         │ 保证金          │ YES/NO 代币对    │                      │
│  │ 新增服务     │ liquidator     │ oracle (可选)    │                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.8 接口扩展预留

```protobuf
// 预测市场接口 (后续实现)
service PredictionMarketService {
    // 市场管理
    rpc GetMarket(GetMarketRequest) returns (GetMarketResponse);
    rpc ListMarkets(ListMarketsRequest) returns (ListMarketsResponse);

    // 下单 (自动创建镜像订单)
    rpc CreatePredictionOrder(CreatePredictionOrderRequest) returns (CreatePredictionOrderResponse);

    // 代币操作
    rpc SplitTokens(SplitTokensRequest) returns (SplitTokensResponse);
    rpc MergeTokens(MergeTokensRequest) returns (MergeTokensResponse);

    // 结算
    rpc RedeemTokens(RedeemTokensRequest) returns (RedeemTokensResponse);

    // 查询用户持仓
    rpc GetPositions(GetPredictionPositionsRequest) returns (GetPredictionPositionsResponse);
}

// 下单请求
message CreatePredictionOrderRequest {
    string market_id = 1;           // 预测市场 ID
    string outcome = 2;             // "YES" 或 "NO"
    string side = 3;                // "BUY" 或 "SELL"
    string price = 4;               // 0.01 - 0.99
    string size = 5;                // 数量
    string nonce = 6;
    bytes signature = 7;
}

// 拆分请求
message SplitTokensRequest {
    string market_id = 1;
    string amount = 2;              // USDC 数量
    string nonce = 3;
    bytes signature = 4;
}

// 合并请求
message MergeTokensRequest {
    string market_id = 1;
    string amount = 2;              // YES/NO 数量 (必须相等)
    string nonce = 3;
    bytes signature = 4;
}
```

---
