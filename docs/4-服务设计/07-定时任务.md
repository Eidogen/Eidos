# Eidos 定时任务服务设计

> 服务名: eidos-jobs
> 语言: Go

---

## 一、服务概述

### 1.1 核心定位

Jobs Service 负责系统中所有定时/周期性任务的调度和执行。参考 dYdX v4 的 roundtable 服务设计，精简为 **6 个核心任务**，覆盖对账、清理、聚合等必要功能。

> **设计原则**: 最小化任务数量，只保留必要任务，避免过度设计。

### 1.2 职责边界

| 职责 | 描述 | 属于本服务 |
|------|------|-----------|
| 链上链下对账 | 定期比对链上和链下余额/结算状态 | ✅ |
| 过期订单清理 | 清理超时/过期订单 | ✅ |
| 数据归档 | 历史订单/成交数据归档 | ✅ |
| 统计汇总 | 交易量、手续费等业务统计 | ✅ |
| K线聚合 | 生成大周期K线 (1h/4h/1d) | ✅ |
| 健康监控 | 服务健康检查 + 告警检测 | ✅ |
| 定时结算 | 批量触发链上结算 | ❌ (eidos-chain) |

### 1.3 对外能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Jobs Service 对外能力                                   │
│                                                                              │
│  定时任务 (6个):                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │  reconciliation │  │  cleanup-orders │  │  archive-data   │              │
│  │  链上链下对账   │  │  清理过期订单   │  │  数据归档       │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │  stats-agg      │  │  kline-agg      │  │  health-monitor │              │
│  │  统计汇总       │  │  K线聚合        │  │  健康监控       │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                              │
│  gRPC 接口:                                                                  │
│  - GetJobStatus: 查询任务执行状态                                            │
│  - TriggerJob: 手动触发任务                                                  │
│  - GetReconciliationReport: 获取对账报告                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、任务清单

### 2.1 任务配置表

| 任务名称 | Cron 表达式 | 执行频率 | 说明 |
|---------|------------|---------|------|
| `reconciliation` | `0 0 * * * *` | 每小时 | 链上链下对账 |
| `cleanup-orders` | `*/2 * * * *` | 每 2 分钟 | 清理过期订单 |
| `archive-data` | `0 0 3 * * *` | 每日凌晨 3 点 | 归档历史数据 |
| `stats-agg` | `0 5 * * * *` | 每小时 | 统计汇总 |
| `kline-agg` | `0 1 * * * *` | 每小时 | K线聚合 |
| `health-monitor` | `*/30 * * * * *` | 每 30 秒 | 健康检查 |
| `partition-manage` | `0 0 1 * *` | 每月1日 | 分区管理 (创建/清理) |
| `data-cleanup` | `0 0 4 * * *` | 每日凌晨 4 点 | 过期数据清理 |

### 2.2 任务状态

```
任务执行状态:
├── PENDING: 等待执行
├── RUNNING: 正在执行
├── SUCCESS: 执行成功
├── FAILED: 执行失败 (需告警)
└── SKIPPED: 跳过 (上一轮未完成)
```

---

## 三、核心任务详解

### 3.1 reconciliation - 链上链下对账

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      链上链下对账流程                                        │
│                                                                              │
│  ┌─────────────────┐                    ┌─────────────────┐                 │
│  │   链下数据库    │                    │   链上合约      │                 │
│  │                 │                    │                 │                 │
│  │  balances 表    │     对比           │  Vault 合约     │                 │
│  │  deposits 表    │  ◄─────────►       │  balanceOf()    │                 │
│  │  withdrawals 表 │                    │  deposited()    │                 │
│  │  trades 表      │                    │  withdrawn()    │                 │
│  └────────┬────────┘                    └────────┬────────┘                 │
│           │                                      │                          │
│           └──────────────────┬───────────────────┘                          │
│                              ▼                                              │
│                    ┌─────────────────┐                                      │
│                    │   对账结果      │                                      │
│                    │  ✅ 一致 → 记录日志                                    │
│                    │  ❌ 不一致 → 差异报告 + 告警                           │
│                    └─────────────────┘                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**对账维度**:
1. 用户余额对账: sum(链下余额) vs sum(链上余额)
2. 充值对账: 链下充值记录 vs 链上 Deposit 事件
3. 提现对账: 链下提现记录 vs 链上 Withdraw 交易
4. 结算对账: 链下成交状态 vs 链上 Settlement 状态

**差异处理**:
- 小额差异 (< 0.01 USDC): 记录日志，自动忽略
- 中等差异 (0.01 - 100 USDC): 告警通知，人工审核
- 大额差异 (> 100 USDC): 紧急告警，暂停相关操作

**增量对账策略**:
- 增量对账 (每小时): 只对账上一小时有变动的账户
- 全量对账 (每日 02:00): 完整遍历所有账户
- 检查点机制: 记录 last_time/last_block，支持中断恢复

### 3.2 cleanup-orders - 清理过期订单

> **重要**: 订单清理必须与撮合引擎协调，避免竞态条件。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      过期订单清理协调流程                                     │
│                                                                              │
│  ┌─────────────────┐                          ┌─────────────────┐           │
│  │   jobs-service  │                          │ matching-engine │           │
│  │                 │                          │                 │           │
│  │ 1. 发现过期订单 │ ──── ExpireOrder ────►   │ 2. 检查订单簿   │           │
│  │    (只读查询)   │      (gRPC 请求)         │    订单存在?    │           │
│  │                 │                          │    ├─ 是: 移除  │           │
│  │                 │ ◄─── 确认响应 ──────     │    └─ 否: 忽略  │           │
│  │                 │                          │                 │           │
│  │                 │                          │ 3. 发送 Kafka   │           │
│  │                 │                          │    OrderExpired │           │
│  └─────────────────┘                          └────────┬────────┘           │
│                                                        │                    │
│                                                        ▼                    │
│                                               ┌─────────────────┐           │
│                                               │ trading-service │           │
│                                               │ 4. 更新 DB 状态 │           │
│                                               │    解冻余额     │           │
│                                               └─────────────────┘           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**协调规则**:
1. jobs-service 不直接修改订单状态，只发送清理请求
2. 撮合引擎是订单状态的权威来源
3. 通过 Kafka 事件驱动后续处理

**清理规则**:
- GTT 订单超过 expiry_time → 标记 EXPIRED
- 已取消订单超过 24 小时 → 清理缓存
- 零数量挂单 → 移除订单簿

### 3.3 archive-data - 数据归档

**归档规则**:
- 已完成订单 (filled/cancelled/expired) 超过 30 天 → 归档
- 已结算成交记录超过 30 天 → 归档
- 归档数据保留 2 年后删除

**批量归档策略**:
- 分批处理 (每批 1000 条)，避免长事务锁表
- 进度检查点: 记录 last_id，支持中断恢复
- 批次间休眠 (100ms)，减少对在线服务影响

### 3.4 stats-agg - 统计汇总

**执行逻辑**:
- 每次执行: 生成过去 1 小时的时统计
- 如果是 00:05: 额外生成昨日的日统计

**统计指标**:
- 交易量 (按交易对)
- 成交笔数
- 手续费收入
- 活跃用户数 (仅日统计)
- 新增用户数 (仅日统计)

### 3.5 kline-agg - K线聚合

**执行逻辑**:
- 1分钟K线: 由 market-service 实时生成
- 每小时: 生成 1h K线
- 0/4/8/12/16/20 点: 额外生成 4h K线
- 00:01: 额外生成昨日 1d K线

**聚合公式**:
- open = 第一根K线的 open
- high = max(所有K线的 high)
- low = min(所有K线的 low)
- close = 最后一根K线的 close
- volume = sum(所有K线的 volume)

### 3.6 health-monitor - 健康监控

> **设计说明**: 只读操作，**无需分布式锁**，多节点执行无害。

**健康检查**:
- 检查所有服务的 /health 端点
- 检查 PostgreSQL / Redis / Kafka 连接状态
- 检查磁盘/内存使用率

**告警检测**:
- 服务响应超时 > 5s → Warning
- 服务连续 3 次无响应 → Critical
- 对账差异金额 > 100 USDC → Critical

**告警去重**: 使用 Redis 记录已发送告警，设置冷却期避免告警风暴

### 3.7 partition-manage - 分区管理

> **设计说明**: 每月 1 日执行，自动创建下月分区并清理过期分区。

**分区创建** (提前创建下月分区):

```sql
-- 自动创建下月分区的存储过程
CREATE OR REPLACE FUNCTION create_monthly_partition(
    table_name TEXT,
    year INT,
    month INT
) RETURNS VOID AS $$
DECLARE
    partition_name TEXT;
    start_ts BIGINT;
    end_ts BIGINT;
BEGIN
    partition_name := table_name || '_' || year || '_' || LPAD(month::TEXT, 2, '0');

    -- 计算月份的起止时间戳 (毫秒)
    start_ts := EXTRACT(EPOCH FROM DATE_TRUNC('month', make_date(year, month, 1))) * 1000;
    end_ts := EXTRACT(EPOCH FROM DATE_TRUNC('month', make_date(year, month, 1) + INTERVAL '1 month')) * 1000;

    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF %I FOR VALUES FROM (%s) TO (%s)',
        partition_name, table_name, start_ts, end_ts
    );
END;
$$ LANGUAGE plpgsql;
```

**需创建分区的表**:

| 服务 | 表名 | 分区策略 |
|------|------|----------|
| 行情 | `eidos_market_trade_history` | 按月 |
| 链上 | `eidos_chain_events` | 按月 |
| 链上 | `eidos_chain_deposit_records` | 按月 |
| 风控 | `eidos_risk_audit_logs` | 按月 |
| 风控 | `eidos_risk_events` | 按月 |
| 定时任务 | `eidos_jobs_executions` | 按月 |

**分区清理** (DROP 过期分区):

```sql
-- 清理过期分区 (示例: 保留6个月)
DROP TABLE IF EXISTS eidos_risk_audit_logs_2023_06;  -- 超过6个月的分区
```

### 3.8 data-cleanup - 过期数据清理

> **设计说明**: 每日凌晨 4 点执行，清理各表过期数据。

**数据保留策略总表** (默认值，详见 `config.yaml` 的 `data_retention` 配置):

| 服务 | 表名 | 默认保留 | 清理方式 | 可配置项 |
|------|------|----------|----------|----------|
| **行情** | `eidos_market_trade_history` | 12 个月 | DROP 分区 | `retention_months`, `archive_before_drop` |
| **行情** | `eidos_market_klines` | 按周期 | drop_chunks | `retention_by_interval` (1m=7d, 5m=30d, ...) |
| **链上** | `eidos_chain_events` | 6 个月 | DROP 分区 | `retention_months` |
| **链上** | `eidos_chain_deposit_records` | 24 个月 | DROP 分区 | `retention_months`, `archive_before_drop` |
| **链上** | `eidos_chain_withdrawal_txs` | 24 个月 | 分批 DELETE | `retention_months`, `batch_size` |
| **链上** | `eidos_chain_settlement_batches` | 24 个月 | 分批 DELETE | `retention_months`, `batch_size` |
| **风控** | `eidos_risk_audit_logs` | 6 个月 | DROP 分区 | `retention_months` |
| **风控** | `eidos_risk_events` | 12 个月 | DROP 分区 | `retention_months`, `archive_before_drop` |
| **风控** | `eidos_risk_withdrawal_reviews` | 24 个月 | 分批 DELETE | `retention_months`, `batch_size` |
| **定时任务** | `eidos_jobs_executions` | 3 个月 | DROP 分区 | `retention_months` |
| **定时任务** | `eidos_jobs_reconciliation_records` | 6 个月 | 分批 DELETE | `retention_months`, `batch_size` |
| **管理后台** | `eidos_admin_audit_logs` | 24 个月 | 分批 DELETE | `retention_months`, `batch_size` |

> **配置说明**: 所有保留时间均可通过 `data_retention` 配置节动态调整，无需改动代码。

**清理执行流程**:

```
1. 查询需清理的分区/数据
2. 对于分区表: DROP TABLE 过期分区
3. 对于普通表: 分批 DELETE (每批 1000 条)
4. 记录清理结果到 eidos_jobs_executions
5. 更新 eidos_jobs_archive_progress 进度
```

**清理前归档** (可选):

```sql
-- 归档到冷存储前导出
COPY (
    SELECT * FROM eidos_risk_audit_logs_2023_06
) TO '/archive/eidos_risk_audit_logs_2023_06.csv' WITH CSV HEADER;

-- 或导出到对象存储 (S3/OSS)
-- 使用 pg_dump 或 COPY TO PROGRAM
```

---

## 四、任务调度架构

### 4.1 调度策略

- 分布式锁: Redis 锁确保同一任务只在一个节点执行
- 任务隔离: 不同类型任务使用不同 Worker Pool
- 超时控制: 每个任务有最大执行时间限制
- 失败重试: 失败后按退避算法重试 (最多 3 次)

### 4.2 锁策略

| 任务 | 预计耗时 | 锁策略 |
|------|---------|--------|
| `health-monitor` | <1s | **无需锁** (只读操作) |
| `cleanup-orders` | <30s | 基础锁 (TTL=1min) |
| `stats-agg` | <1min | 基础锁 (TTL=5min) |
| `kline-agg` | <1min | 基础锁 (TTL=5min) |
| `reconciliation` | 1-10min | **Watchdog 锁** (自动续期) |
| `archive-data` | 10-30min | **Watchdog 锁** (自动续期) |
| `partition-manage` | 1-5min | 基础锁 (TTL=10min) |
| `data-cleanup` | 5-30min | **Watchdog 锁** (自动续期) |

**Watchdog 锁**: 对于长时间运行的任务，使用 Watchdog 协程定期续期锁的 TTL，避免任务执行期间锁过期。

### 4.3 任务幂等性

| 任务 | 幂等性实现 |
|------|-----------|
| `reconciliation` | 检查点 + 增量处理 |
| `cleanup-orders` | 请求级幂等 ID |
| `archive-data` | 进度记录 + 事务归档 |
| `stats-agg` | UPSERT 语义 |
| `kline-agg` | UPSERT 语义 |
| `health-monitor` | 天然幂等 (只读) |
| `partition-manage` | IF NOT EXISTS 语义 |
| `data-cleanup` | 进度记录 + 分批处理 |

---

## 五、数据库设计

> 表名前缀: `eidos_jobs_`

### 5.1 任务执行记录表

```sql
-- 任务执行记录表 (按月分区)
-- 预估数据量: 每日 5000+ 条 (8个任务 * 各自执行频率)
-- 分区策略: 按 started_at 时间范围分区，每月一个分区
-- 保留策略: 保留 3 个月
CREATE TABLE eidos_jobs_executions (
    id              BIGSERIAL,                        -- 自增ID
    job_name        VARCHAR(100) NOT NULL,            -- 任务名称 (如 reconciliation/cleanup-orders)
    status          VARCHAR(20) NOT NULL,             -- 执行状态: running/success/failed/skipped
    started_at      BIGINT NOT NULL,                  -- 开始时间 (毫秒时间戳)
    finished_at     BIGINT,                           -- 结束时间 (运行中为NULL)
    duration_ms     INT,                              -- 执行耗时 (毫秒)
    error_message   TEXT,                             -- 错误信息 (失败时填写)
    result          JSONB,                            -- 执行结果 (JSON格式，如处理条数等)
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)

    PRIMARY KEY (started_at, id)                      -- 分区键必须包含在主键中
) PARTITION BY RANGE (started_at);

-- 分区索引
CREATE INDEX idx_executions_name_time ON eidos_jobs_executions (job_name, started_at DESC);
CREATE INDEX idx_executions_status ON eidos_jobs_executions (status) WHERE status IN ('running', 'failed');

-- 分区示例 (按月)
CREATE TABLE eidos_jobs_executions_2024_01 PARTITION OF eidos_jobs_executions
    FOR VALUES FROM (1704067200000) TO (1706745600000);
CREATE TABLE eidos_jobs_executions_2024_02 PARTITION OF eidos_jobs_executions
    FOR VALUES FROM (1706745600000) TO (1709251200000);
```

### 5.2 统计数据表

```sql
CREATE TABLE eidos_jobs_statistics (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    stat_type       VARCHAR(50) NOT NULL,             -- 统计类型: daily/hourly
    stat_date       DATE NOT NULL,                    -- 统计日期
    stat_hour       INT,                              -- 统计小时 (0-23，仅hourly类型)
    market          VARCHAR(32),                      -- 交易对，NULL表示全局统计
    metric_name     VARCHAR(100) NOT NULL,            -- 指标名称 (如 trade_volume/trade_count/fee_total)
    metric_value    DECIMAL(36, 18) NOT NULL,         -- 指标值
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- 创建时间

    INDEX idx_statistics_type_date (stat_type, stat_date),  -- 按类型+日期查询
    INDEX idx_statistics_market (market, stat_date)         -- 按市场+日期查询
);
```

### 5.3 对账记录表

```sql
-- 对账记录表
-- 预估数据量: 每日 1000~5000 条
-- 保留策略: 保留 6 个月 (普通表，DELETE 清理)
CREATE TABLE eidos_jobs_reconciliation_records (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    job_type        VARCHAR(50) NOT NULL,             -- 对账任务类型: balance/deposit/withdrawal/settlement
    reconcile_type  VARCHAR(20) NOT NULL,             -- 对账类型: incremental/full
    status          VARCHAR(20) NOT NULL,             -- 结果: matched/mismatched
    wallet_address  VARCHAR(42),                      -- 用户钱包地址 (用户级对账时)
    token           VARCHAR(42),                      -- 代币符号
    offchain_value  DECIMAL(36, 18),                  -- 链下值
    onchain_value   DECIMAL(36, 18),                  -- 链上值
    diff_value      DECIMAL(36, 18),                  -- 差异值
    details         JSONB,                            -- 详细信息 (JSON格式)
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)

    INDEX idx_reconciliation_records_type (job_type),      -- 按任务类型查询
    INDEX idx_reconciliation_records_status (status) WHERE status = 'mismatched',  -- 部分索引
    INDEX idx_reconciliation_records_created (created_at DESC)  -- 按时间查询
);
```

### 5.4 对账检查点表

```sql
CREATE TABLE eidos_jobs_reconciliation_checkpoints (
    id              SERIAL PRIMARY KEY,               -- 自增主键
    job_type        VARCHAR(50) NOT NULL UNIQUE,      -- 对账任务类型 (每类型一条记录)
    last_time       TIMESTAMP NOT NULL,               -- 上次对账时间
    last_block      BIGINT,                           -- 上次对账的区块号 (链上相关)
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP  -- 更新时间
);
```

### 5.5 归档进度表

```sql
CREATE TABLE eidos_jobs_archive_progress (
    id              SERIAL PRIMARY KEY,               -- 自增主键
    table_name      VARCHAR(50) NOT NULL UNIQUE,      -- 归档的表名 (如 orders/trades)
    last_id         BIGINT NOT NULL DEFAULT 0,        -- 上次归档的最后一条记录ID
    started_at      TIMESTAMP,                        -- 归档开始时间
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP  -- 更新时间
);
```

---

## 六、配置示例

```yaml
service:
  name: eidos-jobs
  grpc_port: 50056
  http_port: 8080

scheduler:
  max_concurrent_jobs: 3
  default_timeout: 5m

jobs:
  reconciliation:
    cron: "0 0 * * * *"
    timeout: 10m
    enabled: true

  cleanup-orders:
    cron: "*/2 * * * *"
    timeout: 1m
    enabled: true

  archive-data:
    cron: "0 0 3 * * *"
    timeout: 30m
    retention_days: 30
    enabled: true

  stats-agg:
    cron: "0 5 * * * *"
    timeout: 5m
    enabled: true

  kline-agg:
    cron: "0 1 * * * *"
    timeout: 5m
    enabled: true

  health-monitor:
    cron: "*/30 * * * * *"
    timeout: 10s
    enabled: true

  partition-manage:
    cron: "0 0 1 * *"
    timeout: 10m
    enabled: true
    # 需管理分区的表
    tables:
      - eidos_market_trade_history
      - eidos_chain_events
      - eidos_chain_deposit_records
      - eidos_risk_audit_logs
      - eidos_risk_events
      - eidos_jobs_executions

  data-cleanup:
    cron: "0 0 4 * * *"
    timeout: 30m
    enabled: true
    # 归档前是否导出到对象存储
    archive_before_cleanup: true
    archive_storage: "s3://eidos-archive/db/"

redis:
  lock_prefix: "eidos:job:lock"
  lock_ttl: 10m

# =============================================================================
# 数据保留策略配置 (可按需调整)
# =============================================================================
data_retention:
  # 分区表 (按月分区，DROP 整个分区清理)
  partitioned_tables:
    # 行情服务 - 成交历史
    eidos_market_trade_history:
      retention_months: 12          # 保留 12 个月
      archive_before_drop: true     # DROP 前归档
      archive_format: "parquet"     # 归档格式: csv/parquet

    # 链上服务 - 链上事件
    eidos_chain_events:
      retention_months: 6           # 保留 6 个月 (链上可重放)
      archive_before_drop: false    # 无需归档

    # 链上服务 - 充值记录
    eidos_chain_deposit_records:
      retention_months: 24          # 保留 24 个月 (需审计)
      archive_before_drop: true

    # 风控服务 - 审计日志
    eidos_risk_audit_logs:
      retention_months: 6           # 保留 6 个月 (高频写入)
      archive_before_drop: false

    # 风控服务 - 风险事件
    eidos_risk_events:
      retention_months: 12          # 保留 12 个月 (需审计)
      archive_before_drop: true

    # 定时任务 - 执行记录
    eidos_jobs_executions:
      retention_months: 3           # 保留 3 个月 (日志性质)
      archive_before_drop: false

  # 普通表 (分批 DELETE 清理)
  regular_tables:
    # 链上服务 - 提现交易
    eidos_chain_withdrawal_txs:
      retention_months: 24
      batch_size: 1000              # 每批删除条数
      sleep_ms: 100                 # 批次间休眠毫秒

    # 链上服务 - 结算批次
    eidos_chain_settlement_batches:
      retention_months: 24
      batch_size: 500

    # 风控服务 - 提现审核
    eidos_risk_withdrawal_reviews:
      retention_months: 24
      batch_size: 1000

    # 定时任务 - 对账记录
    eidos_jobs_reconciliation_records:
      retention_months: 6
      batch_size: 1000

    # 管理后台 - 审计日志
    eidos_admin_audit_logs:
      retention_months: 24
      batch_size: 1000

  # TimescaleDB K线保留策略 (使用 drop_chunks)
  timescaledb:
    eidos_market_klines:
      # 按 interval 区分保留时间
      retention_by_interval:
        "1m": 7                     # 1分钟K线保留 7 天
        "5m": 30                    # 5分钟K线保留 30 天
        "15m": 90                   # 15分钟K线保留 90 天
        "30m": 180                  # 30分钟K线保留 180 天
        "1h": 365                   # 1小时K线保留 1 年
        "4h": 730                   # 4小时K线保留 2 年
        "1d": 0                     # 日K线永久保留 (0=不清理)
        "1w": 0                     # 周K线永久保留

# =============================================================================
# 安全传输配置 (云组件加密)
# =============================================================================
# 说明: 生产环境使用云托管组件，默认启用加密传输
#       本地开发/测试环境可关闭加密以简化配置
security:
  # 总开关: true=启用加密, false=关闭加密 (本地测试)
  tls_enabled: ${TLS_ENABLED:false}

  # gRPC TLS (服务间调用)
  grpc:
    enabled: ${GRPC_TLS_ENABLED:false}
    cert: "${GRPC_CERT_PATH}"
    key: "${GRPC_KEY_PATH}"
    ca_cert: "${GRPC_CA_CERT_PATH}"
    client_auth: false

  # PostgreSQL/TimescaleDB TLS (云 RDS)
  postgres:
    enabled: ${PG_TLS_ENABLED:false}
    sslmode: "verify-full"
    ca_cert: "${PG_CA_CERT_PATH}"

  # Redis TLS
  redis:
    enabled: ${REDIS_TLS_ENABLED:false}
    ca_cert: "${REDIS_CA_CERT_PATH}"
    skip_verify: false

  # Nacos TLS
  nacos:
    enabled: ${NACOS_TLS_ENABLED:false}
    ca_cert: "${NACOS_CA_CERT_PATH}"

  # 归档存储 (S3/OSS) 加密
  archive_storage:
    enabled: ${ARCHIVE_TLS_ENABLED:false}
    # S3 使用 HTTPS 传输，服务端加密 (SSE-S3 或 SSE-KMS)
    s3_sse: "aws:kms"                        # AES256 | aws:kms
    kms_key_id: "${ARCHIVE_KMS_KEY_ID}"      # KMS 密钥 ID (SSE-KMS)
```

---

## 七、监控指标

| 指标 | 类型 | 说明 |
|------|------|------|
| job_execution_total | Counter | 任务执行总次数 |
| job_execution_duration_seconds | Histogram | 任务执行耗时 |
| job_failures_total | Counter | 任务失败次数 |
| job_last_success_timestamp | Gauge | 上次成功执行时间 |
| reconciliation_diff_count | Gauge | 对账差异数量 |
| reconciliation_diff_amount | Gauge | 对账差异金额 |

---

## 八、告警规则

| 规则 | 条件 | 级别 |
|------|------|------|
| JobExecutionFailed | 任务执行失败 | Warning |
| JobExecutionTimeout | 任务超时未完成 | Warning |
| ReconciliationMismatch | 对账发现差异 | Critical |
| JobNotExecuted | 任务超过 2 个周期未执行 | Critical |
