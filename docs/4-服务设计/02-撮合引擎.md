# Eidos 撮合引擎设计

> 服务名: eidos-matching
> 语言: Go

> **补充设计**: 关于快照原子性、最新价维护、分布式时间戳等内容，
> 请参阅 [00-设计补充-一致性与可靠性.md](./00-设计补充-一致性与可靠性.md)

---

## 一、服务概述

### 1.1 核心定位

Matching Engine (撮合引擎) 是交易所的核心，负责订单匹配和成交。采用 **红黑树 + 双向链表** 的业界标准数据结构，实现 **价格优先、时间优先** 的撮合规则。

### 1.2 设计目标

| 指标 | Phase 1 目标 | Phase 2 目标 |
|------|-------------|-------------|
| **单引擎 TPS** | 100,000+ | 500,000+ |
| **撮合延迟 P50** | < 0.5ms | < 0.1ms |
| **撮合延迟 P99** | < 2ms | < 1ms |
| **订单簿深度** | 100万订单 | 500万订单 |
| **故障恢复时间** | < 10s | < 5s |

### 1.3 职责边界

| 职责 | 描述 | 属于本服务 |
|------|------|-----------|
| 订单簿管理 | 维护内存订单簿 | ✅ |
| 订单匹配 | 价格优先、时间优先撮合 | ✅ |
| 成交生成 | 生成成交记录 | ✅ |
| 订单簿快照 | 定期生成快照供恢复 | ✅ |
| 订单验证 | 签名验证、余额检查 | ❌ (eidos-trading) |
| 余额处理 | 冻结、划转、清算 | ❌ (eidos-trading) |
| 行情计算 | K线、Ticker | ❌ (eidos-market) |

### 1.4 对外能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Matching Engine 对外能力                                  │
│                                                                              │
│  核心特点: 无状态输入、确定性输出                                            │
│                                                                              │
│  输入 (Kafka 消费):                                                          │
│  - topic: orders           接收新订单                                        │
│  - topic: cancel-requests  接收取消请求                                      │
│                                                                              │
│  输出 (Kafka 生产):                                                          │
│  - topic: trade-results    成交结果                                          │
│  - topic: order-cancelled  取消确认                                          │
│  - topic: orderbook-updates 订单簿增量更新                                   │
│                                                                              │
│  注意: 撮合引擎不提供 gRPC 接口，纯事件驱动                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Matching Engine 内部架构                               │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                      Kafka Consumer Group                           │     │
│  │  topics: orders, cancel-requests                                   │     │
│  │  partition: 按 market 分区，保证同交易对顺序                        │     │
│  └───────────────────────────────┬────────────────────────────────────┘     │
│                                  │                                          │
│                                  ▼                                          │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                      Router / Dispatcher                            │     │
│  │  根据 market 路由到对应的 MatchingEngine 实例                       │     │
│  │  每个交易对一个独立的引擎实例 (单线程)                              │     │
│  └───────────────────────────────┬────────────────────────────────────┘     │
│                                  │                                          │
│         ┌────────────────────────┼────────────────────────────────┐         │
│         ▼                        ▼                                ▼         │
│  ┌──────────────┐        ┌──────────────┐                ┌──────────────┐  │
│  │ BTC-USDC     │        │ ETH-USDC     │       ...      │ XXX-USDC     │  │
│  │ Engine       │        │ Engine       │                │ Engine       │  │
│  │ ┌──────────┐ │        │ ┌──────────┐ │                │ ┌──────────┐ │  │
│  │ │OrderBook │ │        │ │OrderBook │ │                │ │OrderBook │ │  │
│  │ │ Bids/Asks│ │        │ │ Bids/Asks│ │                │ │ Bids/Asks│ │  │
│  │ │ (红黑树) │ │        │ │ (红黑树) │ │                │ │ (红黑树) │ │  │
│  │ └──────────┘ │        │ └──────────┘ │                │ └──────────┘ │  │
│  │ goroutine    │        │ goroutine    │                │ goroutine    │  │
│  └──────────────┘        └──────────────┘                └──────────────┘  │
│                                  │                                          │
│                                  ▼                                          │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                      Kafka Producer                                 │     │
│  │  topics: trade-results, order-cancelled, orderbook-updates         │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                      Snapshot Manager                               │     │
│  │  - 定期保存订单簿快照到 Redis                                       │     │
│  │  - 故障恢复时从快照 + Kafka 回放重建                                │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、订单簿数据结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    订单簿数据结构 (红黑树 + 双向链表)                        │
│                                                                              │
│  Layer 1: 红黑树 (按价格索引)                                               │
│                                                                              │
│  卖单树 (Asks)                       买单树 (Bids)                          │
│  价格升序排列                        价格降序排列                            │
│                                                                              │
│       [50100]                             [49900]                           │
│      /      \                            /      \                           │
│  [50050]   [50150]                  [49850]   [49950]                      │
│    /  \                               /  \                                  │
│ [50000] [50075]                   [49800] [49875]                          │
│    ↑                                  ↑                                     │
│  bestAsk                           bestBid                                  │
│                                                                              │
│  Layer 2: 双向链表 (同价格按时间排序)                                       │
│                                                                              │
│  PriceLevel[50000] → Order1 ↔ Order2 ↔ Order3                               │
│                      (最早)           (最晚)                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**核心结构**:
- `PriceLevel`: 价格档位，包含价格、总数量、订单链表头尾
- `Order`: 订单，包含 ID、价格、数量、时间戳、前后指针
- `OrderBook`: 订单簿，包含买卖红黑树、最优价缓存、订单哈希表

**精度**: 使用 int64 定点数，精度 10^8 (如 50000.12345678 表示为 5000012345678)

---

## 四、撮合规则

### 4.1 撮合原则

1. **价格优先**: 买单价高者优先成交，卖单价低者优先成交
2. **时间优先**: 同价格先到者优先成交
3. **成交价格**: 按挂单方 (Maker) 价格成交

### 4.2 限价单撮合流程

1. 遍历对手盘，从最优价开始
2. 如果买价 < 最低卖价 (或卖价 > 最高买价)，无法成交
3. 遍历该价位的所有订单 (时间优先)
4. 计算成交数量，生成成交记录
5. 更新订单数量，完全成交则移除
6. 剩余数量根据 TIF 处理：GTC 加入订单簿，IOC 取消

### 4.3 市价单处理

- 不指定价格，按当前最优价格成交
- 必须设置滑点保护，防止价格偏离过大
- 采用 IOC 模式，未成交部分自动取消

**滑点保护**:
- 市价买单: 保护价格 = 最新价 × (1 + 滑点比例)
- 市价卖单: 保护价格 = 最新价 × (1 - 滑点比例)

### 4.4 FOK 订单

- Fill-Or-Kill: 必须全部成交，否则全部取消
- 预检查：遍历订单簿判断是否能完全成交
- 可以完全成交才执行撮合

---

## 五、高可用设计

### 5.1 快照机制

- 定期快照 (每 30 秒): 将订单簿完整状态序列化保存到 Redis
- 快照内容: market、timestamp、kafka_offset、bids、asks、last_price、checksum
- 保留最近 10 个快照

### 5.2 故障恢复流程

```
加载快照 (Redis) → 获取 Kafka 位点 → 回放消息 (Kafka) → 恢复完成 (服务就绪)
```

### 5.3 主备热切换

- 主备同时消费 Kafka，备节点处理但不发送输出
- 心跳检测 (每 100ms)，ZooKeeper 选举协调
- 切换触发: Primary 心跳超时 (>500ms) 或主动下线

---

## 六、安全机制

### 6.1 并发安全

- 每个交易对一个独立 goroutine，内部串行处理无需加锁
- 不同交易对完全独立，并行执行
- Kafka 分区保证同一 market 消息顺序

### 6.2 幂等性

- 订单 ID 去重: 订单簿维护 orderID -> Order 映射
- 消息序列号检查: 跳过已处理的旧消息
- 快照包含序列号，恢复后从该序列号继续

### 6.3 主备同步安全

- 备节点同步消费，状态与主节点一致
- 切换前比对 checksum，不一致则重建
- 脑裂防护: ZooKeeper 锁 + epoch 编号

---

## 七、数据存储

### 7.1 Redis 快照

```
# 快照 Key 设计
snapshot:{market}:latest          # 最新快照
snapshot:{market}:{timestamp}     # 历史快照
```

### 7.2 引擎状态表

> 表名前缀: `eidos_matching_`
> 说明: 撮合引擎主要使用内存订单簿，数据库仅用于状态持久化和监控

```sql
CREATE TABLE eidos_matching_engine_status (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    node_id         VARCHAR(64) NOT NULL,             -- 引擎节点ID (如 engine-1)
    market          VARCHAR(20) NOT NULL,             -- 交易对 (如 BTC-USDC)
    role            VARCHAR(20) NOT NULL,             -- 角色: PRIMARY/STANDBY
    orderbook_depth INT NOT NULL,                     -- 订单簿深度 (订单总数)
    bid_levels      INT NOT NULL,                     -- 买盘价格档位数
    ask_levels      INT NOT NULL,                     -- 卖盘价格档位数
    best_bid        DECIMAL(36, 18),                  -- 最优买价
    best_ask        DECIMAL(36, 18),                  -- 最优卖价
    last_price      DECIMAL(36, 18),                  -- 最新成交价
    last_trade_at   BIGINT,                           -- 最后成交时间 (毫秒时间戳)
    kafka_offset    BIGINT NOT NULL,                  -- 当前 Kafka 消费位点
    snapshot_at     BIGINT NOT NULL,                  -- 最后快照时间 (毫秒时间戳)
    checksum        VARCHAR(64) NOT NULL,             -- 订单簿校验和 (用于主备同步验证)
    orders_processed BIGINT NOT NULL DEFAULT 0,       -- 累计处理订单数
    trades_generated BIGINT NOT NULL DEFAULT 0,       -- 累计生成成交数
    avg_latency_us  INT NOT NULL DEFAULT 0,           -- 平均撮合延迟 (微秒)
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    updated_at      BIGINT NOT NULL,                  -- 更新时间 (毫秒时间戳)

    UNIQUE (node_id, market),                         -- 每个节点每个市场一条记录
    INDEX idx_engine_status_market (market),          -- 按市场查询
    INDEX idx_engine_status_role (role)               -- 按角色查询
);
```

---

## 八、Kafka 消息格式

### 8.1 输入消息

**OrderMessage (topic: orders)**:
- order_id, maker, market, side, order_type, time_in_force
- price (限价单), size, slippage (市价单)
- timestamp (纳秒), sequence

**CancelMessage (topic: cancel-requests)**:
- order_id, maker, market, timestamp, sequence

### 8.2 输出消息

**TradeResultMessage (topic: trade-results)**:
- trade_id, maker_order_id, taker_order_id, maker, taker
- market, side, price, size, quote_amount
- maker_fee, taker_fee, maker_order_filled, taker_order_filled
- timestamp, sequence

**CancelConfirmMessage (topic: order-cancelled)**:
- order_id, market, success, reason, remaining_size
- timestamp, sequence

**OrderBookUpdateMessage (topic: orderbook-updates)**:
- market, update_type (ADD/REMOVE/UPDATE), side
- price, size (0 表示删除), timestamp, sequence

详见: `proto/matching/v1/matching.proto`

---

## 九、性能优化

| 优化策略 | 说明 |
|----------|------|
| 对象池复用 | sync.Pool 复用 Order 和 PriceLevel 对象 |
| 定点数 | 使用 int64 代替浮点数 |
| 缓存最优价 | BestBid/BestAsk 实现 O(1) 查询 |
| 哈希表 | orderID -> Order O(1) 查找 |
| 单线程 per 市场 | 无锁竞争 |
| Kafka 批量 | 批量消费 (100条/批) 和生产 |
| 消息压缩 | lz4 压缩 |

---

## 十、配置示例

```yaml
service:
  name: eidos-matching
  node_id: "engine-1"

markets:
  - symbol: BTC-USDC
    price_decimals: 8
    size_decimals: 8
    min_size: "0.0001"
    tick_size: "0.01"
    maker_fee_rate: "0.0005"
    taker_fee_rate: "0.001"

kafka:
  consumer:
    group_id: eidos-matching
    topics: [orders, cancel-requests]
    batch_size: 100
    linger_ms: 5
  producer:
    compression: lz4
    batch_size: 1000

snapshot:
  interval: 30s
  max_count: 10

ha:
  enabled: true
  heartbeat_interval: 100ms
  failover_timeout: 500ms

# =============================================================================
# 安全传输配置 (云组件加密)
# =============================================================================
# 说明: 生产环境使用云托管组件，默认启用加密传输
#       本地开发/测试环境可关闭加密以简化配置
security:
  # 总开关: true=启用加密, false=关闭加密 (本地测试)
  tls_enabled: ${TLS_ENABLED:false}

  # Kafka TLS/SASL (云 Kafka 如 AWS MSK, Confluent Cloud)
  kafka:
    enabled: ${KAFKA_TLS_ENABLED:false}
    protocol: "SASL_SSL"                    # PLAINTEXT | SASL_SSL
    sasl_mechanism: "SCRAM-SHA-512"         # PLAIN | SCRAM-SHA-256 | SCRAM-SHA-512
    ca_cert: "${KAFKA_CA_CERT_PATH}"        # CA 证书路径
    client_cert: "${KAFKA_CLIENT_CERT_PATH}"  # 客户端证书 (mTLS)
    client_key: "${KAFKA_CLIENT_KEY_PATH}"    # 客户端私钥 (mTLS)
    username: "${KAFKA_SASL_USERNAME}"      # SASL 用户名
    password: "${KAFKA_SASL_PASSWORD}"      # SASL 密码 (从 Secret Manager 获取)

  # Redis TLS (云 Redis 如 AWS ElastiCache, Aliyun Redis)
  redis:
    enabled: ${REDIS_TLS_ENABLED:false}
    ca_cert: "${REDIS_CA_CERT_PATH}"
    client_cert: "${REDIS_CLIENT_CERT_PATH}"  # mTLS (可选)
    client_key: "${REDIS_CLIENT_KEY_PATH}"
    skip_verify: false                      # 生产环境必须 false
```

---

## 十一、监控指标

| 指标 | 说明 |
|------|------|
| matching_orders_processed_total | 订单处理总数 |
| matching_trades_generated_total | 成交生成总数 |
| matching_trades_volume_total | 成交量 |
| matching_latency_microseconds | 撮合延迟 |
| matching_orderbook_depth | 订单簿深度 |
| matching_orderbook_spread | 买卖价差 |
| matching_kafka_consumer_lag | Kafka 消费延迟 |
