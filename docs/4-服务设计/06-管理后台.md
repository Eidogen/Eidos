# Eidos 管理后台设计

> 服务名: eidos-admin
> 语言: Go

**设计原则**:
- 直接操作数据库，不依赖 Kafka
- 所有操作记录审计日志
- 部署在内网，简化安全设计
- 配置变更后手动刷新或重启相关服务

---

## 一、服务职责

### 1.1 核心定位

eidos-admin 是运营管理后台的 API 服务，提供交易对管理、用户查询、数据统计、系统配置等运营功能。

### 1.2 职责边界

| 职责 | 说明 | 属于本服务 |
|------|------|-----------|
| 交易对管理 | 新增、编辑、上下线交易对 | ✅ |
| 费率管理 | 设置 Maker/Taker 费率 | ✅ |
| 用户查询 | 按地址查询余额、订单、成交 | ✅ |
| 订单管理 | 查询、强制取消订单 | ✅ |
| 数据统计 | 交易量、手续费等报表 | ✅ |
| 系统配置 | 限流、限额等参数配置 | ✅ |
| 操作日志 | 管理员操作审计 | ✅ |
| 权限管理 | 管理员账号和角色 | ✅ |

### 1.3 对外提供的能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        eidos-admin 对外能力                                  │
│                                                                              │
│  REST API (给运营后台前端):                                                  │
│  ────────────────────────────                                                │
│                                                                              │
│  交易对管理:                                                                 │
│    GET    /admin/v1/markets           获取交易对列表                        │
│    POST   /admin/v1/markets           新增交易对                            │
│    PUT    /admin/v1/markets/{symbol}  编辑交易对                            │
│    PUT    /admin/v1/markets/{symbol}/status  上下线                         │
│                                                                              │
│  用户查询:                                                                   │
│    GET    /admin/v1/users/{wallet}/balances   查询用户余额                  │
│    GET    /admin/v1/users/{wallet}/orders     查询用户订单                  │
│    GET    /admin/v1/users/{wallet}/trades     查询用户成交                  │
│    GET    /admin/v1/users/{wallet}/transactions  查询资金流水               │
│                                                                              │
│  订单管理:                                                                   │
│    GET    /admin/v1/orders            查询全部订单                          │
│    GET    /admin/v1/orders/{id}       查询订单详情                          │
│                                                                              │
│  数据统计:                                                                   │
│    GET    /admin/v1/stats/overview    总览数据                              │
│    GET    /admin/v1/stats/volume      交易量统计                            │
│    GET    /admin/v1/stats/fees        手续费统计                            │
│    GET    /admin/v1/stats/users       用户统计                              │
│                                                                              │
│  系统配置:                                                                   │
│    GET    /admin/v1/configs           获取配置列表                          │
│    PUT    /admin/v1/configs/{key}     更新配置                              │
│                                                                              │
│  操作日志:                                                                   │
│    GET    /admin/v1/audit-logs        查询操作日志                          │
│                                                                              │
│  权限管理:                                                                   │
│    GET    /admin/v1/admins            管理员列表                            │
│    POST   /admin/v1/admins            新增管理员                            │
│    PUT    /admin/v1/admins/{id}       编辑管理员                            │
│    DELETE /admin/v1/admins/{id}       删除管理员                            │
│    GET    /admin/v1/roles             角色列表                              │
│    POST   /admin/v1/session           登录                                  │
│    DELETE /admin/v1/session           登出                                  │
│                                                                              │
│  服务管理 (内部接口，仅限运维使用):                                         │
│    POST   /internal/reload/{service}  触发指定服务重新加载配置              │
│           (通过 gRPC 调用目标服务的 ReloadConfig 方法)                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、架构设计

### 2.1 服务架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          eidos-admin 服务架构                                │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         REST API (Gin)                               │    │
│  │                           :8088                                      │    │
│  └───────────────────────────────────┬─────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         中间件层                                     │    │
│  │                                                                      │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │    │
│  │  │ JWT 认证  │ │ 权限检查  │ │ 操作日志  │ │ 限流      │           │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │    │
│  └───────────────────────────────────┬─────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Handler 层                                   │    │
│  │                                                                      │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │    │
│  │  │ Market    │ │ User      │ │ Stats     │ │ System    │           │    │
│  │  │ Handler   │ │ Handler   │ │ Handler   │ │ Handler   │           │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │    │
│  └───────────────────────────────────┬─────────────────────────────────┘    │
│                                      │                                      │
│         ┌────────────────────────────┼────────────────────────┐             │
│         │                            │                        │             │
│         ▼                            ▼                        ▼             │
│  ┌──────────────┐           ┌──────────────┐          ┌──────────────┐     │
│  │ gRPC Clients │           │ Local Repo   │          │ StatsService │     │
│  │              │           │              │          │              │     │
│  │ eidos-trading│           │ 交易对配置   │          │ 数据聚合     │     │
│  │ eidos-market │           │ 管理员账号   │          │ 报表生成     │     │
│  │              │           │ 操作日志     │          │              │     │
│  └──────────────┘           └──────────────┘          └──────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 认证与权限

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          认证与权限设计                                      │
│                                                                              │
│  认证方式: JWT Token                                                         │
│  ═══════════════════                                                         │
│                                                                              │
│  登录流程:                                                                   │
│  ──────────                                                                  │
│  1. 管理员提交用户名 + 密码                                                  │
│  2. 验证密码 (bcrypt)                                                        │
│  3. 生成 JWT Token (有效期 8 小时)                                          │
│  4. 返回 Token，前端保存                                                     │
│                                                                              │
│  Token 内容:                                                                 │
│  {                                                                           │
│    "admin_id": 1,                                                            │
│    "username": "admin",                                                      │
│    "role": "super_admin",                                                    │
│    "permissions": ["market:read", "market:write", ...],                      │
│    "exp": 1704096000                                                         │
│  }                                                                           │
│                                                                              │
│  角色权限:                                                                   │
│  ──────────                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  角色            权限                                                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  super_admin     全部权限                                           │    │
│  │  operator        market:*, user:read, order:*, stats:read           │    │
│  │  support         user:read, order:read                              │    │
│  │  viewer          *:read                                             │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  权限检查:                                                                   │
│  ──────────                                                                  │
│  每个 API 接口声明所需权限，中间件自动检查                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、数据库设计

### 3.1 管理员表

```sql
CREATE TABLE admins (
    id              BIGSERIAL PRIMARY KEY,
    username        VARCHAR(50) NOT NULL UNIQUE,
    password_hash   VARCHAR(100) NOT NULL,         -- bcrypt hash
    nickname        VARCHAR(50),
    email           VARCHAR(100),
    phone           VARCHAR(20),
    role            VARCHAR(30) NOT NULL,          -- super_admin, operator, support, viewer
    status          SMALLINT NOT NULL DEFAULT 1,   -- 1=启用, 0=禁用
    last_login_at   BIGINT,
    last_login_ip   VARCHAR(45),

    -- 审计字段
    created_by      VARCHAR(42),
    created_at      BIGINT NOT NULL,
    updated_by      VARCHAR(42),
    updated_at      BIGINT NOT NULL
);

CREATE INDEX idx_admins_username ON admins (username);
CREATE INDEX idx_admins_role ON admins (role);
```

### 3.2 交易对配置表

```sql
CREATE TABLE market_configs (
    id              BIGSERIAL PRIMARY KEY,
    symbol          VARCHAR(20) NOT NULL UNIQUE,   -- BTC-USDC
    base_token      VARCHAR(10) NOT NULL,
    quote_token     VARCHAR(10) NOT NULL,

    -- 精度配置
    price_decimals  SMALLINT NOT NULL DEFAULT 2,
    size_decimals   SMALLINT NOT NULL DEFAULT 6,

    -- 交易限制
    min_size        DECIMAL(36, 18) NOT NULL,
    max_size        DECIMAL(36, 18),
    min_notional    DECIMAL(36, 18) NOT NULL,
    tick_size       DECIMAL(36, 18) NOT NULL,

    -- 费率
    maker_fee       DECIMAL(10, 6) NOT NULL DEFAULT 0.001,
    taker_fee       DECIMAL(10, 6) NOT NULL DEFAULT 0.001,

    -- 状态
    status          SMALLINT NOT NULL DEFAULT 1,   -- 1=活跃, 2=暂停, 3=下线
    trading_enabled BOOLEAN NOT NULL DEFAULT TRUE,

    -- 审计字段
    created_by      VARCHAR(42),
    created_at      BIGINT NOT NULL,
    updated_by      VARCHAR(42),
    updated_at      BIGINT NOT NULL
);

CREATE INDEX idx_markets_status ON market_configs (status);
```

### 3.3 系统配置表

```sql
CREATE TABLE system_configs (
    id              BIGSERIAL PRIMARY KEY,
    config_key      VARCHAR(100) NOT NULL UNIQUE,
    config_value    TEXT NOT NULL,
    config_type     VARCHAR(20) NOT NULL,          -- string, number, boolean, json
    description     VARCHAR(500),
    is_secret       BOOLEAN NOT NULL DEFAULT FALSE,

    -- 审计字段
    created_by      VARCHAR(42),
    created_at      BIGINT NOT NULL,
    updated_by      VARCHAR(42),
    updated_at      BIGINT NOT NULL
);

-- 初始配置
INSERT INTO system_configs (config_key, config_value, config_type, description, created_at, updated_at) VALUES
('rate_limit.orders_per_second', '10', 'number', '每秒下单限制', 1704067200000, 1704067200000),
('rate_limit.queries_per_second', '100', 'number', '每秒查询限制', 1704067200000, 1704067200000),
('order.max_open_orders', '200', 'number', '最大挂单数', 1704067200000, 1704067200000),
('order.min_order_value', '10', 'number', '最小订单金额', 1704067200000, 1704067200000),
('withdraw.daily_limit', '0', 'number', '每日提现限额(0=无限)', 1704067200000, 1704067200000);
```

### 3.4 操作日志表

```sql
CREATE TABLE audit_logs (
    id              BIGSERIAL PRIMARY KEY,

    -- 操作者
    admin_id        BIGINT NOT NULL,
    admin_username  VARCHAR(50) NOT NULL,
    ip_address      VARCHAR(45),
    user_agent      VARCHAR(500),

    -- 操作信息
    action          VARCHAR(50) NOT NULL,          -- create_market, update_fee, cancel_order, etc.
    resource_type   VARCHAR(50) NOT NULL,          -- market, order, admin, config
    resource_id     VARCHAR(100),
    description     VARCHAR(500),

    -- 变更详情
    old_value       JSONB,
    new_value       JSONB,

    -- 结果
    status          SMALLINT NOT NULL,             -- 1=成功, 0=失败
    error_message   VARCHAR(500),

    -- 审计字段
    created_by      VARCHAR(42),
    created_at      BIGINT NOT NULL,
    updated_by      VARCHAR(42),
    updated_at      BIGINT NOT NULL
);

CREATE INDEX idx_audit_admin ON audit_logs (admin_id);
CREATE INDEX idx_audit_action ON audit_logs (action);
CREATE INDEX idx_audit_resource ON audit_logs (resource_type, resource_id);
CREATE INDEX idx_audit_created ON audit_logs (created_at);
```

### 3.5 统计数据表

```sql
-- 日统计表 (按天聚合)
CREATE TABLE daily_stats (
    id              BIGSERIAL PRIMARY KEY,
    stat_date       DATE NOT NULL,
    market          VARCHAR(20),                   -- NULL 表示全市场

    -- 交易统计
    trade_count     BIGINT NOT NULL DEFAULT 0,
    trade_volume    DECIMAL(36, 18) NOT NULL DEFAULT 0,
    trade_amount    DECIMAL(36, 18) NOT NULL DEFAULT 0,

    -- 订单统计
    order_count     BIGINT NOT NULL DEFAULT 0,
    cancelled_count BIGINT NOT NULL DEFAULT 0,

    -- 手续费统计
    maker_fee_total DECIMAL(36, 18) NOT NULL DEFAULT 0,
    taker_fee_total DECIMAL(36, 18) NOT NULL DEFAULT 0,

    -- 用户统计
    active_users    INT NOT NULL DEFAULT 0,
    new_users       INT NOT NULL DEFAULT 0,

    -- 审计字段
    created_by      VARCHAR(42),
    created_at      BIGINT NOT NULL,
    updated_by      VARCHAR(42),
    updated_at      BIGINT NOT NULL,

    UNIQUE (stat_date, market)
);

CREATE INDEX idx_daily_stats_date ON daily_stats (stat_date);
CREATE INDEX idx_daily_stats_market ON daily_stats (market);
```

---

## 四、数据流转

### 4.1 交易对配置管理

**设计说明**:
- 配置变更直接写入数据库，不依赖消息队列
- 各服务在启动时从数据库加载配置
- 配置变更后，通过内部接口或重启服务使配置生效

#### 4.1.1 配置版本号与一致性约束（必须）

> **目标**: 防止 `eidos-trading / eidos-matching / eidos-market / eidos-risk / eidos-api` 在同一时间窗口加载到**不同版本**配置而导致错误撮合、错误风控或错误限价。

**核心原则**:
- **所有配置变更必须有单调递增的版本号**（config_version）
- **服务必须以“版本号”为准判断是否需要 reload**，并在 reload 完成后上报当前版本
- **涉及撮合不变量的配置变更必须走“维护窗口发布流程”**（见 4.1.3），禁止热更新

**推荐实现（全局版本表）**:

```sql
-- 全局配置版本表：每次配置变更 +1（按 scope 维度）
CREATE TABLE config_versions (
    scope        VARCHAR(50) PRIMARY KEY,   -- market_configs / system_configs / risk_rules ...
    version      BIGINT NOT NULL DEFAULT 0,
    updated_by   VARCHAR(42),
    updated_at   BIGINT NOT NULL
);
```

**写入事务约束（示例：变更市场配置）**:

```sql
BEGIN;

-- 1) 先写配置（market_configs / system_configs / risk_rules 等）
UPDATE market_configs
SET maker_fee = $1,
    taker_fee = $2,
    updated_by = $op,
    updated_at = $now
WHERE symbol = $symbol;

-- 2) 同事务 bump 版本号（作为“配置发布版本”）
UPDATE config_versions
SET version = version + 1,
    updated_by = $op,
    updated_at = $now
WHERE scope = 'market_configs'
RETURNING version;

COMMIT;
```

> **说明**: 版本号是“发布信号”。各服务 reload 时应读取 `config_versions.scope` 的 `version`，并将本地缓存的版本推进到最新。

#### 4.1.2 生效方式（reload / 重启）的验收要求

无论采用重启还是 reload，都必须满足：
- **可观测**: 每个服务暴露 `config_version{scope="market_configs"}` 指标或 `/internal/config/version`（二选一），便于运维核对“已全部推进”
- **可审计**: `eidos-admin` 记录本次变更的 scope、版本号、影响市场、影响字段、触发 reload 的服务列表与结果

#### 4.1.3 配置发布流程（SOP，防止版本分叉）

**A. 热更新（允许）**：不影响撮合不变量的配置，例如：
- 限流阈值、最大挂单数等 `system_configs`
- 风控阈值/黑名单等 `risk_rules`
- **不改变撮合精度/价格步长/最小下单量**的轻量市场参数（如费率）

流程（推荐顺序）：
1. `eidos-admin` 事务写 DB + bump `config_versions`（得到 version）
2. 依次触发相关服务 reload（建议顺序）：`eidos-risk` → `eidos-trading` → `eidos-api` → `eidos-market`
3. 运维核对所有相关服务的 `config_version` 已达到目标 version
4. 记录审计日志，完成发布

**B. 维护窗口发布（必须）**：会影响撮合不变量或撮合状态的变更，例如：
- 新增交易对（需要初始化订单簿）
- 修改 `price_decimals/size_decimals/tick_size/min_size/min_notional` 等撮合/撮合前校验的关键约束
- 任何要求撮合引擎重建内部结构的数据变更

流程（强制顺序）：
1. **停新单**：将对应市场 `status=2(暂停)` 且 `trading_enabled=false` 写入 DB，并 bump 版本号
2. 触发 `eidos-api` / `eidos-trading` / `eidos-risk` reload，确保新单被拒绝（以版本号验收）
3. 等待撮合队列 drain（撮合完成处理在途消息），并生成撮合快照（matching 快照机制）
4. 重启/滚动 `eidos-matching`（必要时 `eidos-market` 一并重启或 reload）以重建内部状态
5. 再次核对各服务配置版本一致（尤其 matching + trading + risk）
6. **恢复交易**：将市场 `status=1(活跃)` 且 `trading_enabled=true` 写入 DB，并 bump 版本号；触发相关服务 reload 生效
7. 监控 5~10 分钟（拒单率、撮合延迟、成交率、风险拦截率），确认稳定后结束窗口

#### 4.1.4 新增交易对（必须包含“初始化订单簿”）

推荐分两阶段：

**阶段 1：预发布（不对外）**
1. `eidos-admin` 创建 `market_configs` 记录，设置 `status=2(暂停)`、`trading_enabled=false`
2. bump `config_versions(scope='market_configs')`
3. 重启 `eidos-matching`（或执行其“创建市场/初始化订单簿”内部能力，若实现）以初始化空订单簿
4. `eidos-market` 从 DB 加载新市场配置，准备行情聚合/订阅（可先不对外推送）

**阶段 2：开闸（对外）**
1. 将市场切到 `status=1(活跃)`、`trading_enabled=true`，bump 版本号
2. reload `eidos-risk` / `eidos-trading` / `eidos-api` / `eidos-market`
3. 观察：订单拒绝原因分布、撮合延迟、行情推送延迟、K线落库是否正常

> **注意**: 上述 `config_versions`/版本验收指标/发布 SOP 是**强约束**。如果短期内不实现版本表，至少也要实现“配置读取结果带版本号 + reload 后上报版本号”的最小闭环，否则无法证明“撮合/行情/交易/风控已统一到同一配置版本”。 

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       交易对配置管理流程                                     │
│                                                                              │
│  Admin前端        eidos-admin          PostgreSQL         其他服务          │
│      │                │                    │                   │             │
│      │ 新增/编辑交易对│                    │                   │             │
│      │───────────────>│                    │                   │             │
│      │                │                    │                   │             │
│      │                │ 1. 保存到 DB       │                   │             │
│      │                │───────────────────>│                   │             │
│      │                │                    │                   │             │
│      │                │ 2. 记录审计日志    │                   │             │
│      │                │───────────────────>│                   │             │
│      │                │                    │                   │             │
│      │ 200 OK         │                    │                   │             │
│      │<───────────────│                    │                   │             │
│      │                │                    │                   │             │
│                                                                              │
│  配置生效方式 (任选其一):                                                    │
│  ────────────────────────                                                    │
│  方式1: 服务重启 - 重启 eidos-matching/eidos-market 等服务                  │
│  方式2: 内部接口 - 调用 /internal/reload 接口刷新配置                       │
│                                                                              │
│  注意: 新增交易对通常需要重启撮合引擎以初始化订单簿                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 统计数据查询

**说明**: 统计数据由 eidos-jobs 定时聚合写入 daily_stats 表，eidos-admin 仅做查询展示。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       统计数据查询                                           │
│                                                                              │
│  数据来源:                                                                   │
│  ──────────                                                                  │
│  - daily_stats 表 (由 eidos-jobs 定时聚合)                                  │
│  - Redis 实时统计缓存 (由 eidos-jobs 更新)                                  │
│                                                                              │
│  eidos-admin 职责:                                                          │
│  ─────────────────                                                           │
│  - 读取 daily_stats 表展示历史统计                                          │
│  - 读取 Redis 缓存展示实时统计                                              │
│  - 不做任何聚合计算                                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、服务依赖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       eidos-admin 服务依赖                                   │
│                                                                              │
│                              eidos-admin                                     │
│                                  │                                           │
│         ┌────────────────────────┼────────────────────────┐                  │
│         │                        │                        │                  │
│         ▼                        ▼                        ▼                  │
│  ┌─────────────────────────────────────┐        ┌──────────────┐           │
│  │         eidos-trading              │        │ eidos-market │           │
│  │                                    │        │              │           │
│  │ 订单查询 / 订单取消 / 成交查询     │        │ 交易对状态   │           │
│  │ 余额查询 / 流水查询                │        │              │           │
│  └─────────────────────────────────────┘        └──────────────┘           │
│                                                                              │
│  本地存储:                                                                   │
│  ──────────                                                                  │
│  - PostgreSQL: admins, market_configs, system_configs, audit_logs           │
│  - Redis: 会话缓存, 统计缓存                                                 │
│                                                                              │
│  说明: 本服务不依赖 Kafka，配置变更直接写数据库                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、配置项

```yaml
service:
  name: eidos-admin
  port: 8088

nacos:
  server_addr: "nacos:8848"
  namespace: "eidos-prod"
  group: "EIDOS_GROUP"

# gRPC 客户端
grpc_clients:
  eidos-trading:
    timeout: 5s
  eidos-market:
    timeout: 3s

# 数据库
postgres:
  host: postgres
  port: 5432
  database: eidos_admin
  max_connections: 50

redis:
  cluster:
    nodes:
      - redis-1:6379
      - redis-2:6379
      - redis-3:6379

# JWT 配置
jwt:
  secret: "${JWT_SECRET}"
  expires_in: 8h

# 安全配置
security:
  password_min_length: 8
  max_login_attempts: 5
  lockout_duration: 30m
```
