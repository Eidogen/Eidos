# Eidos 管理后台设计

> 服务名: eidos-admin
> 语言: Go

**设计原则**:
- 直接操作数据库，不依赖 Kafka
- 所有操作记录审计日志
- 部署在内网，简化安全设计
- 配置变更后手动刷新或重启相关服务

---

## 一、服务职责

### 1.1 核心定位

eidos-admin 是运营管理后台的 API 服务，提供交易对管理、用户查询、数据统计、系统配置等运营功能。

### 1.2 职责边界

| 职责 | 说明 | 属于本服务 |
|------|------|-----------|
| 交易对管理 | 新增、编辑、上下线交易对 | ✅ |
| 费率管理 | 设置 Maker/Taker 费率 | ✅ |
| 用户查询 | 按地址查询余额、订单、成交 | ✅ |
| 订单管理 | 查询、强制取消订单 | ✅ |
| 数据统计 | 交易量、手续费等报表 | ✅ |
| 系统配置 | 限流、限额等参数配置 | ✅ |
| 操作日志 | 管理员操作审计 | ✅ |
| 权限管理 | 管理员账号和角色 | ✅ |

### 1.3 对外提供的能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        eidos-admin 对外能力                                  │
│                                                                              │
│  REST API (给运营后台前端):                                                  │
│  ────────────────────────────                                                │
│                                                                              │
│  交易对管理:                                                                 │
│    GET    /admin/v1/markets           获取交易对列表                        │
│    POST   /admin/v1/markets           新增交易对                            │
│    PUT    /admin/v1/markets/{symbol}  编辑交易对                            │
│    PUT    /admin/v1/markets/{symbol}/status  上下线                         │
│                                                                              │
│  用户查询:                                                                   │
│    GET    /admin/v1/users/{wallet}/balances   查询用户余额                  │
│    GET    /admin/v1/users/{wallet}/orders     查询用户订单                  │
│    GET    /admin/v1/users/{wallet}/trades     查询用户成交                  │
│    GET    /admin/v1/users/{wallet}/transactions  查询资金流水               │
│                                                                              │
│  订单管理:                                                                   │
│    GET    /admin/v1/orders            查询全部订单                          │
│    GET    /admin/v1/orders/{id}       查询订单详情                          │
│                                                                              │
│  数据统计:                                                                   │
│    GET    /admin/v1/stats/overview    总览数据                              │
│    GET    /admin/v1/stats/volume      交易量统计                            │
│    GET    /admin/v1/stats/fees        手续费统计                            │
│    GET    /admin/v1/stats/users       用户统计                              │
│                                                                              │
│  系统配置:                                                                   │
│    GET    /admin/v1/configs           获取配置列表                          │
│    PUT    /admin/v1/configs/{key}     更新配置                              │
│                                                                              │
│  操作日志:                                                                   │
│    GET    /admin/v1/audit-logs        查询操作日志                          │
│                                                                              │
│  权限管理:                                                                   │
│    GET    /admin/v1/admins            管理员列表                            │
│    POST   /admin/v1/admins            新增管理员                            │
│    PUT    /admin/v1/admins/{id}       编辑管理员                            │
│    DELETE /admin/v1/admins/{id}       删除管理员                            │
│    GET    /admin/v1/roles             角色列表                              │
│    POST   /admin/v1/session           登录                                  │
│    DELETE /admin/v1/session           登出                                  │
│                                                                              │
│  服务管理 (内部接口，仅限运维使用):                                         │
│    POST   /internal/reload/{service}  触发指定服务重新加载配置              │
│           (通过 gRPC 调用目标服务的 ReloadConfig 方法)                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、架构设计

### 2.1 服务架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          eidos-admin 服务架构                                │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         REST API (Gin)                               │    │
│  │                           :8088                                      │    │
│  └───────────────────────────────────┬─────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         中间件层                                     │    │
│  │                                                                      │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │    │
│  │  │ JWT 认证  │ │ 权限检查  │ │ 操作日志  │ │ 限流      │           │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │    │
│  └───────────────────────────────────┬─────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Handler 层                                   │    │
│  │                                                                      │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │    │
│  │  │ Market    │ │ User      │ │ Stats     │ │ System    │           │    │
│  │  │ Handler   │ │ Handler   │ │ Handler   │ │ Handler   │           │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │    │
│  └───────────────────────────────────┬─────────────────────────────────┘    │
│                                      │                                      │
│         ┌────────────────────────────┼────────────────────────┐             │
│         │                            │                        │             │
│         ▼                            ▼                        ▼             │
│  ┌──────────────┐           ┌──────────────┐          ┌──────────────┐     │
│  │ gRPC Clients │           │ Local Repo   │          │ StatsService │     │
│  │              │           │              │          │              │     │
│  │ eidos-trading│           │ 交易对配置   │          │ 数据聚合     │     │
│  │ eidos-market │           │ 管理员账号   │          │ 报表生成     │     │
│  │              │           │ 操作日志     │          │              │     │
│  └──────────────┘           └──────────────┘          └──────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 认证与权限

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          认证与权限设计                                      │
│                                                                              │
│  认证方式: JWT Token                                                         │
│  ═══════════════════                                                         │
│                                                                              │
│  登录流程:                                                                   │
│  ──────────                                                                  │
│  1. 管理员提交用户名 + 密码                                                  │
│  2. 验证密码 (bcrypt)                                                        │
│  3. 生成 JWT Token (有效期 8 小时)                                          │
│  4. 返回 Token，前端保存                                                     │
│                                                                              │
│  Token 内容:                                                                 │
│  {                                                                           │
│    "admin_id": 1,                                                            │
│    "username": "admin",                                                      │
│    "role": "super_admin",                                                    │
│    "permissions": ["market:read", "market:write", ...],                      │
│    "exp": 1704096000                                                         │
│  }                                                                           │
│                                                                              │
│  角色权限:                                                                   │
│  ──────────                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  角色            权限                                                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  super_admin     全部权限                                           │    │
│  │  operator        market:*, user:read, order:*, stats:read           │    │
│  │  support         user:read, order:read                              │    │
│  │  viewer          *:read                                             │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  权限检查:                                                                   │
│  ──────────                                                                  │
│  每个 API 接口声明所需权限，中间件自动检查                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、数据库设计

### 3.1 管理员表

```sql
-- 管理后台管理员账号表
-- 用途: 存储管理员登录信息、角色权限、登录记录
CREATE TABLE eidos_admin_admins (
    id              BIGSERIAL PRIMARY KEY,                        -- 管理员唯一标识
    username        VARCHAR(50) NOT NULL UNIQUE,                  -- 登录用户名，全局唯一
    password_hash   VARCHAR(100) NOT NULL,                        -- 密码 bcrypt 哈希值
    nickname        VARCHAR(50),                                  -- 显示昵称
    email           VARCHAR(100),                                 -- 邮箱地址，用于通知
    phone           VARCHAR(20),                                  -- 手机号码
    role            VARCHAR(30) NOT NULL,                         -- 角色: super_admin/operator/support/viewer
    status          SMALLINT NOT NULL DEFAULT 1,                  -- 状态: 1=启用, 0=禁用
    last_login_at   BIGINT,                                       -- 最后登录时间(毫秒时间戳)
    last_login_ip   VARCHAR(45),                                  -- 最后登录 IP 地址
    login_attempts  SMALLINT NOT NULL DEFAULT 0,                  -- 连续登录失败次数
    locked_until    BIGINT,                                       -- 锁定截止时间(毫秒时间戳)

    -- 审计字段
    created_by      VARCHAR(42),                                  -- 创建者(管理员用户名)
    created_at      BIGINT NOT NULL,                              -- 创建时间(毫秒时间戳)
    updated_by      VARCHAR(42),                                  -- 更新者(管理员用户名)
    updated_at      BIGINT NOT NULL,                              -- 更新时间(毫秒时间戳)

    -- 索引
    INDEX idx_admins_username (username),                         -- 登录查询
    INDEX idx_admins_role (role),                                 -- 按角色筛选
    INDEX idx_admins_status (status)                              -- 按状态筛选
);
```

### 3.2 交易对配置表

```sql
-- 交易对配置主表
-- 用途: 存储所有交易对的配置信息，包括精度、限制、费率等
-- 说明: 此表是交易对配置的唯一来源，各服务通过此表加载配置
CREATE TABLE eidos_admin_market_configs (
    id              BIGSERIAL PRIMARY KEY,                        -- 配置唯一标识
    symbol          VARCHAR(20) NOT NULL UNIQUE,                  -- 交易对符号，如 BTC-USDC
    base_token      VARCHAR(10) NOT NULL,                         -- 基础代币，如 BTC
    quote_token     VARCHAR(10) NOT NULL,                         -- 报价代币，如 USDC
    base_token_addr VARCHAR(42) NOT NULL,                         -- 基础代币合约地址
    quote_token_addr VARCHAR(42) NOT NULL,                        -- 报价代币合约地址

    -- 精度配置
    price_decimals  SMALLINT NOT NULL DEFAULT 2,                  -- 价格小数位数
    size_decimals   SMALLINT NOT NULL DEFAULT 6,                  -- 数量小数位数

    -- 交易限制
    min_size        DECIMAL(36, 18) NOT NULL,                     -- 最小下单数量
    max_size        DECIMAL(36, 18),                              -- 最大下单数量(NULL=无限制)
    min_notional    DECIMAL(36, 18) NOT NULL,                     -- 最小名义价值(price*size)
    tick_size       DECIMAL(36, 18) NOT NULL,                     -- 价格最小变动单位

    -- 费率配置 (小数形式，如 0.001 = 0.1%)
    maker_fee       DECIMAL(10, 6) NOT NULL DEFAULT 0.001,        -- Maker 费率
    taker_fee       DECIMAL(10, 6) NOT NULL DEFAULT 0.001,        -- Taker 费率

    -- 状态控制
    status          SMALLINT NOT NULL DEFAULT 1,                  -- 状态: 1=活跃, 2=暂停, 3=下线
    trading_enabled BOOLEAN NOT NULL DEFAULT TRUE,                -- 是否允许交易
    display_order   INT NOT NULL DEFAULT 0,                       -- 前端展示排序

    -- 审计字段
    created_by      VARCHAR(42),                                  -- 创建者(管理员用户名)
    created_at      BIGINT NOT NULL,                              -- 创建时间(毫秒时间戳)
    updated_by      VARCHAR(42),                                  -- 更新者(管理员用户名)
    updated_at      BIGINT NOT NULL,                              -- 更新时间(毫秒时间戳)

    -- 索引
    INDEX idx_market_configs_status (status),                     -- 按状态筛选活跃市场
    INDEX idx_market_configs_trading (trading_enabled),           -- 可交易市场筛选
    INDEX idx_market_configs_base (base_token),                   -- 按基础代币查询
    INDEX idx_market_configs_quote (quote_token)                  -- 按报价代币查询
);
```

### 3.3 系统配置表

```sql
-- 系统配置表
-- 用途: 存储可动态调整的系统配置参数
-- 说明: 配置变更后需通知相关服务 reload
CREATE TABLE eidos_admin_system_configs (
    id              BIGSERIAL PRIMARY KEY,                        -- 配置唯一标识
    config_key      VARCHAR(100) NOT NULL UNIQUE,                 -- 配置键名，格式: 模块.参数名
    config_value    TEXT NOT NULL,                                -- 配置值(字符串形式存储)
    config_type     VARCHAR(20) NOT NULL,                         -- 值类型: string/number/boolean/json
    description     VARCHAR(500),                                 -- 配置说明
    is_secret       BOOLEAN NOT NULL DEFAULT FALSE,               -- 是否敏感配置(不显示明文)
    scope           VARCHAR(50) NOT NULL DEFAULT 'global',        -- 作用域: global/service名

    -- 审计字段
    created_by      VARCHAR(42),                                  -- 创建者(管理员用户名)
    created_at      BIGINT NOT NULL,                              -- 创建时间(毫秒时间戳)
    updated_by      VARCHAR(42),                                  -- 更新者(管理员用户名)
    updated_at      BIGINT NOT NULL,                              -- 更新时间(毫秒时间戳)

    -- 索引
    INDEX idx_system_configs_scope (scope),                       -- 按作用域筛选
    INDEX idx_system_configs_key (config_key)                     -- 配置键查询
);

-- 初始配置数据
INSERT INTO eidos_admin_system_configs (config_key, config_value, config_type, description, scope, created_at, updated_at) VALUES
('rate_limit.orders_per_second', '10', 'number', '每秒下单限制', 'eidos-api', 1704067200000, 1704067200000),
('rate_limit.queries_per_second', '100', 'number', '每秒查询限制', 'eidos-api', 1704067200000, 1704067200000),
('order.max_open_orders', '200', 'number', '单用户最大挂单数', 'eidos-trading', 1704067200000, 1704067200000),
('order.min_order_value', '10', 'number', '最小订单名义价值(USDC)', 'eidos-trading', 1704067200000, 1704067200000),
('withdraw.daily_limit', '0', 'number', '单用户每日提现限额(0=无限)', 'eidos-chain', 1704067200000, 1704067200000),
('withdraw.single_limit', '100000', 'number', '单笔提现限额(USDC)', 'eidos-chain', 1704067200000, 1704067200000),
('risk.price_deviation_pct', '10', 'number', '价格偏离阈值百分比', 'eidos-risk', 1704067200000, 1704067200000);
```

### 3.4 操作日志表

```sql
-- 管理后台操作审计日志表
-- 用途: 记录所有管理员操作，用于安全审计和问题追溯
-- 说明: 此表只增不改，保证审计完整性
CREATE TABLE eidos_admin_audit_logs (
    id              BIGSERIAL PRIMARY KEY,                        -- 日志唯一标识

    -- 操作者信息
    admin_id        BIGINT NOT NULL,                              -- 操作管理员 ID
    admin_username  VARCHAR(50) NOT NULL,                         -- 操作管理员用户名(冗余存储)
    ip_address      VARCHAR(45),                                  -- 操作来源 IP 地址
    user_agent      VARCHAR(500),                                 -- 客户端 User-Agent

    -- 操作信息
    action          VARCHAR(50) NOT NULL,                         -- 操作类型: create_market/update_fee/cancel_order 等
    resource_type   VARCHAR(50) NOT NULL,                         -- 资源类型: market/order/admin/config
    resource_id     VARCHAR(100),                                 -- 资源标识(如 symbol、order_id)
    description     VARCHAR(500),                                 -- 操作描述

    -- 变更详情
    old_value       JSONB,                                        -- 变更前的值(JSON 格式)
    new_value       JSONB,                                        -- 变更后的值(JSON 格式)

    -- 结果
    status          SMALLINT NOT NULL,                            -- 操作结果: 1=成功, 0=失败
    error_message   VARCHAR(500),                                 -- 失败时的错误信息

    -- 审计字段
    created_by      VARCHAR(42),                                  -- 创建者(同 admin_username)
    created_at      BIGINT NOT NULL,                              -- 创建时间(毫秒时间戳)
    updated_by      VARCHAR(42),                                  -- 更新者(审计日志不可更新)
    updated_at      BIGINT NOT NULL,                              -- 更新时间(审计日志不可更新)

    -- 索引
    INDEX idx_audit_admin (admin_id),                             -- 按操作者查询
    INDEX idx_audit_action (action),                              -- 按操作类型筛选
    INDEX idx_audit_resource (resource_type, resource_id),        -- 按资源查询操作历史
    INDEX idx_audit_created (created_at DESC),                    -- 按时间倒序查询
    INDEX idx_audit_status (status)                               -- 按操作结果筛选
);
```

### 3.5 统计数据表

```sql
-- 日统计汇总表
-- 用途: 存储按天聚合的交易、用户、手续费统计数据
-- 说明: 由 eidos-jobs 定时任务每日凌晨聚合写入
CREATE TABLE eidos_admin_daily_stats (
    id              BIGSERIAL PRIMARY KEY,                        -- 记录唯一标识
    stat_date       DATE NOT NULL,                                -- 统计日期
    market          VARCHAR(20),                                  -- 交易对(NULL 表示全市场汇总)

    -- 交易统计
    trade_count     BIGINT NOT NULL DEFAULT 0,                    -- 成交笔数
    trade_volume    DECIMAL(36, 18) NOT NULL DEFAULT 0,           -- 成交量(base 代币)
    trade_amount    DECIMAL(36, 18) NOT NULL DEFAULT 0,           -- 成交额(quote 代币)

    -- 订单统计
    order_count     BIGINT NOT NULL DEFAULT 0,                    -- 下单总数
    cancelled_count BIGINT NOT NULL DEFAULT 0,                    -- 取消订单数

    -- 手续费统计 (quote 代币计)
    maker_fee_total DECIMAL(36, 18) NOT NULL DEFAULT 0,           -- Maker 手续费总额
    taker_fee_total DECIMAL(36, 18) NOT NULL DEFAULT 0,           -- Taker 手续费总额

    -- 用户统计
    active_users    INT NOT NULL DEFAULT 0,                       -- 活跃用户数(当日有交易)
    new_users       INT NOT NULL DEFAULT 0,                       -- 新增用户数(首次交易)

    -- 审计字段
    created_by      VARCHAR(42),                                  -- 创建者(定时任务标识)
    created_at      BIGINT NOT NULL,                              -- 创建时间(毫秒时间戳)
    updated_by      VARCHAR(42),                                  -- 更新者
    updated_at      BIGINT NOT NULL,                              -- 更新时间(毫秒时间戳)

    -- 唯一约束
    UNIQUE (stat_date, market),

    -- 索引
    INDEX idx_daily_stats_date (stat_date DESC),                  -- 按日期倒序查询
    INDEX idx_daily_stats_market (market),                        -- 按市场筛选
    INDEX idx_daily_stats_date_market (stat_date, market)         -- 联合查询
);
```

### 3.6 配置版本表

```sql
-- 全局配置版本表
-- 用途: 跟踪各类配置的版本号，用于服务配置同步
-- 说明: 每次配置变更时版本号 +1，各服务以此判断是否需要 reload
CREATE TABLE eidos_admin_config_versions (
    scope           VARCHAR(50) PRIMARY KEY,                      -- 配置作用域: market_configs/system_configs/risk_rules
    version         BIGINT NOT NULL DEFAULT 0,                    -- 当前版本号(单调递增)
    updated_by      VARCHAR(42),                                  -- 最后更新者(管理员用户名)
    updated_at      BIGINT NOT NULL                               -- 最后更新时间(毫秒时间戳)
);

-- 初始化版本记录
INSERT INTO eidos_admin_config_versions (scope, version, updated_at) VALUES
('market_configs', 0, 1704067200000),
('system_configs', 0, 1704067200000),
('risk_rules', 0, 1704067200000);
```

---

## 四、数据流转

### 4.1 交易对配置管理

**设计说明**:
- 配置变更直接写入数据库，不依赖消息队列
- 各服务在启动时从数据库加载配置
- 配置变更后，通过内部接口或重启服务使配置生效

#### 4.1.1 配置版本号与一致性约束（必须）

> **目标**: 防止 `eidos-trading / eidos-matching / eidos-market / eidos-risk / eidos-api` 在同一时间窗口加载到**不同版本**配置而导致错误撮合、错误风控或错误限价。

**核心原则**:
- **所有配置变更必须有单调递增的版本号**（config_version）
- **服务必须以“版本号”为准判断是否需要 reload**，并在 reload 完成后上报当前版本
- **涉及撮合不变量的配置变更必须走“维护窗口发布流程”**（见 4.1.3），禁止热更新

**推荐实现（全局版本表）**:

```sql
-- 全局配置版本表：每次配置变更 +1（按 scope 维度）
CREATE TABLE config_versions (
    scope        VARCHAR(50) PRIMARY KEY,   -- market_configs / system_configs / risk_rules ...
    version      BIGINT NOT NULL DEFAULT 0,
    updated_by   VARCHAR(42),
    updated_at   BIGINT NOT NULL
);
```

**写入事务约束（示例：变更市场配置）**:

```sql
BEGIN;

-- 1) 先写配置（market_configs / system_configs / risk_rules 等）
UPDATE market_configs
SET maker_fee = $1,
    taker_fee = $2,
    updated_by = $op,
    updated_at = $now
WHERE symbol = $symbol;

-- 2) 同事务 bump 版本号（作为“配置发布版本”）
UPDATE config_versions
SET version = version + 1,
    updated_by = $op,
    updated_at = $now
WHERE scope = 'market_configs'
RETURNING version;

COMMIT;
```

> **说明**: 版本号是“发布信号”。各服务 reload 时应读取 `config_versions.scope` 的 `version`，并将本地缓存的版本推进到最新。

#### 4.1.2 生效方式（reload / 重启）的验收要求

无论采用重启还是 reload，都必须满足：
- **可观测**: 每个服务暴露 `config_version{scope="market_configs"}` 指标或 `/internal/config/version`（二选一），便于运维核对“已全部推进”
- **可审计**: `eidos-admin` 记录本次变更的 scope、版本号、影响市场、影响字段、触发 reload 的服务列表与结果

#### 4.1.3 配置发布流程（SOP，防止版本分叉）

**A. 热更新（允许）**：不影响撮合不变量的配置，例如：
- 限流阈值、最大挂单数等 `system_configs`
- 风控阈值/黑名单等 `risk_rules`
- **不改变撮合精度/价格步长/最小下单量**的轻量市场参数（如费率）

流程（推荐顺序）：
1. `eidos-admin` 事务写 DB + bump `config_versions`（得到 version）
2. 依次触发相关服务 reload（建议顺序）：`eidos-risk` → `eidos-trading` → `eidos-api` → `eidos-market`
3. 运维核对所有相关服务的 `config_version` 已达到目标 version
4. 记录审计日志，完成发布

**B. 维护窗口发布（必须）**：会影响撮合不变量或撮合状态的变更，例如：
- 新增交易对（需要初始化订单簿）
- 修改 `price_decimals/size_decimals/tick_size/min_size/min_notional` 等撮合/撮合前校验的关键约束
- 任何要求撮合引擎重建内部结构的数据变更

流程（强制顺序）：
1. **停新单**：将对应市场 `status=2(暂停)` 且 `trading_enabled=false` 写入 DB，并 bump 版本号
2. 触发 `eidos-api` / `eidos-trading` / `eidos-risk` reload，确保新单被拒绝（以版本号验收）
3. 等待撮合队列 drain（撮合完成处理在途消息），并生成撮合快照（matching 快照机制）
4. 重启/滚动 `eidos-matching`（必要时 `eidos-market` 一并重启或 reload）以重建内部状态
5. 再次核对各服务配置版本一致（尤其 matching + trading + risk）
6. **恢复交易**：将市场 `status=1(活跃)` 且 `trading_enabled=true` 写入 DB，并 bump 版本号；触发相关服务 reload 生效
7. 监控 5~10 分钟（拒单率、撮合延迟、成交率、风险拦截率），确认稳定后结束窗口

#### 4.1.4 新增交易对（必须包含“初始化订单簿”）

推荐分两阶段：

**阶段 1：预发布（不对外）**
1. `eidos-admin` 创建 `market_configs` 记录，设置 `status=2(暂停)`、`trading_enabled=false`
2. bump `config_versions(scope='market_configs')`
3. 重启 `eidos-matching`（或执行其“创建市场/初始化订单簿”内部能力，若实现）以初始化空订单簿
4. `eidos-market` 从 DB 加载新市场配置，准备行情聚合/订阅（可先不对外推送）

**阶段 2：开闸（对外）**
1. 将市场切到 `status=1(活跃)`、`trading_enabled=true`，bump 版本号
2. reload `eidos-risk` / `eidos-trading` / `eidos-api` / `eidos-market`
3. 观察：订单拒绝原因分布、撮合延迟、行情推送延迟、K线落库是否正常

> **注意**: 上述 `config_versions`/版本验收指标/发布 SOP 是**强约束**。如果短期内不实现版本表，至少也要实现“配置读取结果带版本号 + reload 后上报版本号”的最小闭环，否则无法证明“撮合/行情/交易/风控已统一到同一配置版本”。 

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       交易对配置管理流程                                     │
│                                                                              │
│  Admin前端        eidos-admin          PostgreSQL         其他服务          │
│      │                │                    │                   │             │
│      │ 新增/编辑交易对│                    │                   │             │
│      │───────────────>│                    │                   │             │
│      │                │                    │                   │             │
│      │                │ 1. 保存到 DB       │                   │             │
│      │                │───────────────────>│                   │             │
│      │                │                    │                   │             │
│      │                │ 2. 记录审计日志    │                   │             │
│      │                │───────────────────>│                   │             │
│      │                │                    │                   │             │
│      │ 200 OK         │                    │                   │             │
│      │<───────────────│                    │                   │             │
│      │                │                    │                   │             │
│                                                                              │
│  配置生效方式 (任选其一):                                                    │
│  ────────────────────────                                                    │
│  方式1: 服务重启 - 重启 eidos-matching/eidos-market 等服务                  │
│  方式2: 内部接口 - 调用 /internal/reload 接口刷新配置                       │
│                                                                              │
│  注意: 新增交易对通常需要重启撮合引擎以初始化订单簿                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 统计数据查询

**说明**: 统计数据由 eidos-jobs 定时聚合写入 daily_stats 表，eidos-admin 仅做查询展示。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       统计数据查询                                           │
│                                                                              │
│  数据来源:                                                                   │
│  ──────────                                                                  │
│  - daily_stats 表 (由 eidos-jobs 定时聚合)                                  │
│  - Redis 实时统计缓存 (由 eidos-jobs 更新)                                  │
│                                                                              │
│  eidos-admin 职责:                                                          │
│  ─────────────────                                                           │
│  - 读取 daily_stats 表展示历史统计                                          │
│  - 读取 Redis 缓存展示实时统计                                              │
│  - 不做任何聚合计算                                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、服务依赖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       eidos-admin 服务依赖                                   │
│                                                                              │
│                              eidos-admin                                     │
│                                  │                                           │
│         ┌────────────────────────┼────────────────────────┐                  │
│         │                        │                        │                  │
│         ▼                        ▼                        ▼                  │
│  ┌─────────────────────────────────────┐        ┌──────────────┐           │
│  │         eidos-trading              │        │ eidos-market │           │
│  │                                    │        │              │           │
│  │ 订单查询 / 订单取消 / 成交查询     │        │ 交易对状态   │           │
│  │ 余额查询 / 流水查询                │        │              │           │
│  └─────────────────────────────────────┘        └──────────────┘           │
│                                                                              │
│  本地存储:                                                                   │
│  ──────────                                                                  │
│  - PostgreSQL: admins, market_configs, system_configs, audit_logs           │
│  - Redis: 会话缓存, 统计缓存                                                 │
│                                                                              │
│  说明: 本服务不依赖 Kafka，配置变更直接写数据库                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、配置项

```yaml
service:
  name: eidos-admin
  port: 8088

nacos:
  server_addr: "nacos:8848"
  namespace: "eidos-prod"
  group: "EIDOS_GROUP"

# gRPC 客户端
grpc_clients:
  eidos-trading:
    timeout: 5s
  eidos-market:
    timeout: 3s

# 数据库
postgres:
  host: postgres
  port: 5432
  database: eidos_admin
  max_connections: 50

redis:
  cluster:
    nodes:
      - redis-1:6379
      - redis-2:6379
      - redis-3:6379

# JWT 配置
jwt:
  secret: "${JWT_SECRET}"
  expires_in: 8h

# 应用安全配置
app_security:
  password_min_length: 8
  max_login_attempts: 5
  lockout_duration: 30m

# =============================================================================
# 安全传输配置 (云组件加密)
# =============================================================================
# 说明: 生产环境使用云托管组件，默认启用加密传输
#       本地开发/测试环境可关闭加密以简化配置
security:
  # 总开关: true=启用加密, false=关闭加密 (本地测试)
  tls_enabled: ${TLS_ENABLED:false}

  # HTTP TLS (对外)
  # 注意: 管理后台部署在内网，可由内部 LB 终结 TLS
  http:
    enabled: ${HTTP_TLS_ENABLED:false}
    cert: "${HTTP_CERT_PATH}"
    key: "${HTTP_KEY_PATH}"

  # gRPC TLS (调用后端服务)
  grpc:
    enabled: ${GRPC_TLS_ENABLED:false}
    ca_cert: "${GRPC_CA_CERT_PATH}"
    client_cert: "${GRPC_CLIENT_CERT_PATH}"
    client_key: "${GRPC_CLIENT_KEY_PATH}"

  # PostgreSQL TLS (云 RDS)
  postgres:
    enabled: ${PG_TLS_ENABLED:false}
    sslmode: "verify-full"
    ca_cert: "${PG_CA_CERT_PATH}"

  # Redis TLS
  redis:
    enabled: ${REDIS_TLS_ENABLED:false}
    ca_cert: "${REDIS_CA_CERT_PATH}"
    skip_verify: false

  # Nacos TLS
  nacos:
    enabled: ${NACOS_TLS_ENABLED:false}
    ca_cert: "${NACOS_CA_CERT_PATH}"
```

---

## 七、Redis 缓存设计

### 7.1 Key 命名规范

```
eidos:admin:{domain}:{identifier}

命名示例:
├── eidos:admin:session:{token_id}          JWT 会话缓存
├── eidos:admin:login_attempts:{username}   登录失败计数
├── eidos:admin:config:{scope}              配置缓存
├── eidos:admin:market:{symbol}             市场配置缓存
└── eidos:admin:stats:realtime              实时统计缓存
```

### 7.2 会话管理

| Key 模式 | 类型 | TTL | 说明 |
|----------|------|-----|------|
| `eidos:admin:session:{token_id}` | HASH | 8h | JWT 会话详情 |
| `eidos:admin:login_attempts:{username}` | STRING | 30min | 登录失败次数计数 |
| `eidos:admin:locked:{username}` | STRING | 锁定时长 | 账号锁定标记 |

**会话 HASH 结构**:

```
HGETALL eidos:admin:session:{token_id}
{
    "admin_id": "1",                       -- 管理员 ID
    "username": "admin",                   -- 用户名
    "role": "super_admin",                 -- 角色
    "permissions": "[\"market:*\",...]",   -- 权限列表(JSON)
    "ip": "192.168.1.1",                   -- 登录 IP
    "created_at": "1704067200000"          -- 创建时间
}
```

**登录锁定逻辑**:

```lua
-- 登录失败处理
-- KEYS[1]: eidos:admin:login_attempts:{username}
-- KEYS[2]: eidos:admin:locked:{username}
-- ARGV[1]: 最大尝试次数
-- ARGV[2]: 锁定时长(秒)

local attempts = redis.call('INCR', KEYS[1])
redis.call('EXPIRE', KEYS[1], 1800)  -- 30分钟窗口

if tonumber(attempts) >= tonumber(ARGV[1]) then
    redis.call('SET', KEYS[2], '1', 'EX', ARGV[2])
    redis.call('DEL', KEYS[1])
    return 0  -- 账号已锁定
end

return tonumber(ARGV[1]) - attempts  -- 剩余尝试次数
```

### 7.3 配置缓存

| Key 模式 | 类型 | TTL | 说明 |
|----------|------|-----|------|
| `eidos:admin:config:version:{scope}` | STRING | - | 配置版本号 |
| `eidos:admin:config:data:{scope}` | STRING | 5min | 配置数据(JSON) |
| `eidos:admin:market:{symbol}` | HASH | 5min | 单个市场配置 |
| `eidos:admin:markets:active` | STRING | 1min | 活跃市场列表(JSON) |

**配置读取策略**:

```
1. 先检查 Redis 缓存
2. 若缓存不存在或版本不匹配，从 DB 加载
3. 更新缓存并设置 TTL
4. 配置变更时主动删除缓存

配置变更事件处理:
1. 更新 DB
2. 更新 config_versions 表
3. DEL eidos:admin:config:data:{scope}
4. DEL eidos:admin:markets:active (若影响市场配置)
```

### 7.4 统计缓存

| Key 模式 | 类型 | TTL | 说明 |
|----------|------|-----|------|
| `eidos:admin:stats:realtime` | HASH | 1min | 实时统计数据 |
| `eidos:admin:stats:today:{market}` | HASH | 5min | 当日市场统计 |
| `eidos:admin:stats:overview` | STRING | 5min | 总览数据(JSON) |

**实时统计 HASH 结构**:

```
HGETALL eidos:admin:stats:realtime
{
    "total_volume_24h": "12345678.90",     -- 24小时交易量
    "total_trades_24h": "54321",           -- 24小时成交笔数
    "active_users_24h": "1234",            -- 24小时活跃用户
    "open_orders": "9876",                 -- 当前挂单数
    "updated_at": "1704067200000"          -- 更新时间
}
```

**说明**: 实时统计由 eidos-jobs 定时刷新写入 Redis，eidos-admin 直接读取展示。

### 7.5 缓存策略汇总

| 缓存类型 | 写入策略 | 一致性保障 | 备注 |
|----------|----------|------------|------|
| JWT 会话 | 登录时创建 | 强一致 | 登出时主动删除 |
| 登录锁定 | 失败时写入 | 强一致 | 自动过期解锁 |
| 市场配置 | 读时写入 | 最终一致(5min) | 变更时主动删除 |
| 实时统计 | 定时刷新 | 最终一致(1min) | eidos-jobs 维护 |
