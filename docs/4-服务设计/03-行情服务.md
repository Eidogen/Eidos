# Eidos 行情服务设计

> 服务名: eidos-market
> 语言: Go

---

## 一、服务职责

### 1.1 核心定位

Market Data Service (行情服务) 负责聚合和分发所有行情数据，包括 K线、Ticker、订单簿深度、成交流等。

### 1.2 职责边界

| 职责 | 描述 | 属于本服务 |
|------|------|-----------|
| K线聚合 | 实时聚合各周期 K线 | ✅ |
| Ticker 计算 | 24h 统计数据 | ✅ |
| 订单簿快照 | 维护和分发订单簿深度 | ✅ |
| 成交流 | 分发实时成交记录 | ✅ |
| 数据推送 | 通过 Redis Pub/Sub 推送给 WebSocket | ✅ |
| 历史数据 | K线历史存储和查询 | ✅ |

### 1.3 对外能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Market Data Service 对外能力                             │
│                                                                              │
│  gRPC 接口:                                                                  │
│  ───────────                                                                 │
│  - GetKlines      查询K线数据                                               │
│  - GetTicker      查询单个Ticker                                            │
│  - GetTickers     查询所有Ticker                                            │
│  - GetOrderBook   查询订单簿深度                                            │
│  - GetTrades      查询最近成交                                              │
│  - GetMarkets     查询交易对列表                                            │
│                                                                              │
│  Kafka 消费:                                                                 │
│  ───────────                                                                 │
│  - topic: trade-results      成交数据 (用于 K线、Ticker)                    │
│  - topic: orderbook-updates  订单簿增量更新                                  │
│                                                                              │
│  Redis Pub/Sub 发布:                                                         │
│  ─────────────────────                                                       │
│  - eidos:kline:{market}:{interval}   K线更新                                │
│  - eidos:ticker:{market}             Ticker 更新                            │
│  - eidos:depth:{market}:{level}      深度更新                               │
│  - eidos:trades:{market}             成交流                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、模块架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Market Data Service 内部架构                            │
│                                                                              │
│  Kafka Consumer (trade-results, orderbook-updates)                          │
│                    │                                                         │
│                    ▼                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                       │
│  │ KlineAggr    │  │ TickerCalc   │  │ OrderBookMgr │                       │
│  │  K线聚合器   │  │  Ticker计算  │  │  订单簿管理  │                       │
│  │ 1m/5m/15m/   │  │  24h统计     │  │  深度快照    │                       │
│  │ 1h/4h/1d/1w  │  │  涨跌幅      │  │  增量更新    │                       │
│  └──────────────┘  └──────────────┘  └──────────────┘                       │
│         │                  │                  │                              │
│         └──────────────────┴──────────────────┘                              │
│                            │                                                 │
│                            ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  gRPC Server  +  Redis Pub/Sub Publisher  +  Storage Layer          │    │
│  │  (Redis 实时缓存 + TimescaleDB K线历史 + PostgreSQL 交易对配置)     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、K线聚合设计

### 3.1 K线周期

1m, 5m, 15m, 30m, 1h, 4h, 1d, 1w

### 3.2 K线数据结构

```json
{
  "open_time": 1704067200000,
  "open": "50000.00",
  "high": "50500.00",
  "low": "49800.00",
  "close": "50200.00",
  "volume": "123.456",
  "quote_volume": "6172800.00",
  "trades": 1234,
  "close_time": 1704067259999
}
```

### 3.3 聚合规则

- 成交触发 1m K线更新 (内存)
- 每分钟保存到 TimescaleDB，创建新 K线
- 大周期聚合：5m = 5×1m, 15m = 3×5m, 1h = 4×15m, ...
- 聚合公式：Open=第一根Open, High=max(High), Low=min(Low), Close=最后Close, Volume=sum

---

## 四、Ticker 计算

### 4.1 Ticker 数据结构

```json
{
  "symbol": "BTC-USDC",
  "last_price": "50200.00",
  "price_change": "200.00",
  "price_change_percent": "0.40",
  "high_price": "50800.00",
  "low_price": "49200.00",
  "volume": "12345.67",
  "quote_volume": "617283950.00",
  "best_bid": "50190.00",
  "best_ask": "50210.00"
}
```

### 4.2 计算方式

使用 1 分钟桶聚合（推荐）：
- 保存最近 1440 个桶 (24h × 60min)
- 计算 Ticker 时聚合所有桶
- 增量更新最新桶

---

## 五、订单簿深度

### 5.1 深度级别

5, 10, 20, 50, 100 档

### 5.2 深度数据结构

```json
{
  "last_update_id": 123456789,
  "bids": [["49990.00", "1.5"], ["49980.00", "2.3"]],
  "asks": [["50010.00", "0.8"], ["50020.00", "1.2"]]
}
```

### 5.3 同步机制

- 序列号检查：检测缺口触发全量同步
- 定期全量同步：每 60 秒
- 校验和检查：CRC32 校验前 25 档

---

## 六、数据库设计

> 表名前缀: `eidos_market_`
> 存储: TimescaleDB (K线) + PostgreSQL (配置)

### 6.1 K线数据表 (TimescaleDB Hypertable)

```sql
CREATE TABLE eidos_market_klines (
    time            TIMESTAMPTZ NOT NULL,             -- K线开盘时间 (UTC)
    market          VARCHAR(20) NOT NULL,             -- 交易对，如 BTC-USDC
    interval        VARCHAR(5) NOT NULL,              -- K线周期: 1m/5m/15m/30m/1h/4h/1d/1w
    open            DECIMAL(36, 18) NOT NULL,         -- 开盘价
    high            DECIMAL(36, 18) NOT NULL,         -- 最高价
    low             DECIMAL(36, 18) NOT NULL,         -- 最低价
    close           DECIMAL(36, 18) NOT NULL,         -- 收盘价
    volume          DECIMAL(36, 18) NOT NULL,         -- 成交量 (基础代币数量)
    quote_volume    DECIMAL(36, 18) NOT NULL,         -- 成交额 (计价代币金额)
    trades          INT NOT NULL,                     -- 成交笔数

    PRIMARY KEY (market, interval, time),
    INDEX idx_klines_market_interval (market, interval, time DESC)  -- 按时间倒序查询
);

-- 创建 Hypertable，按天分片
SELECT create_hypertable('eidos_market_klines', 'time', chunk_time_interval => INTERVAL '1 day');
```

### 6.2 交易对配置表

```sql
CREATE TABLE eidos_market_markets (
    id              SERIAL PRIMARY KEY,               -- 自增主键
    symbol          VARCHAR(20) NOT NULL UNIQUE,      -- 交易对符号，如 BTC-USDC
    base_token      VARCHAR(10) NOT NULL,             -- 基础代币，如 BTC
    quote_token     VARCHAR(10) NOT NULL,             -- 计价代币，如 USDC
    price_decimals  SMALLINT NOT NULL DEFAULT 2,      -- 价格显示精度位数
    size_decimals   SMALLINT NOT NULL DEFAULT 6,      -- 数量显示精度位数
    min_size        DECIMAL(36, 18) NOT NULL,         -- 最小下单数量
    max_size        DECIMAL(36, 18),                  -- 最大下单数量，NULL表示不限
    min_notional    DECIMAL(36, 18) NOT NULL,         -- 最小下单金额 (price * size)
    tick_size       DECIMAL(36, 18) NOT NULL,         -- 价格最小变动单位
    maker_fee       DECIMAL(10, 6) NOT NULL DEFAULT 0.001,  -- Maker 费率，0.001 = 0.1%
    taker_fee       DECIMAL(10, 6) NOT NULL DEFAULT 0.001,  -- Taker 费率
    status          SMALLINT NOT NULL DEFAULT 1,      -- 状态: 1=活跃, 2=暂停, 3=下线
    trading_enabled BOOLEAN NOT NULL DEFAULT TRUE,    -- 是否允许交易
    created_by      VARCHAR(42),                      -- 创建者钱包地址
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    updated_by      VARCHAR(42),                      -- 更新者钱包地址
    updated_at      BIGINT NOT NULL,                  -- 更新时间 (毫秒时间戳)

    INDEX idx_markets_status (status)                 -- 按状态查询
);
```

### 6.3 成交历史表

```sql
-- 成交历史表 (按月分区)
-- 预估数据量: 每日 100万+ 条，月增 3000万+
-- 分区策略: 按 traded_at 时间范围分区，每月一个分区
CREATE TABLE eidos_market_trade_history (
    id              BIGSERIAL,                        -- 自增ID (分区表不能做主键)
    trade_id        VARCHAR(64) NOT NULL,             -- 成交唯一ID (来自撮合引擎)
    market          VARCHAR(20) NOT NULL,             -- 交易对，如 BTC-USDC
    price           DECIMAL(36, 18) NOT NULL,         -- 成交价格
    size            DECIMAL(36, 18) NOT NULL,         -- 成交数量 (基础代币)
    quote_amount    DECIMAL(36, 18) NOT NULL,         -- 成交金额 (计价代币)
    side            SMALLINT NOT NULL,                -- Taker方向: 0=买入, 1=卖出
    maker           VARCHAR(42) NOT NULL,             -- Maker方钱包地址
    taker           VARCHAR(42) NOT NULL,             -- Taker方钱包地址
    traded_at       BIGINT NOT NULL,                  -- 成交时间 (毫秒时间戳)

    PRIMARY KEY (traded_at, id),                      -- 分区键必须包含在主键中
    UNIQUE (trade_id, traded_at)                      -- 唯一约束需包含分区键
) PARTITION BY RANGE (traded_at);

-- 分区索引 (自动应用到所有分区)
CREATE INDEX idx_trade_history_market_time ON eidos_market_trade_history (market, traded_at DESC);
CREATE INDEX idx_trade_history_maker ON eidos_market_trade_history (maker, traded_at DESC);
CREATE INDEX idx_trade_history_taker ON eidos_market_trade_history (taker, traded_at DESC);

-- 创建分区示例 (按月，时间戳为毫秒)
-- 2024年1月: 1704067200000 ~ 1706745600000
CREATE TABLE eidos_market_trade_history_2024_01 PARTITION OF eidos_market_trade_history
    FOR VALUES FROM (1704067200000) TO (1706745600000);

-- 2024年2月: 1706745600000 ~ 1709251200000
CREATE TABLE eidos_market_trade_history_2024_02 PARTITION OF eidos_market_trade_history
    FOR VALUES FROM (1706745600000) TO (1709251200000);

-- 后续分区由 eidos-jobs 定时任务自动创建
```

### 6.4 成交历史分区管理

```sql
-- 自动创建下月分区 (eidos-jobs 每月1日执行)
-- 示例: 创建2024年3月分区
DO $$
DECLARE
    partition_name TEXT;
    start_ts BIGINT;
    end_ts BIGINT;
BEGIN
    partition_name := 'eidos_market_trade_history_2024_03';
    start_ts := 1709251200000;  -- 2024-03-01 00:00:00 UTC
    end_ts := 1711929600000;    -- 2024-04-01 00:00:00 UTC

    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF eidos_market_trade_history FOR VALUES FROM (%s) TO (%s)',
        partition_name, start_ts, end_ts
    );
END $$;

-- 分区保留策略
-- 热数据: 最近 3 个月，保留在主存储
-- 温数据: 3-12 个月，可迁移到低成本存储
-- 冷数据: 12 个月以上，归档到对象存储或删除
```

### 6.2 K线保留策略

| 周期 | 保留时间 |
|------|----------|
| 1m | 7 天 |
| 5m | 30 天 |
| 15m | 90 天 |
| 其他 | 永久 |

### 6.3 Redis 缓存结构

```
eidos:ticker:{market}         → Ticker 缓存
eidos:orderbook:{market}      → 订单簿快照
eidos:trades:{market}         → 最近成交 (List, 100条)
eidos:kline:{market}:{interval} → 当前 K线
eidos:ticker_bucket:{market}:{minute} → 1分钟桶 (TTL 25h)
```

---

## 七、容灾恢复

### 7.1 恢复流程

1. 加载检查点 (Redis)
2. 恢复 K线 (TimescaleDB 最近 2h)
3. 同步订单簿 (从 eidos-matching 获取快照)
4. 从检查点 offset 消费 Kafka

### 7.2 检查点

每 10 秒或每 100 条消息保存检查点到 Redis

---

## 八、配置

```yaml
service:
  name: eidos-market
  grpc_port: 50053

kafka:
  consumer:
    group_id: eidos-market
    topics:
      - trade-results
      - orderbook-updates

klines:
  intervals: [1m, 5m, 15m, 30m, 1h, 4h, 1d, 1w]

orderbook:
  levels: [5, 10, 20, 50, 100]
  snapshot_interval: 100ms
  full_sync_interval: 60s

ticker:
  update_interval: 100ms
  bucket_count: 1440

# =============================================================================
# 安全传输配置 (云组件加密)
# =============================================================================
# 说明: 生产环境使用云托管组件，默认启用加密传输
#       本地开发/测试环境可关闭加密以简化配置
security:
  # 总开关: true=启用加密, false=关闭加密 (本地测试)
  tls_enabled: ${TLS_ENABLED:false}

  # gRPC TLS (服务间调用)
  grpc:
    enabled: ${GRPC_TLS_ENABLED:false}
    cert: "${GRPC_CERT_PATH}"               # 服务端证书
    key: "${GRPC_KEY_PATH}"                 # 服务端私钥
    ca_cert: "${GRPC_CA_CERT_PATH}"         # CA 证书 (用于验证客户端)
    client_auth: false                      # 是否要求客户端证书 (mTLS)

  # PostgreSQL/TimescaleDB TLS (云 RDS)
  postgres:
    enabled: ${PG_TLS_ENABLED:false}
    sslmode: "verify-full"                  # disable | require | verify-ca | verify-full
    ca_cert: "${PG_CA_CERT_PATH}"           # RDS CA 证书

  # Kafka TLS/SASL
  kafka:
    enabled: ${KAFKA_TLS_ENABLED:false}
    protocol: "SASL_SSL"
    sasl_mechanism: "SCRAM-SHA-512"
    ca_cert: "${KAFKA_CA_CERT_PATH}"
    username: "${KAFKA_SASL_USERNAME}"
    password: "${KAFKA_SASL_PASSWORD}"

  # Redis TLS
  redis:
    enabled: ${REDIS_TLS_ENABLED:false}
    ca_cert: "${REDIS_CA_CERT_PATH}"
    skip_verify: false
```

---

## 九、监控指标

| 指标 | 说明 |
|------|------|
| market_data_kline_updates_total | K线更新数 |
| market_data_ticker_updates_total | Ticker 更新数 |
| market_data_orderbook_updates_total | 订单簿更新数 |
| market_data_trades_processed_total | 成交处理数 |
| market_data_pubsub_latency_ms | Pub/Sub 延迟 |
| market_data_grpc_latency_ms | gRPC 延迟 |
| market_data_orderbook_sync_total | 订单簿同步数 |

---

## 十、Proto 定义

详见: `eidos-market/api/proto/market/v1/market.proto`

核心接口:
- GetKlines / GetTicker / GetTickers
- GetOrderBook / GetTrades
- GetMarkets / GetMarket

核心枚举:
- KlineInterval: 1M/5M/15M/30M/1H/4H/1D/1W
- MarketStatus: ACTIVE/SUSPENDED/DELISTED
