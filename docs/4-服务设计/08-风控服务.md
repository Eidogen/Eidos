# Eidos 风控服务设计

> 服务名: eidos-risk
> 语言: Go

---

## 一、服务概述

### 1.1 核心定位

eidos-risk 是交易风控服务，负责交易前校验和交易后监控。

**设计原则**:
- 同步校验保证实时拦截
- 异步监控降低性能影响
- 规则可配置支持动态调整

### 1.2 职责边界

| 职责 | 描述 | 属于本服务 |
|------|------|-----------|
| 价格偏离检查 | 检查订单价格是否偏离市场价过大 | ✅ |
| 单笔限额检查 | 检查单笔交易金额是否超限 | ✅ |
| 频率限制 | 检查用户下单频率是否异常 | ✅ |
| 自成交检测 | 检测是否与自己的订单成交 | ✅ |
| 异常交易告警 | 监控异常交易行为 | ✅ |
| 大额提现审核 | 审核大额提现请求 | ✅ |
| 黑名单管理 | 管理风险地址黑名单 | ✅ |

### 1.3 对外能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       eidos-risk 对外能力                                    │
│                                                                              │
│  gRPC 接口 (同步调用):                                                       │
│  ─────────────────────                                                       │
│  - CheckOrder        订单风控校验                                           │
│  - CheckWithdraw     提现风控校验                                           │
│  - GetRiskStatus     查询风险状态                                           │
│  - AddToBlacklist    添加黑名单                                             │
│  - RemoveFromBlack   移除黑名单                                             │
│                                                                              │
│  Kafka 消费 (异步监控):                                                      │
│  ─────────────────────                                                       │
│  - topic: trade-results    成交结果                                         │
│  - topic: order-updates    订单状态                                         │
│                                                                              │
│  Kafka 生产:                                                                 │
│  ───────────                                                                 │
│  - topic: risk-alerts      风控告警事件                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、同步风控校验

### 2.1 订单风控流程

1. 黑名单检查
2. 价格偏离检查 (对比最近成交价)
3. 单笔限额检查
4. 频率限制检查 (滑动窗口)
5. 自成交风险检查
6. 返回结果 (allowed/rejected + reason)

### 2.2 服务降级策略

**分级降级** (非简单 fail_open):

| 级别 | 触发条件 | 执行的检查 |
|------|----------|-----------|
| Level 0 | 正常 | 全部检查 |
| Level 1 | 超时率 > 10% | 跳过洗盘检测 |
| Level 2 | 超时率 > 30% | 只执行黑名单 + 限额 |
| Level 3 | 超时率 > 50% | 只执行黑名单 |
| Level 4 | 错误率 > 80% | 熔断 (fail_close) |

恢复策略: 每 30 秒尝试恢复一个级别，先用 10% 流量探测

### 2.3 风控规则

#### 价格偏离检查

```
deviation = |order_price - reference_price| / reference_price * 100%

参考价格来源 (优先级):
1. 最近成交价 (10分钟内)
2. 中间价 (best_bid + best_ask) / 2
3. 外部指数价格

阈值:
- warning: 5%
- reject: 10%
- 市价单: 3%
```

#### 频率限制

- 下单: 10/秒, 200/分钟
- 取消: 20/秒, 500/分钟
- 提现: 10/小时, 50/天

使用 Redis Lua 脚本实现原子滑动窗口

#### 单笔限额

- 订单: 最小 10 USDC, 最大 100,000 USDC
- 提现: 单笔 50,000 USDC, 每日 500,000 USDC

#### 自成交检查

- 查询用户现有挂单
- 检查新订单是否可能与现有挂单成交
- 优化: 缓存用户订单价格区间，O(1) 快速判断

---

## 三、大额提现审核

### 3.1 审核流程

```
用户提现 → 风控检查 → 金额 > 10000?
                         ↓ 是
                    创建审核任务 → 审核员处理 → 通过/拒绝
                         ↓ 通过
                    触发链上提现
```

### 3.2 风险评分因素

| 因素 | 分值 |
|------|------|
| 金额 > 50,000 | +30 |
| 账户年龄 < 7 天 | +25 |
| 新目标地址 | +15 |
| 24h 内提现 > 5 次 | +20 |

### 3.3 自动决策

- 低风险 (< 30 分): 自动通过
- 中风险 (30-70 分): 人工审核
- 高风险 (> 70 分): 建议拒绝

审核超时 (24h): 低风险自动通过，高风险自动拒绝

---

## 四、异步风控监控

### 4.1 检测规则

| 检测项 | 触发条件 | 告警级别 | 处理方式 |
|--------|----------|----------|----------|
| 价格异动 | 5 分钟涨跌 > 5% | 警告 | 记录日志 |
| 洗盘嫌疑 | 同账户 1h 内 > 50 笔 | 严重 | 暂停账户 |
| 大单异动 | 单笔 > 日均 10 倍 | 警告 | 人工审核 |
| 高频交易 | 1 分钟 > 1000 笔 | 严重 | 限制频率 |

### 4.2 自动处置

| 异常类型 | 自动处置 | 需人工确认 |
|---------|---------|-----------|
| 洗盘嫌疑 | 暂停交易 24h | 是 |
| 高频异常 | 限流降级 | 否 |
| 大单异动 | 人工审核队列 | 是 |

---

## 五、黑名单管理

### 5.1 黑名单类型

| 类型 | 影响范围 |
|------|----------|
| trade | 禁止下单 |
| withdraw | 禁止提现 |
| full | 禁止所有操作 |

### 5.2 黑名单来源

- 手动添加 (管理后台)
- 自动触发 (风控规则)
- 外部数据 (OFAC 制裁名单)

---

## 六、数据库设计

> 表名前缀: `eidos_risk_`

### 6.1 风控规则表

```sql
CREATE TABLE eidos_risk_rules (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    rule_id         VARCHAR(64) NOT NULL UNIQUE,      -- 规则唯一ID
    rule_type       VARCHAR(50) NOT NULL,             -- 规则类型: price_deviation/rate_limit/amount_limit/self_trade
    market          VARCHAR(20),                      -- 适用交易对，NULL表示全局规则
    description     VARCHAR(500),                     -- 规则描述
    config          JSONB NOT NULL,                   -- 规则配置 (JSON格式，包含阈值等)
    enabled         BOOLEAN NOT NULL DEFAULT TRUE,    -- 是否启用
    created_by      VARCHAR(42),                      -- 创建者钱包地址
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    updated_by      VARCHAR(42),                      -- 更新者钱包地址
    updated_at      BIGINT NOT NULL,                  -- 更新时间 (毫秒时间戳)

    INDEX idx_rules_type (rule_type),                 -- 按类型查询
    INDEX idx_rules_market (market)                   -- 按交易对查询
);
```

### 6.2 规则版本表

```sql
CREATE TABLE eidos_risk_rule_versions (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    rule_id         VARCHAR(64) NOT NULL,             -- 规则ID
    version         INT NOT NULL,                     -- 版本号 (递增)
    config_snapshot JSONB NOT NULL,                   -- 配置快照 (该版本的完整配置)
    enabled         BOOLEAN NOT NULL,                 -- 该版本的启用状态
    change_type     VARCHAR(20) NOT NULL,             -- 变更类型: CREATE/UPDATE/ENABLE/DISABLE
    change_reason   VARCHAR(500),                     -- 变更原因
    changed_by      VARCHAR(42) NOT NULL,             -- 变更人钱包地址
    changed_at      BIGINT NOT NULL,                  -- 变更时间 (毫秒时间戳)
    effective_at    BIGINT NOT NULL,                  -- 生效时间 (毫秒时间戳)

    UNIQUE (rule_id, version),                        -- 同规则版本唯一
    INDEX idx_rule_versions_rule_id (rule_id),        -- 按规则查询
    INDEX idx_rule_versions_effective (effective_at)  -- 按生效时间查询
);
```

### 6.3 风险事件表

```sql
-- 风险事件表 (按月分区)
-- 预估数据量: 每日 1万~10万 条 (风险触发频率)
-- 分区策略: 按 created_at 时间范围分区，每月一个分区
-- 保留策略: 保留 12 个月 (需审计)，超期归档到冷存储
CREATE TABLE eidos_risk_events (
    id              BIGSERIAL,                        -- 自增ID
    event_id        VARCHAR(64) NOT NULL,             -- 事件唯一ID
    event_type      VARCHAR(50) NOT NULL,             -- 事件类型: PRICE_DEVIATION/RATE_LIMIT/SELF_TRADE/WASH_TRADE
    risk_level      VARCHAR(20) NOT NULL,             -- 风险级别: LOW/MEDIUM/HIGH/CRITICAL
    wallet_address  VARCHAR(42) NOT NULL,             -- 触发用户钱包地址
    ref_type        VARCHAR(20),                      -- 关联对象类型: ORDER/TRADE/WITHDRAW
    ref_id          VARCHAR(64),                      -- 关联对象ID
    details         JSONB NOT NULL,                   -- 事件详情 (JSON格式)
    status          VARCHAR(20) NOT NULL DEFAULT 'pending',  -- 状态: pending/resolved/ignored
    resolved_by     VARCHAR(42),                      -- 处理人钱包地址
    resolved_at     BIGINT,                           -- 处理时间
    resolution      VARCHAR(500),                     -- 处理结果描述
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)

    PRIMARY KEY (created_at, id),                     -- 分区键必须包含在主键中
    UNIQUE (event_id, created_at)                     -- 事件ID唯一 (包含分区键)
) PARTITION BY RANGE (created_at);

-- 分区索引
CREATE INDEX idx_events_wallet ON eidos_risk_events (wallet_address, created_at DESC);
CREATE INDEX idx_events_level_status ON eidos_risk_events (risk_level, status) WHERE status = 'pending';  -- 待处理高风险
CREATE INDEX idx_events_type ON eidos_risk_events (event_type, created_at DESC);

-- 分区示例 (按月)
CREATE TABLE eidos_risk_events_2024_01 PARTITION OF eidos_risk_events
    FOR VALUES FROM (1704067200000) TO (1706745600000);
CREATE TABLE eidos_risk_events_2024_02 PARTITION OF eidos_risk_events
    FOR VALUES FROM (1706745600000) TO (1709251200000);
```

### 6.4 黑名单表

```sql
CREATE TABLE eidos_risk_blacklist (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    wallet_address  VARCHAR(42) NOT NULL UNIQUE,      -- 用户钱包地址
    list_type       VARCHAR(20) NOT NULL,             -- 黑名单类型: trade/withdraw/full
    reason          VARCHAR(500) NOT NULL,            -- 加入原因
    source          VARCHAR(50) NOT NULL,             -- 来源: manual/auto/external(如OFAC)
    effective_from  BIGINT NOT NULL,                  -- 生效开始时间 (毫秒时间戳)
    effective_until BIGINT,                           -- 生效结束时间，NULL表示永久
    status          VARCHAR(20) NOT NULL DEFAULT 'active',  -- 状态: active/expired/removed
    created_by      VARCHAR(42),                      -- 创建者钱包地址
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    updated_by      VARCHAR(42),                      -- 更新者钱包地址
    updated_at      BIGINT NOT NULL,                  -- 更新时间 (毫秒时间戳)

    INDEX idx_blacklist_status (status),              -- 按状态查询
    INDEX idx_blacklist_type (list_type)              -- 按类型查询
);
```

### 6.5 风控审计日志表

```sql
-- 风控审计日志表 (按月分区)
-- 预估数据量: 每日 100万+ 条 (每个订单检查一次)
-- 分区策略: 按 created_at 时间范围分区，每月一个分区
-- 保留策略: 保留 6 个月，超期分区 DROP
CREATE TABLE eidos_risk_audit_logs (
    id              BIGSERIAL,                        -- 自增ID
    action          VARCHAR(50) NOT NULL,             -- 操作类型: CHECK_ORDER/CHECK_WITHDRAW/ADD_BLACKLIST
    wallet_address  VARCHAR(42),                      -- 被检查的用户钱包地址
    request         JSONB NOT NULL,                   -- 请求内容 (JSON格式)
    result          VARCHAR(20) NOT NULL,             -- 结果: ALLOWED/REJECTED/PENDING
    reason          VARCHAR(500),                     -- 拒绝原因 (REJECTED时填写)
    duration_ms     INT NOT NULL,                     -- 处理耗时 (毫秒)
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)

    PRIMARY KEY (created_at, id)                      -- 分区键必须包含在主键中
) PARTITION BY RANGE (created_at);

-- 分区索引 (仅保留高频查询索引，减少写入开销)
CREATE INDEX idx_audit_logs_wallet_time ON eidos_risk_audit_logs (wallet_address, created_at DESC);
CREATE INDEX idx_audit_logs_result ON eidos_risk_audit_logs (result) WHERE result = 'REJECTED';  -- 部分索引

-- 分区示例 (按月)
CREATE TABLE eidos_risk_audit_logs_2024_01 PARTITION OF eidos_risk_audit_logs
    FOR VALUES FROM (1704067200000) TO (1706745600000);
CREATE TABLE eidos_risk_audit_logs_2024_02 PARTITION OF eidos_risk_audit_logs
    FOR VALUES FROM (1706745600000) TO (1709251200000);
```

### 6.6 提现审核表

```sql
CREATE TABLE eidos_risk_withdrawal_reviews (
    id              BIGSERIAL PRIMARY KEY,            -- 自增主键
    review_id       VARCHAR(64) NOT NULL UNIQUE,      -- 审核唯一ID
    withdrawal_id   VARCHAR(64) NOT NULL UNIQUE,      -- 提现ID (来自trading服务)
    wallet_address  VARCHAR(42) NOT NULL,             -- 用户钱包地址
    token           VARCHAR(42) NOT NULL,             -- 代币符号
    amount          DECIMAL(36, 18) NOT NULL,         -- 提现金额
    to_address      VARCHAR(42) NOT NULL,             -- 目标地址
    risk_score      INT NOT NULL,                     -- 风险评分 (0-100)
    risk_factors    JSONB NOT NULL,                   -- 风险因素 (JSON格式，各因素的分值)
    auto_decision   VARCHAR(20),                      -- 自动决策: AUTO_APPROVE/MANUAL_REVIEW/AUTO_REJECT
    status          VARCHAR(20) NOT NULL DEFAULT 'pending',  -- 状态: pending/approved/rejected
    reviewer        VARCHAR(42),                      -- 审核人钱包地址
    review_comment  VARCHAR(500),                     -- 审核备注
    reviewed_at     BIGINT,                           -- 审核时间
    created_at      BIGINT NOT NULL,                  -- 创建时间 (毫秒时间戳)
    expires_at      BIGINT NOT NULL,                  -- 审核超时时间 (24小时后)

    INDEX idx_withdrawal_reviews_wallet (wallet_address),  -- 按用户查询
    INDEX idx_withdrawal_reviews_status (status)           -- 按状态查询
);
```

---

## 七、Redis 缓存设计

### 7.1 Key 命名规范

```
格式: eidos:risk:{业务域}:{标识符}

示例:
- eidos:risk:blacklist:{wallet}           黑名单缓存
- eidos:risk:blacklist:set                全量黑名单集合
- eidos:risk:rate:{wallet}:{action}:{window}  频率限制计数
- eidos:risk:price:{market}               最近成交价缓存
- eidos:risk:orders:{wallet}              用户挂单价格区间
- eidos:risk:alert:{alert_id}             告警去重
- eidos:risk:degradation:level            当前降级级别
```

### 7.2 缓存策略

| 缓存类型 | TTL | 一致性策略 | 用途 |
|----------|-----|------------|------|
| 黑名单缓存 | 10m | 写后失效 | 快速黑名单检查 |
| 黑名单集合 | 10m | 定期刷新 | 全量黑名单 SET |
| 频率限制 | 滑动窗口 | Lua 原子操作 | 下单/取消频率控制 |
| 最近成交价 | 10m | 写后更新 | 价格偏离检查 |
| 用户挂单 | 5m | 写后失效 | 自成交快速检查 |
| 告警去重 | 1h | - | 防止告警风暴 |
| 降级级别 | 永久 | 实时更新 | 服务降级状态 |

### 7.3 频率限制实现 (滑动窗口)

```lua
-- Redis Lua 脚本: 滑动窗口频率限制
-- KEYS[1]: rate limit key
-- ARGV[1]: 窗口大小 (秒)
-- ARGV[2]: 最大请求数
-- ARGV[3]: 当前时间戳 (毫秒)

local key = KEYS[1]
local window = tonumber(ARGV[1]) * 1000
local limit = tonumber(ARGV[2])
local now = tonumber(ARGV[3])

-- 移除过期记录
redis.call('ZREMRANGEBYSCORE', key, 0, now - window)

-- 获取当前窗口请求数
local count = redis.call('ZCARD', key)

if count < limit then
    -- 添加当前请求
    redis.call('ZADD', key, now, now .. ':' .. math.random())
    redis.call('PEXPIRE', key, window)
    return 1  -- 允许
else
    return 0  -- 拒绝
end
```

### 7.4 用户挂单价格区间缓存

```
# 用于自成交快速检查
eidos:risk:orders:{wallet}:{market} → {
    "buy_min": "49000.00",   -- 最低买单价
    "buy_max": "49500.00",   -- 最高买单价
    "sell_min": "50000.00",  -- 最低卖单价
    "sell_max": "50500.00",  -- 最高卖单价
    "count": 10              -- 挂单数量
}

# O(1) 自成交检查:
# 新买单价格 >= sell_min → 可能自成交
# 新卖单价格 <= buy_max → 可能自成交
```

---

## 八、配置

```yaml
service:
  name: eidos-risk
  grpc_port: 50055

sync_check:
  timeout: 100ms
  degradation:
    enabled: true
    level_1_threshold: 0.10
    level_2_threshold: 0.30
    level_3_threshold: 0.50
    level_4_threshold: 0.80

rules:
  price_deviation:
    warning: 0.05
    reject: 0.10
  rate_limits:
    create_order:
      per_second: 10
      per_minute: 200
  order_limits:
    min_value: "10"
    max_value: "100000"
  withdraw_limits:
    single_max: "50000"
    daily_max: "500000"
    large_threshold: "10000"

# =============================================================================
# 安全传输配置 (云组件加密)
# =============================================================================
# 说明: 生产环境使用云托管组件，默认启用加密传输
#       本地开发/测试环境可关闭加密以简化配置
security:
  # 总开关: true=启用加密, false=关闭加密 (本地测试)
  tls_enabled: ${TLS_ENABLED:false}

  # gRPC TLS (服务间调用)
  grpc:
    enabled: ${GRPC_TLS_ENABLED:false}
    cert: "${GRPC_CERT_PATH}"
    key: "${GRPC_KEY_PATH}"
    ca_cert: "${GRPC_CA_CERT_PATH}"
    client_auth: false

  # PostgreSQL TLS (云 RDS)
  postgres:
    enabled: ${PG_TLS_ENABLED:false}
    sslmode: "verify-full"
    ca_cert: "${PG_CA_CERT_PATH}"

  # Kafka TLS/SASL
  kafka:
    enabled: ${KAFKA_TLS_ENABLED:false}
    protocol: "SASL_SSL"
    sasl_mechanism: "SCRAM-SHA-512"
    ca_cert: "${KAFKA_CA_CERT_PATH}"
    username: "${KAFKA_SASL_USERNAME}"
    password: "${KAFKA_SASL_PASSWORD}"

  # Redis TLS
  redis:
    enabled: ${REDIS_TLS_ENABLED:false}
    ca_cert: "${REDIS_CA_CERT_PATH}"
    skip_verify: false

  # Nacos TLS
  nacos:
    enabled: ${NACOS_TLS_ENABLED:false}
    ca_cert: "${NACOS_CA_CERT_PATH}"
```

---

## 八、监控指标

| 指标 | 说明 |
|------|------|
| risk_check_total | 风控检查总数 |
| risk_check_duration_seconds | 检查耗时 |
| risk_reject_total | 拒绝数 (按原因) |
| risk_alerts_total | 告警数 |
| risk_blacklist_size | 黑名单大小 |
| risk_service_timeouts_total | 服务超时数 |

---

## 九、错误码

| 错误码 | 说明 |
|--------|------|
| RISK_PRICE_DEVIATION | 价格偏离过大 |
| RISK_RATE_LIMIT_EXCEEDED | 频率限制 |
| RISK_ORDER_AMOUNT_TOO_SMALL | 金额过小 |
| RISK_ORDER_AMOUNT_TOO_LARGE | 金额过大 |
| RISK_SELF_TRADE | 自成交风险 |
| RISK_WITHDRAW_NEED_REVIEW | 提现需审核 |
| RISK_BLACKLISTED | 黑名单 |

---

## 十、Proto 定义

详见: `eidos-risk/api/proto/risk/v1/risk.proto`

核心接口:
- CheckOrder / CheckWithdraw
- GetRiskStatus
- AddToBlacklist / RemoveFromBlacklist / CheckBlacklist
